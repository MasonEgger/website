<!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Build a durable AI agent from scratch using the Temporal Python SDK">
      
      
        <meta name="author" content="Mason Egger">
      
      
        <link rel="canonical" href="https://mason.dev/tutorials/how-to-build-a-durable-ai-agent-with-temporal-and-python/">
      
      
        <link rel="prev" href="../how-to-build-a-7-days-to-die-server-on-ubuntu/">
      
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../static/img/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>How To Build a Durable AI Agent with Temporal and Python - Mason Egger</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-885F33V7K6"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-885F33V7K6",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-885F33V7K6",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="How To Build a Durable AI Agent with Temporal and Python - Mason Egger" >
      
        <meta  property="og:description"  content="Build a durable AI agent from scratch using the Temporal Python SDK" >
      
        <meta  property="og:image"  content="https://mason.dev/assets/images/social/tutorials/posts/003-durable-ai-agent.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://mason.dev/tutorials/how-to-build-a-durable-ai-agent-with-temporal-and-python/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="How To Build a Durable AI Agent with Temporal and Python - Mason Egger" >
      
        <meta  name="twitter:description"  content="Build a durable AI agent from scratch using the Temporal Python SDK" >
      
        <meta  name="twitter:image"  content="https://mason.dev/assets/images/social/tutorials/posts/003-durable-ai-agent.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="mme" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Mason Egger" class="md-header__button md-logo" aria-label="Mason Egger" data-md-component="logo">
      
  <img src="../../static/img/mmeg.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Mason Egger
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              How To Build a Durable AI Agent with Temporal and Python
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="mme" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/masonegger/website" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    masonegger/website
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../blog/" class="md-tabs__link">
        
  
  
    
  
  Blog

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="../" class="md-tabs__link">
        
  
  
    
  
  Tutorials

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../speaking/" class="md-tabs__link">
        
  
  
    
  
  Speaking

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../uses/" class="md-tabs__link">
        
  
  
    
  
  Uses

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../bio/" class="md-tabs__link">
        
  
  
    
  
  Bio

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../extras/" class="md-tabs__link">
        
  
  
    
  
  Extras

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Mason Egger" class="md-nav__button md-logo" aria-label="Mason Egger" data-md-component="logo">
      
  <img src="../../static/img/mmeg.png" alt="logo">

    </a>
    Mason Egger
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/masonegger/website" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    masonegger/website
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../blog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../speaking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Speaking
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../uses/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Uses
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bio
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../extras/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extras
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content md-content--post" data-md-component="content">

    <!-- Sidebar -->
    <div
      class="md-sidebar md-sidebar--post"
      data-md-component="sidebar"
      data-md-type="navigation"
    >
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav">

            <!-- Back to overview link -->
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../" class=" md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>

            <!-- Page authors -->
            
              <div class="md-post__authors md-typeset">
                
                  <div class="md-profile md-post__profile">
                    <span class="md-author md-author--long">
                      <img src="https://github.com/masonegger.png" alt="Mason Egger" />
                    </span>
                    <span class="md-profile__description">
                      <strong>Mason Egger</strong><br />
                      Developer, Educator, Community Organizer
                    </span>
                  </div>
                
              </div>
            

            <!-- Page metadata -->
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__title">
                <div class="md-nav__link">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
              </li>

              

              

              <!-- Page original publish date -->
              <li class="md-nav__item">
                <div class="md-nav__link">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                    <time datetime="2025-07-24" class="md-ellipsis">
                    Published: July 24, 2025</time>
                </div>
              </li>  
              <!-- Page categories -->
              
                <li class="md-nav__item">
                  <div class="md-nav__link">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg>
                    <span class="md-ellipsis">
                      in
                      
                        <a href="../category/python/">Python</a>, 
                        <a href="../category/temporal/">Temporal</a>, 
                        <a href="../category/ai/">AI</a></span>
                  </div>
                </li>
              

              <!-- Page readtime -->
              
            </ul>

            <!-- Page links -->
            
          </nav>

          <!-- Table of contents, if integrated -->
          
            

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prerequisites">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#required" class="md-nav__link">
    <span class="md-ellipsis">
      Required
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional" class="md-nav__link">
    <span class="md-ellipsis">
      Optional
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#concepts" class="md-nav__link">
    <span class="md-ellipsis">
      Concepts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#programming-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      Programming Concepts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ai-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      AI Concepts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-your-development-environment" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up your development environment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#constructing-the-agent-toolkit" class="md-nav__link">
    <span class="md-ellipsis">
      Constructing the agent toolkit
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Constructing the agent toolkit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-up-the-tools-package" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up the tools package
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acquiring-the-find_events-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Acquiring the find_events tool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acquiring-the-search_flights-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Acquiring the search_flights tool
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Acquiring the search_flights tool">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#testing-the-mocked-search_flight-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Testing the mocked search_flight tool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-the-sky-scrapper-powered-search_flights-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Testing the Sky Scrapper powered search_flights tool
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acquiring-the-create_invoice-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Acquiring the create_invoice tool
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Acquiring the create_invoice tool">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#testing-the-mocked-create_invoice-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Testing the mocked create_invoice tool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-the-stripe-powered-create_invoice-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Testing the Stripe-powered create_invoice tool
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exposing-the-tools-to-the-agent" class="md-nav__link">
    <span class="md-ellipsis">
      Exposing the tools to the agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Exposing the tools to the agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defining-the-core-models" class="md-nav__link">
    <span class="md-ellipsis">
      Defining the core models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-the-tool-registry" class="md-nav__link">
    <span class="md-ellipsis">
      Creating the tool registry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mapping-the-registry-to-the-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Mapping the registry to the functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#designating-the-agents-goal" class="md-nav__link">
    <span class="md-ellipsis">
      Designating the agent's goal
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Designating the agent&#39;s goal">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defining-the-agentgoal-type" class="md-nav__link">
    <span class="md-ellipsis">
      Defining the AgentGoal type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementing-the-goal-registry" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing the goal registry
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-temporal-activities-to-execute-non-deterministic-agent-code" class="md-nav__link">
    <span class="md-ellipsis">
      Building Temporal Activities to execute non-deterministic agent code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building Temporal Activities to execute non-deterministic agent code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-the-requests-data-models" class="md-nav__link">
    <span class="md-ellipsis">
      Creating the requests data models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-the-activities-submodule" class="md-nav__link">
    <span class="md-ellipsis">
      Creating the Activities submodule
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constructing-the-agentactivities-class" class="md-nav__link">
    <span class="md-ellipsis">
      Constructing the AgentActivities Class
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Constructing the AgentActivities Class">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementing-various-helper-methods" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing various helper methods
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementing-the-activity-for-making-llm-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing the Activity for making LLM calls
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementing-the-activity-for-prompt-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing the Activity for prompt validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementing-the-activity-for-retrieving-environment-variables" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing the Activity for retrieving environment variables
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementing-dynamic-tool-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing dynamic tool execution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#developing-the-necessary-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      Developing the necessary prompts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Developing the necessary prompts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-the-submodule" class="md-nav__link">
    <span class="md-ellipsis">
      Creating the submodule
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crafting-the-prompts-templates" class="md-nav__link">
    <span class="md-ellipsis">
      Crafting the prompts templates
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Crafting the prompts templates">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defining-the-primary-context-prompt" class="md-nav__link">
    <span class="md-ellipsis">
      Defining the primary context prompt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-the-tool-completion-prompt" class="md-nav__link">
    <span class="md-ellipsis">
      Defining the tool completion prompt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-the-missing-arguments-prompt" class="md-nav__link">
    <span class="md-ellipsis">
      Defining the missing arguments prompt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-the-toolchain-complete-prompt" class="md-nav__link">
    <span class="md-ellipsis">
      Defining the toolchain complete prompt
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-the-prompt-generation-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Building the prompt generation functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-the-agent-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Building the agent Workflow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building the agent Workflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-the-workflows-submodule" class="md-nav__link">
    <span class="md-ellipsis">
      Creating the workflows submodule
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementing-a-few-workflow-helper-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing a few Workflow helper functions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing a few Workflow helper functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defining-the-tool-execution-activity-invocation-function" class="md-nav__link">
    <span class="md-ellipsis">
      Defining the tool execution Activity invocation function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-the-missing-argument-handler-function" class="md-nav__link">
    <span class="md-ellipsis">
      Defining the missing argument handler function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-the-history-formatting-function" class="md-nav__link">
    <span class="md-ellipsis">
      Defining the history formatting function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-the-history-summarization-prompt-function" class="md-nav__link">
    <span class="md-ellipsis">
      Defining the history summarization prompt function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-the-function-to-handle-long-event-histories" class="md-nav__link">
    <span class="md-ellipsis">
      Defining the function to handle long Event Histories
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-the-prompt-entity-identification-function" class="md-nav__link">
    <span class="md-ellipsis">
      Defining the prompt entity identification function
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparing-the-core-agent-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Preparing the core agent Workflow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Preparing the core agent Workflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#defining-the-agent-class-and-constructor" class="md-nav__link">
    <span class="md-ellipsis">
      Defining the agent class and constructor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-the-agent-control-variables" class="md-nav__link">
    <span class="md-ellipsis">
      Defining the agent control variables
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementing-the-core-agent-loop" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing the core agent loop
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing the core agent loop">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#handling-the-await-conditions-and-exit-condition" class="md-nav__link">
    <span class="md-ellipsis">
      Handling the await conditions and exit condition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executing-the-tool" class="md-nav__link">
    <span class="md-ellipsis">
      Executing the tool
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-in-a-few-more-helper-methods" class="md-nav__link">
    <span class="md-ellipsis">
      Adding in a few more helper methods
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validating-user-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      Validating user prompts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generating-a-context-aware-prompt" class="md-nav__link">
    <span class="md-ellipsis">
      Generating a context-aware prompt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executing-the-tool-planner" class="md-nav__link">
    <span class="md-ellipsis">
      Executing the tool planner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#determining-the-next_step" class="md-nav__link">
    <span class="md-ellipsis">
      Determining the next_step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-a-long-running-execution" class="md-nav__link">
    <span class="md-ellipsis">
      Handling a long running execution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#communicating-with-the-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Communicating with the Workflow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Communicating with the Workflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#accepting-the-users-input" class="md-nav__link">
    <span class="md-ellipsis">
      Accepting the users input
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#confirming-the-users-request" class="md-nav__link">
    <span class="md-ellipsis">
      Confirming the users request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ending-the-chat" class="md-nav__link">
    <span class="md-ellipsis">
      Ending the chat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retrieving-the-conversing-history" class="md-nav__link">
    <span class="md-ellipsis">
      Retrieving the conversing history
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retrieving-the-latest-tool-data" class="md-nav__link">
    <span class="md-ellipsis">
      Retrieving the latest tool data
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-the-temporal-worker" class="md-nav__link">
    <span class="md-ellipsis">
      Building the Temporal Worker
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building the Temporal Worker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-the-temporal-client" class="md-nav__link">
    <span class="md-ellipsis">
      Creating the Temporal client
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring-the-worker" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring the Worker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-the-worker" class="md-nav__link">
    <span class="md-ellipsis">
      Testing the Worker
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-a-rest-api-for-interacting-with-your-agent" class="md-nav__link">
    <span class="md-ellipsis">
      Building a REST API for interacting with your agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building a REST API for interacting with your agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-up-the-fastapi-application" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up the FastAPI application
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementing-agent-workflow-endpoints" class="md-nav__link">
    <span class="md-ellipsis">
      Implementing agent Workflow endpoints
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing agent Workflow endpoints">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#validating-the-temporal-client" class="md-nav__link">
    <span class="md-ellipsis">
      Validating the Temporal client
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#starting-the-agent-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Starting the agent Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sending-a-user-prompt-to-the-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Sending a user prompt to the Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sending-a-confirmation-to-the-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Sending a confirmation to the Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ending-the-chat_1" class="md-nav__link">
    <span class="md-ellipsis">
      Ending the chat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retrieving-the-conversation-history" class="md-nav__link">
    <span class="md-ellipsis">
      Retrieving the conversation history
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-your-agent" class="md-nav__link">
    <span class="md-ellipsis">
      Running your agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Running your agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adding-a-chatbot-web-ui" class="md-nav__link">
    <span class="md-ellipsis">
      Adding a Chatbot Web UI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#starting-your-agent" class="md-nav__link">
    <span class="md-ellipsis">
      Starting Your Agent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-the-complete-system" class="md-nav__link">
    <span class="md-ellipsis">
      Testing the complete system
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tracing-the-workflow-execution-in-the-web-ui" class="md-nav__link">
    <span class="md-ellipsis">
      Tracing the Workflow Execution in the Web UI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional-witnessing-the-durability-of-the-agent" class="md-nav__link">
    <span class="md-ellipsis">
      (Optional) Witnessing the Durability of the Agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="(Optional) Witnessing the Durability of the Agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#part-1-terminating-the-worker" class="md-nav__link">
    <span class="md-ellipsis">
      Part 1: Terminating the Worker
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-2-turning-off-the-internet" class="md-nav__link">
    <span class="md-ellipsis">
      Part 2: Turning off the Internet
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#part-3-swapping-out-llms" class="md-nav__link">
    <span class="md-ellipsis">
      Part 3: Swapping out LLMs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Conclusion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-architectural-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      Key architectural patterns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#resources-for-continued-learning" class="md-nav__link">
    <span class="md-ellipsis">
      Resources for continued learning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-thoughts" class="md-nav__link">
    <span class="md-ellipsis">
      Final thoughts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#license-acknowledgements" class="md-nav__link">
    <span class="md-ellipsis">
      License Acknowledgements
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
          
        </div>
      </div>
    </div>

    <!-- Page content -->
    <article class="md-content__inner md-typeset">
      
        
  



  
  


  <h1>How To Build a Durable AI Agent with Temporal and Python</h1>

<p>AI Agents are distributed systems, and come with all of the challenges expected.
Temporal provides Durable Execution for software, and pairing it with AI Agents is a match made in heaven.
In this tutorial you'll implement an AI Agent using Temporal's Python SDK.</p>
<!-- more -->

<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>An AI agent uses large language models (LLMs) to plan and execute steps towards a goal.
While attempting to reach its goal, the agent can perform actions such as searching for information, interacting with external services, and even calling other agents. 
However, building reliable AI agents presents various challenges. 
Network failures, long-running workflows, observability challenges, and more make building AI agents a textbook distributed systems problem.</p>
<p>Temporal orchestrates long-running workflows, automatically handles failure cases from network outages to server crashes, provides insights into your running applications, and more.
These features provide the resiliency and durability necessary to build reliable agents that users can rely on.</p>
<p>In this tutorial you'll build an AI agent using Temporal that searches for events in a given city, helps you book a plane ticket, and creates an invoice for the trip. 
The user will interact with this application through a chatbot interface, communicating with the agent using natural language.
Throughout this tutorial you will implement the following components:</p>
<ul>
<li>Various <strong>tools</strong> the agent will use to search for events, find flights, and generate invoices.</li>
<li>An <strong>agent goal</strong> that will specify what overall task the agent is trying to achieve and what tools it is allowed to use.</li>
<li><strong>Temporal Workflows</strong> that will orchestrate multi-turn conversations and ensure durability across failures</li>
<li><strong>Temporal Activities</strong> that execute tools and language model calls with automatic retry logic</li>
<li>A <strong>FastAPI backend</strong> that connects the web interface to your Temporal Workflows</li>
<li>A <strong>web-based chat interface</strong> that allows users to interact with the agent</li>
</ul>
<p>By the end of this tutorial, you will have a modular, durable AI agent that you can extend to run any goal using any set of tools.
Your agent will be able to recover from failure, whether it's a hardware failure, a tool failure, or an LLM failure.
And you'll be able to use Temporal to build reliable AI applications that maintain state and provide consistent user experiences.</p>
<p>You can find the code for this tutorial on GitHub in the <a href="https://github.com/temporal-community/tutorial-temporal-ai-agent">tutorial-temporal-ai-agent</a> repository.</p>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h2>
<p>Before starting this tutorial, ensure that you have the following on your local machine:</p>
<h3 id="required">Required<a class="headerlink" href="#required" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="https://learn.temporal.io/getting_started/python/dev_environment/#set-up-a-local-temporal-service-for-development-with-temporal-cli">The Temporal CLI development service</a> installed and verified.</li>
<li><a href="https://www.python.org/downloads/">Python 3.9 or higher</a> installed. 
Verify your installation by running <code>python3 --version</code> in your terminal.</li>
<li>The <a href="https://docs.astral.sh/uv/getting-started/installation/"><code>uv</code> package and project manager installed</a>. <code>uv</code> is a modern, fast Python package manager that will handle virtual environments and dependencies. </li>
<li>The command line tool <a href="https://curl.se/">curl</a> installed for downloading certain files.</li>
<li><a href="https://nodejs.org/en/download">Node.js 18 or higher installed</a>.
You can verify your installation with <code>node --version</code> and <code>npm --version</code>.</li>
<li>An <a href="https://platform.openai.com/api-keys">OpenAI API key</a> saved securely where you can access it.
You may need to create an <a href="https://platform.openai.com/">OpenAI</a> account first.
You will use this key to configure the LLM integration.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>OpenAI API Keys require purchasing credits to use.
You can succeed with this tutorial with minimal credits; in our experience, less than $1 will suffice.</p>
</div>
<h3 id="optional">Optional<a class="headerlink" href="#optional" title="Permanent link">&para;</a></h3>
<p>You can opt to use real API services for your tools, or use provided mock functions. </p>
<ul>
<li>A free <a href="https://rapidapi.com/apiheya/api/sky-scrapper">RapidAPI Sky Scrapper API Key</a> saved securely where you can access it. You will use this to search for flights.</li>
<li>A free <a href="https://stripe.com/lp/start-now">Stripe Account</a> with a configured <a href="https://docs.stripe.com/sandboxes">sandbox</a>. You will use this to generate fake invoices for the flights that are being booked.</li>
</ul>
<h3 id="concepts">Concepts<a class="headerlink" href="#concepts" title="Permanent link">&para;</a></h3>
<p>Additionally, this tutorial assumes you have basic familiarity with:</p>
<h4 id="programming-concepts">Programming Concepts<a class="headerlink" href="#programming-concepts" title="Permanent link">&para;</a></h4>
<ul>
<li>Temporal fundamentals such as <a href="https://docs.temporal.io/develop/python/core-application#develop-workflows">Workflows</a>, <a href="https://docs.temporal.io/develop/python/core-application#develop-activities">Activities</a>, <a href="https://docs.temporal.io/develop/python/core-application#run-a-dev-worker">Workers</a>, <a href="https://docs.temporal.io/develop/python/message-passing#signals">Signals</a>, and <a href="https://docs.temporal.io/develop/python/message-passing#queries">Queries</a></li>
<li>Python fundamentals such as functions, classes, <a href="https://docs.python.org/3/library/asyncio.html">async/await syntax</a>, and virtual environments</li>
<li>Command line interface and running commands in a terminal or command prompt  </li>
<li>REST API concepts including HTTP requests and JSON responses</li>
<li>How to set and use environment variables in your operating system</li>
</ul>
<h4 id="ai-concepts">AI Concepts<a class="headerlink" href="#ai-concepts" title="Permanent link">&para;</a></h4>
<ul>
<li><a href="https://temporal.io/blog/a-mental-model-for-agentic-ai-applications">A Mental Model for Agentic AI Applications</a></li>
<li><a href="https://temporal.io/blog/building-an-agentic-system-thats-actually-production-ready">Building an agentic system that's actually production ready</a></li>
<li><a href="https://temporal.io/blog/from-ai-hype-to-durable-reality-why-agentic-flows-need-distributed-systems">Why Agentic Flows Need Distributed Systems</a></li>
</ul>
<h2 id="setting-up-your-development-environment">Setting up your development environment<a class="headerlink" href="#setting-up-your-development-environment" title="Permanent link">&para;</a></h2>
<p>Before you start coding, you need to set up your Python developer environment.
In this step, you will set up your project structure, install the necessary Python packages, and configure the Python environment needed to build your AI agent.</p>
<p>First, create your project using <code>uv</code>:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>uv init temporal-ai-agent --python &quot;&gt;=3.9&quot;
</span></code></pre></div>
<p><code>uv</code> is a modern Python project and packaging tool that sets up a project structure for  you.
Running this command creates the following default Python package structure for you:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>temporal-ai-agent/
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>├── .gitignore
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>├── .python-version
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>├── main.py
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>├── README.md
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>├── pyproject.toml
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>└── uv.lock
</span></code></pre></div>
<p>It automatically runs a <code>git init</code> command for you, provides you with the default <code>.gitignore</code> for Python, creates a <code>.python-version</code> file that has the project's default Python version, a README.md, a Hello World <code>main.py</code> program, and a <code>pyproject.toml</code> file for managing the projects packages and environment.</p>
<p>Next, change directories into your newly created project:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>cd temporal-ai-agent
</span></code></pre></div>
<p>You won't need the <code>main.py</code> file, so delete it:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>rm main.py
</span></code></pre></div>
<p>Next, create your virtual environment by running the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>uv<span class="w"> </span>venv
</span></code></pre></div>
<p>This creates a virtual environment named <code>.venv</code> in the current working directory.</p>
<p>Now that you have a virtual environment created, add the dependencies needed to build your AI agent system:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>uv add python-dotenv fastapi jinja2 litellm stripe temporalio uvicorn requests
</span></code></pre></div>
<p>This installs all the necessary packages:
- <code>python-dotenv</code> - For loading environment variables from a <code>.env</code> file
- <code>fastapi</code> and <code>uvicorn</code> - Web framework and server for the API backend
- <code>jinja2</code> - Template engine
- <code>litellm</code> - Unified interface for different language model providers
- <code>stripe</code> - Payment processing library for the invoice generation demo
- <code>temporalio</code> - The Temporal Python SDK
- <code>requests</code> - HTTP library for API calls</p>
<p>Finally, add the following lines to the end of your <code>pyproject.toml</code> file:</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">[build-system]</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="na">requires</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">[&quot;hatchling&quot;]</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="na">build-backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;hatchling.build&quot;</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="c1"># Tell hatchling what to include</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="k">[tool.hatch.build.targets.wheel]</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="na">packages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">[&quot;activities&quot;, &quot;api&quot;, &quot;models&quot;, &quot;prompts&quot;, &quot;shared&quot;, &quot;tools&quot;, &quot;workflows&quot;]</span>
</span></code></pre></div>
<p>This configures <code>uv</code> as to which packages to include and enable for execution.
You will create these packages later in the tutorial.</p>
<details>

<summary>
The <code>pyproject.toml</code> is complete and will need no more revisions. You can review the complete file and copy the code here
</summary>

[pyproject.toml](https://github.com/temporal-community/tutorial-temporal-ai-agent/blob/main/pyproject.toml)

<div class="language-ini highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">[project]</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;temporal-ai-agent&quot;</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;0.1.0&quot;</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Add your description here&quot;</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="na">readme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;README.md&quot;</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="na">requires-python</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&gt;=3.9&quot;</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="na">dependencies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">[</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">    </span><span class="na">&quot;python-dotenv&gt;</span><span class="o">=</span><span class="s">1.0.0&quot;,</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">    </span><span class="na">&quot;fastapi&gt;</span><span class="o">=</span><span class="s">0.115.12&quot;,</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">    </span><span class="na">&quot;jinja2&gt;</span><span class="o">=</span><span class="s">3.1.6&quot;,</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">    </span><span class="na">&quot;litellm&gt;</span><span class="o">=</span><span class="s">1.72.2&quot;,</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">    </span><span class="na">&quot;stripe&gt;</span><span class="o">=</span><span class="s">12.2.0&quot;,</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">    </span><span class="na">&quot;temporalio&gt;</span><span class="o">=</span><span class="s">1.12.0&quot;,</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">    </span><span class="na">&quot;uvicorn&gt;</span><span class="o">=</span><span class="s">0.34.3&quot;,</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">    </span><span class="na">&quot;requests&gt;</span><span class="o">=</span><span class="s">2.32.4&quot;,</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="na">]</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="k">[build-system]</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="na">requires</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">[&quot;hatchling&quot;]</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="na">build-backend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;hatchling.build&quot;</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="c1"># Tell hatchling what to include</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="k">[tool.hatch.build.targets.wheel]</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="na">packages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">[&quot;activities&quot;, &quot;api&quot;, &quot;models&quot;, &quot;prompts&quot;, &quot;shared&quot;, &quot;tools&quot;, &quot;workflows&quot;]</span>
</span></code></pre></div>
</details>

<p>Next, create a <code>.env</code> file to store your configuration:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>touch .env
</span></code></pre></div>
<p>Next, copy the following configuration to your <code>.env</code> file.</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># LLM Configuration</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="na">LLM_MODEL</span><span class="o">=</span><span class="s">openai/gpt-4o</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="na">LLM_KEY</span><span class="o">=</span><span class="s">YOUR_OPEN_AI_KEY</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="c1"># Set if the user should click a Confirm button in the UI to allow the tool</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="c1"># to execute</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="na">SHOW_CONFIRM</span><span class="o">=</span><span class="s">True</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="c1"># Temporal Configuration</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="na">TEMPORAL_ADDRESS</span><span class="o">=</span><span class="s">localhost:7233</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="na">TEMPORAL_NAMESPACE</span><span class="o">=</span><span class="s">default</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="na">TEMPORAL_TASK_QUEUE</span><span class="o">=</span><span class="s">agent-task-queue</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="c1"># (Optional) - Uncomment both lines and set RAPIDAPI_KEY if you plan on </span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="c1"># using the real flights API</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="c1"># RAPIDAPI_KEY=YOUR_RAPID_API_KEY</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="c1"># RAPIDAPI_HOST_FLIGHTS=sky-scrapper.p.rapidapi.com</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="c1"># (Optional) - Uncomment and set STRIPE_API_KEY if you plan on using the Stripe</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="c1"># API to generate a fake invoice</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="c1"># STRIPE_API_KEY=YOUR_STRIPE_API_KEY</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="c1"># Uncomment if connecting to Temporal Cloud using mTLS (not needed for local dev server)</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a><span class="c1"># TEMPORAL_TLS_CERT=&#39;path/to/cert.pem&#39;</span>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="c1"># TEMPORAL_TLS_KEY=&#39;path/to/key.pem&#39;</span>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="c1"># Uncomment if connecting to Temporal Cloud using API key (not needed for local dev server)</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="c1"># TEMPORAL_API_KEY=abcdef1234567890</span>
</span></code></pre></div>
<p>Once copied, replace <code>YOUR_OPEN_API_KEY</code> with your OpenAI API key.
Setting <code>SHOW_CONFIRM=True</code> requires the user to confirm each tool prior to it being executed.
This will allow you to see what the agent is doing step by step.
These are the only two mandatory variables to set.
This tutorial provides both an ability to create pseudo tools that perform simulations, or tools that use external APIs to achieve their goals.
If you plan on using the <a href="#optional">RapidAPI SkyScraper API</a> to look up flight data or the <a href="#optional">Stripe API</a> to generate an invoice, you can uncomment these lines and provide the API keys here.</p>
<p>Additionally, if you plan on connecting to Temporal Cloud, you will need to update the <code>TEMPORAL_ADDRESS</code> and <code>TEMPORAL_NAMESPACE</code> parameters to connect to your Temporal Cloud instance.
You will also need to uncomment and set the <code>TEMPORAL_TLS</code> or <code>TEMPORAL_API_KEY</code> variables, depending on which authentication method you are using.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As this project is using <a href="https://pypi.org/project/litellm/">LiteLLM</a>, it supports various different LLM providers.
This tutorial will use OpenAI's gpt-4o, but you are welcome to use whichever LLM you wish, so long as it is supported by LiteLLM.</p>
</div>
<p>At this point, you have configured your developer environment to include a Python project managed by <code>uv</code> with all required dependencies to build a Temporal powered agentic AI, and all necessary environment variables. </p>
<p>Now that you have set up your developer environment, you will build the tools that your agent will use to perform the various tasks it needs to accomplish its goal.</p>
<h2 id="constructing-the-agent-toolkit">Constructing the agent toolkit<a class="headerlink" href="#constructing-the-agent-toolkit" title="Permanent link">&para;</a></h2>
<p>In this step, you will acquire the tools that will be available to your agent.
Agents are aware of the tools they have available to them while attempting to achieve their goal.
The agent will evaluate which tools are available and execute a tool if the agent believes it will provide the result the agent needs to progress in its task. </p>
<p>These tools can take various forms, but in this tutorial they're implemented as a series of independent Python scripts that provide data in a specific format that the agent can process. 
There are three tools: a <code>find_events</code> tool, a <code>search_flights</code> tool, and a <code>create_invoice</code> tool.
The LLM will decide when to use each tool as it interacts with the user who is trying to find an event and book a flight to attend it.
You could implement these tools yourself, or you could download a tool and provide it to an agent.
For this tutorial, you will download the tools directly from the <a href="https://github.com/temporal-community/tutorial-temporal-ai-agent">companion GitHub repository</a>.</p>
<h3 id="setting-up-the-tools-package">Setting up the <code>tools</code> package<a class="headerlink" href="#setting-up-the-tools-package" title="Permanent link">&para;</a></h3>
<p>To get started, first create the directory for your tools modules:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>mkdir tools
</span></code></pre></div>
<p>Then change directories into it:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>cd tools
</span></code></pre></div>
<p>However, for this to be an importable tools package, you will need to add a <code>__init__.py</code> file.
It can be blank for now, so create it with the following command:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>touch __init__.py
</span></code></pre></div>
<p>Now that you have set up the structure for your tools package, you'll acquire and test the tools needed to have the agent succeed with its goal.</p>
<h3 id="acquiring-the-find_events-tool">Acquiring the <code>find_events</code> tool<a class="headerlink" href="#acquiring-the-find_events-tool" title="Permanent link">&para;</a></h3>
<p>The <code>find_events</code> tool searches for events within a given city during a certain time of year.
The tool takes a month and city as inputs and provides events for not only the month that was provided, but the months before and after the given month as well. 
The LLM will use this tool to search for events when helping the user plan their trip.
This tool doesn't use an API, but rather simulates looking events up in a data store using mock data.</p>
<p>First, create a <code>data</code> directory within the <code>tools</code> directory to store the sample event data and change directories into it:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>mkdir data
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>cd data
</span></code></pre></div>
<p>Next, run the following command to download the sample data from the <a href="https://github.com/temporal-community/tutorial-temporal-ai-agent">companion GitHub repository</a>:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>curl -o find_events_data.json https://raw.githubusercontent.com/temporal-community/tutorial-temporal-ai-agent/main/tools/data/find_events_data.json
</span></code></pre></div>
<p>You can confirm you have the correct data by running the following command to sample the file and comparing it to the output:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>head -8 find_events_data.json
</span></code></pre></div>
<div class="language-json highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="p">{</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">  </span><span class="nt">&quot;New York&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">      </span><span class="nt">&quot;eventName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Winter Jazzfest&quot;</span><span class="p">,</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">      </span><span class="nt">&quot;dateFrom&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-01-10&quot;</span><span class="p">,</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">      </span><span class="nt">&quot;dateTo&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-01-19&quot;</span><span class="p">,</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">      </span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;A multi-venue jazz festival featuring emerging and established artists performing across Greenwich Village venues.&quot;</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="p">},</span>
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the dates appear to be far in the past, don't worry. 
There is logic within the <code>find_events</code> tool that automatically adjusts the date to ensure that no dates can be presented that are in the past.</p>
</div>
<p>Next, change directories back up one directory to the <code>tools</code> directory:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>cd ..
</span></code></pre></div>
<p>Now that you have the data, download the <code>find_events</code> tool using the command:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>curl -o find_events.py https://raw.githubusercontent.com/temporal-community/tutorial-temporal-ai-agent/main/tools/find_events.py
</span></code></pre></div>
<p>Open the file and explore the logic; you should never download a file from the internet and just trust it.</p>
<p>Try to answer the following questions about the codebase:
* Where in the code does it determine the adjacent months?
* How does the tool prevent the data from <code>find_events_data.json</code> being presented with a date that has already passed?
* What is the schema for the data that will be returned?</p>
<p>Once you have finished reviewing the code, navigate to the root directory of your project and create a scripts directory for testing this tool.
The root of your project should be one level higher your current directory, so you can get there by running the following command:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>cd ..
</span></code></pre></div>
<p>Create the <code>scripts</code> directory:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>mkdir scripts
</span></code></pre></div>
<p>Now create a test script named <code>find_events_test.py</code> in the <code>scripts</code> directory and add the following to test your script:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tools.find_events</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_events</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>    <span class="n">search_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="s2">&quot;Austin&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="s2">&quot;December&quot;</span><span class="p">}</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">find_events</span><span class="p">(</span><span class="n">search_args</span><span class="p">)</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></code></pre></div>
<p>This script will check for events in Austin, TX in the month of December.</p>
<p>From the root of your project, run the script using the following command to verify it's configured correctly:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>uv run scripts/find_events_test.py
</span></code></pre></div>
<p>You should see the following output:</p>
<div class="language-output highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="go">{</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="go">  &quot;note&quot;: &quot;Returning events from December plus one month either side (i.e., November, December, January).&quot;,</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="go">  &quot;events&quot;: [</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="go">    {</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="go">      &quot;city&quot;: &quot;Austin&quot;,</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="go">      &quot;eventName&quot;: &quot;Austin Celtic Festival&quot;,</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="go">      &quot;dateFrom&quot;: &quot;2025-11-08&quot;,</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="go">      &quot;dateTo&quot;: &quot;2025-11-09&quot;,</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="go">      &quot;description&quot;: &quot;Celebration of Celtic culture featuring traditional music, dance, crafts, and Irish food.&quot;,</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="go">      &quot;month&quot;: &quot;previous month&quot;</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="go">    },</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="go">    {</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="go">      &quot;city&quot;: &quot;Austin&quot;,</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="go">      &quot;eventName&quot;: &quot;Trail of Lights&quot;,</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="go">      &quot;dateFrom&quot;: &quot;2025-12-05&quot;,</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="go">      &quot;dateTo&quot;: &quot;2025-12-23&quot;,</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a><span class="go">      &quot;description&quot;: &quot;Holiday light display in Zilker Park featuring festive decorations, food vendors, and family activities.&quot;,</span>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="go">      &quot;month&quot;: &quot;requested month&quot;</span>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="go">    }</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a><span class="go">  ]</span>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a><span class="go">}</span>
</span></code></pre></div>
<p>Now that you have the <code>find_events</code> tool functioning, it's time to do the same for the <code>search_flights</code> tool.</p>
<h3 id="acquiring-the-search_flights-tool">Acquiring the <code>search_flights</code> tool<a class="headerlink" href="#acquiring-the-search_flights-tool" title="Permanent link">&para;</a></h3>
<p>The <code>search_flights</code> tool searches roundtrip flights to a destination.
The tool takes the origin, destination, arrival date, and departure date as arguments and returns flight data containing details such as carrier, price, and flight code for the flights.
The LLM will use this tool to find flights to the location once the user has selected the dates they wish to travel.
This tool can either use the <a href="#optional">RapidAPI SkyScraper API</a> if you have an API key configured in your <code>.env</code> file, or it will generate mock data if it's unable to detect the API key.</p>
<p>First, change directories into the <code>tools</code> directory:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>cd tools
</span></code></pre></div>
<p>Then get the tool by running the following command to download it from the <a href="https://github.com/temporal-community/tutorial-temporal-ai-agent">companion GitHub repository</a>:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>curl -o search_flights.py https://raw.githubusercontent.com/temporal-community/tutorial-temporal-ai-agent/main/tools/search_flights.py
</span></code></pre></div>
<p>Next, familiarize yourself with the tool by reviewing the code.
Try to answer the following questions about the code:
* What is the purpose of the <code>search_flights</code> function? (It's not as straightforward of an answer as it may appear)
* How many REST API calls does is it take to call complete the real flight API search?</p>
<p>Once you have finished reviewing the code, you will test it.</p>
<p>Create another test within the <code>scripts</code> directory named <code>search_flights_test.py</code> and add the following code:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tools.search_flights</span><span class="w"> </span><span class="kn">import</span> <span class="n">search_flights</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>    <span class="n">flights</span> <span class="o">=</span> <span class="n">search_flights</span><span class="p">(</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>        <span class="p">{</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>            <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="s2">&quot;ORD&quot;</span><span class="p">,</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>            <span class="s2">&quot;destination&quot;</span><span class="p">:</span> <span class="s2">&quot;DFW&quot;</span><span class="p">,</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>            <span class="s2">&quot;dateDepart&quot;</span><span class="p">:</span> <span class="s2">&quot;2025-09-20&quot;</span><span class="p">,</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>            <span class="s2">&quot;dateReturn&quot;</span><span class="p">:</span> <span class="s2">&quot;2025-09-22&quot;</span><span class="p">,</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>        <span class="p">}</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>    <span class="p">)</span>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">flights</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></code></pre></div>
<p>This test searches for a flight from Chicago to Dallas-Fort Worth.
However, since this tool can operate in either a mock mode or live API mode, there are two ways to verify it.</p>
<h4 id="testing-the-mocked-search_flight-tool">Testing the mocked <code>search_flight</code> tool<a class="headerlink" href="#testing-the-mocked-search_flight-tool" title="Permanent link">&para;</a></h4>
<p>Let's start by testing it without the RapidAPI key. 
If you have that set in your <code>.env</code> file, comment it out for now, or skip this step.</p>
<p>Change directories back to the root of the project and run the test using the following command:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>cd ..
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>uv run scripts/search_flights_test.py
</span></code></pre></div>
<p>Your output will vary, as the mock data function randomly generates results.
The output should, however, look something like this with more items in the results list:</p>
<div class="language-output highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="go">{</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="go">  &quot;currency&quot;: &quot;USD&quot;,</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="go">  &quot;destination&quot;: &quot;DFW&quot;,</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="go">  &quot;origin&quot;: &quot;ORD&quot;,</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="go">  &quot;results&quot;: [</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="go">    {</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="go">      &quot;operating_carrier&quot;: &quot;Southwest Airlines&quot;,</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="go">      &quot;outbound_flight_code&quot;: &quot;WN427&quot;,</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="go">      &quot;price&quot;: 462.43,</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="go">      &quot;return_flight_code&quot;: &quot;WN744&quot;,</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="go">      &quot;return_operating_carrier&quot;: &quot;Southwest Airlines&quot;</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="go">    }</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="go">  ]</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="go">}</span>
</span></code></pre></div>
<p>If you aren't planning on using the Sky Scrapper API, you can skip this next step and continue if you'd like.</p>
<h4 id="testing-the-sky-scrapper-powered-search_flights-tool">Testing the Sky Scrapper powered <code>search_flights</code> tool<a class="headerlink" href="#testing-the-sky-scrapper-powered-search_flights-tool" title="Permanent link">&para;</a></h4>
<p>Testing the API-powered version of the tool is similar to testing the mocked version.</p>
<p>First, if you haven't uncommented the <code>RAPID_API</code> lines in your <code>.env</code> file and added your API key, do this before running the test.
You will also need to uncomment the <code>RAPIDAPI_HOST_FLIGHTS</code> environment variable as this is the endpoint the tool will be accessing.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="nv">RAPIDAPI_KEY</span><span class="o">=</span>YOUR_RAPID_API_KEY
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="nv">RAPIDAPI_HOST_FLIGHTS</span><span class="o">=</span>sky-scrapper.p.rapidapi.com
</span></code></pre></div>
<p>Next, review the code in <code>scripts/search_flights_test.py</code> and make sure that the <code>dateDepart</code> and <code>dateReturn</code> dates are both in the future.
At this point you have no way of determining if the dates are in the past, and the API will return an error if you try to search for flights in the past. </p>
<p>Once you've reviewed the code, make sure you are at the root directory of the project.
If are still in the <code>scripts</code> directory, run the following command:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>cd ..
</span></code></pre></div>
<p>Then run the test using the following command:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>uv run scripts/search_flights_test.py
</span></code></pre></div>
<p>If you've changed the dates or cities, you may see different results, but the format should be similar to this:</p>
<div class="language-output highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="go">Searching for: ORD</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="go">Searching for: DFW</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="go">{</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="go">  &quot;origin&quot;: &quot;ORD&quot;,</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="go">  &quot;destination&quot;: &quot;DFW&quot;,</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="go">  &quot;currency&quot;: &quot;USD&quot;,</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="go">  &quot;results&quot;: [</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="go">    {</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="go">      &quot;outbound_flight_code&quot;: &quot;NK824&quot;,</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="go">      &quot;operating_carrier&quot;: &quot;Spirit Airlines&quot;,</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="go">      &quot;return_flight_code&quot;: &quot;NK828&quot;,</span>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="go">      &quot;return_operating_carrier&quot;: &quot;Spirit Airlines&quot;,</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="go">      &quot;price&quot;: 119.98</span>
</span><span id="__span-32-14"><a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="go">    },</span>
</span><span id="__span-32-15"><a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="go">  ]</span>
</span><span id="__span-32-16"><a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="go">}</span>
</span></code></pre></div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If the API gives you cryptic error messages such as <strong>Something went wrong</strong> or returns an incomplete response, you can try running it a few times and see if you get a different response.</p>
</div>
<p>Now that you have finished testing the <code>search_flights</code> tool, you can add the final tool to the agent's toolkit.</p>
<h3 id="acquiring-the-create_invoice-tool">Acquiring the <code>create_invoice</code> tool<a class="headerlink" href="#acquiring-the-create_invoice-tool" title="Permanent link">&para;</a></h3>
<p>The final tool is the <code>create_invoice</code> tool.
The tool takes the customer's email and trip information such as the cost of the flight, the description of the event, the number of days until the invoice is due, and generates a sample invoice for that user showing the details of the flight and the cost.
The LLM will use this tool to invoice the customer once the customer has confirmed their travel plans.
This tool can either use the <a href="#optional">Stripe API</a> if you have an API key configured in your <code>.env</code> file, or it will generate a mock invoice if it is unable to detect an API key.</p>
<p>First, change directories into the <code>tools</code> directory again:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>cd tools
</span></code></pre></div>
<p>Then get the tool by running the following command to download it from the <a href="https://github.com/temporal-community/tutorial-temporal-ai-agent">companion GitHub repository</a>:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>curl -o create_invoice.py https://raw.githubusercontent.com/temporal-community/tutorial-temporal-ai-agent/main/tools/create_invoice.py
</span></code></pre></div>
<p>Next, familiarize yourself with the tool by reviewing the code.
Try to answer the following questions about the code:
* What customer related verification does the tool do before creating the invoice?
* What does the tool do if this verification fails?</p>
<p>Once you have finished reviewing the code, test it.</p>
<p>Create another test within the <code>scripts</code> directory named <code>create_invoice_test.py</code> and add the following code:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tools.create_invoice</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_invoice</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>    <span class="n">args_create</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;ziggy.tardigrade@example.com&quot;</span><span class="p">,</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>        <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="mf">150.00</span><span class="p">,</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Flight to Replay&quot;</span><span class="p">,</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>        <span class="s2">&quot;days_until_due&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>    <span class="p">}</span>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>    <span class="n">invoice_details</span> <span class="o">=</span> <span class="n">create_invoice</span><span class="p">(</span><span class="n">args_create</span><span class="p">)</span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">invoice_details</span><span class="p">)</span>
</span></code></pre></div>
<p>However, since this tool can operate in either a mock mode or live API mode, there are two ways to verify it.</p>
<h4 id="testing-the-mocked-create_invoice-tool">Testing the mocked <code>create_invoice</code> tool<a class="headerlink" href="#testing-the-mocked-create_invoice-tool" title="Permanent link">&para;</a></h4>
<p>Start by testing it without the Stripe key. 
If you have it set in your <code>.env</code> file, comment it out for now, or skip this step.</p>
<p>Change directories back to the root project directory and run the test using the following command:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>cd ..
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>uv run scripts/create_invoice_test.py
</span></code></pre></div>
<p>The output should be:</p>
<div class="language-output highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="go">[CreateInvoice] Creating invoice with: {&#39;email&#39;: &#39;ziggy.tardigrade@example.com&#39;, &#39;amount&#39;: 150.0, &#39;description&#39;: &#39;Flight to Replay&#39;, &#39;days_until_due&#39;: 7}</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="go">{&#39;invoiceStatus&#39;: &#39;generated&#39;, &#39;invoiceURL&#39;: &#39;https://pay.example.com/invoice/12345&#39;, &#39;reference&#39;: &#39;INV-12345&#39;}</span>
</span></code></pre></div>
<p>If you aren't planning on using the Stripe API, you can skip this next step and continue if you'd like.</p>
<h4 id="testing-the-stripe-powered-create_invoice-tool">Testing the Stripe-powered <code>create_invoice</code> tool<a class="headerlink" href="#testing-the-stripe-powered-create_invoice-tool" title="Permanent link">&para;</a></h4>
<p>Testing the Stripe powered version of the tool is nearly identical to testing the mocked version of the tool.</p>
<p>First, if you haven't uncommented the <code>STRIPE_API_KEY</code> lines in your <code>.env</code> file and added your API key, do this before running the test.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="nv">STRIPE_API_KEY</span><span class="o">=</span>YOUR_STRIPE_API_KEY
</span></code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Make sure you have set up your Stripe account as a <a href="https://docs.stripe.com/sandboxes">sandbox</a> and are using an API key from there. If it is your first time setting up a Stripe account and you haven't added any billing information, this will be the default.
Otherwise the invoices will be real.</p>
</div>
<p>Make sure you aren't in the <code>scripts</code> directory any more.
If you are, run the following command to get back to the root directory of the project:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>cd ..
</span></code></pre></div>
<p>Then run the test using the following command the same way you would the mocked version:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>uv run scripts/create_invoice_test.py
</span></code></pre></div>
<p>The result will contain an <code>invoiceURL</code>, as well as the status of the invoice and a reference.</p>
<div class="language-output highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="go">{&#39;invoiceStatus&#39;: &#39;open&#39;, &#39;invoiceURL&#39;: &#39;https://invoice.stripe.com/i/acct_1RMFbIQej3CO0i8K/test_YWNjdF8xUk1GYklRZWozQ08wThLLF9TVJpYWZ2WXREVXZrcDJqMGhIM0hSdkVEa2hVYmM0LDE0MTI2NjEwNg0200VaZpBdSc?s=ap&#39;, &#39;reference&#39;: &#39;FEUS4MXS-0001&#39;}</span>
</span></code></pre></div>
<p>By following that invoice link in a browser, Stripe will present you with a sample invoice in your sandbox environment. </p>
<details>

<summary>
Before you move on, verify that you have created all the necessary files in the correct structure.
</summary>

So far you've implemented and tested the agents tools.
Verify your directory structure and files look and are named appropriately according to the following diagram before continuing:

<div class="language-text highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>temporal-ai-agent/
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>├── .env
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>├── .gitignore
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>├── .python-version
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>├── README.md
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>├── pyproject.toml
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>├── uv.lock
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>├── scripts/
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a>│   ├── create_invoice_test.py
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>│   ├── find_events_test.py
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a>│   └── search_flights_test.py
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a>└── tools/
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a>    ├── __init__.py
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a>    ├── create_invoice.py
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a>    ├── find_events.py
</span><span id="__span-42-16"><a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a>    ├── search_flights.py
</span><span id="__span-42-17"><a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a>    └── data/
</span><span id="__span-42-18"><a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a>        └── find_events_data.json
</span></code></pre></div>
</details>

<p>And those are the three tools in this agent's toolkit to achieve its goal.
Other goals may have different tools, and you could add more tools.
Next, you'll make the tools available to the agent to use.</p>
<h2 id="exposing-the-tools-to-the-agent">Exposing the tools to the agent<a class="headerlink" href="#exposing-the-tools-to-the-agent" title="Permanent link">&para;</a></h2>
<p>Now that you have the tools necessary to complete the agent's goal, you need to implement a way to inform the agent that these tools are available.
To do this, you'll create a tool registry. 
The tool registry will contain a definition of each tool, along with information such as the tool's name, description, and what arguments it accepts. </p>
<p>However, before you create the registry, you should define the tool definition and tool argument as models that can be shared across your codebase.</p>
<h3 id="defining-the-core-models">Defining the core models<a class="headerlink" href="#defining-the-core-models" title="Permanent link">&para;</a></h3>
<p>Defining the tool arguments, tool definition, and agent goal as custom types allows for better reusability and type hinting.
Temporal also recommends passing a single object between functions, and requires these objects to be serializable.
Given these requirements, you'll implement the <code>ToolArgument</code> and <code>ToolDefinition</code> types as a Python <code>dataclass</code>.</p>
<p>Before you define these models, navigate to the root directory of your project and create the <code>models</code> directory:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>mkdir models
</span></code></pre></div>
<p>Since this directory will be imported throughout your project, it needs to be configured as a module.
To do this, create a blank <code>__init__.py</code> file by running the following command:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>touch models/__init__.py
</span></code></pre></div>
<p>Next, create the file <code>core.py</code>. This file will contain the tool argument and definition models used to in your agent. 
Open <code>models/core.py</code> and add the following imports:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
</span></code></pre></div>
<p>Next, add the <code>ToolArgument</code> <code>dataclass</code> to the file:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="nd">@dataclass</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">ToolArgument</span><span class="p">:</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span></code></pre></div>
<p>An instance of this <code>dataclass</code> will represent an argument that your tool can accept, including the name of the argument, a description of what the argument represents, and the type of the argument, such as an <code>int</code> or <code>str</code>. </p>
<p>Next, add the <code>ToolDefinition</code> <code>dataclass</code> to the file:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="nd">@dataclass</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">ToolDefinition</span><span class="p">:</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>    <span class="n">arguments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolArgument</span><span class="p">]</span>
</span></code></pre></div>
<p>This will hold information about the tool that's provided to the agent so it can determine what action to take.
It defines the name of the tool, a description of what the can do, and an argument list. This list is composed of your <code>ToolArgument</code> objects.</p>
<p>Now that you have the appropriate model to define your tools, you can create a registry of the tools for the agent to access.</p>
<h3 id="creating-the-tool-registry">Creating the tool registry<a class="headerlink" href="#creating-the-tool-registry" title="Permanent link">&para;</a></h3>
<p>Agents use LLMs to determine what action to take and then execute a tool from their toolkit.
However, you have to make those tools available to the agent.
Now that you have structure for defining your tools, you should create a registry that your agent reads to load the available tools.</p>
<p>Navigate back to the <code>tools</code> directory and create the file <code>tools/tool_registry.py</code>.
In this file you will define all of your tools using the models you defined in the previous step.</p>
<p>First, add the following import to the file to import the models:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolArgument</span><span class="p">,</span> <span class="n">ToolDefinition</span>
</span></code></pre></div>
<p>Next, add the first part of the <code>ToolDefinition</code> for the <code>find_events</code> tool:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="n">find_events_tool</span> <span class="o">=</span> <span class="n">ToolDefinition</span><span class="p">(</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;FindEvents&quot;</span><span class="p">,</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Find upcoming events to travel to a given city (e.g., &#39;New York City&#39;) and a date or month. &quot;</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>    <span class="s2">&quot;It knows about events in North America only (e.g. major North American cities). &quot;</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>    <span class="s2">&quot;It will search 1 month either side of the month provided. &quot;</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a>    <span class="s2">&quot;Returns a list of events. &quot;</span><span class="p">,</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>    <span class="c1"># arguments to be inserted here in the next step</span>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="p">)</span>
</span></code></pre></div>
<p>This defines your tool using the <code>ToolDefinition</code> model you defined, gives it a name and a description that the LLM can use to understand the tool and also use as a prompt.
Next you need to add the arguments to this instantiation.
The arguments in the <code>ToolDefinition</code> model were defined as a <code>List[ToolArgument]</code>, so you may have multiple arguments within your list.</p>
<p>To complete the definition, add the following code to your <code>find_events_tool</code> instantiation to add the arguments:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>    <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;city&quot;</span><span class="p">,</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Which city to search for events&quot;</span><span class="p">,</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>        <span class="p">),</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">,</span>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The month to search for events (will search 1 month either side of the month provided)&quot;</span><span class="p">,</span>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a>        <span class="p">),</span>
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a>    <span class="p">]</span>
</span></code></pre></div>
<p>The <code>find_events</code> tool requires two arguments, the city and month in which to search, and it also provides a string description so the LLM would know how to prompt the user if an argument is missing.</p>
<p>Bringing it all together, the complete <code>ToolDefinition</code> would be:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="n">find_events_tool</span> <span class="o">=</span> <span class="n">ToolDefinition</span><span class="p">(</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;FindEvents&quot;</span><span class="p">,</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Find upcoming events to travel to a given city (e.g., &#39;New York City&#39;) and a date or month. &quot;</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>    <span class="s2">&quot;It knows about events in North America only (e.g. major North American cities). &quot;</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>    <span class="s2">&quot;It will search 1 month either side of the month provided. &quot;</span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>    <span class="s2">&quot;Returns a list of events. &quot;</span><span class="p">,</span>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>    <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;city&quot;</span><span class="p">,</span>
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Which city to search for events&quot;</span><span class="p">,</span>
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a>        <span class="p">),</span>
</span><span id="__span-51-13"><a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-51-14"><a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">,</span>
</span><span id="__span-51-15"><a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="__span-51-16"><a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The month to search for events (will search 1 month either side of the month provided)&quot;</span><span class="p">,</span>
</span><span id="__span-51-17"><a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a>        <span class="p">),</span>
</span><span id="__span-51-18"><a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a>    <span class="p">],</span>
</span><span id="__span-51-19"><a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a><span class="p">)</span>
</span></code></pre></div>
<p>Now that you have the first tool defined in your registry, implement the remaining tool definitions. </p>
<p>Add the following code to register the <code>search_flights</code> tool. 
The structure is similar to the <code>find_events</code> tool, except that <code>search_flights</code> requires more arguments, to search for the origin, destination, departure date, return date, and confirmation status.
These arguments are a direct mapping of the required parameters to the RAPIDAPI REST API.
When creating a tool that maps to an API, be sure to include that APIs required parameters as <code>ToolArgument</code>s.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="n">search_flights_tool</span> <span class="o">=</span> <span class="n">ToolDefinition</span><span class="p">(</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;SearchFlights&quot;</span><span class="p">,</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Search for return flights from an origin to a destination within a date range (dateDepart, dateReturn). &quot;</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>    <span class="s2">&quot;You are allowed to suggest dates from the conversation history, but ALWAYS ask the user if ok.&quot;</span><span class="p">,</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>    <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;origin&quot;</span><span class="p">,</span>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="__span-52-9"><a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Airport or city (infer airport code from city and store)&quot;</span><span class="p">,</span>
</span><span id="__span-52-10"><a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a>        <span class="p">),</span>
</span><span id="__span-52-11"><a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-52-12"><a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;destination&quot;</span><span class="p">,</span>
</span><span id="__span-52-13"><a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="__span-52-14"><a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Airport or city code for arrival (infer airport code from city and store)&quot;</span><span class="p">,</span>
</span><span id="__span-52-15"><a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a>        <span class="p">),</span>
</span><span id="__span-52-16"><a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-52-17"><a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dateDepart&quot;</span><span class="p">,</span>
</span><span id="__span-52-18"><a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;ISO8601&quot;</span><span class="p">,</span>
</span><span id="__span-52-19"><a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Start of date range in human readable format, when you want to depart&quot;</span><span class="p">,</span>
</span><span id="__span-52-20"><a id="__codelineno-52-20" name="__codelineno-52-20" href="#__codelineno-52-20"></a>        <span class="p">),</span>
</span><span id="__span-52-21"><a id="__codelineno-52-21" name="__codelineno-52-21" href="#__codelineno-52-21"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-52-22"><a id="__codelineno-52-22" name="__codelineno-52-22" href="#__codelineno-52-22"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dateReturn&quot;</span><span class="p">,</span>
</span><span id="__span-52-23"><a id="__codelineno-52-23" name="__codelineno-52-23" href="#__codelineno-52-23"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;ISO8601&quot;</span><span class="p">,</span>
</span><span id="__span-52-24"><a id="__codelineno-52-24" name="__codelineno-52-24" href="#__codelineno-52-24"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;End of date range in human readable format, when you want to return&quot;</span><span class="p">,</span>
</span><span id="__span-52-25"><a id="__codelineno-52-25" name="__codelineno-52-25" href="#__codelineno-52-25"></a>        <span class="p">),</span>
</span><span id="__span-52-26"><a id="__codelineno-52-26" name="__codelineno-52-26" href="#__codelineno-52-26"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-52-27"><a id="__codelineno-52-27" name="__codelineno-52-27" href="#__codelineno-52-27"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;userConfirmation&quot;</span><span class="p">,</span>
</span><span id="__span-52-28"><a id="__codelineno-52-28" name="__codelineno-52-28" href="#__codelineno-52-28"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="__span-52-29"><a id="__codelineno-52-29" name="__codelineno-52-29" href="#__codelineno-52-29"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Indication of the user&#39;s desire to search flights, and to confirm the details &quot;</span>
</span><span id="__span-52-30"><a id="__codelineno-52-30" name="__codelineno-52-30" href="#__codelineno-52-30"></a>            <span class="o">+</span> <span class="s2">&quot;before moving on to the next step&quot;</span><span class="p">,</span>
</span><span id="__span-52-31"><a id="__codelineno-52-31" name="__codelineno-52-31" href="#__codelineno-52-31"></a>        <span class="p">),</span>
</span><span id="__span-52-32"><a id="__codelineno-52-32" name="__codelineno-52-32" href="#__codelineno-52-32"></a>    <span class="p">],</span>
</span><span id="__span-52-33"><a id="__codelineno-52-33" name="__codelineno-52-33" href="#__codelineno-52-33"></a><span class="p">)</span>
</span></code></pre></div>
<p>And then add the following code to register the <code>create_invoice</code> tool. 
This tool requires three arguments: the amount to be paid, the details of the trip, and a user confirmation.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="n">create_invoice_tool</span> <span class="o">=</span> <span class="n">ToolDefinition</span><span class="p">(</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CreateInvoice&quot;</span><span class="p">,</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Generate an invoice for the items described for the total inferred by the conversation history so far. Returns URL to invoice.&quot;</span><span class="p">,</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>    <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;amount&quot;</span><span class="p">,</span>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">,</span>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The total cost to be invoiced. Infer this from the conversation history.&quot;</span><span class="p">,</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>        <span class="p">),</span>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;tripDetails&quot;</span><span class="p">,</span>
</span><span id="__span-53-12"><a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="__span-53-13"><a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A description of the item details to be invoiced, inferred from the conversation history.&quot;</span><span class="p">,</span>
</span><span id="__span-53-14"><a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a>        <span class="p">),</span>
</span><span id="__span-53-15"><a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-53-16"><a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;userConfirmation&quot;</span><span class="p">,</span>
</span><span id="__span-53-17"><a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="__span-53-18"><a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Indication of user&#39;s desire to create an invoice&quot;</span><span class="p">,</span>
</span><span id="__span-53-19"><a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a>        <span class="p">),</span>
</span><span id="__span-53-20"><a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a>    <span class="p">],</span>
</span><span id="__span-53-21"><a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a><span class="p">)</span>
</span></code></pre></div>
<p>You now have a tool registry your agent imports to inform it of what tools it has available to execute.
Finally, you need to create a mapping between the tool registered in <code>tool_registry.py</code> with the actual functions the Activity will invoke during Workflow execution.</p>
<h3 id="mapping-the-registry-to-the-functions">Mapping the registry to the functions<a class="headerlink" href="#mapping-the-registry-to-the-functions" title="Permanent link">&para;</a></h3>
<p>Your agent will use the registry to identify which tool it should use, but it still needs to translate the string <code>name</code> of the tool to the function definition the code will execute.
You will modify the code in <code>tool_registry</code> to add this functionality.</p>
<p>First, add the following imports with the other imports in <code>tool_registry.py</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tools.create_invoice</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_invoice</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tools.find_events</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_events</span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tools.search_flights</span><span class="w"> </span><span class="kn">import</span> <span class="n">search_flights</span>
</span></code></pre></div>
<p>These handle the appropriate typings, as well as import the function from each of the tool files.</p>
<p>Next, go to the bottom of the file after the previous tool definitions and add the code to map the string representation of the <code>ToolDefinition</code> to the function:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c1"># Dictionary mapping tool names to their handler functions</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="n">TOOL_HANDLERS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>    <span class="s2">&quot;SearchFlights&quot;</span><span class="p">:</span> <span class="n">search_flights</span><span class="p">,</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>    <span class="s2">&quot;CreateInvoice&quot;</span><span class="p">:</span> <span class="n">create_invoice</span><span class="p">,</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a>    <span class="s2">&quot;FindEvents&quot;</span><span class="p">:</span> <span class="n">find_events</span><span class="p">,</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="p">}</span>
</span></code></pre></div>
<p>Finally, add a function named <code>get_handler</code> that returns the function given the tool name:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_handler</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the handler function for a given tool name.</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="sd">    Args:</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="sd">        tool_name: The name of the tool to get the handler for.</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="sd">    Returns:</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="sd">        The handler function for the specified tool.</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="sd">    Raises:</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a><span class="sd">        ValueError: If the tool name is not found in the registry.</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12" href="#__codelineno-56-12"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13" href="#__codelineno-56-13"></a>    <span class="k">if</span> <span class="n">tool_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TOOL_HANDLERS</span><span class="p">:</span>
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14" href="#__codelineno-56-14"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tool: </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-56-15"><a id="__codelineno-56-15" name="__codelineno-56-15" href="#__codelineno-56-15"></a>
</span><span id="__span-56-16"><a id="__codelineno-56-16" name="__codelineno-56-16" href="#__codelineno-56-16"></a>    <span class="k">return</span> <span class="n">TOOL_HANDLERS</span><span class="p">[</span><span class="n">tool_name</span><span class="p">]</span>
</span></code></pre></div>
<p>You have now successfully implemented a structured model for expressing tools available to your AI agent. 
This is necessary for building a robust, capable agent.</p>
<details>

<summary>
The <code>tools/tool_registry.py</code> is complete and will need no more revisions. You can review the complete file and copy the code here.
</summary>

[tools/tool_registry](https://github.com/temporal-community/tutorial-temporal-ai-agent/blob/main/tools/tool_registry.py)

<div class="language-python highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolArgument</span><span class="p">,</span> <span class="n">ToolDefinition</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tools.create_invoice</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_invoice</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tools.find_events</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_events</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tools.search_flights</span><span class="w"> </span><span class="kn">import</span> <span class="n">search_flights</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="n">find_events_tool</span> <span class="o">=</span> <span class="n">ToolDefinition</span><span class="p">(</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;FindEvents&quot;</span><span class="p">,</span>
</span><span id="__span-57-10"><a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Find upcoming events to travel to a given city (e.g., &#39;New York City&#39;) and a date or month. &quot;</span>
</span><span id="__span-57-11"><a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a>    <span class="s2">&quot;It knows about events in North America only (e.g. major North American cities). &quot;</span>
</span><span id="__span-57-12"><a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a>    <span class="s2">&quot;It will search 1 month either side of the month provided. &quot;</span>
</span><span id="__span-57-13"><a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a>    <span class="s2">&quot;Returns a list of events. &quot;</span><span class="p">,</span>
</span><span id="__span-57-14"><a id="__codelineno-57-14" name="__codelineno-57-14" href="#__codelineno-57-14"></a>    <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-57-15"><a id="__codelineno-57-15" name="__codelineno-57-15" href="#__codelineno-57-15"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-57-16"><a id="__codelineno-57-16" name="__codelineno-57-16" href="#__codelineno-57-16"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;city&quot;</span><span class="p">,</span>
</span><span id="__span-57-17"><a id="__codelineno-57-17" name="__codelineno-57-17" href="#__codelineno-57-17"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="__span-57-18"><a id="__codelineno-57-18" name="__codelineno-57-18" href="#__codelineno-57-18"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Which city to search for events&quot;</span><span class="p">,</span>
</span><span id="__span-57-19"><a id="__codelineno-57-19" name="__codelineno-57-19" href="#__codelineno-57-19"></a>        <span class="p">),</span>
</span><span id="__span-57-20"><a id="__codelineno-57-20" name="__codelineno-57-20" href="#__codelineno-57-20"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-57-21"><a id="__codelineno-57-21" name="__codelineno-57-21" href="#__codelineno-57-21"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">,</span>
</span><span id="__span-57-22"><a id="__codelineno-57-22" name="__codelineno-57-22" href="#__codelineno-57-22"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="__span-57-23"><a id="__codelineno-57-23" name="__codelineno-57-23" href="#__codelineno-57-23"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The month to search for events (will search 1 month either side of the month provided)&quot;</span><span class="p">,</span>
</span><span id="__span-57-24"><a id="__codelineno-57-24" name="__codelineno-57-24" href="#__codelineno-57-24"></a>        <span class="p">),</span>
</span><span id="__span-57-25"><a id="__codelineno-57-25" name="__codelineno-57-25" href="#__codelineno-57-25"></a>    <span class="p">],</span>
</span><span id="__span-57-26"><a id="__codelineno-57-26" name="__codelineno-57-26" href="#__codelineno-57-26"></a><span class="p">)</span>
</span><span id="__span-57-27"><a id="__codelineno-57-27" name="__codelineno-57-27" href="#__codelineno-57-27"></a>
</span><span id="__span-57-28"><a id="__codelineno-57-28" name="__codelineno-57-28" href="#__codelineno-57-28"></a>
</span><span id="__span-57-29"><a id="__codelineno-57-29" name="__codelineno-57-29" href="#__codelineno-57-29"></a><span class="n">search_flights_tool</span> <span class="o">=</span> <span class="n">ToolDefinition</span><span class="p">(</span>
</span><span id="__span-57-30"><a id="__codelineno-57-30" name="__codelineno-57-30" href="#__codelineno-57-30"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;SearchFlights&quot;</span><span class="p">,</span>
</span><span id="__span-57-31"><a id="__codelineno-57-31" name="__codelineno-57-31" href="#__codelineno-57-31"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Search for return flights from an origin to a destination within a date range (dateDepart, dateReturn). &quot;</span>
</span><span id="__span-57-32"><a id="__codelineno-57-32" name="__codelineno-57-32" href="#__codelineno-57-32"></a>    <span class="s2">&quot;You are allowed to suggest dates from the conversation history, but ALWAYS ask the user if ok.&quot;</span><span class="p">,</span>
</span><span id="__span-57-33"><a id="__codelineno-57-33" name="__codelineno-57-33" href="#__codelineno-57-33"></a>    <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-57-34"><a id="__codelineno-57-34" name="__codelineno-57-34" href="#__codelineno-57-34"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-57-35"><a id="__codelineno-57-35" name="__codelineno-57-35" href="#__codelineno-57-35"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;origin&quot;</span><span class="p">,</span>
</span><span id="__span-57-36"><a id="__codelineno-57-36" name="__codelineno-57-36" href="#__codelineno-57-36"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="__span-57-37"><a id="__codelineno-57-37" name="__codelineno-57-37" href="#__codelineno-57-37"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Airport or city (infer airport code from city and store)&quot;</span><span class="p">,</span>
</span><span id="__span-57-38"><a id="__codelineno-57-38" name="__codelineno-57-38" href="#__codelineno-57-38"></a>        <span class="p">),</span>
</span><span id="__span-57-39"><a id="__codelineno-57-39" name="__codelineno-57-39" href="#__codelineno-57-39"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-57-40"><a id="__codelineno-57-40" name="__codelineno-57-40" href="#__codelineno-57-40"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;destination&quot;</span><span class="p">,</span>
</span><span id="__span-57-41"><a id="__codelineno-57-41" name="__codelineno-57-41" href="#__codelineno-57-41"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="__span-57-42"><a id="__codelineno-57-42" name="__codelineno-57-42" href="#__codelineno-57-42"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Airport or city code for arrival (infer airport code from city and store)&quot;</span><span class="p">,</span>
</span><span id="__span-57-43"><a id="__codelineno-57-43" name="__codelineno-57-43" href="#__codelineno-57-43"></a>        <span class="p">),</span>
</span><span id="__span-57-44"><a id="__codelineno-57-44" name="__codelineno-57-44" href="#__codelineno-57-44"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-57-45"><a id="__codelineno-57-45" name="__codelineno-57-45" href="#__codelineno-57-45"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dateDepart&quot;</span><span class="p">,</span>
</span><span id="__span-57-46"><a id="__codelineno-57-46" name="__codelineno-57-46" href="#__codelineno-57-46"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;ISO8601&quot;</span><span class="p">,</span>
</span><span id="__span-57-47"><a id="__codelineno-57-47" name="__codelineno-57-47" href="#__codelineno-57-47"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Start of date range in human readable format, when you want to depart&quot;</span><span class="p">,</span>
</span><span id="__span-57-48"><a id="__codelineno-57-48" name="__codelineno-57-48" href="#__codelineno-57-48"></a>        <span class="p">),</span>
</span><span id="__span-57-49"><a id="__codelineno-57-49" name="__codelineno-57-49" href="#__codelineno-57-49"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-57-50"><a id="__codelineno-57-50" name="__codelineno-57-50" href="#__codelineno-57-50"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dateReturn&quot;</span><span class="p">,</span>
</span><span id="__span-57-51"><a id="__codelineno-57-51" name="__codelineno-57-51" href="#__codelineno-57-51"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;ISO8601&quot;</span><span class="p">,</span>
</span><span id="__span-57-52"><a id="__codelineno-57-52" name="__codelineno-57-52" href="#__codelineno-57-52"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;End of date range in human readable format, when you want to return&quot;</span><span class="p">,</span>
</span><span id="__span-57-53"><a id="__codelineno-57-53" name="__codelineno-57-53" href="#__codelineno-57-53"></a>        <span class="p">),</span>
</span><span id="__span-57-54"><a id="__codelineno-57-54" name="__codelineno-57-54" href="#__codelineno-57-54"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-57-55"><a id="__codelineno-57-55" name="__codelineno-57-55" href="#__codelineno-57-55"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;userConfirmation&quot;</span><span class="p">,</span>
</span><span id="__span-57-56"><a id="__codelineno-57-56" name="__codelineno-57-56" href="#__codelineno-57-56"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="__span-57-57"><a id="__codelineno-57-57" name="__codelineno-57-57" href="#__codelineno-57-57"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Indication of the user&#39;s desire to search flights, and to confirm the details &quot;</span>
</span><span id="__span-57-58"><a id="__codelineno-57-58" name="__codelineno-57-58" href="#__codelineno-57-58"></a>            <span class="o">+</span> <span class="s2">&quot;before moving on to the next step&quot;</span><span class="p">,</span>
</span><span id="__span-57-59"><a id="__codelineno-57-59" name="__codelineno-57-59" href="#__codelineno-57-59"></a>        <span class="p">),</span>
</span><span id="__span-57-60"><a id="__codelineno-57-60" name="__codelineno-57-60" href="#__codelineno-57-60"></a>    <span class="p">],</span>
</span><span id="__span-57-61"><a id="__codelineno-57-61" name="__codelineno-57-61" href="#__codelineno-57-61"></a><span class="p">)</span>
</span><span id="__span-57-62"><a id="__codelineno-57-62" name="__codelineno-57-62" href="#__codelineno-57-62"></a>
</span><span id="__span-57-63"><a id="__codelineno-57-63" name="__codelineno-57-63" href="#__codelineno-57-63"></a><span class="n">create_invoice_tool</span> <span class="o">=</span> <span class="n">ToolDefinition</span><span class="p">(</span>
</span><span id="__span-57-64"><a id="__codelineno-57-64" name="__codelineno-57-64" href="#__codelineno-57-64"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;CreateInvoice&quot;</span><span class="p">,</span>
</span><span id="__span-57-65"><a id="__codelineno-57-65" name="__codelineno-57-65" href="#__codelineno-57-65"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Generate an invoice for the items described for the total inferred by the conversation history so far. Returns URL to invoice.&quot;</span><span class="p">,</span>
</span><span id="__span-57-66"><a id="__codelineno-57-66" name="__codelineno-57-66" href="#__codelineno-57-66"></a>    <span class="n">arguments</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-57-67"><a id="__codelineno-57-67" name="__codelineno-57-67" href="#__codelineno-57-67"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-57-68"><a id="__codelineno-57-68" name="__codelineno-57-68" href="#__codelineno-57-68"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;amount&quot;</span><span class="p">,</span>
</span><span id="__span-57-69"><a id="__codelineno-57-69" name="__codelineno-57-69" href="#__codelineno-57-69"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">,</span>
</span><span id="__span-57-70"><a id="__codelineno-57-70" name="__codelineno-57-70" href="#__codelineno-57-70"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The total cost to be invoiced. Infer this from the conversation history.&quot;</span><span class="p">,</span>
</span><span id="__span-57-71"><a id="__codelineno-57-71" name="__codelineno-57-71" href="#__codelineno-57-71"></a>        <span class="p">),</span>
</span><span id="__span-57-72"><a id="__codelineno-57-72" name="__codelineno-57-72" href="#__codelineno-57-72"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-57-73"><a id="__codelineno-57-73" name="__codelineno-57-73" href="#__codelineno-57-73"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;tripDetails&quot;</span><span class="p">,</span>
</span><span id="__span-57-74"><a id="__codelineno-57-74" name="__codelineno-57-74" href="#__codelineno-57-74"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="__span-57-75"><a id="__codelineno-57-75" name="__codelineno-57-75" href="#__codelineno-57-75"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A description of the item details to be invoiced, inferred from the conversation history.&quot;</span><span class="p">,</span>
</span><span id="__span-57-76"><a id="__codelineno-57-76" name="__codelineno-57-76" href="#__codelineno-57-76"></a>        <span class="p">),</span>
</span><span id="__span-57-77"><a id="__codelineno-57-77" name="__codelineno-57-77" href="#__codelineno-57-77"></a>        <span class="n">ToolArgument</span><span class="p">(</span>
</span><span id="__span-57-78"><a id="__codelineno-57-78" name="__codelineno-57-78" href="#__codelineno-57-78"></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;userConfirmation&quot;</span><span class="p">,</span>
</span><span id="__span-57-79"><a id="__codelineno-57-79" name="__codelineno-57-79" href="#__codelineno-57-79"></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;string&quot;</span><span class="p">,</span>
</span><span id="__span-57-80"><a id="__codelineno-57-80" name="__codelineno-57-80" href="#__codelineno-57-80"></a>            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Indication of user&#39;s desire to create an invoice&quot;</span><span class="p">,</span>
</span><span id="__span-57-81"><a id="__codelineno-57-81" name="__codelineno-57-81" href="#__codelineno-57-81"></a>        <span class="p">),</span>
</span><span id="__span-57-82"><a id="__codelineno-57-82" name="__codelineno-57-82" href="#__codelineno-57-82"></a>    <span class="p">],</span>
</span><span id="__span-57-83"><a id="__codelineno-57-83" name="__codelineno-57-83" href="#__codelineno-57-83"></a><span class="p">)</span>
</span><span id="__span-57-84"><a id="__codelineno-57-84" name="__codelineno-57-84" href="#__codelineno-57-84"></a>
</span><span id="__span-57-85"><a id="__codelineno-57-85" name="__codelineno-57-85" href="#__codelineno-57-85"></a>
</span><span id="__span-57-86"><a id="__codelineno-57-86" name="__codelineno-57-86" href="#__codelineno-57-86"></a><span class="c1"># Dictionary mapping tool names to their handler functions</span>
</span><span id="__span-57-87"><a id="__codelineno-57-87" name="__codelineno-57-87" href="#__codelineno-57-87"></a><span class="n">TOOL_HANDLERS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-57-88"><a id="__codelineno-57-88" name="__codelineno-57-88" href="#__codelineno-57-88"></a>    <span class="s2">&quot;SearchFlights&quot;</span><span class="p">:</span> <span class="n">search_flights</span><span class="p">,</span>
</span><span id="__span-57-89"><a id="__codelineno-57-89" name="__codelineno-57-89" href="#__codelineno-57-89"></a>    <span class="s2">&quot;CreateInvoice&quot;</span><span class="p">:</span> <span class="n">create_invoice</span><span class="p">,</span>
</span><span id="__span-57-90"><a id="__codelineno-57-90" name="__codelineno-57-90" href="#__codelineno-57-90"></a>    <span class="s2">&quot;FindEvents&quot;</span><span class="p">:</span> <span class="n">find_events</span><span class="p">,</span>
</span><span id="__span-57-91"><a id="__codelineno-57-91" name="__codelineno-57-91" href="#__codelineno-57-91"></a><span class="p">}</span>
</span><span id="__span-57-92"><a id="__codelineno-57-92" name="__codelineno-57-92" href="#__codelineno-57-92"></a>
</span><span id="__span-57-93"><a id="__codelineno-57-93" name="__codelineno-57-93" href="#__codelineno-57-93"></a>
</span><span id="__span-57-94"><a id="__codelineno-57-94" name="__codelineno-57-94" href="#__codelineno-57-94"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_handler</span><span class="p">(</span><span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="__span-57-95"><a id="__codelineno-57-95" name="__codelineno-57-95" href="#__codelineno-57-95"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the handler function for a given tool name.</span>
</span><span id="__span-57-96"><a id="__codelineno-57-96" name="__codelineno-57-96" href="#__codelineno-57-96"></a>
</span><span id="__span-57-97"><a id="__codelineno-57-97" name="__codelineno-57-97" href="#__codelineno-57-97"></a><span class="sd">    Args:</span>
</span><span id="__span-57-98"><a id="__codelineno-57-98" name="__codelineno-57-98" href="#__codelineno-57-98"></a><span class="sd">        tool_name: The name of the tool to get the handler for.</span>
</span><span id="__span-57-99"><a id="__codelineno-57-99" name="__codelineno-57-99" href="#__codelineno-57-99"></a>
</span><span id="__span-57-100"><a id="__codelineno-57-100" name="__codelineno-57-100" href="#__codelineno-57-100"></a><span class="sd">    Returns:</span>
</span><span id="__span-57-101"><a id="__codelineno-57-101" name="__codelineno-57-101" href="#__codelineno-57-101"></a><span class="sd">        The handler function for the specified tool.</span>
</span><span id="__span-57-102"><a id="__codelineno-57-102" name="__codelineno-57-102" href="#__codelineno-57-102"></a>
</span><span id="__span-57-103"><a id="__codelineno-57-103" name="__codelineno-57-103" href="#__codelineno-57-103"></a><span class="sd">    Raises:</span>
</span><span id="__span-57-104"><a id="__codelineno-57-104" name="__codelineno-57-104" href="#__codelineno-57-104"></a><span class="sd">        ValueError: If the tool name is not found in the registry.</span>
</span><span id="__span-57-105"><a id="__codelineno-57-105" name="__codelineno-57-105" href="#__codelineno-57-105"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-57-106"><a id="__codelineno-57-106" name="__codelineno-57-106" href="#__codelineno-57-106"></a>    <span class="k">if</span> <span class="n">tool_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TOOL_HANDLERS</span><span class="p">:</span>
</span><span id="__span-57-107"><a id="__codelineno-57-107" name="__codelineno-57-107" href="#__codelineno-57-107"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown tool: </span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-57-108"><a id="__codelineno-57-108" name="__codelineno-57-108" href="#__codelineno-57-108"></a>
</span><span id="__span-57-109"><a id="__codelineno-57-109" name="__codelineno-57-109" href="#__codelineno-57-109"></a>    <span class="k">return</span> <span class="n">TOOL_HANDLERS</span><span class="p">[</span><span class="n">tool_name</span><span class="p">]</span>
</span></code></pre></div>
</details>

<details>

<summary>
Before moving on to the next section, verify that your file and directory structure is correct.
</summary>

You just implemented a model for defining your tools in a way that your agent could discover and use them.
Verify that your directory structure and file names are correct according to the following diagram before continuing:

<div class="language-text highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>temporal-ai-agent/
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>├── .env
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>├── .gitignore
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>├── .python-version
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a>├── README.md
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>├── pyproject.toml
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a>├── uv.lock
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>├── models/
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a>│   ├── __init__.py
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a>│   └── core.py
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a>├── scripts/
</span><span id="__span-58-12"><a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a>│   ├── create_invoice_test.py
</span><span id="__span-58-13"><a id="__codelineno-58-13" name="__codelineno-58-13" href="#__codelineno-58-13"></a>│   ├── find_events_test.py
</span><span id="__span-58-14"><a id="__codelineno-58-14" name="__codelineno-58-14" href="#__codelineno-58-14"></a>│   └── search_flights_test.py
</span><span id="__span-58-15"><a id="__codelineno-58-15" name="__codelineno-58-15" href="#__codelineno-58-15"></a>└── tools/
</span><span id="__span-58-16"><a id="__codelineno-58-16" name="__codelineno-58-16" href="#__codelineno-58-16"></a>    ├── __init__.py
</span><span id="__span-58-17"><a id="__codelineno-58-17" name="__codelineno-58-17" href="#__codelineno-58-17"></a>    ├── create_invoice.py
</span><span id="__span-58-18"><a id="__codelineno-58-18" name="__codelineno-58-18" href="#__codelineno-58-18"></a>    ├── find_events.py
</span><span id="__span-58-19"><a id="__codelineno-58-19" name="__codelineno-58-19" href="#__codelineno-58-19"></a>    ├── search_flights.py
</span><span id="__span-58-20"><a id="__codelineno-58-20" name="__codelineno-58-20" href="#__codelineno-58-20"></a>    ├── tool_registry.py
</span><span id="__span-58-21"><a id="__codelineno-58-21" name="__codelineno-58-21" href="#__codelineno-58-21"></a>    └── data/
</span><span id="__span-58-22"><a id="__codelineno-58-22" name="__codelineno-58-22" href="#__codelineno-58-22"></a>        └── find_events_data.json
</span></code></pre></div>
</details>

<p>In the next step, you will use the tool definitions you just created to define the agent's goal. </p>
<h2 id="designating-the-agents-goal">Designating the agent's goal<a class="headerlink" href="#designating-the-agents-goal" title="Permanent link">&para;</a></h2>
<p>An agent's goal is the definition of the task it's trying to achieve.
It achieves this goal by executing tools, analyzing the results, and using an LLM to decide what to do next.
In this tutorial you will define the goal as a combination of several fields, including a description, a starter prompt, an example conversation history, and the list of tools the agent can use to achieve its goal.
Now that you've defined the <code>ToolDefinition</code> that will be available for your agent, you can define the <code>AgentGoal</code> type and create your agent's goal.</p>
<h3 id="defining-the-agentgoal-type">Defining the <code>AgentGoal</code> type<a class="headerlink" href="#defining-the-agentgoal-type" title="Permanent link">&para;</a></h3>
<p>To define the <code>AgentGoal</code> type, open <code>models/core.py</code> and add the following code:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="nd">@dataclass</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentGoal</span><span class="p">:</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>    <span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDefinition</span><span class="p">]</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a>    <span class="n">starter_prompt</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a>    <span class="n">example_conversation_history</span><span class="p">:</span> <span class="nb">str</span>
</span></code></pre></div>
<p>This <code>dataclass</code> defines your <code>AgentGoal</code> as a combination of a few attributes:
* <code>agent_name</code> - A human readable name for the agent
* <code>tools</code> - A list of tools, defined as <code>ToolDefinition</code> types, that the agent can use to achieve its goal
* <code>description</code> - A description of the goal, in a bulleted list format specifying how to achieve it.
* <code>starter_prompt</code> - A starter prompt for the AI agent to run
* <code>example_conversation_history</code> - A sample conversation history of what a successful interaction with this agent would look like</p>
<details>

<summary>
The <code>models/core.py</code> is complete and will need no more revisions. You can review the complete file and copy the code here.
</summary>

<br />
Hover your cursor over the code block to reveal the copy-code option.
<br />
<br />

[models/core.py](https://github.com/temporal-community/tutorial-temporal-ai-agent/blob/main/models/core.py)

<div class="language-python highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="nd">@dataclass</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">ToolArgument</span><span class="p">:</span>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a>    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-60-10"><a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a>
</span><span id="__span-60-11"><a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a>
</span><span id="__span-60-12"><a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="nd">@dataclass</span>
</span><span id="__span-60-13"><a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">ToolDefinition</span><span class="p">:</span>
</span><span id="__span-60-14"><a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-60-15"><a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-60-16"><a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a>    <span class="n">arguments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolArgument</span><span class="p">]</span>
</span><span id="__span-60-17"><a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a>
</span><span id="__span-60-18"><a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a>
</span><span id="__span-60-19"><a id="__codelineno-60-19" name="__codelineno-60-19" href="#__codelineno-60-19"></a><span class="nd">@dataclass</span>
</span><span id="__span-60-20"><a id="__codelineno-60-20" name="__codelineno-60-20" href="#__codelineno-60-20"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentGoal</span><span class="p">:</span>
</span><span id="__span-60-21"><a id="__codelineno-60-21" name="__codelineno-60-21" href="#__codelineno-60-21"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-60-22"><a id="__codelineno-60-22" name="__codelineno-60-22" href="#__codelineno-60-22"></a>    <span class="n">category_tag</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-60-23"><a id="__codelineno-60-23" name="__codelineno-60-23" href="#__codelineno-60-23"></a>    <span class="n">agent_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-60-24"><a id="__codelineno-60-24" name="__codelineno-60-24" href="#__codelineno-60-24"></a>    <span class="n">agent_friendly_description</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-60-25"><a id="__codelineno-60-25" name="__codelineno-60-25" href="#__codelineno-60-25"></a>    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ToolDefinition</span><span class="p">]</span>
</span><span id="__span-60-26"><a id="__codelineno-60-26" name="__codelineno-60-26" href="#__codelineno-60-26"></a>    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Description of the tools purpose and overall goal&quot;</span>
</span><span id="__span-60-27"><a id="__codelineno-60-27" name="__codelineno-60-27" href="#__codelineno-60-27"></a>    <span class="n">starter_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Initial prompt to start the conversation&quot;</span>
</span><span id="__span-60-28"><a id="__codelineno-60-28" name="__codelineno-60-28" href="#__codelineno-60-28"></a>    <span class="n">example_conversation_history</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-60-29"><a id="__codelineno-60-29" name="__codelineno-60-29" href="#__codelineno-60-29"></a>        <span class="s2">&quot;Example conversation history to help the AI agent understand the context of the conversation&quot;</span>
</span><span id="__span-60-30"><a id="__codelineno-60-30" name="__codelineno-60-30" href="#__codelineno-60-30"></a>    <span class="p">)</span>
</span></code></pre></div>
</details>

<p>Now that you have the type available to define the goal, you will implement the goal for your agent.</p>
<h3 id="implementing-the-goal-registry">Implementing the goal registry<a class="headerlink" href="#implementing-the-goal-registry" title="Permanent link">&para;</a></h3>
<p>Similar to implementing the <code>tool_registry</code>, next you will implement a <code>goal_registry</code> to define your agent's goal and make it available to the Workflow. 
You will do this by creating an instance of your <code>AgentGoal</code> type for every goal you wish to implement.
For this tutorial you will only implement a single goal, named <code>goal_event_flight_invoice</code>, but you may want to use this framework going forward to create your own agent goals at a later date.</p>
<p>To implement your agent's goal, create the file <code>tools/goal_registry.py</code> and add the following imports to the file:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">tools.tool_registry</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tool_registry</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentGoal</span>
</span></code></pre></div>
<p>To create the goal, first create an instance of the <code>AgentGoal</code> <code>dataclass</code> and add the first parameter, <code>agent_name</code>, to identify the goal:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="n">goal_event_flight_invoice</span> <span class="o">=</span> <span class="n">AgentGoal</span><span class="p">(</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>    <span class="n">agent_name</span><span class="o">=</span><span class="s2">&quot;North America Event Flight Booking&quot;</span><span class="p">,</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>    <span class="c1"># ...</span>
</span></code></pre></div>
<p>Next, pass in the <code>ToolDefnition</code>s that the agent is allowed to use to accomplish its goal to the <code>tools</code> parameter.
Add the following code as the next parameter:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a>    <span class="c1"># ...</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>    <span class="n">tools</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>        <span class="n">tool_registry</span><span class="o">.</span><span class="n">find_events_tool</span><span class="p">,</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a>        <span class="n">tool_registry</span><span class="o">.</span><span class="n">search_flights_tool</span><span class="p">,</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a>        <span class="n">tool_registry</span><span class="o">.</span><span class="n">create_invoice_tool</span><span class="p">,</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a>    <span class="p">],</span>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a>    <span class="c1"># ...</span>
</span></code></pre></div>
<p>The following parameter defines a detailed description of what the goal is and the ideal path for the agent to take to achieve its goal.
Add the following code to the file:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a>    <span class="c1"># ...</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Help the user gather args for these tools in order: &quot;</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>    <span class="s2">&quot;1. FindEvents: Find an event to travel to &quot;</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>    <span class="s2">&quot;2. SearchFlights: search for a flight around the event dates &quot;</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a>    <span class="s2">&quot;3. CreateInvoice: Create a simple invoice for the cost of that flight &quot;</span><span class="p">,</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>    <span class="c1"># ...</span>
</span></code></pre></div>
<p>The next parameter provides a starter prompt for the agent, detailing how it should begin its interaction with every user.
A starter prompt is the first prompt an agent sees, and gives the initial set of instructions.
Think of this an initialization function for the conversation.
A common format is to provide a greeting, explain your purpose, and prompt the user for information the agent needs to succeed.</p>
<p>Add the following code to define your prompt:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>    <span class="c1"># ...</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>    <span class="n">starter_prompt</span><span class="o">=</span><span class="s2">&quot;Welcome me, give me a description of what you can do, then ask me for the details you need to do your job.&quot;</span><span class="p">,</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>    <span class="c1"># ...</span>
</span></code></pre></div>
<p>Finally, draft an example conversation of a successful interaction with your agent to pass in.
LLMs perform better when they have an example of expected output, so providing this aids the LLM in its goal.
Since this is a <code>str</code> type, but the conversation is long, you will define each statement as a line in a list and then use <code>"\n ".join()</code> to create a string from your conversation.
Add the conversation as the final parameter.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>    <span class="c1"># ...</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>    <span class="n">example_conversation_history</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>        <span class="p">[</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>            <span class="s2">&quot;user: I&#39;d like to travel to an event&quot;</span><span class="p">,</span>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a>            <span class="s2">&quot;agent: Sure! Let&#39;s start by finding an event you&#39;d like to attend. I know about events in North American cities. Could you tell me which city and month you&#39;re interested in?&quot;</span><span class="p">,</span>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>            <span class="s2">&quot;user: nyc in may please&quot;</span><span class="p">,</span>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>            <span class="s2">&quot;agent: Great! Let&#39;s find an events in New York City in May.&quot;</span><span class="p">,</span>
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a>            <span class="s2">&quot;user_confirmed_tool_run: &lt;user clicks confirm on FindEvents tool&gt;&quot;</span><span class="p">,</span>
</span><span id="__span-66-9"><a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a>            <span class="s2">&quot;tool_result: { &#39;event_name&#39;: &#39;Frieze New York City&#39;, &#39;event_date&#39;: &#39;2023-05-01&#39; }&quot;</span><span class="p">,</span>
</span><span id="__span-66-10"><a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a>            <span class="s2">&quot;agent: Found an event! There&#39;s Frieze New York City on May 1 2025, ending on May 14 2025. Would you like to search for flights around these dates?&quot;</span><span class="p">,</span>
</span><span id="__span-66-11"><a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a>            <span class="s2">&quot;user: Yes, please&quot;</span><span class="p">,</span>
</span><span id="__span-66-12"><a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a>            <span class="s2">&quot;agent: Let&#39;s search for flights around these dates. Could you provide your departure city?&quot;</span><span class="p">,</span>
</span><span id="__span-66-13"><a id="__codelineno-66-13" name="__codelineno-66-13" href="#__codelineno-66-13"></a>            <span class="s2">&quot;user: San Francisco&quot;</span><span class="p">,</span>
</span><span id="__span-66-14"><a id="__codelineno-66-14" name="__codelineno-66-14" href="#__codelineno-66-14"></a>            <span class="s2">&quot;agent: Thanks, searching for flights from San Francisco to New York City around 2023-02-25 to 2023-02-28.&quot;</span><span class="p">,</span>
</span><span id="__span-66-15"><a id="__codelineno-66-15" name="__codelineno-66-15" href="#__codelineno-66-15"></a>            <span class="s2">&quot;user_confirmed_tool_run: &lt;user clicks confirm on SearchFlights tool&gt;&quot;</span>
</span><span id="__span-66-16"><a id="__codelineno-66-16" name="__codelineno-66-16" href="#__codelineno-66-16"></a>            <span class="s1">&#39;tool_result: results including {&quot;flight_number&quot;: &quot;AA101&quot;, &quot;return_flight_number&quot;: &quot;AA102&quot;, &quot;price&quot;: 850.0}&#39;</span><span class="p">,</span>
</span><span id="__span-66-17"><a id="__codelineno-66-17" name="__codelineno-66-17" href="#__codelineno-66-17"></a>            <span class="s2">&quot;agent: Found some flights! The cheapest is AA101 for $850. Would you like to generate an invoice for this flight?&quot;</span><span class="p">,</span>
</span><span id="__span-66-18"><a id="__codelineno-66-18" name="__codelineno-66-18" href="#__codelineno-66-18"></a>            <span class="s2">&quot;user_confirmed_tool_run: &lt;user clicks confirm on CreateInvoice tool&gt;&quot;</span><span class="p">,</span>
</span><span id="__span-66-19"><a id="__codelineno-66-19" name="__codelineno-66-19" href="#__codelineno-66-19"></a>            <span class="s1">&#39;tool_result: { &quot;status&quot;: &quot;success&quot;, &quot;invoice&quot;: { &quot;flight_number&quot;: &quot;AA101&quot;, &quot;amount&quot;: 850.0 }, invoiceURL: &quot;https://example.com/invoice&quot; }&#39;</span><span class="p">,</span>
</span><span id="__span-66-20"><a id="__codelineno-66-20" name="__codelineno-66-20" href="#__codelineno-66-20"></a>            <span class="s2">&quot;agent: Invoice generated! Here&#39;s the link: https://example.com/invoice&quot;</span><span class="p">,</span>
</span><span id="__span-66-21"><a id="__codelineno-66-21" name="__codelineno-66-21" href="#__codelineno-66-21"></a>        <span class="p">]</span>
</span><span id="__span-66-22"><a id="__codelineno-66-22" name="__codelineno-66-22" href="#__codelineno-66-22"></a>    <span class="p">),</span>
</span><span id="__span-66-23"><a id="__codelineno-66-23" name="__codelineno-66-23" href="#__codelineno-66-23"></a><span class="p">)</span>
</span></code></pre></div>
<details>

<summary>
The <code>tools/goal_registry.py</code> is complete and will need no more revisions. You can review the complete file and copy the code here.
</summary>

<br />
Hover your cursor over the code block to reveal the copy-code option.
<br />
<br />

[tools/goal_registry.py](https://github.com/temporal-community/tutorial-temporal-ai-agent/blob/main/tools/goal_registry.py)

<div class="language-python highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">tools.tool_registry</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tool_registry</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentGoal</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="n">goal_event_flight_invoice</span> <span class="o">=</span> <span class="n">AgentGoal</span><span class="p">(</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a>    <span class="n">agent_name</span><span class="o">=</span><span class="s2">&quot;North America Event Flight Booking&quot;</span><span class="p">,</span>
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a>    <span class="n">tools</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-67-7"><a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a>        <span class="n">tool_registry</span><span class="o">.</span><span class="n">find_events_tool</span><span class="p">,</span>
</span><span id="__span-67-8"><a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a>        <span class="n">tool_registry</span><span class="o">.</span><span class="n">search_flights_tool</span><span class="p">,</span>
</span><span id="__span-67-9"><a id="__codelineno-67-9" name="__codelineno-67-9" href="#__codelineno-67-9"></a>        <span class="n">tool_registry</span><span class="o">.</span><span class="n">create_invoice_tool</span><span class="p">,</span>
</span><span id="__span-67-10"><a id="__codelineno-67-10" name="__codelineno-67-10" href="#__codelineno-67-10"></a>    <span class="p">],</span>
</span><span id="__span-67-11"><a id="__codelineno-67-11" name="__codelineno-67-11" href="#__codelineno-67-11"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Help the user gather args for these tools in order: &quot;</span>
</span><span id="__span-67-12"><a id="__codelineno-67-12" name="__codelineno-67-12" href="#__codelineno-67-12"></a>    <span class="s2">&quot;1. FindEvents: Find an event to travel to &quot;</span>
</span><span id="__span-67-13"><a id="__codelineno-67-13" name="__codelineno-67-13" href="#__codelineno-67-13"></a>    <span class="s2">&quot;2. SearchFlights: search for a flight around the event dates &quot;</span>
</span><span id="__span-67-14"><a id="__codelineno-67-14" name="__codelineno-67-14" href="#__codelineno-67-14"></a>    <span class="s2">&quot;3. CreateInvoice: Create a simple invoice for the cost of that flight &quot;</span><span class="p">,</span>
</span><span id="__span-67-15"><a id="__codelineno-67-15" name="__codelineno-67-15" href="#__codelineno-67-15"></a>    <span class="n">starter_prompt</span><span class="o">=</span><span class="s2">&quot;Welcome me, give me a description of what you can do, then ask me for the details you need to do your job.&quot;</span><span class="p">,</span>
</span><span id="__span-67-16"><a id="__codelineno-67-16" name="__codelineno-67-16" href="#__codelineno-67-16"></a>    <span class="n">example_conversation_history</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-67-17"><a id="__codelineno-67-17" name="__codelineno-67-17" href="#__codelineno-67-17"></a>        <span class="p">[</span>
</span><span id="__span-67-18"><a id="__codelineno-67-18" name="__codelineno-67-18" href="#__codelineno-67-18"></a>            <span class="s2">&quot;user: I&#39;d like to travel to an event&quot;</span><span class="p">,</span>
</span><span id="__span-67-19"><a id="__codelineno-67-19" name="__codelineno-67-19" href="#__codelineno-67-19"></a>            <span class="s2">&quot;agent: Sure! Let&#39;s start by finding an event you&#39;d like to attend. I know about events in North American cities. Could you tell me which city and month you&#39;re interested in?&quot;</span><span class="p">,</span>
</span><span id="__span-67-20"><a id="__codelineno-67-20" name="__codelineno-67-20" href="#__codelineno-67-20"></a>            <span class="s2">&quot;user: sydney in may please&quot;</span><span class="p">,</span>
</span><span id="__span-67-21"><a id="__codelineno-67-21" name="__codelineno-67-21" href="#__codelineno-67-21"></a>            <span class="s2">&quot;agent: Great! Let&#39;s find an events in New York City in May.&quot;</span><span class="p">,</span>
</span><span id="__span-67-22"><a id="__codelineno-67-22" name="__codelineno-67-22" href="#__codelineno-67-22"></a>            <span class="s2">&quot;user_confirmed_tool_run: &lt;user clicks confirm on FindEvents tool&gt;&quot;</span><span class="p">,</span>
</span><span id="__span-67-23"><a id="__codelineno-67-23" name="__codelineno-67-23" href="#__codelineno-67-23"></a>            <span class="s2">&quot;tool_result: { &#39;event_name&#39;: &#39;Vivid New York City&#39;, &#39;event_date&#39;: &#39;2023-05-01&#39; }&quot;</span><span class="p">,</span>
</span><span id="__span-67-24"><a id="__codelineno-67-24" name="__codelineno-67-24" href="#__codelineno-67-24"></a>            <span class="s2">&quot;agent: Found an event! There&#39;s Vivid New York City on May 1 2025, ending on May 14 2025. Would you like to search for flights around these dates?&quot;</span><span class="p">,</span>
</span><span id="__span-67-25"><a id="__codelineno-67-25" name="__codelineno-67-25" href="#__codelineno-67-25"></a>            <span class="s2">&quot;user: Yes, please&quot;</span><span class="p">,</span>
</span><span id="__span-67-26"><a id="__codelineno-67-26" name="__codelineno-67-26" href="#__codelineno-67-26"></a>            <span class="s2">&quot;agent: Let&#39;s search for flights around these dates. Could you provide your departure city?&quot;</span><span class="p">,</span>
</span><span id="__span-67-27"><a id="__codelineno-67-27" name="__codelineno-67-27" href="#__codelineno-67-27"></a>            <span class="s2">&quot;user: San Francisco&quot;</span><span class="p">,</span>
</span><span id="__span-67-28"><a id="__codelineno-67-28" name="__codelineno-67-28" href="#__codelineno-67-28"></a>            <span class="s2">&quot;agent: Thanks, searching for flights from San Francisco to New York City around 2023-02-25 to 2023-02-28.&quot;</span><span class="p">,</span>
</span><span id="__span-67-29"><a id="__codelineno-67-29" name="__codelineno-67-29" href="#__codelineno-67-29"></a>            <span class="s2">&quot;user_confirmed_tool_run: &lt;user clicks confirm on SearchFlights tool&gt;&quot;</span>
</span><span id="__span-67-30"><a id="__codelineno-67-30" name="__codelineno-67-30" href="#__codelineno-67-30"></a>            <span class="s1">&#39;tool_result: results including {&quot;flight_number&quot;: &quot;AA101&quot;, &quot;return_flight_number&quot;: &quot;AA102&quot;, &quot;price&quot;: 850.0}&#39;</span><span class="p">,</span>
</span><span id="__span-67-31"><a id="__codelineno-67-31" name="__codelineno-67-31" href="#__codelineno-67-31"></a>            <span class="s2">&quot;agent: Found some flights! The cheapest is AA101 for $850. Would you like to generate an invoice for this flight?&quot;</span><span class="p">,</span>
</span><span id="__span-67-32"><a id="__codelineno-67-32" name="__codelineno-67-32" href="#__codelineno-67-32"></a>            <span class="s2">&quot;user_confirmed_tool_run: &lt;user clicks confirm on CreateInvoice tool&gt;&quot;</span><span class="p">,</span>
</span><span id="__span-67-33"><a id="__codelineno-67-33" name="__codelineno-67-33" href="#__codelineno-67-33"></a>            <span class="s1">&#39;tool_result: { &quot;status&quot;: &quot;success&quot;, &quot;invoice&quot;: { &quot;flight_number&quot;: &quot;AA101&quot;, &quot;amount&quot;: 850.0 }, invoiceURL: &quot;https://example.com/invoice&quot; }&#39;</span><span class="p">,</span>
</span><span id="__span-67-34"><a id="__codelineno-67-34" name="__codelineno-67-34" href="#__codelineno-67-34"></a>            <span class="s2">&quot;agent: Invoice generated! Here&#39;s the link: https://example.com/invoice&quot;</span><span class="p">,</span>
</span><span id="__span-67-35"><a id="__codelineno-67-35" name="__codelineno-67-35" href="#__codelineno-67-35"></a>        <span class="p">]</span>
</span><span id="__span-67-36"><a id="__codelineno-67-36" name="__codelineno-67-36" href="#__codelineno-67-36"></a>    <span class="p">),</span>
</span><span id="__span-67-37"><a id="__codelineno-67-37" name="__codelineno-67-37" href="#__codelineno-67-37"></a><span class="p">)</span>
</span></code></pre></div>
</details>

<p>Now that you have defined your agent's goal, you can begin implementing the Activities.</p>
<details>

<summary>
Before moving on to the next section, verify your files and directory structure is correct.
</summary>

<div class="language-text highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a>temporal-ai-agent/
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>├── .env
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>├── .gitignore
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>├── .python-version
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a>├── README.md
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a>├── pyproject.toml
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a>├── uv.lock
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a>├── models/
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a>│   ├── __init__.py
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a>│   └── core.py
</span><span id="__span-68-11"><a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a>├── scripts/
</span><span id="__span-68-12"><a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a>│   ├── create_invoice_test.py
</span><span id="__span-68-13"><a id="__codelineno-68-13" name="__codelineno-68-13" href="#__codelineno-68-13"></a>│   ├── find_events_test.py
</span><span id="__span-68-14"><a id="__codelineno-68-14" name="__codelineno-68-14" href="#__codelineno-68-14"></a>│   └── search_flights_test.py
</span><span id="__span-68-15"><a id="__codelineno-68-15" name="__codelineno-68-15" href="#__codelineno-68-15"></a>└── tools/
</span><span id="__span-68-16"><a id="__codelineno-68-16" name="__codelineno-68-16" href="#__codelineno-68-16"></a>    ├── __init__.py
</span><span id="__span-68-17"><a id="__codelineno-68-17" name="__codelineno-68-17" href="#__codelineno-68-17"></a>    ├── create_invoice.py
</span><span id="__span-68-18"><a id="__codelineno-68-18" name="__codelineno-68-18" href="#__codelineno-68-18"></a>    ├── find_events.py
</span><span id="__span-68-19"><a id="__codelineno-68-19" name="__codelineno-68-19" href="#__codelineno-68-19"></a>    ├── goal_registry.py
</span><span id="__span-68-20"><a id="__codelineno-68-20" name="__codelineno-68-20" href="#__codelineno-68-20"></a>    ├── search_flights.py
</span><span id="__span-68-21"><a id="__codelineno-68-21" name="__codelineno-68-21" href="#__codelineno-68-21"></a>    ├── tool_registry.py
</span><span id="__span-68-22"><a id="__codelineno-68-22" name="__codelineno-68-22" href="#__codelineno-68-22"></a>    └── data/
</span><span id="__span-68-23"><a id="__codelineno-68-23" name="__codelineno-68-23" href="#__codelineno-68-23"></a>        └── find_events_data.json
</span></code></pre></div>
</details>

<h2 id="building-temporal-activities-to-execute-non-deterministic-agent-code">Building Temporal Activities to execute non-deterministic agent code<a class="headerlink" href="#building-temporal-activities-to-execute-non-deterministic-agent-code" title="Permanent link">&para;</a></h2>
<p>Now that you have built the agent's goal, and the tools it needs to achieve it, you can start building the agent code. 
In this step, you will create Activities that execute code in your AI agent that can behave non-deterministically, such as making the LLM calls or calling tools.
Because tools can call out to external services, have the possibility to fail, be rate limited, or perform other non-deterministic operations, it's safer to always call them in an Activity.
When an Activity fails, it's automatically retried by default until it succeeds or is canceled.</p>
<p>Another added benefit of executing your tool as an Activity is that after the Activity completes, the result is saved to an Event History managed by Temporal.
If your application were to then crash after executing a few tools, it could reconstruct the state of the execution and use the previous execution's results, without having to re-execute the tools.
This provides durability to your agent for intermittent issues, which are common in distributed systems.</p>
<p>Before you can proceed to creating the Activities, however, you need to create the custom types that you'll use for Activity communication.
Recall that Workflow and Activity best practices recommend only passing a single <code>dataclass</code> parameter.
This helps with the evolution of parameters as well as ensuring type safety.</p>
<h3 id="creating-the-requests-data-models">Creating the <code>requests</code> data models<a class="headerlink" href="#creating-the-requests-data-models" title="Permanent link">&para;</a></h3>
<p>Your agent will require specific types for input and output for both the Activities and the Workflow.
You will put all request-based models in a new file in the models directory named <code>requests.py</code>.</p>
<p>First, open <code>models/requests.py</code> and add the following import statements:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Deque</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentGoal</span>
</span></code></pre></div>
<p>You will use these when creating the new types for your agent.</p>
<p>Next, add the following single attribute data types to the file:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="n">Message</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="n">ConversationHistory</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Message</span><span class="p">]]</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="n">NextStep</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;confirm&quot;</span><span class="p">,</span> <span class="s2">&quot;question&quot;</span><span class="p">,</span> <span class="s2">&quot;done&quot;</span><span class="p">]</span>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="n">CurrentTool</span> <span class="o">=</span> <span class="nb">str</span>
</span></code></pre></div>
<p>These types are used to compose other, multi-attribute <code>dataclass</code> types, or sent as a single parameter.
They are used in the following context of the agent:</p>
<ul>
<li><code>Message</code> - A nested dictionary that represents one turn of a conversation between the LLM and the user</li>
<li><code>ConversationHistory</code> - A dictionary containing an <code>str</code> key and a <code>List</code> of <code>Messages</code> that keeps track of the conversation between the LLM and the user</li>
<li><code>NextStep</code> - A <code>Literal</code> containing three options, picked by the agent to decide the next action to take and interpreted by the Workflow</li>
<li><code>CurrentTool</code> - An <code>str</code> representation of the current tool the agent is using</li>
</ul>
<p>Next, add the following <code>dataclass</code>es for handling the primary agent parameters:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="nd">@dataclass</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentGoalWorkflowParams</span><span class="p">:</span>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>    <span class="n">conversation_summary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>    <span class="n">prompt_queue</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Deque</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="nd">@dataclass</span>
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">CombinedInput</span><span class="p">:</span>
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a>    <span class="n">agent_goal</span><span class="p">:</span> <span class="n">AgentGoal</span>
</span><span id="__span-71-10"><a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a>    <span class="n">tool_params</span><span class="p">:</span> <span class="n">AgentGoalWorkflowParams</span>
</span></code></pre></div>
<p>The <code>AgentWorkflowParams</code> type contains a summary of the conversation and a queue of prompts that the agent needs to process via the LLM. 
The <code>CombinedInput</code> type contains the agent's goal and the parameters.
This type is the input that is passed to the main agent Workflow and is used to start the initial Workflow Execution.</p>
<p>Next, add the <code>dataclass</code> that handles the input for calling the LLM for tool planning:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="nd">@dataclass</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">ToolPromptInput</span><span class="p">:</span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>    <span class="n">context_instructions</span><span class="p">:</span> <span class="nb">str</span>
</span></code></pre></div>
<p><code>ToolPromptInput</code> contains the prompt the Activity will issue to the LLM, along with any context that the LLM needs when executing the prompt.</p>
<p>To go along with the this type, you need to add types that store the results of validation of the prompt:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="nd">@dataclass</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">ValidationInput</span><span class="p">:</span>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a>    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a>    <span class="n">conversation_history</span><span class="p">:</span> <span class="n">ConversationHistory</span>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>    <span class="n">agent_goal</span><span class="p">:</span> <span class="n">AgentGoal</span>
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a>
</span><span id="__span-73-7"><a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a>
</span><span id="__span-73-8"><a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a><span class="nd">@dataclass</span>
</span><span id="__span-73-9"><a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">ValidationResult</span><span class="p">:</span>
</span><span id="__span-73-10"><a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a>    <span class="n">validationResult</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="__span-73-11"><a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a>    <span class="n">validationFailedReason</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span></code></pre></div>
<p>The <code>ValidationInput</code> type contains the prompt given by the user, the conversation history, and the agent's goal.
An Activity will use this type as input and validate the prompt against the agent's goal.
Conversely, the <code>ValidationResult</code> type will contain the results of this validation Activity and will return a boolean signifying if the prompt passed or failed, and if it did fail a reason why.</p>
<p>Next, add two more <code>dataclass</code>es for handling the input and output of reading environment variables into the Workflow:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="nd">@dataclass</span>
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">EnvLookupInput</span><span class="p">:</span>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>    <span class="n">show_confirm_env_var_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>    <span class="n">show_confirm_default</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a>
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="nd">@dataclass</span>
</span><span id="__span-74-8"><a id="__codelineno-74-8" name="__codelineno-74-8" href="#__codelineno-74-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">EnvLookupOutput</span><span class="p">:</span>
</span><span id="__span-74-9"><a id="__codelineno-74-9" name="__codelineno-74-9" href="#__codelineno-74-9"></a>    <span class="n">show_confirm</span><span class="p">:</span> <span class="nb">bool</span>
</span></code></pre></div>
<p>Since reading from the filesystem is a non-deterministic operation, this action must be done from an Activity, so it is best practice to define types to handle this in case you ever need to add more environment variables.
Your environment variables will contain things such as your API keys, agent configurations, timeouts, and other settings.</p>
<p>Finally, add the class that will contain the next step the agent should take and the data the tool needs to execute:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ToolData</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a>    <span class="nb">next</span><span class="p">:</span> <span class="n">NextStep</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a>    <span class="n">tool</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a>    <span class="n">response</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a>    <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a>    <span class="n">force_confirm</span><span class="p">:</span> <span class="nb">bool</span>
</span></code></pre></div>
<p><code>ToolData</code> contains the <code>NextStep</code> that the agent should take, along with the tool that should be used, the arguments for the tool, the response from the LLM, and a <code>force_confirm</code> boolean.
You may notice this type is different from the previous types, as it is a subclass of <code>TypedDict</code> and not a <code>dataclass</code>.
This is done to handle converting the type to JSON for use in the API later, because <code>dataclass</code>es don't support conversion of nested custom types to JSON.</p>
<details>

<summary>
The <code>models/requests.py</code> is complete and will need no more revisions. You can review the complete file and copy the code here.
</summary>

<br />
Hover your cursor over the code block to reveal the copy-code option.
<br />
<br />

[models/requests.py](https://github.com/temporal-community/tutorial-temporal-ai-agent/blob/main/models/requests.py)

<div class="language-python highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Deque</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentGoal</span>
</span><span id="__span-76-5"><a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a>
</span><span id="__span-76-6"><a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a><span class="c1"># Common type aliases</span>
</span><span id="__span-76-7"><a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a>
</span><span id="__span-76-8"><a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a><span class="n">Message</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>
</span><span id="__span-76-9"><a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a><span class="n">ConversationHistory</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Message</span><span class="p">]]</span>
</span><span id="__span-76-10"><a id="__codelineno-76-10" name="__codelineno-76-10" href="#__codelineno-76-10"></a><span class="n">NextStep</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;confirm&quot;</span><span class="p">,</span> <span class="s2">&quot;question&quot;</span><span class="p">,</span> <span class="s2">&quot;pick-new-goal&quot;</span><span class="p">,</span> <span class="s2">&quot;done&quot;</span><span class="p">]</span>
</span><span id="__span-76-11"><a id="__codelineno-76-11" name="__codelineno-76-11" href="#__codelineno-76-11"></a><span class="n">CurrentTool</span> <span class="o">=</span> <span class="nb">str</span>
</span><span id="__span-76-12"><a id="__codelineno-76-12" name="__codelineno-76-12" href="#__codelineno-76-12"></a>
</span><span id="__span-76-13"><a id="__codelineno-76-13" name="__codelineno-76-13" href="#__codelineno-76-13"></a>
</span><span id="__span-76-14"><a id="__codelineno-76-14" name="__codelineno-76-14" href="#__codelineno-76-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">ToolData</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="__span-76-15"><a id="__codelineno-76-15" name="__codelineno-76-15" href="#__codelineno-76-15"></a>    <span class="nb">next</span><span class="p">:</span> <span class="n">NextStep</span>
</span><span id="__span-76-16"><a id="__codelineno-76-16" name="__codelineno-76-16" href="#__codelineno-76-16"></a>    <span class="n">tool</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-76-17"><a id="__codelineno-76-17" name="__codelineno-76-17" href="#__codelineno-76-17"></a>    <span class="n">response</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-76-18"><a id="__codelineno-76-18" name="__codelineno-76-18" href="#__codelineno-76-18"></a>    <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="__span-76-19"><a id="__codelineno-76-19" name="__codelineno-76-19" href="#__codelineno-76-19"></a>    <span class="n">force_confirm</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="__span-76-20"><a id="__codelineno-76-20" name="__codelineno-76-20" href="#__codelineno-76-20"></a>
</span><span id="__span-76-21"><a id="__codelineno-76-21" name="__codelineno-76-21" href="#__codelineno-76-21"></a>
</span><span id="__span-76-22"><a id="__codelineno-76-22" name="__codelineno-76-22" href="#__codelineno-76-22"></a><span class="nd">@dataclass</span>
</span><span id="__span-76-23"><a id="__codelineno-76-23" name="__codelineno-76-23" href="#__codelineno-76-23"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentGoalWorkflowParams</span><span class="p">:</span>
</span><span id="__span-76-24"><a id="__codelineno-76-24" name="__codelineno-76-24" href="#__codelineno-76-24"></a>    <span class="n">conversation_summary</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-76-25"><a id="__codelineno-76-25" name="__codelineno-76-25" href="#__codelineno-76-25"></a>    <span class="n">prompt_queue</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Deque</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-76-26"><a id="__codelineno-76-26" name="__codelineno-76-26" href="#__codelineno-76-26"></a>
</span><span id="__span-76-27"><a id="__codelineno-76-27" name="__codelineno-76-27" href="#__codelineno-76-27"></a>
</span><span id="__span-76-28"><a id="__codelineno-76-28" name="__codelineno-76-28" href="#__codelineno-76-28"></a><span class="nd">@dataclass</span>
</span><span id="__span-76-29"><a id="__codelineno-76-29" name="__codelineno-76-29" href="#__codelineno-76-29"></a><span class="k">class</span><span class="w"> </span><span class="nc">CombinedInput</span><span class="p">:</span>
</span><span id="__span-76-30"><a id="__codelineno-76-30" name="__codelineno-76-30" href="#__codelineno-76-30"></a>    <span class="n">tool_params</span><span class="p">:</span> <span class="n">AgentGoalWorkflowParams</span>
</span><span id="__span-76-31"><a id="__codelineno-76-31" name="__codelineno-76-31" href="#__codelineno-76-31"></a>    <span class="n">agent_goal</span><span class="p">:</span> <span class="n">AgentGoal</span>
</span><span id="__span-76-32"><a id="__codelineno-76-32" name="__codelineno-76-32" href="#__codelineno-76-32"></a>
</span><span id="__span-76-33"><a id="__codelineno-76-33" name="__codelineno-76-33" href="#__codelineno-76-33"></a>
</span><span id="__span-76-34"><a id="__codelineno-76-34" name="__codelineno-76-34" href="#__codelineno-76-34"></a><span class="nd">@dataclass</span>
</span><span id="__span-76-35"><a id="__codelineno-76-35" name="__codelineno-76-35" href="#__codelineno-76-35"></a><span class="k">class</span><span class="w"> </span><span class="nc">ToolPromptInput</span><span class="p">:</span>
</span><span id="__span-76-36"><a id="__codelineno-76-36" name="__codelineno-76-36" href="#__codelineno-76-36"></a>    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-76-37"><a id="__codelineno-76-37" name="__codelineno-76-37" href="#__codelineno-76-37"></a>    <span class="n">context_instructions</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-76-38"><a id="__codelineno-76-38" name="__codelineno-76-38" href="#__codelineno-76-38"></a>
</span><span id="__span-76-39"><a id="__codelineno-76-39" name="__codelineno-76-39" href="#__codelineno-76-39"></a>
</span><span id="__span-76-40"><a id="__codelineno-76-40" name="__codelineno-76-40" href="#__codelineno-76-40"></a><span class="nd">@dataclass</span>
</span><span id="__span-76-41"><a id="__codelineno-76-41" name="__codelineno-76-41" href="#__codelineno-76-41"></a><span class="k">class</span><span class="w"> </span><span class="nc">ValidationInput</span><span class="p">:</span>
</span><span id="__span-76-42"><a id="__codelineno-76-42" name="__codelineno-76-42" href="#__codelineno-76-42"></a>    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-76-43"><a id="__codelineno-76-43" name="__codelineno-76-43" href="#__codelineno-76-43"></a>    <span class="n">conversation_history</span><span class="p">:</span> <span class="n">ConversationHistory</span>
</span><span id="__span-76-44"><a id="__codelineno-76-44" name="__codelineno-76-44" href="#__codelineno-76-44"></a>    <span class="n">agent_goal</span><span class="p">:</span> <span class="n">AgentGoal</span>
</span><span id="__span-76-45"><a id="__codelineno-76-45" name="__codelineno-76-45" href="#__codelineno-76-45"></a>
</span><span id="__span-76-46"><a id="__codelineno-76-46" name="__codelineno-76-46" href="#__codelineno-76-46"></a>
</span><span id="__span-76-47"><a id="__codelineno-76-47" name="__codelineno-76-47" href="#__codelineno-76-47"></a><span class="nd">@dataclass</span>
</span><span id="__span-76-48"><a id="__codelineno-76-48" name="__codelineno-76-48" href="#__codelineno-76-48"></a><span class="k">class</span><span class="w"> </span><span class="nc">ValidationResult</span><span class="p">:</span>
</span><span id="__span-76-49"><a id="__codelineno-76-49" name="__codelineno-76-49" href="#__codelineno-76-49"></a>    <span class="n">validationResult</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="__span-76-50"><a id="__codelineno-76-50" name="__codelineno-76-50" href="#__codelineno-76-50"></a>    <span class="n">validationFailedReason</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</span><span id="__span-76-51"><a id="__codelineno-76-51" name="__codelineno-76-51" href="#__codelineno-76-51"></a>
</span><span id="__span-76-52"><a id="__codelineno-76-52" name="__codelineno-76-52" href="#__codelineno-76-52"></a>
</span><span id="__span-76-53"><a id="__codelineno-76-53" name="__codelineno-76-53" href="#__codelineno-76-53"></a><span class="nd">@dataclass</span>
</span><span id="__span-76-54"><a id="__codelineno-76-54" name="__codelineno-76-54" href="#__codelineno-76-54"></a><span class="k">class</span><span class="w"> </span><span class="nc">EnvLookupInput</span><span class="p">:</span>
</span><span id="__span-76-55"><a id="__codelineno-76-55" name="__codelineno-76-55" href="#__codelineno-76-55"></a>    <span class="n">show_confirm_env_var_name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="__span-76-56"><a id="__codelineno-76-56" name="__codelineno-76-56" href="#__codelineno-76-56"></a>    <span class="n">show_confirm_default</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="__span-76-57"><a id="__codelineno-76-57" name="__codelineno-76-57" href="#__codelineno-76-57"></a>
</span><span id="__span-76-58"><a id="__codelineno-76-58" name="__codelineno-76-58" href="#__codelineno-76-58"></a>
</span><span id="__span-76-59"><a id="__codelineno-76-59" name="__codelineno-76-59" href="#__codelineno-76-59"></a><span class="nd">@dataclass</span>
</span><span id="__span-76-60"><a id="__codelineno-76-60" name="__codelineno-76-60" href="#__codelineno-76-60"></a><span class="k">class</span><span class="w"> </span><span class="nc">EnvLookupOutput</span><span class="p">:</span>
</span><span id="__span-76-61"><a id="__codelineno-76-61" name="__codelineno-76-61" href="#__codelineno-76-61"></a>    <span class="n">show_confirm</span><span class="p">:</span> <span class="nb">bool</span>
</span></code></pre></div>
</details>

<p>Now that you have your custom types defined for Activity communication, you can implement the Activities.</p>
<h3 id="creating-the-activities-submodule">Creating the Activities submodule<a class="headerlink" href="#creating-the-activities-submodule" title="Permanent link">&para;</a></h3>
<p>First, create the directory structure for your Activities and make it a module:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a>mkdir activities
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>touch activities/__init__.py
</span></code></pre></div>
<p>Next, create the file <code>activities/activities.py</code> and add the necessary <code>import</code> statements and a statement to load the environment variables:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span>
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a>
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
</span><span id="__span-78-8"><a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">litellm</span><span class="w"> </span><span class="kn">import</span> <span class="n">completion</span>
</span><span id="__span-78-9"><a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio</span><span class="w"> </span><span class="kn">import</span> <span class="n">activity</span>
</span><span id="__span-78-10"><a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">RawValue</span>
</span><span id="__span-78-11"><a id="__codelineno-78-11" name="__codelineno-78-11" href="#__codelineno-78-11"></a>
</span><span id="__span-78-12"><a id="__codelineno-78-12" name="__codelineno-78-12" href="#__codelineno-78-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-78-13"><a id="__codelineno-78-13" name="__codelineno-78-13" href="#__codelineno-78-13"></a>    <span class="n">EnvLookupInput</span><span class="p">,</span>
</span><span id="__span-78-14"><a id="__codelineno-78-14" name="__codelineno-78-14" href="#__codelineno-78-14"></a>    <span class="n">EnvLookupOutput</span><span class="p">,</span>
</span><span id="__span-78-15"><a id="__codelineno-78-15" name="__codelineno-78-15" href="#__codelineno-78-15"></a>    <span class="n">ToolPromptInput</span><span class="p">,</span>
</span><span id="__span-78-16"><a id="__codelineno-78-16" name="__codelineno-78-16" href="#__codelineno-78-16"></a>    <span class="n">ValidationInput</span><span class="p">,</span>
</span><span id="__span-78-17"><a id="__codelineno-78-17" name="__codelineno-78-17" href="#__codelineno-78-17"></a>    <span class="n">ValidationResult</span><span class="p">,</span>
</span><span id="__span-78-18"><a id="__codelineno-78-18" name="__codelineno-78-18" href="#__codelineno-78-18"></a><span class="p">)</span>
</span><span id="__span-78-19"><a id="__codelineno-78-19" name="__codelineno-78-19" href="#__codelineno-78-19"></a>
</span><span id="__span-78-20"><a id="__codelineno-78-20" name="__codelineno-78-20" href="#__codelineno-78-20"></a><span class="n">load_dotenv</span><span class="p">(</span><span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></code></pre></div>
<p>This imports various system packages, Temporal libraries, the <code>litellm</code> package for making LLM calls, the <code>dotenv</code> package for loading environment variables, and a number of custom types you defined in <code>models/requests.py</code>. 
Next, you'll create the <code>AgentActivities</code> class, which contains activities the agent will call to achieve its goal. </p>
<h3 id="constructing-the-agentactivities-class">Constructing the <code>AgentActivities</code> Class<a class="headerlink" href="#constructing-the-agentactivities-class" title="Permanent link">&para;</a></h3>
<p>The <code>AgentActivities</code> class enables the Workflow to plan which tools to use, validate prompts, read in environment variables, and more.</p>
<p>To implement it, open <code>activities/activities.py</code> and create the class and define the <code>__init__</code> method:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentActivities</span><span class="p">:</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize LLM client using LiteLLM.&quot;&quot;&quot;</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm_model</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LLM_MODEL&quot;</span><span class="p">,</span> <span class="s2">&quot;openai/gpt-4&quot;</span><span class="p">)</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LLM_KEY&quot;</span><span class="p">)</span>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm_base_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LLM_BASE_URL&quot;</span><span class="p">)</span>
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a>        <span class="n">activity</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-79-8"><a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a>            <span class="sa">f</span><span class="s2">&quot;Initializing AgentActivities with LLM model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_model</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-79-9"><a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a>        <span class="p">)</span>
</span><span id="__span-79-10"><a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_base_url</span><span class="p">:</span>
</span><span id="__span-79-11"><a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a>            <span class="n">activity</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using custom base URL: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_base_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>Temporal Activities can be implemented as either a function or a class and method.
As the agent requires a persistent object for communication, in this case, communicating to the LLM, it's good practice to use a class and set the parameters as part of the initialization of the Activity, so to not waste resources re-initializing the object for every LLM call.
The <code>__init__</code> method reads the LLM configuration from environment variables and assigns the values to instance variables.</p>
<h4 id="implementing-various-helper-methods">Implementing various helper methods<a class="headerlink" href="#implementing-various-helper-methods" title="Permanent link">&para;</a></h4>
<p>Before you implement the Activities, implement the following helper functions:</p>
<p>The first method sanitizes the JSON response you get from the LLM and sanitizing it to a proper JSON string.
The LLM may return a string with extra whitespace, or formatted as markdown, so sanitizing the string is necessary before parsing it.</p>
<p>Add the following helper method to the bottom of your <code>activities.py</code> file:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">sanitize_json_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="sd">        Sanitizes the response content to ensure it&#39;s valid JSON.</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a>        <span class="c1"># Remove any markdown code block markers</span>
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>        <span class="n">response_content</span> <span class="o">=</span> <span class="n">response_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;```json&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a>
</span><span id="__span-80-8"><a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a>        <span class="c1"># Remove any leading/trailing whitespace</span>
</span><span id="__span-80-9"><a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a>        <span class="n">response_content</span> <span class="o">=</span> <span class="n">response_content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="__span-80-10"><a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a>
</span><span id="__span-80-11"><a id="__codelineno-80-11" name="__codelineno-80-11" href="#__codelineno-80-11"></a>        <span class="k">return</span> <span class="n">response_content</span>
</span></code></pre></div>
<p>The second helper function takes a string as input and returns a dictionary after attempting to parse the string as valid JSON.
Add this method to the bottom of your <code>activities.py</code> file:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">parse_json_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="sd">        Parses the JSON response content and returns it as a dictionary.</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response_content</span><span class="p">)</span>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a>            <span class="k">return</span> <span class="n">data</span>
</span><span id="__span-81-8"><a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a>        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-81-9"><a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a>            <span class="n">activity</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-81-10"><a id="__codelineno-81-10" name="__codelineno-81-10" href="#__codelineno-81-10"></a>            <span class="k">raise</span>
</span></code></pre></div>
<p>Now that you have the helper methods implemented, you can implement the Activity responsible for making LLM calls.</p>
<h4 id="implementing-the-activity-for-making-llm-calls">Implementing the Activity for making LLM calls<a class="headerlink" href="#implementing-the-activity-for-making-llm-calls" title="Permanent link">&para;</a></h4>
<p>The <code>agent_toolPlanner</code> Activity handles all interactions with your chosen LLM.
It makes the call to the LLM, parses the response and returns JSON on success, and raises an Exception on failure.</p>
<p>Add the method header with the appropriate decorator to your <code>activities.py</code> file, underneath the <code>__init__</code> method:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a>    <span class="nd">@activity</span><span class="o">.</span><span class="n">defn</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">agent_toolPlanner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">ToolPromptInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span></code></pre></div>
<p>Next, create the <code>messages</code> list, which contains various dictionaries with the data necessary to perform an LLM prompt.
This format is specifically OpenAI's format, which you can use for any LLM, because you are using <code>LiteLLM</code> to as your <a href="https://docs.litellm.ai/docs/anthropic_unified#litellm-python-sdk">LLM abstraction library</a>.</p>
<p>Add the following code to craft the <code>messages</code> list:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a>            <span class="p">{</span>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a>                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="nb">input</span><span class="o">.</span><span class="n">context_instructions</span>
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>                <span class="o">+</span> <span class="s2">&quot;. The current date is &quot;</span>
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a>                <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%B </span><span class="si">%d</span><span class="s2">, %Y&quot;</span><span class="p">),</span>
</span><span id="__span-83-7"><a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a>            <span class="p">},</span>
</span><span id="__span-83-8"><a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a>            <span class="p">{</span>
</span><span id="__span-83-9"><a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="__span-83-10"><a id="__codelineno-83-10" name="__codelineno-83-10" href="#__codelineno-83-10"></a>                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="nb">input</span><span class="o">.</span><span class="n">prompt</span><span class="p">,</span>
</span><span id="__span-83-11"><a id="__codelineno-83-11" name="__codelineno-83-11" href="#__codelineno-83-11"></a>            <span class="p">},</span>
</span><span id="__span-83-12"><a id="__codelineno-83-12" name="__codelineno-83-12" href="#__codelineno-83-12"></a>        <span class="p">]</span>
</span></code></pre></div>
<p>The <code>agent_toolPlanner</code> Activity constructs standard OpenAI-format messages with system context and user input. 
It automatically includes the current date, which helps the language model provide accurate responses for time-sensitive queries.</p>
<p>Continue the method with the LLM call implementation:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a>            <span class="n">completion_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a>                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_model</span><span class="p">,</span>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a>                <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_key</span><span class="p">,</span>
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a>            <span class="p">}</span>
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a>
</span><span id="__span-84-8"><a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a>            <span class="c1"># Add base_url if configured</span>
</span><span id="__span-84-9"><a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_base_url</span><span class="p">:</span>
</span><span id="__span-84-10"><a id="__codelineno-84-10" name="__codelineno-84-10" href="#__codelineno-84-10"></a>                <span class="n">completion_kwargs</span><span class="p">[</span><span class="s2">&quot;base_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_base_url</span>
</span><span id="__span-84-11"><a id="__codelineno-84-11" name="__codelineno-84-11" href="#__codelineno-84-11"></a>
</span><span id="__span-84-12"><a id="__codelineno-84-12" name="__codelineno-84-12" href="#__codelineno-84-12"></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">completion</span><span class="p">(</span><span class="o">**</span><span class="n">completion_kwargs</span><span class="p">)</span>
</span><span id="__span-84-13"><a id="__codelineno-84-13" name="__codelineno-84-13" href="#__codelineno-84-13"></a>
</span><span id="__span-84-14"><a id="__codelineno-84-14" name="__codelineno-84-14" href="#__codelineno-84-14"></a>            <span class="n">response_content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span><span id="__span-84-15"><a id="__codelineno-84-15" name="__codelineno-84-15" href="#__codelineno-84-15"></a>            <span class="n">activity</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LLM response: </span><span class="si">{</span><span class="n">response_content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-84-16"><a id="__codelineno-84-16" name="__codelineno-84-16" href="#__codelineno-84-16"></a>
</span><span id="__span-84-17"><a id="__codelineno-84-17" name="__codelineno-84-17" href="#__codelineno-84-17"></a>            <span class="c1"># Use the new sanitize function</span>
</span><span id="__span-84-18"><a id="__codelineno-84-18" name="__codelineno-84-18" href="#__codelineno-84-18"></a>            <span class="n">response_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_json_response</span><span class="p">(</span><span class="n">response_content</span><span class="p">)</span>
</span><span id="__span-84-19"><a id="__codelineno-84-19" name="__codelineno-84-19" href="#__codelineno-84-19"></a>
</span><span id="__span-84-20"><a id="__codelineno-84-20" name="__codelineno-84-20" href="#__codelineno-84-20"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_json_response</span><span class="p">(</span><span class="n">response_content</span><span class="p">)</span>
</span><span id="__span-84-21"><a id="__codelineno-84-21" name="__codelineno-84-21" href="#__codelineno-84-21"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-84-22"><a id="__codelineno-84-22" name="__codelineno-84-22" href="#__codelineno-84-22"></a>            <span class="n">activity</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in LLM completion: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-84-23"><a id="__codelineno-84-23" name="__codelineno-84-23" href="#__codelineno-84-23"></a>            <span class="k">raise</span>
</span></code></pre></div>
<p>This call is wrapped in a <code>try/except</code> statement to handle a potential failure.
It creates a dictionary containing the arguments for calling the LLM, including the model choice, the messages, the API key, and a custom base URL if set.
Next it performs the call to the LLM using the <code>completion</code> function, passing in the arguments dictionary.
It then extracts the message you want from the response content, sanitizes the JSON and returns it as properly parsed JSON upon success.
Upon failure, it will raise an exception.</p>
<p>The complete implementation of <code>agent_toolPlanner</code> is as follows:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a>    <span class="nd">@activity</span><span class="o">.</span><span class="n">defn</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">agent_toolPlanner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">ToolPromptInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a>            <span class="p">{</span>
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>
</span><span id="__span-85-6"><a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a>                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="nb">input</span><span class="o">.</span><span class="n">context_instructions</span>
</span><span id="__span-85-7"><a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a>                <span class="o">+</span> <span class="s2">&quot;. The current date is &quot;</span>
</span><span id="__span-85-8"><a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a>                <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%B </span><span class="si">%d</span><span class="s2">, %Y&quot;</span><span class="p">),</span>
</span><span id="__span-85-9"><a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a>            <span class="p">},</span>
</span><span id="__span-85-10"><a id="__codelineno-85-10" name="__codelineno-85-10" href="#__codelineno-85-10"></a>            <span class="p">{</span>
</span><span id="__span-85-11"><a id="__codelineno-85-11" name="__codelineno-85-11" href="#__codelineno-85-11"></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="__span-85-12"><a id="__codelineno-85-12" name="__codelineno-85-12" href="#__codelineno-85-12"></a>                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="nb">input</span><span class="o">.</span><span class="n">prompt</span><span class="p">,</span>
</span><span id="__span-85-13"><a id="__codelineno-85-13" name="__codelineno-85-13" href="#__codelineno-85-13"></a>            <span class="p">},</span>
</span><span id="__span-85-14"><a id="__codelineno-85-14" name="__codelineno-85-14" href="#__codelineno-85-14"></a>        <span class="p">]</span>
</span><span id="__span-85-15"><a id="__codelineno-85-15" name="__codelineno-85-15" href="#__codelineno-85-15"></a>
</span><span id="__span-85-16"><a id="__codelineno-85-16" name="__codelineno-85-16" href="#__codelineno-85-16"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-85-17"><a id="__codelineno-85-17" name="__codelineno-85-17" href="#__codelineno-85-17"></a>            <span class="n">completion_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-85-18"><a id="__codelineno-85-18" name="__codelineno-85-18" href="#__codelineno-85-18"></a>                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_model</span><span class="p">,</span>
</span><span id="__span-85-19"><a id="__codelineno-85-19" name="__codelineno-85-19" href="#__codelineno-85-19"></a>                <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
</span><span id="__span-85-20"><a id="__codelineno-85-20" name="__codelineno-85-20" href="#__codelineno-85-20"></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_key</span><span class="p">,</span>
</span><span id="__span-85-21"><a id="__codelineno-85-21" name="__codelineno-85-21" href="#__codelineno-85-21"></a>            <span class="p">}</span>
</span><span id="__span-85-22"><a id="__codelineno-85-22" name="__codelineno-85-22" href="#__codelineno-85-22"></a>
</span><span id="__span-85-23"><a id="__codelineno-85-23" name="__codelineno-85-23" href="#__codelineno-85-23"></a>            <span class="c1"># Add base_url if configured</span>
</span><span id="__span-85-24"><a id="__codelineno-85-24" name="__codelineno-85-24" href="#__codelineno-85-24"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_base_url</span><span class="p">:</span>
</span><span id="__span-85-25"><a id="__codelineno-85-25" name="__codelineno-85-25" href="#__codelineno-85-25"></a>                <span class="n">completion_kwargs</span><span class="p">[</span><span class="s2">&quot;base_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_base_url</span>
</span><span id="__span-85-26"><a id="__codelineno-85-26" name="__codelineno-85-26" href="#__codelineno-85-26"></a>
</span><span id="__span-85-27"><a id="__codelineno-85-27" name="__codelineno-85-27" href="#__codelineno-85-27"></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">completion</span><span class="p">(</span><span class="o">**</span><span class="n">completion_kwargs</span><span class="p">)</span>
</span><span id="__span-85-28"><a id="__codelineno-85-28" name="__codelineno-85-28" href="#__codelineno-85-28"></a>
</span><span id="__span-85-29"><a id="__codelineno-85-29" name="__codelineno-85-29" href="#__codelineno-85-29"></a>            <span class="n">response_content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span><span id="__span-85-30"><a id="__codelineno-85-30" name="__codelineno-85-30" href="#__codelineno-85-30"></a>            <span class="n">activity</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LLM response: </span><span class="si">{</span><span class="n">response_content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-85-31"><a id="__codelineno-85-31" name="__codelineno-85-31" href="#__codelineno-85-31"></a>
</span><span id="__span-85-32"><a id="__codelineno-85-32" name="__codelineno-85-32" href="#__codelineno-85-32"></a>            <span class="c1"># Use the new sanitize function</span>
</span><span id="__span-85-33"><a id="__codelineno-85-33" name="__codelineno-85-33" href="#__codelineno-85-33"></a>            <span class="n">response_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_json_response</span><span class="p">(</span><span class="n">response_content</span><span class="p">)</span>
</span><span id="__span-85-34"><a id="__codelineno-85-34" name="__codelineno-85-34" href="#__codelineno-85-34"></a>
</span><span id="__span-85-35"><a id="__codelineno-85-35" name="__codelineno-85-35" href="#__codelineno-85-35"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_json_response</span><span class="p">(</span><span class="n">response_content</span><span class="p">)</span>
</span><span id="__span-85-36"><a id="__codelineno-85-36" name="__codelineno-85-36" href="#__codelineno-85-36"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-85-37"><a id="__codelineno-85-37" name="__codelineno-85-37" href="#__codelineno-85-37"></a>            <span class="n">activity</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in LLM completion: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-85-38"><a id="__codelineno-85-38" name="__codelineno-85-38" href="#__codelineno-85-38"></a>            <span class="k">raise</span>
</span></code></pre></div>
<p>Now that you have implemented the Activity to call the LLM, you will implement the Activity to validate the user's prompts.</p>
<h4 id="implementing-the-activity-for-prompt-validation">Implementing the Activity for prompt validation<a class="headerlink" href="#implementing-the-activity-for-prompt-validation" title="Permanent link">&para;</a></h4>
<p>It is important to not let the user take your agent off on a tangent, sending prompts that are not related to the goal.
To do this, you must validate the prompt against your agent's goal and context prior to executing the LLM with the user's input.</p>
<p>Next, create the <code>agent_validatePrompt</code> Activity to validate any prompt sent to the LLM in the context of the conversation history and agent goal.</p>
<p>Within the <code>AgentActivities</code> class, add the following method header:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a>    <span class="nd">@activity</span><span class="o">.</span><span class="n">defn</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">agent_validatePrompt</span><span class="p">(</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3" href="#__codelineno-86-3"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">validation_input</span><span class="p">:</span> <span class="n">ValidationInput</span>
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4" href="#__codelineno-86-4"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ValidationResult</span><span class="p">:</span>
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5" href="#__codelineno-86-5"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-86-6"><a id="__codelineno-86-6" name="__codelineno-86-6" href="#__codelineno-86-6"></a><span class="sd">        Validates the prompt in the context of the conversation history and agent goal.</span>
</span><span id="__span-86-7"><a id="__codelineno-86-7" name="__codelineno-86-7" href="#__codelineno-86-7"></a><span class="sd">        Returns a ValidationResult indicating if the prompt makes sense given the context.</span>
</span><span id="__span-86-8"><a id="__codelineno-86-8" name="__codelineno-86-8" href="#__codelineno-86-8"></a><span class="sd">        &quot;&quot;&quot;</span>
</span></code></pre></div>
<p>This Activity takes in a single argument, using the custom <code>ValidationInput</code> type you specified, and returns a single value, <code>ValidationResult</code>, in accordance with Temporal best practices.</p>
<p>Next, add the code following code to iterate over the tools specified in the agent's goal and add them to a list.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a>        <span class="c1"># Create simple context string describing tools and goals</span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a>        <span class="n">tools_description</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a>        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">validation_input</span><span class="o">.</span><span class="n">agent_goal</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span>
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a>            <span class="n">tool_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tool: </span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-87-5"><a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a>            <span class="n">tool_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Description: </span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-87-6"><a id="__codelineno-87-6" name="__codelineno-87-6" href="#__codelineno-87-6"></a>            <span class="n">tool_str</span> <span class="o">+=</span> <span class="s2">&quot;Arguments: &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-87-7"><a id="__codelineno-87-7" name="__codelineno-87-7" href="#__codelineno-87-7"></a>                <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">tool</span><span class="o">.</span><span class="n">arguments</span><span class="p">]</span>
</span><span id="__span-87-8"><a id="__codelineno-87-8" name="__codelineno-87-8" href="#__codelineno-87-8"></a>            <span class="p">)</span>
</span><span id="__span-87-9"><a id="__codelineno-87-9" name="__codelineno-87-9" href="#__codelineno-87-9"></a>            <span class="n">tools_description</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_str</span><span class="p">)</span>
</span><span id="__span-87-10"><a id="__codelineno-87-10" name="__codelineno-87-10" href="#__codelineno-87-10"></a>        <span class="n">tools_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tools_description</span><span class="p">)</span>
</span></code></pre></div>
<p>By doing this, you are creating a string the LLM can use as context to validate against.
This context helps the LLM understand what capabilities are available to the agent, and whether or not the prompt the user sent makes sense.</p>
<p>Continue the validation method by adding conversation context:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a>        <span class="c1"># Convert conversation history to string</span>
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a>        <span class="n">history_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">validation_input</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a>
</span><span id="__span-88-4"><a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a>        <span class="c1"># Create context instructions</span>
</span><span id="__span-88-5"><a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a>        <span class="n">context_instructions</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;The agent goal and tools are as follows:</span>
</span><span id="__span-88-6"><a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a><span class="s2">            Description: </span><span class="si">{</span><span class="n">validation_input</span><span class="o">.</span><span class="n">agent_goal</span><span class="o">.</span><span class="n">description</span><span class="si">}</span>
</span><span id="__span-88-7"><a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a><span class="s2">            Available Tools:</span>
</span><span id="__span-88-8"><a id="__codelineno-88-8" name="__codelineno-88-8" href="#__codelineno-88-8"></a><span class="s2">            </span><span class="si">{</span><span class="n">tools_str</span><span class="si">}</span>
</span><span id="__span-88-9"><a id="__codelineno-88-9" name="__codelineno-88-9" href="#__codelineno-88-9"></a><span class="s2">            The conversation history to date is:</span>
</span><span id="__span-88-10"><a id="__codelineno-88-10" name="__codelineno-88-10" href="#__codelineno-88-10"></a><span class="s2">            </span><span class="si">{</span><span class="n">history_str</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
</span></code></pre></div>
<p>This section gathers the past conversation history and concatenates it with the available tool context, creating a complete context for the LLM.</p>
<p>Next, add the following prompt for the LLM to use to validate the prompt:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a>        <span class="c1"># Create validation prompt</span>
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a>        <span class="n">validation_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;The user&#39;s prompt is: &quot;</span><span class="si">{</span><span class="n">validation_input</span><span class="o">.</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-89-3"><a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a><span class="s2">            Please validate if this prompt makes sense given the agent goal and conversation history.</span>
</span><span id="__span-89-4"><a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a><span class="s2">            If the prompt makes sense toward the goal then validationResult should be true.</span>
</span><span id="__span-89-5"><a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a><span class="s2">            If the prompt is wildly nonsensical or makes no sense toward the goal and current conversation history then validationResult should be false.</span>
</span><span id="__span-89-6"><a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a><span class="s2">            If the response is low content such as &quot;yes&quot; or &quot;that&#39;s right&quot; then the user is probably responding to a previous prompt.  </span>
</span><span id="__span-89-7"><a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a><span class="s2">             Therefore examine it in the context of the conversation history to determine if it makes sense and return true if it makes sense.</span>
</span><span id="__span-89-8"><a id="__codelineno-89-8" name="__codelineno-89-8" href="#__codelineno-89-8"></a><span class="s2">            Return ONLY a JSON object with the following structure:</span>
</span><span id="__span-89-9"><a id="__codelineno-89-9" name="__codelineno-89-9" href="#__codelineno-89-9"></a><span class="s2">                &quot;validationResult&quot;: true/false,</span>
</span><span id="__span-89-10"><a id="__codelineno-89-10" name="__codelineno-89-10" href="#__codelineno-89-10"></a><span class="s2">                &quot;validationFailedReason&quot;: &quot;If validationResult is false, provide a clear explanation to the user in the response field </span>
</span><span id="__span-89-11"><a id="__codelineno-89-11" name="__codelineno-89-11" href="#__codelineno-89-11"></a><span class="s2">                about why their request doesn&#39;t make sense in the context and what information they should provide instead.</span>
</span><span id="__span-89-12"><a id="__codelineno-89-12" name="__codelineno-89-12" href="#__codelineno-89-12"></a><span class="s2">                validationFailedReason should contain JSON in the format</span>
</span><span id="__span-89-13"><a id="__codelineno-89-13" name="__codelineno-89-13" href="#__codelineno-89-13"></a><span class="s2">                </span><span class="se">{{</span>
</span><span id="__span-89-14"><a id="__codelineno-89-14" name="__codelineno-89-14" href="#__codelineno-89-14"></a><span class="s2">                    &quot;next&quot;: &quot;question&quot;,</span>
</span><span id="__span-89-15"><a id="__codelineno-89-15" name="__codelineno-89-15" href="#__codelineno-89-15"></a><span class="s2">                    &quot;response&quot;: &quot;[your reason here and a response to get the user back on track with the agent goal]&quot;</span>
</span><span id="__span-89-16"><a id="__codelineno-89-16" name="__codelineno-89-16" href="#__codelineno-89-16"></a><span class="s2">                </span><span class="se">}}</span>
</span><span id="__span-89-17"><a id="__codelineno-89-17" name="__codelineno-89-17" href="#__codelineno-89-17"></a><span class="s2">                If validationResult is true (the prompt makes sense), return an empty dict as its value </span><span class="se">{{}}</span><span class="s2">&quot;</span>
</span><span id="__span-89-18"><a id="__codelineno-89-18" name="__codelineno-89-18" href="#__codelineno-89-18"></a><span class="s2">            &quot;&quot;&quot;</span>
</span></code></pre></div>
<p>Finally, instantiate a <code>ToolPromptInput</code> object and pass that to <code>agent_toolPlanner</code> to execute:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a>        <span class="c1"># Call the LLM with the validation prompt</span>
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a>        <span class="n">prompt_input</span> <span class="o">=</span> <span class="n">ToolPromptInput</span><span class="p">(</span>
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">validation_prompt</span><span class="p">,</span> <span class="n">context_instructions</span><span class="o">=</span><span class="n">context_instructions</span>
</span><span id="__span-90-4"><a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a>        <span class="p">)</span>
</span><span id="__span-90-5"><a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a>
</span><span id="__span-90-6"><a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_toolPlanner</span><span class="p">(</span><span class="n">prompt_input</span><span class="p">)</span>
</span><span id="__span-90-7"><a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a>
</span><span id="__span-90-8"><a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a>        <span class="k">return</span> <span class="n">ValidationResult</span><span class="p">(</span>
</span><span id="__span-90-9"><a id="__codelineno-90-9" name="__codelineno-90-9" href="#__codelineno-90-9"></a>            <span class="n">validationResult</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validationResult&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="__span-90-10"><a id="__codelineno-90-10" name="__codelineno-90-10" href="#__codelineno-90-10"></a>            <span class="n">validationFailedReason</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validationFailedReason&quot;</span><span class="p">,</span> <span class="p">{}),</span>
</span><span id="__span-90-11"><a id="__codelineno-90-11" name="__codelineno-90-11" href="#__codelineno-90-11"></a>        <span class="p">)</span>
</span></code></pre></div>
<p>The complete implementation of <code>agent_validatePrompt</code> is as follows:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="nd">@activity</span><span class="o">.</span><span class="n">defn</span>
</span><span id="__span-91-2"><a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">agent_validatePrompt</span><span class="p">(</span>
</span><span id="__span-91-3"><a id="__codelineno-91-3" name="__codelineno-91-3" href="#__codelineno-91-3"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">validation_input</span><span class="p">:</span> <span class="n">ValidationInput</span>
</span><span id="__span-91-4"><a id="__codelineno-91-4" name="__codelineno-91-4" href="#__codelineno-91-4"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ValidationResult</span><span class="p">:</span>
</span><span id="__span-91-5"><a id="__codelineno-91-5" name="__codelineno-91-5" href="#__codelineno-91-5"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-91-6"><a id="__codelineno-91-6" name="__codelineno-91-6" href="#__codelineno-91-6"></a><span class="sd">        Validates the prompt in the context of the conversation history and agent goal.</span>
</span><span id="__span-91-7"><a id="__codelineno-91-7" name="__codelineno-91-7" href="#__codelineno-91-7"></a><span class="sd">        Returns a ValidationResult indicating if the prompt makes sense given the context.</span>
</span><span id="__span-91-8"><a id="__codelineno-91-8" name="__codelineno-91-8" href="#__codelineno-91-8"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-91-9"><a id="__codelineno-91-9" name="__codelineno-91-9" href="#__codelineno-91-9"></a>        <span class="c1"># Create simple context string describing tools and goals</span>
</span><span id="__span-91-10"><a id="__codelineno-91-10" name="__codelineno-91-10" href="#__codelineno-91-10"></a>        <span class="n">tools_description</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-91-11"><a id="__codelineno-91-11" name="__codelineno-91-11" href="#__codelineno-91-11"></a>        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">validation_input</span><span class="o">.</span><span class="n">agent_goal</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span>
</span><span id="__span-91-12"><a id="__codelineno-91-12" name="__codelineno-91-12" href="#__codelineno-91-12"></a>            <span class="n">tool_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tool: </span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-91-13"><a id="__codelineno-91-13" name="__codelineno-91-13" href="#__codelineno-91-13"></a>            <span class="n">tool_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Description: </span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-91-14"><a id="__codelineno-91-14" name="__codelineno-91-14" href="#__codelineno-91-14"></a>            <span class="n">tool_str</span> <span class="o">+=</span> <span class="s2">&quot;Arguments: &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-91-15"><a id="__codelineno-91-15" name="__codelineno-91-15" href="#__codelineno-91-15"></a>                <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">tool</span><span class="o">.</span><span class="n">arguments</span><span class="p">]</span>
</span><span id="__span-91-16"><a id="__codelineno-91-16" name="__codelineno-91-16" href="#__codelineno-91-16"></a>            <span class="p">)</span>
</span><span id="__span-91-17"><a id="__codelineno-91-17" name="__codelineno-91-17" href="#__codelineno-91-17"></a>            <span class="n">tools_description</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_str</span><span class="p">)</span>
</span><span id="__span-91-18"><a id="__codelineno-91-18" name="__codelineno-91-18" href="#__codelineno-91-18"></a>        <span class="n">tools_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tools_description</span><span class="p">)</span>
</span><span id="__span-91-19"><a id="__codelineno-91-19" name="__codelineno-91-19" href="#__codelineno-91-19"></a>
</span><span id="__span-91-20"><a id="__codelineno-91-20" name="__codelineno-91-20" href="#__codelineno-91-20"></a>        <span class="c1"># Convert conversation history to string</span>
</span><span id="__span-91-21"><a id="__codelineno-91-21" name="__codelineno-91-21" href="#__codelineno-91-21"></a>        <span class="n">history_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">validation_input</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-91-22"><a id="__codelineno-91-22" name="__codelineno-91-22" href="#__codelineno-91-22"></a>
</span><span id="__span-91-23"><a id="__codelineno-91-23" name="__codelineno-91-23" href="#__codelineno-91-23"></a>        <span class="c1"># Create context instructions</span>
</span><span id="__span-91-24"><a id="__codelineno-91-24" name="__codelineno-91-24" href="#__codelineno-91-24"></a>        <span class="n">context_instructions</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;The agent goal and tools are as follows:</span>
</span><span id="__span-91-25"><a id="__codelineno-91-25" name="__codelineno-91-25" href="#__codelineno-91-25"></a><span class="s2">            Description: </span><span class="si">{</span><span class="n">validation_input</span><span class="o">.</span><span class="n">agent_goal</span><span class="o">.</span><span class="n">description</span><span class="si">}</span>
</span><span id="__span-91-26"><a id="__codelineno-91-26" name="__codelineno-91-26" href="#__codelineno-91-26"></a><span class="s2">            Available Tools:</span>
</span><span id="__span-91-27"><a id="__codelineno-91-27" name="__codelineno-91-27" href="#__codelineno-91-27"></a><span class="s2">            </span><span class="si">{</span><span class="n">tools_str</span><span class="si">}</span>
</span><span id="__span-91-28"><a id="__codelineno-91-28" name="__codelineno-91-28" href="#__codelineno-91-28"></a><span class="s2">            The conversation history to date is:</span>
</span><span id="__span-91-29"><a id="__codelineno-91-29" name="__codelineno-91-29" href="#__codelineno-91-29"></a><span class="s2">            </span><span class="si">{</span><span class="n">history_str</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-91-30"><a id="__codelineno-91-30" name="__codelineno-91-30" href="#__codelineno-91-30"></a>
</span><span id="__span-91-31"><a id="__codelineno-91-31" name="__codelineno-91-31" href="#__codelineno-91-31"></a>        <span class="c1"># Create validation prompt</span>
</span><span id="__span-91-32"><a id="__codelineno-91-32" name="__codelineno-91-32" href="#__codelineno-91-32"></a>        <span class="n">validation_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;The user&#39;s prompt is: &quot;</span><span class="si">{</span><span class="n">validation_input</span><span class="o">.</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-91-33"><a id="__codelineno-91-33" name="__codelineno-91-33" href="#__codelineno-91-33"></a><span class="s2">            Please validate if this prompt makes sense given the agent goal and conversation history.</span>
</span><span id="__span-91-34"><a id="__codelineno-91-34" name="__codelineno-91-34" href="#__codelineno-91-34"></a><span class="s2">            If the prompt makes sense toward the goal then validationResult should be true.</span>
</span><span id="__span-91-35"><a id="__codelineno-91-35" name="__codelineno-91-35" href="#__codelineno-91-35"></a><span class="s2">            If the prompt is wildly nonsensical or makes no sense toward the goal and current conversation history then validationResult should be false.</span>
</span><span id="__span-91-36"><a id="__codelineno-91-36" name="__codelineno-91-36" href="#__codelineno-91-36"></a><span class="s2">            If the response is low content such as &quot;yes&quot; or &quot;that&#39;s right&quot; then the user is probably responding to a previous prompt.  </span>
</span><span id="__span-91-37"><a id="__codelineno-91-37" name="__codelineno-91-37" href="#__codelineno-91-37"></a><span class="s2">             Therefore examine it in the context of the conversation history to determine if it makes sense and return true if it makes sense.</span>
</span><span id="__span-91-38"><a id="__codelineno-91-38" name="__codelineno-91-38" href="#__codelineno-91-38"></a><span class="s2">            Return ONLY a JSON object with the following structure:</span>
</span><span id="__span-91-39"><a id="__codelineno-91-39" name="__codelineno-91-39" href="#__codelineno-91-39"></a><span class="s2">                &quot;validationResult&quot;: true/false,</span>
</span><span id="__span-91-40"><a id="__codelineno-91-40" name="__codelineno-91-40" href="#__codelineno-91-40"></a><span class="s2">                &quot;validationFailedReason&quot;: &quot;If validationResult is false, provide a clear explanation to the user in the response field </span>
</span><span id="__span-91-41"><a id="__codelineno-91-41" name="__codelineno-91-41" href="#__codelineno-91-41"></a><span class="s2">                about why their request doesn&#39;t make sense in the context and what information they should provide instead.</span>
</span><span id="__span-91-42"><a id="__codelineno-91-42" name="__codelineno-91-42" href="#__codelineno-91-42"></a><span class="s2">                validationFailedReason should contain JSON in the format</span>
</span><span id="__span-91-43"><a id="__codelineno-91-43" name="__codelineno-91-43" href="#__codelineno-91-43"></a><span class="s2">                </span><span class="se">{{</span>
</span><span id="__span-91-44"><a id="__codelineno-91-44" name="__codelineno-91-44" href="#__codelineno-91-44"></a><span class="s2">                    &quot;next&quot;: &quot;question&quot;,</span>
</span><span id="__span-91-45"><a id="__codelineno-91-45" name="__codelineno-91-45" href="#__codelineno-91-45"></a><span class="s2">                    &quot;response&quot;: &quot;[your reason here and a response to get the user back on track with the agent goal]&quot;</span>
</span><span id="__span-91-46"><a id="__codelineno-91-46" name="__codelineno-91-46" href="#__codelineno-91-46"></a><span class="s2">                </span><span class="se">}}</span>
</span><span id="__span-91-47"><a id="__codelineno-91-47" name="__codelineno-91-47" href="#__codelineno-91-47"></a><span class="s2">                If validationResult is true (the prompt makes sense), return an empty dict as its value </span><span class="se">{{}}</span><span class="s2">&quot;</span>
</span><span id="__span-91-48"><a id="__codelineno-91-48" name="__codelineno-91-48" href="#__codelineno-91-48"></a><span class="s2">            &quot;&quot;&quot;</span>
</span><span id="__span-91-49"><a id="__codelineno-91-49" name="__codelineno-91-49" href="#__codelineno-91-49"></a>
</span><span id="__span-91-50"><a id="__codelineno-91-50" name="__codelineno-91-50" href="#__codelineno-91-50"></a>        <span class="c1"># Call the LLM with the validation prompt</span>
</span><span id="__span-91-51"><a id="__codelineno-91-51" name="__codelineno-91-51" href="#__codelineno-91-51"></a>        <span class="n">prompt_input</span> <span class="o">=</span> <span class="n">ToolPromptInput</span><span class="p">(</span>
</span><span id="__span-91-52"><a id="__codelineno-91-52" name="__codelineno-91-52" href="#__codelineno-91-52"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">validation_prompt</span><span class="p">,</span> <span class="n">context_instructions</span><span class="o">=</span><span class="n">context_instructions</span>
</span><span id="__span-91-53"><a id="__codelineno-91-53" name="__codelineno-91-53" href="#__codelineno-91-53"></a>        <span class="p">)</span>
</span><span id="__span-91-54"><a id="__codelineno-91-54" name="__codelineno-91-54" href="#__codelineno-91-54"></a>
</span><span id="__span-91-55"><a id="__codelineno-91-55" name="__codelineno-91-55" href="#__codelineno-91-55"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_toolPlanner</span><span class="p">(</span><span class="n">prompt_input</span><span class="p">)</span>
</span><span id="__span-91-56"><a id="__codelineno-91-56" name="__codelineno-91-56" href="#__codelineno-91-56"></a>
</span><span id="__span-91-57"><a id="__codelineno-91-57" name="__codelineno-91-57" href="#__codelineno-91-57"></a>        <span class="k">return</span> <span class="n">ValidationResult</span><span class="p">(</span>
</span><span id="__span-91-58"><a id="__codelineno-91-58" name="__codelineno-91-58" href="#__codelineno-91-58"></a>            <span class="n">validationResult</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validationResult&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="__span-91-59"><a id="__codelineno-91-59" name="__codelineno-91-59" href="#__codelineno-91-59"></a>            <span class="n">validationFailedReason</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validationFailedReason&quot;</span><span class="p">,</span> <span class="p">{}),</span>
</span><span id="__span-91-60"><a id="__codelineno-91-60" name="__codelineno-91-60" href="#__codelineno-91-60"></a>        <span class="p">)</span>
</span></code></pre></div>
<p>Calling an Activity within another Activity won't invoke that Activity, but will call the method like a typical Python method.
The Activity then returns a <code>ValidationResult</code> for the agent to interpret and continue with its execution.</p>
<h4 id="implementing-the-activity-for-retrieving-environment-variables">Implementing the Activity for retrieving environment variables<a class="headerlink" href="#implementing-the-activity-for-retrieving-environment-variables" title="Permanent link">&para;</a></h4>
<p>The final Activity within the <code>AgentActivities</code> class is the <code>get_wf_env_vars</code> Activity.
This Activity reads certain environment variables that need to be known within the Workflow.
Since reading from the file system is a potentially non-deterministic operation, this must happen within an Activity.</p>
<p>Add the following code within the <code>AgentActivities</code> class to implement the Activity:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a>    <span class="nd">@activity</span><span class="o">.</span><span class="n">defn</span>
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_wf_env_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">EnvLookupInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnvLookupOutput</span><span class="p">:</span>
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;gets env vars for workflow as an activity result so it&#39;s deterministic</span>
</span><span id="__span-92-4"><a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a><span class="sd">        handles default/None</span>
</span><span id="__span-92-5"><a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-92-6"><a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a>        <span class="n">output</span><span class="p">:</span> <span class="n">EnvLookupOutput</span> <span class="o">=</span> <span class="n">EnvLookupOutput</span><span class="p">(</span>
</span><span id="__span-92-7"><a id="__codelineno-92-7" name="__codelineno-92-7" href="#__codelineno-92-7"></a>            <span class="n">show_confirm</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">show_confirm_default</span>
</span><span id="__span-92-8"><a id="__codelineno-92-8" name="__codelineno-92-8" href="#__codelineno-92-8"></a>        <span class="p">)</span>
</span><span id="__span-92-9"><a id="__codelineno-92-9" name="__codelineno-92-9" href="#__codelineno-92-9"></a>        <span class="n">show_confirm_value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">show_confirm_env_var_name</span><span class="p">)</span>
</span><span id="__span-92-10"><a id="__codelineno-92-10" name="__codelineno-92-10" href="#__codelineno-92-10"></a>        <span class="k">if</span> <span class="n">show_confirm_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-92-11"><a id="__codelineno-92-11" name="__codelineno-92-11" href="#__codelineno-92-11"></a>            <span class="n">output</span><span class="o">.</span><span class="n">show_confirm</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">show_confirm_default</span>
</span><span id="__span-92-12"><a id="__codelineno-92-12" name="__codelineno-92-12" href="#__codelineno-92-12"></a>        <span class="k">elif</span> <span class="n">show_confirm_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">show_confirm_value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
</span><span id="__span-92-13"><a id="__codelineno-92-13" name="__codelineno-92-13" href="#__codelineno-92-13"></a>            <span class="n">output</span><span class="o">.</span><span class="n">show_confirm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-92-14"><a id="__codelineno-92-14" name="__codelineno-92-14" href="#__codelineno-92-14"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-92-15"><a id="__codelineno-92-15" name="__codelineno-92-15" href="#__codelineno-92-15"></a>            <span class="n">output</span><span class="o">.</span><span class="n">show_confirm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-92-16"><a id="__codelineno-92-16" name="__codelineno-92-16" href="#__codelineno-92-16"></a>
</span><span id="__span-92-17"><a id="__codelineno-92-17" name="__codelineno-92-17" href="#__codelineno-92-17"></a>        <span class="k">return</span> <span class="n">output</span>
</span></code></pre></div>
<p>This Activity reads the environment variables and ensures that <code>show_confirm_value</code> is set, returning your custom <code>EnvLookupOutput</code> type.
While this type may only contain one value at the moment, having it designed with this custom type allows you to expand this method later if necessary.</p>
<p>You have implemented all Activities within the <code>AgentActivities</code> class, but there is still one Activity left to implement, the Activity for executing the tools.</p>
<h3 id="implementing-dynamic-tool-execution">Implementing dynamic tool execution<a class="headerlink" href="#implementing-dynamic-tool-execution" title="Permanent link">&para;</a></h3>
<p>The final Activity enables runtime execution of any tool from your registry. 
To enable this, you must use <a href="https://docs.temporal.io/develop/python/message-passing#set-a-dynamic-activity">Dynamic Activities</a>, which are necessary when you request execution of an Activity with an unknown <a href="https://docs.temporal.io/activity-definition#activity-type">Activity Type</a>.
Since your tools are loaded in dynamically, this is a perfect example of when to use Temporal's Dynamic Activities.</p>
<p>This Activity will <strong>not</strong> be implemented as a method within the class, but rather a function within the same <code>activities.py</code> file.</p>
<p>Add this function outside the class definition:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="nd">@activity</span><span class="o">.</span><span class="n">defn</span><span class="p">(</span><span class="n">dynamic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dynamic_tool_activity</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">RawValue</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-93-3"><a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">tools.tool_registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_handler</span>
</span><span id="__span-93-4"><a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a>
</span><span id="__span-93-5"><a id="__codelineno-93-5" name="__codelineno-93-5" href="#__codelineno-93-5"></a>    <span class="n">tool_name</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="n">info</span><span class="p">()</span><span class="o">.</span><span class="n">activity_type</span>  <span class="c1"># e.g. &quot;FindEvents&quot;</span>
</span><span id="__span-93-6"><a id="__codelineno-93-6" name="__codelineno-93-6" href="#__codelineno-93-6"></a>    <span class="n">tool_args</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="n">payload_converter</span><span class="p">()</span><span class="o">.</span><span class="n">from_payload</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</span><span id="__span-93-7"><a id="__codelineno-93-7" name="__codelineno-93-7" href="#__codelineno-93-7"></a>    <span class="n">activity</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running dynamic tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39; with args: </span><span class="si">{</span><span class="n">tool_args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-93-8"><a id="__codelineno-93-8" name="__codelineno-93-8" href="#__codelineno-93-8"></a>
</span><span id="__span-93-9"><a id="__codelineno-93-9" name="__codelineno-93-9" href="#__codelineno-93-9"></a>    <span class="c1"># Delegate to the relevant function</span>
</span><span id="__span-93-10"><a id="__codelineno-93-10" name="__codelineno-93-10" href="#__codelineno-93-10"></a>    <span class="n">handler</span> <span class="o">=</span> <span class="n">get_handler</span><span class="p">(</span><span class="n">tool_name</span><span class="p">)</span>
</span><span id="__span-93-11"><a id="__codelineno-93-11" name="__codelineno-93-11" href="#__codelineno-93-11"></a>    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
</span><span id="__span-93-12"><a id="__codelineno-93-12" name="__codelineno-93-12" href="#__codelineno-93-12"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="n">tool_args</span><span class="p">)</span>
</span><span id="__span-93-13"><a id="__codelineno-93-13" name="__codelineno-93-13" href="#__codelineno-93-13"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-93-14"><a id="__codelineno-93-14" name="__codelineno-93-14" href="#__codelineno-93-14"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">tool_args</span><span class="p">)</span>
</span><span id="__span-93-15"><a id="__codelineno-93-15" name="__codelineno-93-15" href="#__codelineno-93-15"></a>
</span><span id="__span-93-16"><a id="__codelineno-93-16" name="__codelineno-93-16" href="#__codelineno-93-16"></a>    <span class="c1"># Optionally log or augment the result</span>
</span><span id="__span-93-17"><a id="__codelineno-93-17" name="__codelineno-93-17" href="#__codelineno-93-17"></a>    <span class="n">activity</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39; result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-93-18"><a id="__codelineno-93-18" name="__codelineno-93-18" href="#__codelineno-93-18"></a>    <span class="k">return</span> <span class="n">result</span>
</span></code></pre></div>
<p>This dynamic Activity uses Temporal's runtime information to determine which tool to execute. 
It retrieves the tool name from the Activity type and loads arguments from the payload.
It then inspects the handler to determine if the implementation of the tool is an asynchronous Python function. If it is, it <code>await</code>s its execution, otherwise it directly invokes the function.
This means the Activity handles both synchronous and asynchronous tool functions.</p>
<details>

<summary>
The <code>activities/activities.py</code> is complete and will need no more revisions. You can review the complete file and copy the code here.
</summary>

<br />
Hover your cursor over the code block to reveal the copy-code option.
<br />
<br />

[activities/activities.py](https://github.com/temporal-community/tutorial-temporal-ai-agent/blob/main/activities/activities.py)


<div class="language-python highlight"><pre><span></span><code><span id="__span-94-1"><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
</span><span id="__span-94-2"><a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-94-3"><a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-94-4"><a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="__span-94-5"><a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span>
</span><span id="__span-94-6"><a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a>
</span><span id="__span-94-7"><a id="__codelineno-94-7" name="__codelineno-94-7" href="#__codelineno-94-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
</span><span id="__span-94-8"><a id="__codelineno-94-8" name="__codelineno-94-8" href="#__codelineno-94-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">litellm</span><span class="w"> </span><span class="kn">import</span> <span class="n">completion</span>
</span><span id="__span-94-9"><a id="__codelineno-94-9" name="__codelineno-94-9" href="#__codelineno-94-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio</span><span class="w"> </span><span class="kn">import</span> <span class="n">activity</span>
</span><span id="__span-94-10"><a id="__codelineno-94-10" name="__codelineno-94-10" href="#__codelineno-94-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">RawValue</span>
</span><span id="__span-94-11"><a id="__codelineno-94-11" name="__codelineno-94-11" href="#__codelineno-94-11"></a>
</span><span id="__span-94-12"><a id="__codelineno-94-12" name="__codelineno-94-12" href="#__codelineno-94-12"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-94-13"><a id="__codelineno-94-13" name="__codelineno-94-13" href="#__codelineno-94-13"></a>    <span class="n">EnvLookupInput</span><span class="p">,</span>
</span><span id="__span-94-14"><a id="__codelineno-94-14" name="__codelineno-94-14" href="#__codelineno-94-14"></a>    <span class="n">EnvLookupOutput</span><span class="p">,</span>
</span><span id="__span-94-15"><a id="__codelineno-94-15" name="__codelineno-94-15" href="#__codelineno-94-15"></a>    <span class="n">ToolPromptInput</span><span class="p">,</span>
</span><span id="__span-94-16"><a id="__codelineno-94-16" name="__codelineno-94-16" href="#__codelineno-94-16"></a>    <span class="n">ValidationInput</span><span class="p">,</span>
</span><span id="__span-94-17"><a id="__codelineno-94-17" name="__codelineno-94-17" href="#__codelineno-94-17"></a>    <span class="n">ValidationResult</span><span class="p">,</span>
</span><span id="__span-94-18"><a id="__codelineno-94-18" name="__codelineno-94-18" href="#__codelineno-94-18"></a><span class="p">)</span>
</span><span id="__span-94-19"><a id="__codelineno-94-19" name="__codelineno-94-19" href="#__codelineno-94-19"></a>
</span><span id="__span-94-20"><a id="__codelineno-94-20" name="__codelineno-94-20" href="#__codelineno-94-20"></a><span class="n">load_dotenv</span><span class="p">(</span><span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-94-21"><a id="__codelineno-94-21" name="__codelineno-94-21" href="#__codelineno-94-21"></a>
</span><span id="__span-94-22"><a id="__codelineno-94-22" name="__codelineno-94-22" href="#__codelineno-94-22"></a>
</span><span id="__span-94-23"><a id="__codelineno-94-23" name="__codelineno-94-23" href="#__codelineno-94-23"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentActivities</span><span class="p">:</span>
</span><span id="__span-94-24"><a id="__codelineno-94-24" name="__codelineno-94-24" href="#__codelineno-94-24"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-94-25"><a id="__codelineno-94-25" name="__codelineno-94-25" href="#__codelineno-94-25"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize LLM client using LiteLLM.&quot;&quot;&quot;</span>
</span><span id="__span-94-26"><a id="__codelineno-94-26" name="__codelineno-94-26" href="#__codelineno-94-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm_model</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LLM_MODEL&quot;</span><span class="p">,</span> <span class="s2">&quot;openai/gpt-4&quot;</span><span class="p">)</span>
</span><span id="__span-94-27"><a id="__codelineno-94-27" name="__codelineno-94-27" href="#__codelineno-94-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LLM_KEY&quot;</span><span class="p">)</span>
</span><span id="__span-94-28"><a id="__codelineno-94-28" name="__codelineno-94-28" href="#__codelineno-94-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm_base_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LLM_BASE_URL&quot;</span><span class="p">)</span>
</span><span id="__span-94-29"><a id="__codelineno-94-29" name="__codelineno-94-29" href="#__codelineno-94-29"></a>        <span class="n">activity</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-94-30"><a id="__codelineno-94-30" name="__codelineno-94-30" href="#__codelineno-94-30"></a>            <span class="sa">f</span><span class="s2">&quot;Initializing AgentActivities with LLM model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_model</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-94-31"><a id="__codelineno-94-31" name="__codelineno-94-31" href="#__codelineno-94-31"></a>        <span class="p">)</span>
</span><span id="__span-94-32"><a id="__codelineno-94-32" name="__codelineno-94-32" href="#__codelineno-94-32"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_base_url</span><span class="p">:</span>
</span><span id="__span-94-33"><a id="__codelineno-94-33" name="__codelineno-94-33" href="#__codelineno-94-33"></a>            <span class="n">activity</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using custom base URL: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_base_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-94-34"><a id="__codelineno-94-34" name="__codelineno-94-34" href="#__codelineno-94-34"></a>
</span><span id="__span-94-35"><a id="__codelineno-94-35" name="__codelineno-94-35" href="#__codelineno-94-35"></a>    <span class="nd">@activity</span><span class="o">.</span><span class="n">defn</span>
</span><span id="__span-94-36"><a id="__codelineno-94-36" name="__codelineno-94-36" href="#__codelineno-94-36"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">agent_toolPlanner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">ToolPromptInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-94-37"><a id="__codelineno-94-37" name="__codelineno-94-37" href="#__codelineno-94-37"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-94-38"><a id="__codelineno-94-38" name="__codelineno-94-38" href="#__codelineno-94-38"></a>            <span class="p">{</span>
</span><span id="__span-94-39"><a id="__codelineno-94-39" name="__codelineno-94-39" href="#__codelineno-94-39"></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>
</span><span id="__span-94-40"><a id="__codelineno-94-40" name="__codelineno-94-40" href="#__codelineno-94-40"></a>                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="nb">input</span><span class="o">.</span><span class="n">context_instructions</span>
</span><span id="__span-94-41"><a id="__codelineno-94-41" name="__codelineno-94-41" href="#__codelineno-94-41"></a>                <span class="o">+</span> <span class="s2">&quot;. The current date is &quot;</span>
</span><span id="__span-94-42"><a id="__codelineno-94-42" name="__codelineno-94-42" href="#__codelineno-94-42"></a>                <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%B </span><span class="si">%d</span><span class="s2">, %Y&quot;</span><span class="p">),</span>
</span><span id="__span-94-43"><a id="__codelineno-94-43" name="__codelineno-94-43" href="#__codelineno-94-43"></a>            <span class="p">},</span>
</span><span id="__span-94-44"><a id="__codelineno-94-44" name="__codelineno-94-44" href="#__codelineno-94-44"></a>            <span class="p">{</span>
</span><span id="__span-94-45"><a id="__codelineno-94-45" name="__codelineno-94-45" href="#__codelineno-94-45"></a>                <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="__span-94-46"><a id="__codelineno-94-46" name="__codelineno-94-46" href="#__codelineno-94-46"></a>                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="nb">input</span><span class="o">.</span><span class="n">prompt</span><span class="p">,</span>
</span><span id="__span-94-47"><a id="__codelineno-94-47" name="__codelineno-94-47" href="#__codelineno-94-47"></a>            <span class="p">},</span>
</span><span id="__span-94-48"><a id="__codelineno-94-48" name="__codelineno-94-48" href="#__codelineno-94-48"></a>        <span class="p">]</span>
</span><span id="__span-94-49"><a id="__codelineno-94-49" name="__codelineno-94-49" href="#__codelineno-94-49"></a>
</span><span id="__span-94-50"><a id="__codelineno-94-50" name="__codelineno-94-50" href="#__codelineno-94-50"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-94-51"><a id="__codelineno-94-51" name="__codelineno-94-51" href="#__codelineno-94-51"></a>            <span class="n">completion_kwargs</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-94-52"><a id="__codelineno-94-52" name="__codelineno-94-52" href="#__codelineno-94-52"></a>                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_model</span><span class="p">,</span>
</span><span id="__span-94-53"><a id="__codelineno-94-53" name="__codelineno-94-53" href="#__codelineno-94-53"></a>                <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span>
</span><span id="__span-94-54"><a id="__codelineno-94-54" name="__codelineno-94-54" href="#__codelineno-94-54"></a>                <span class="s2">&quot;api_key&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_key</span><span class="p">,</span>
</span><span id="__span-94-55"><a id="__codelineno-94-55" name="__codelineno-94-55" href="#__codelineno-94-55"></a>            <span class="p">}</span>
</span><span id="__span-94-56"><a id="__codelineno-94-56" name="__codelineno-94-56" href="#__codelineno-94-56"></a>
</span><span id="__span-94-57"><a id="__codelineno-94-57" name="__codelineno-94-57" href="#__codelineno-94-57"></a>            <span class="c1"># Add base_url if configured</span>
</span><span id="__span-94-58"><a id="__codelineno-94-58" name="__codelineno-94-58" href="#__codelineno-94-58"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_base_url</span><span class="p">:</span>
</span><span id="__span-94-59"><a id="__codelineno-94-59" name="__codelineno-94-59" href="#__codelineno-94-59"></a>                <span class="n">completion_kwargs</span><span class="p">[</span><span class="s2">&quot;base_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_base_url</span>
</span><span id="__span-94-60"><a id="__codelineno-94-60" name="__codelineno-94-60" href="#__codelineno-94-60"></a>
</span><span id="__span-94-61"><a id="__codelineno-94-61" name="__codelineno-94-61" href="#__codelineno-94-61"></a>            <span class="n">response</span> <span class="o">=</span> <span class="n">completion</span><span class="p">(</span><span class="o">**</span><span class="n">completion_kwargs</span><span class="p">)</span>
</span><span id="__span-94-62"><a id="__codelineno-94-62" name="__codelineno-94-62" href="#__codelineno-94-62"></a>
</span><span id="__span-94-63"><a id="__codelineno-94-63" name="__codelineno-94-63" href="#__codelineno-94-63"></a>            <span class="n">response_content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span><span id="__span-94-64"><a id="__codelineno-94-64" name="__codelineno-94-64" href="#__codelineno-94-64"></a>            <span class="n">activity</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LLM response: </span><span class="si">{</span><span class="n">response_content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-94-65"><a id="__codelineno-94-65" name="__codelineno-94-65" href="#__codelineno-94-65"></a>
</span><span id="__span-94-66"><a id="__codelineno-94-66" name="__codelineno-94-66" href="#__codelineno-94-66"></a>            <span class="c1"># Use the new sanitize function</span>
</span><span id="__span-94-67"><a id="__codelineno-94-67" name="__codelineno-94-67" href="#__codelineno-94-67"></a>            <span class="n">response_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sanitize_json_response</span><span class="p">(</span><span class="n">response_content</span><span class="p">)</span>
</span><span id="__span-94-68"><a id="__codelineno-94-68" name="__codelineno-94-68" href="#__codelineno-94-68"></a>
</span><span id="__span-94-69"><a id="__codelineno-94-69" name="__codelineno-94-69" href="#__codelineno-94-69"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_json_response</span><span class="p">(</span><span class="n">response_content</span><span class="p">)</span>
</span><span id="__span-94-70"><a id="__codelineno-94-70" name="__codelineno-94-70" href="#__codelineno-94-70"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-94-71"><a id="__codelineno-94-71" name="__codelineno-94-71" href="#__codelineno-94-71"></a>            <span class="n">activity</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in LLM completion: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-94-72"><a id="__codelineno-94-72" name="__codelineno-94-72" href="#__codelineno-94-72"></a>            <span class="k">raise</span>
</span><span id="__span-94-73"><a id="__codelineno-94-73" name="__codelineno-94-73" href="#__codelineno-94-73"></a>
</span><span id="__span-94-74"><a id="__codelineno-94-74" name="__codelineno-94-74" href="#__codelineno-94-74"></a>    <span class="nd">@activity</span><span class="o">.</span><span class="n">defn</span>
</span><span id="__span-94-75"><a id="__codelineno-94-75" name="__codelineno-94-75" href="#__codelineno-94-75"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">agent_validatePrompt</span><span class="p">(</span>
</span><span id="__span-94-76"><a id="__codelineno-94-76" name="__codelineno-94-76" href="#__codelineno-94-76"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">validation_input</span><span class="p">:</span> <span class="n">ValidationInput</span>
</span><span id="__span-94-77"><a id="__codelineno-94-77" name="__codelineno-94-77" href="#__codelineno-94-77"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ValidationResult</span><span class="p">:</span>
</span><span id="__span-94-78"><a id="__codelineno-94-78" name="__codelineno-94-78" href="#__codelineno-94-78"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-94-79"><a id="__codelineno-94-79" name="__codelineno-94-79" href="#__codelineno-94-79"></a><span class="sd">        Validates the prompt in the context of the conversation history and agent goal.</span>
</span><span id="__span-94-80"><a id="__codelineno-94-80" name="__codelineno-94-80" href="#__codelineno-94-80"></a><span class="sd">        Returns a ValidationResult indicating if the prompt makes sense given the context.</span>
</span><span id="__span-94-81"><a id="__codelineno-94-81" name="__codelineno-94-81" href="#__codelineno-94-81"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-94-82"><a id="__codelineno-94-82" name="__codelineno-94-82" href="#__codelineno-94-82"></a>        <span class="c1"># Create simple context string describing tools and goals</span>
</span><span id="__span-94-83"><a id="__codelineno-94-83" name="__codelineno-94-83" href="#__codelineno-94-83"></a>        <span class="n">tools_description</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-94-84"><a id="__codelineno-94-84" name="__codelineno-94-84" href="#__codelineno-94-84"></a>        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">validation_input</span><span class="o">.</span><span class="n">agent_goal</span><span class="o">.</span><span class="n">tools</span><span class="p">:</span>
</span><span id="__span-94-85"><a id="__codelineno-94-85" name="__codelineno-94-85" href="#__codelineno-94-85"></a>            <span class="n">tool_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tool: </span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-94-86"><a id="__codelineno-94-86" name="__codelineno-94-86" href="#__codelineno-94-86"></a>            <span class="n">tool_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Description: </span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="__span-94-87"><a id="__codelineno-94-87" name="__codelineno-94-87" href="#__codelineno-94-87"></a>            <span class="n">tool_str</span> <span class="o">+=</span> <span class="s2">&quot;Arguments: &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="__span-94-88"><a id="__codelineno-94-88" name="__codelineno-94-88" href="#__codelineno-94-88"></a>                <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">arg</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">arg</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">tool</span><span class="o">.</span><span class="n">arguments</span><span class="p">]</span>
</span><span id="__span-94-89"><a id="__codelineno-94-89" name="__codelineno-94-89" href="#__codelineno-94-89"></a>            <span class="p">)</span>
</span><span id="__span-94-90"><a id="__codelineno-94-90" name="__codelineno-94-90" href="#__codelineno-94-90"></a>            <span class="n">tools_description</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_str</span><span class="p">)</span>
</span><span id="__span-94-91"><a id="__codelineno-94-91" name="__codelineno-94-91" href="#__codelineno-94-91"></a>        <span class="n">tools_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tools_description</span><span class="p">)</span>
</span><span id="__span-94-92"><a id="__codelineno-94-92" name="__codelineno-94-92" href="#__codelineno-94-92"></a>
</span><span id="__span-94-93"><a id="__codelineno-94-93" name="__codelineno-94-93" href="#__codelineno-94-93"></a>        <span class="c1"># Convert conversation history to string</span>
</span><span id="__span-94-94"><a id="__codelineno-94-94" name="__codelineno-94-94" href="#__codelineno-94-94"></a>        <span class="n">history_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">validation_input</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="__span-94-95"><a id="__codelineno-94-95" name="__codelineno-94-95" href="#__codelineno-94-95"></a>
</span><span id="__span-94-96"><a id="__codelineno-94-96" name="__codelineno-94-96" href="#__codelineno-94-96"></a>        <span class="c1"># Create context instructions</span>
</span><span id="__span-94-97"><a id="__codelineno-94-97" name="__codelineno-94-97" href="#__codelineno-94-97"></a>        <span class="n">context_instructions</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;The agent goal and tools are as follows:</span>
</span><span id="__span-94-98"><a id="__codelineno-94-98" name="__codelineno-94-98" href="#__codelineno-94-98"></a><span class="s2">            Description: </span><span class="si">{</span><span class="n">validation_input</span><span class="o">.</span><span class="n">agent_goal</span><span class="o">.</span><span class="n">description</span><span class="si">}</span>
</span><span id="__span-94-99"><a id="__codelineno-94-99" name="__codelineno-94-99" href="#__codelineno-94-99"></a><span class="s2">            Available Tools:</span>
</span><span id="__span-94-100"><a id="__codelineno-94-100" name="__codelineno-94-100" href="#__codelineno-94-100"></a><span class="s2">            </span><span class="si">{</span><span class="n">tools_str</span><span class="si">}</span>
</span><span id="__span-94-101"><a id="__codelineno-94-101" name="__codelineno-94-101" href="#__codelineno-94-101"></a><span class="s2">            The conversation history to date is:</span>
</span><span id="__span-94-102"><a id="__codelineno-94-102" name="__codelineno-94-102" href="#__codelineno-94-102"></a><span class="s2">            </span><span class="si">{</span><span class="n">history_str</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="__span-94-103"><a id="__codelineno-94-103" name="__codelineno-94-103" href="#__codelineno-94-103"></a>
</span><span id="__span-94-104"><a id="__codelineno-94-104" name="__codelineno-94-104" href="#__codelineno-94-104"></a>        <span class="c1"># Create validation prompt</span>
</span><span id="__span-94-105"><a id="__codelineno-94-105" name="__codelineno-94-105" href="#__codelineno-94-105"></a>        <span class="n">validation_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;The user&#39;s prompt is: &quot;</span><span class="si">{</span><span class="n">validation_input</span><span class="o">.</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-94-106"><a id="__codelineno-94-106" name="__codelineno-94-106" href="#__codelineno-94-106"></a><span class="s2">            Please validate if this prompt makes sense given the agent goal and conversation history.</span>
</span><span id="__span-94-107"><a id="__codelineno-94-107" name="__codelineno-94-107" href="#__codelineno-94-107"></a><span class="s2">            If the prompt makes sense toward the goal then validationResult should be true.</span>
</span><span id="__span-94-108"><a id="__codelineno-94-108" name="__codelineno-94-108" href="#__codelineno-94-108"></a><span class="s2">            If the prompt is wildly nonsensical or makes no sense toward the goal and current conversation history then validationResult should be false.</span>
</span><span id="__span-94-109"><a id="__codelineno-94-109" name="__codelineno-94-109" href="#__codelineno-94-109"></a><span class="s2">            If the response is low content such as &quot;yes&quot; or &quot;that&#39;s right&quot; then the user is probably responding to a previous prompt.  </span>
</span><span id="__span-94-110"><a id="__codelineno-94-110" name="__codelineno-94-110" href="#__codelineno-94-110"></a><span class="s2">             Therefore examine it in the context of the conversation history to determine if it makes sense and return true if it makes sense.</span>
</span><span id="__span-94-111"><a id="__codelineno-94-111" name="__codelineno-94-111" href="#__codelineno-94-111"></a><span class="s2">            Return ONLY a JSON object with the following structure:</span>
</span><span id="__span-94-112"><a id="__codelineno-94-112" name="__codelineno-94-112" href="#__codelineno-94-112"></a><span class="s2">                &quot;validationResult&quot;: true/false,</span>
</span><span id="__span-94-113"><a id="__codelineno-94-113" name="__codelineno-94-113" href="#__codelineno-94-113"></a><span class="s2">                &quot;validationFailedReason&quot;: &quot;If validationResult is false, provide a clear explanation to the user in the response field </span>
</span><span id="__span-94-114"><a id="__codelineno-94-114" name="__codelineno-94-114" href="#__codelineno-94-114"></a><span class="s2">                about why their request doesn&#39;t make sense in the context and what information they should provide instead.</span>
</span><span id="__span-94-115"><a id="__codelineno-94-115" name="__codelineno-94-115" href="#__codelineno-94-115"></a><span class="s2">                validationFailedReason should contain JSON in the format</span>
</span><span id="__span-94-116"><a id="__codelineno-94-116" name="__codelineno-94-116" href="#__codelineno-94-116"></a><span class="s2">                </span><span class="se">{{</span>
</span><span id="__span-94-117"><a id="__codelineno-94-117" name="__codelineno-94-117" href="#__codelineno-94-117"></a><span class="s2">                    &quot;next&quot;: &quot;question&quot;,</span>
</span><span id="__span-94-118"><a id="__codelineno-94-118" name="__codelineno-94-118" href="#__codelineno-94-118"></a><span class="s2">                    &quot;response&quot;: &quot;[your reason here and a response to get the user back on track with the agent goal]&quot;</span>
</span><span id="__span-94-119"><a id="__codelineno-94-119" name="__codelineno-94-119" href="#__codelineno-94-119"></a><span class="s2">                </span><span class="se">}}</span>
</span><span id="__span-94-120"><a id="__codelineno-94-120" name="__codelineno-94-120" href="#__codelineno-94-120"></a><span class="s2">                If validationResult is true (the prompt makes sense), return an empty dict as its value </span><span class="se">{{}}</span><span class="s2">&quot;</span>
</span><span id="__span-94-121"><a id="__codelineno-94-121" name="__codelineno-94-121" href="#__codelineno-94-121"></a><span class="s2">            &quot;&quot;&quot;</span>
</span><span id="__span-94-122"><a id="__codelineno-94-122" name="__codelineno-94-122" href="#__codelineno-94-122"></a>
</span><span id="__span-94-123"><a id="__codelineno-94-123" name="__codelineno-94-123" href="#__codelineno-94-123"></a>        <span class="c1"># Call the LLM with the validation prompt</span>
</span><span id="__span-94-124"><a id="__codelineno-94-124" name="__codelineno-94-124" href="#__codelineno-94-124"></a>        <span class="n">prompt_input</span> <span class="o">=</span> <span class="n">ToolPromptInput</span><span class="p">(</span>
</span><span id="__span-94-125"><a id="__codelineno-94-125" name="__codelineno-94-125" href="#__codelineno-94-125"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">validation_prompt</span><span class="p">,</span> <span class="n">context_instructions</span><span class="o">=</span><span class="n">context_instructions</span>
</span><span id="__span-94-126"><a id="__codelineno-94-126" name="__codelineno-94-126" href="#__codelineno-94-126"></a>        <span class="p">)</span>
</span><span id="__span-94-127"><a id="__codelineno-94-127" name="__codelineno-94-127" href="#__codelineno-94-127"></a>
</span><span id="__span-94-128"><a id="__codelineno-94-128" name="__codelineno-94-128" href="#__codelineno-94-128"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_toolPlanner</span><span class="p">(</span><span class="n">prompt_input</span><span class="p">)</span>
</span><span id="__span-94-129"><a id="__codelineno-94-129" name="__codelineno-94-129" href="#__codelineno-94-129"></a>
</span><span id="__span-94-130"><a id="__codelineno-94-130" name="__codelineno-94-130" href="#__codelineno-94-130"></a>        <span class="k">return</span> <span class="n">ValidationResult</span><span class="p">(</span>
</span><span id="__span-94-131"><a id="__codelineno-94-131" name="__codelineno-94-131" href="#__codelineno-94-131"></a>            <span class="n">validationResult</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validationResult&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
</span><span id="__span-94-132"><a id="__codelineno-94-132" name="__codelineno-94-132" href="#__codelineno-94-132"></a>            <span class="n">validationFailedReason</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validationFailedReason&quot;</span><span class="p">,</span> <span class="p">{}),</span>
</span><span id="__span-94-133"><a id="__codelineno-94-133" name="__codelineno-94-133" href="#__codelineno-94-133"></a>        <span class="p">)</span>
</span><span id="__span-94-134"><a id="__codelineno-94-134" name="__codelineno-94-134" href="#__codelineno-94-134"></a>
</span><span id="__span-94-135"><a id="__codelineno-94-135" name="__codelineno-94-135" href="#__codelineno-94-135"></a>    <span class="nd">@activity</span><span class="o">.</span><span class="n">defn</span>
</span><span id="__span-94-136"><a id="__codelineno-94-136" name="__codelineno-94-136" href="#__codelineno-94-136"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_wf_env_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="n">EnvLookupInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnvLookupOutput</span><span class="p">:</span>
</span><span id="__span-94-137"><a id="__codelineno-94-137" name="__codelineno-94-137" href="#__codelineno-94-137"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;gets env vars for workflow as an activity result so it&#39;s deterministic</span>
</span><span id="__span-94-138"><a id="__codelineno-94-138" name="__codelineno-94-138" href="#__codelineno-94-138"></a><span class="sd">        handles default/None</span>
</span><span id="__span-94-139"><a id="__codelineno-94-139" name="__codelineno-94-139" href="#__codelineno-94-139"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-94-140"><a id="__codelineno-94-140" name="__codelineno-94-140" href="#__codelineno-94-140"></a>        <span class="n">output</span><span class="p">:</span> <span class="n">EnvLookupOutput</span> <span class="o">=</span> <span class="n">EnvLookupOutput</span><span class="p">(</span>
</span><span id="__span-94-141"><a id="__codelineno-94-141" name="__codelineno-94-141" href="#__codelineno-94-141"></a>            <span class="n">show_confirm</span><span class="o">=</span><span class="nb">input</span><span class="o">.</span><span class="n">show_confirm_default</span>
</span><span id="__span-94-142"><a id="__codelineno-94-142" name="__codelineno-94-142" href="#__codelineno-94-142"></a>        <span class="p">)</span>
</span><span id="__span-94-143"><a id="__codelineno-94-143" name="__codelineno-94-143" href="#__codelineno-94-143"></a>        <span class="n">show_confirm_value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">show_confirm_env_var_name</span><span class="p">)</span>
</span><span id="__span-94-144"><a id="__codelineno-94-144" name="__codelineno-94-144" href="#__codelineno-94-144"></a>        <span class="k">if</span> <span class="n">show_confirm_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-94-145"><a id="__codelineno-94-145" name="__codelineno-94-145" href="#__codelineno-94-145"></a>            <span class="n">output</span><span class="o">.</span><span class="n">show_confirm</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">show_confirm_default</span>
</span><span id="__span-94-146"><a id="__codelineno-94-146" name="__codelineno-94-146" href="#__codelineno-94-146"></a>        <span class="k">elif</span> <span class="n">show_confirm_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">show_confirm_value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
</span><span id="__span-94-147"><a id="__codelineno-94-147" name="__codelineno-94-147" href="#__codelineno-94-147"></a>            <span class="n">output</span><span class="o">.</span><span class="n">show_confirm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-94-148"><a id="__codelineno-94-148" name="__codelineno-94-148" href="#__codelineno-94-148"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-94-149"><a id="__codelineno-94-149" name="__codelineno-94-149" href="#__codelineno-94-149"></a>            <span class="n">output</span><span class="o">.</span><span class="n">show_confirm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-94-150"><a id="__codelineno-94-150" name="__codelineno-94-150" href="#__codelineno-94-150"></a>
</span><span id="__span-94-151"><a id="__codelineno-94-151" name="__codelineno-94-151" href="#__codelineno-94-151"></a>        <span class="k">return</span> <span class="n">output</span>
</span><span id="__span-94-152"><a id="__codelineno-94-152" name="__codelineno-94-152" href="#__codelineno-94-152"></a>
</span><span id="__span-94-153"><a id="__codelineno-94-153" name="__codelineno-94-153" href="#__codelineno-94-153"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">sanitize_json_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-94-154"><a id="__codelineno-94-154" name="__codelineno-94-154" href="#__codelineno-94-154"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-94-155"><a id="__codelineno-94-155" name="__codelineno-94-155" href="#__codelineno-94-155"></a><span class="sd">        Sanitizes the response content to ensure it&#39;s valid JSON.</span>
</span><span id="__span-94-156"><a id="__codelineno-94-156" name="__codelineno-94-156" href="#__codelineno-94-156"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-94-157"><a id="__codelineno-94-157" name="__codelineno-94-157" href="#__codelineno-94-157"></a>        <span class="c1"># Remove any markdown code block markers</span>
</span><span id="__span-94-158"><a id="__codelineno-94-158" name="__codelineno-94-158" href="#__codelineno-94-158"></a>        <span class="n">response_content</span> <span class="o">=</span> <span class="n">response_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;```json&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-94-159"><a id="__codelineno-94-159" name="__codelineno-94-159" href="#__codelineno-94-159"></a>
</span><span id="__span-94-160"><a id="__codelineno-94-160" name="__codelineno-94-160" href="#__codelineno-94-160"></a>        <span class="c1"># Remove any leading/trailing whitespace</span>
</span><span id="__span-94-161"><a id="__codelineno-94-161" name="__codelineno-94-161" href="#__codelineno-94-161"></a>        <span class="n">response_content</span> <span class="o">=</span> <span class="n">response_content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="__span-94-162"><a id="__codelineno-94-162" name="__codelineno-94-162" href="#__codelineno-94-162"></a>
</span><span id="__span-94-163"><a id="__codelineno-94-163" name="__codelineno-94-163" href="#__codelineno-94-163"></a>        <span class="k">return</span> <span class="n">response_content</span>
</span><span id="__span-94-164"><a id="__codelineno-94-164" name="__codelineno-94-164" href="#__codelineno-94-164"></a>
</span><span id="__span-94-165"><a id="__codelineno-94-165" name="__codelineno-94-165" href="#__codelineno-94-165"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">parse_json_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-94-166"><a id="__codelineno-94-166" name="__codelineno-94-166" href="#__codelineno-94-166"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-94-167"><a id="__codelineno-94-167" name="__codelineno-94-167" href="#__codelineno-94-167"></a><span class="sd">        Parses the JSON response content and returns it as a dictionary.</span>
</span><span id="__span-94-168"><a id="__codelineno-94-168" name="__codelineno-94-168" href="#__codelineno-94-168"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-94-169"><a id="__codelineno-94-169" name="__codelineno-94-169" href="#__codelineno-94-169"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-94-170"><a id="__codelineno-94-170" name="__codelineno-94-170" href="#__codelineno-94-170"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response_content</span><span class="p">)</span>
</span><span id="__span-94-171"><a id="__codelineno-94-171" name="__codelineno-94-171" href="#__codelineno-94-171"></a>            <span class="k">return</span> <span class="n">data</span>
</span><span id="__span-94-172"><a id="__codelineno-94-172" name="__codelineno-94-172" href="#__codelineno-94-172"></a>        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-94-173"><a id="__codelineno-94-173" name="__codelineno-94-173" href="#__codelineno-94-173"></a>            <span class="n">activity</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-94-174"><a id="__codelineno-94-174" name="__codelineno-94-174" href="#__codelineno-94-174"></a>            <span class="k">raise</span>
</span><span id="__span-94-175"><a id="__codelineno-94-175" name="__codelineno-94-175" href="#__codelineno-94-175"></a>
</span><span id="__span-94-176"><a id="__codelineno-94-176" name="__codelineno-94-176" href="#__codelineno-94-176"></a>
</span><span id="__span-94-177"><a id="__codelineno-94-177" name="__codelineno-94-177" href="#__codelineno-94-177"></a><span class="nd">@activity</span><span class="o">.</span><span class="n">defn</span><span class="p">(</span><span class="n">dynamic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-94-178"><a id="__codelineno-94-178" name="__codelineno-94-178" href="#__codelineno-94-178"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dynamic_tool_activity</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">RawValue</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-94-179"><a id="__codelineno-94-179" name="__codelineno-94-179" href="#__codelineno-94-179"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">tools.tool_registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_handler</span>
</span><span id="__span-94-180"><a id="__codelineno-94-180" name="__codelineno-94-180" href="#__codelineno-94-180"></a>
</span><span id="__span-94-181"><a id="__codelineno-94-181" name="__codelineno-94-181" href="#__codelineno-94-181"></a>    <span class="n">tool_name</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="n">info</span><span class="p">()</span><span class="o">.</span><span class="n">activity_type</span>  <span class="c1"># e.g. &quot;FindEvents&quot;</span>
</span><span id="__span-94-182"><a id="__codelineno-94-182" name="__codelineno-94-182" href="#__codelineno-94-182"></a>    <span class="n">tool_args</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="n">payload_converter</span><span class="p">()</span><span class="o">.</span><span class="n">from_payload</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</span><span id="__span-94-183"><a id="__codelineno-94-183" name="__codelineno-94-183" href="#__codelineno-94-183"></a>    <span class="n">activity</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running dynamic tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39; with args: </span><span class="si">{</span><span class="n">tool_args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-94-184"><a id="__codelineno-94-184" name="__codelineno-94-184" href="#__codelineno-94-184"></a>
</span><span id="__span-94-185"><a id="__codelineno-94-185" name="__codelineno-94-185" href="#__codelineno-94-185"></a>    <span class="c1"># Delegate to the relevant function</span>
</span><span id="__span-94-186"><a id="__codelineno-94-186" name="__codelineno-94-186" href="#__codelineno-94-186"></a>    <span class="n">handler</span> <span class="o">=</span> <span class="n">get_handler</span><span class="p">(</span><span class="n">tool_name</span><span class="p">)</span>
</span><span id="__span-94-187"><a id="__codelineno-94-187" name="__codelineno-94-187" href="#__codelineno-94-187"></a>    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
</span><span id="__span-94-188"><a id="__codelineno-94-188" name="__codelineno-94-188" href="#__codelineno-94-188"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="n">tool_args</span><span class="p">)</span>
</span><span id="__span-94-189"><a id="__codelineno-94-189" name="__codelineno-94-189" href="#__codelineno-94-189"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-94-190"><a id="__codelineno-94-190" name="__codelineno-94-190" href="#__codelineno-94-190"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">tool_args</span><span class="p">)</span>
</span><span id="__span-94-191"><a id="__codelineno-94-191" name="__codelineno-94-191" href="#__codelineno-94-191"></a>
</span><span id="__span-94-192"><a id="__codelineno-94-192" name="__codelineno-94-192" href="#__codelineno-94-192"></a>    <span class="c1"># Optionally log or augment the result</span>
</span><span id="__span-94-193"><a id="__codelineno-94-193" name="__codelineno-94-193" href="#__codelineno-94-193"></a>    <span class="n">activity</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39; result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-94-194"><a id="__codelineno-94-194" name="__codelineno-94-194" href="#__codelineno-94-194"></a>    <span class="k">return</span> <span class="n">result</span>
</span></code></pre></div>
</details>

<p>The Activities you implemented handle LLM communication, user input validation, environment configuration, and dynamic tool execution. </p>
<details>

<summary>
Before moving on to the next section, verify your files and directory structure is correct.
</summary>

<div class="language-text highlight"><pre><span></span><code><span id="__span-95-1"><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a>temporal-ai-agent/
</span><span id="__span-95-2"><a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a>├── .env
</span><span id="__span-95-3"><a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a>├── .gitignore
</span><span id="__span-95-4"><a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a>├── .python-version
</span><span id="__span-95-5"><a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a>├── README.md
</span><span id="__span-95-6"><a id="__codelineno-95-6" name="__codelineno-95-6" href="#__codelineno-95-6"></a>├── pyproject.toml
</span><span id="__span-95-7"><a id="__codelineno-95-7" name="__codelineno-95-7" href="#__codelineno-95-7"></a>├── uv.lock
</span><span id="__span-95-8"><a id="__codelineno-95-8" name="__codelineno-95-8" href="#__codelineno-95-8"></a>├── activities/
</span><span id="__span-95-9"><a id="__codelineno-95-9" name="__codelineno-95-9" href="#__codelineno-95-9"></a>|   ├── __init__.py
</span><span id="__span-95-10"><a id="__codelineno-95-10" name="__codelineno-95-10" href="#__codelineno-95-10"></a>|   └── activities.py
</span><span id="__span-95-11"><a id="__codelineno-95-11" name="__codelineno-95-11" href="#__codelineno-95-11"></a>├── models/
</span><span id="__span-95-12"><a id="__codelineno-95-12" name="__codelineno-95-12" href="#__codelineno-95-12"></a>│   ├── __init__.py
</span><span id="__span-95-13"><a id="__codelineno-95-13" name="__codelineno-95-13" href="#__codelineno-95-13"></a>│   ├── core.py
</span><span id="__span-95-14"><a id="__codelineno-95-14" name="__codelineno-95-14" href="#__codelineno-95-14"></a>│   └── requests.py
</span><span id="__span-95-15"><a id="__codelineno-95-15" name="__codelineno-95-15" href="#__codelineno-95-15"></a>├── scripts/
</span><span id="__span-95-16"><a id="__codelineno-95-16" name="__codelineno-95-16" href="#__codelineno-95-16"></a>│   ├── create_invoice_test.py
</span><span id="__span-95-17"><a id="__codelineno-95-17" name="__codelineno-95-17" href="#__codelineno-95-17"></a>│   ├── find_events_test.py
</span><span id="__span-95-18"><a id="__codelineno-95-18" name="__codelineno-95-18" href="#__codelineno-95-18"></a>│   └── search_flights_test.py
</span><span id="__span-95-19"><a id="__codelineno-95-19" name="__codelineno-95-19" href="#__codelineno-95-19"></a>└── tools/
</span><span id="__span-95-20"><a id="__codelineno-95-20" name="__codelineno-95-20" href="#__codelineno-95-20"></a>    ├── __init__.py
</span><span id="__span-95-21"><a id="__codelineno-95-21" name="__codelineno-95-21" href="#__codelineno-95-21"></a>    ├── create_invoice.py
</span><span id="__span-95-22"><a id="__codelineno-95-22" name="__codelineno-95-22" href="#__codelineno-95-22"></a>    ├── find_events.py
</span><span id="__span-95-23"><a id="__codelineno-95-23" name="__codelineno-95-23" href="#__codelineno-95-23"></a>    ├── goal_registry.py
</span><span id="__span-95-24"><a id="__codelineno-95-24" name="__codelineno-95-24" href="#__codelineno-95-24"></a>    ├── search_flights.py
</span><span id="__span-95-25"><a id="__codelineno-95-25" name="__codelineno-95-25" href="#__codelineno-95-25"></a>    ├── tool_registry.py
</span><span id="__span-95-26"><a id="__codelineno-95-26" name="__codelineno-95-26" href="#__codelineno-95-26"></a>    └── data/
</span><span id="__span-95-27"><a id="__codelineno-95-27" name="__codelineno-95-27" href="#__codelineno-95-27"></a>        └── find_events_data.json
</span></code></pre></div>
</details>

<p>In the next step, you will create a submodule that stores and renders the main prompts the agent uses to communicate with the LLM. </p>
<h2 id="developing-the-necessary-prompts">Developing the necessary prompts<a class="headerlink" href="#developing-the-necessary-prompts" title="Permanent link">&para;</a></h2>
<p>Your agent communicates with an LLM to determine what steps it should take and which tool it should use.
However, LLM output is non-determinstic, so how do you ensure that you receive data that you can rely on so your agent can interpret it and continue execution?
To do this, you need to carefully craft a prompt explicitly stating what the LLM should do and what format it should return.
These prompts can often be complex, and since your agent dynamically loads tools, will also need to be dynamically generated.
In this section, you will implement the code to generate these prompts.</p>
<h3 id="creating-the-submodule">Creating the submodule<a class="headerlink" href="#creating-the-submodule" title="Permanent link">&para;</a></h3>
<p>First, create a new directory named <code>prompts</code>:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-96-1"><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a>mkdir<span class="w"> </span>prompts
</span></code></pre></div>
<p>Then create the <code>__init__.py</code> file in the <code>prompts</code> director to make it a submodule:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-97-1"><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a>touch<span class="w"> </span>prompts/__init__.py
</span></code></pre></div>
<p>Next, you'll craft your prompt templates that the LLM will use.</p>
<h3 id="crafting-the-prompts-templates">Crafting the prompts templates<a class="headerlink" href="#crafting-the-prompts-templates" title="Permanent link">&para;</a></h3>
<p>The prompts templates you create will vary in the amount of customization they allow.
For templates with minimal customization, for example, templates that only require a few variable substitutions, Python's string formatting syntax will suffice.
However, if your template requires iteration, conditional logic, or variable interpolation, you should use a more advanced templating system, such as <code>Jinja2</code>.</p>
<h4 id="defining-the-primary-context-prompt">Defining the primary context prompt<a class="headerlink" href="#defining-the-primary-context-prompt" title="Permanent link">&para;</a></h4>
<p>The primary context that the LLM uses to determine the next action requires multiple steps, conditionals, and loops to implement, so you will implement it using <code>Jinja2</code>.</p>
<p>Create the file <code>prompts/prompts.py</code> and add the import for <code>Jinja2</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-98-1"><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">jinja2</span><span class="w"> </span><span class="kn">import</span> <span class="n">Template</span>
</span></code></pre></div>
<p>Next, add the first part of the primary prompt, which you'll name <code>GENAI_PROMPT</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-99-1"><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a><span class="n">GENAI_PROMPT</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
</span><span id="__span-99-2"><a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-99-3"><a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a><span class="sd">You are an AI agent that helps fill required arguments for the tools described below. </span>
</span><span id="__span-99-4"><a id="__codelineno-99-4" name="__codelineno-99-4" href="#__codelineno-99-4"></a><span class="sd">You must respond with valid JSON ONLY, using the schema provided in the instructions.</span>
</span><span id="__span-99-5"><a id="__codelineno-99-5" name="__codelineno-99-5" href="#__codelineno-99-5"></a>
</span><span id="__span-99-6"><a id="__codelineno-99-6" name="__codelineno-99-6" href="#__codelineno-99-6"></a><span class="sd">=== Conversation History ===</span>
</span><span id="__span-99-7"><a id="__codelineno-99-7" name="__codelineno-99-7" href="#__codelineno-99-7"></a><span class="sd">This is the ongoing history to determine which tool and arguments to gather:</span>
</span><span id="__span-99-8"><a id="__codelineno-99-8" name="__codelineno-99-8" href="#__codelineno-99-8"></a><span class="sd">*BEGIN CONVERSATION HISTORY*</span>
</span><span id="__span-99-9"><a id="__codelineno-99-9" name="__codelineno-99-9" href="#__codelineno-99-9"></a><span class="sd">{{ conversation_history_json }}</span>
</span><span id="__span-99-10"><a id="__codelineno-99-10" name="__codelineno-99-10" href="#__codelineno-99-10"></a><span class="sd">*END CONVERSATION HISTORY*</span>
</span><span id="__span-99-11"><a id="__codelineno-99-11" name="__codelineno-99-11" href="#__codelineno-99-11"></a><span class="sd">REMINDER: You can use the conversation history to infer arguments for the tools.</span>
</span><span id="__span-99-12"><a id="__codelineno-99-12" name="__codelineno-99-12" href="#__codelineno-99-12"></a>
</span><span id="__span-99-13"><a id="__codelineno-99-13" name="__codelineno-99-13" href="#__codelineno-99-13"></a><span class="sd">{% if agent_goal.example_conversation_history %}</span>
</span><span id="__span-99-14"><a id="__codelineno-99-14" name="__codelineno-99-14" href="#__codelineno-99-14"></a><span class="sd">=== Example Conversation With These Tools ===</span>
</span><span id="__span-99-15"><a id="__codelineno-99-15" name="__codelineno-99-15" href="#__codelineno-99-15"></a><span class="sd">Use this example to understand how tools are invoked and arguments are gathered.</span>
</span><span id="__span-99-16"><a id="__codelineno-99-16" name="__codelineno-99-16" href="#__codelineno-99-16"></a><span class="sd">BEGIN EXAMPLE</span>
</span><span id="__span-99-17"><a id="__codelineno-99-17" name="__codelineno-99-17" href="#__codelineno-99-17"></a><span class="sd">{{ agent_goal.example_conversation_history }}</span>
</span><span id="__span-99-18"><a id="__codelineno-99-18" name="__codelineno-99-18" href="#__codelineno-99-18"></a><span class="sd">END EXAMPLE</span>
</span><span id="__span-99-19"><a id="__codelineno-99-19" name="__codelineno-99-19" href="#__codelineno-99-19"></a>
</span><span id="__span-99-20"><a id="__codelineno-99-20" name="__codelineno-99-20" href="#__codelineno-99-20"></a><span class="sd">{% endif %}</span>
</span><span id="__span-99-21"><a id="__codelineno-99-21" name="__codelineno-99-21" href="#__codelineno-99-21"></a><span class="sd">&quot;&quot;&quot;</span>
</span></code></pre></div>
<p>This section of the prompt sets the primary role for the LLM, provides the current conversation history for the LLM to analyze, and if an example conversation was provided, provides that as an example for the LLM to use as well.</p>
<p>Continue adding this prompt by adding the following lines:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-100-1"><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-100-2"><a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a><span class="sd">=== Tools Definitions ===</span>
</span><span id="__span-100-3"><a id="__codelineno-100-3" name="__codelineno-100-3" href="#__codelineno-100-3"></a><span class="sd">There are {{ agent_goal.tools|length }} available tools:</span>
</span><span id="__span-100-4"><a id="__codelineno-100-4" name="__codelineno-100-4" href="#__codelineno-100-4"></a><span class="sd">{{ agent_goal.tools|map(attribute=&#39;name&#39;)|join(&#39;, &#39;) }}</span>
</span><span id="__span-100-5"><a id="__codelineno-100-5" name="__codelineno-100-5" href="#__codelineno-100-5"></a><span class="sd">Goal: {{ agent_goal.description }}</span>
</span><span id="__span-100-6"><a id="__codelineno-100-6" name="__codelineno-100-6" href="#__codelineno-100-6"></a><span class="sd">Gather the necessary information for each tool in the sequence described above.</span>
</span><span id="__span-100-7"><a id="__codelineno-100-7" name="__codelineno-100-7" href="#__codelineno-100-7"></a><span class="sd">Only ask for arguments listed below. Do not add extra arguments.</span>
</span><span id="__span-100-8"><a id="__codelineno-100-8" name="__codelineno-100-8" href="#__codelineno-100-8"></a>
</span><span id="__span-100-9"><a id="__codelineno-100-9" name="__codelineno-100-9" href="#__codelineno-100-9"></a><span class="sd">{% for tool in agent_goal.tools %}</span>
</span><span id="__span-100-10"><a id="__codelineno-100-10" name="__codelineno-100-10" href="#__codelineno-100-10"></a><span class="sd">Tool name: {{ tool.name }}</span>
</span><span id="__span-100-11"><a id="__codelineno-100-11" name="__codelineno-100-11" href="#__codelineno-100-11"></a><span class="sd">  Description: {{ tool.description }}</span>
</span><span id="__span-100-12"><a id="__codelineno-100-12" name="__codelineno-100-12" href="#__codelineno-100-12"></a><span class="sd">  Required args:</span>
</span><span id="__span-100-13"><a id="__codelineno-100-13" name="__codelineno-100-13" href="#__codelineno-100-13"></a><span class="sd">{% for arg in tool.arguments %}</span>
</span><span id="__span-100-14"><a id="__codelineno-100-14" name="__codelineno-100-14" href="#__codelineno-100-14"></a><span class="sd">    - {{ arg.name }} ({{ arg.type }}): {{ arg.description }}</span>
</span><span id="__span-100-15"><a id="__codelineno-100-15" name="__codelineno-100-15" href="#__codelineno-100-15"></a><span class="sd">{% endfor %}</span>
</span><span id="__span-100-16"><a id="__codelineno-100-16" name="__codelineno-100-16" href="#__codelineno-100-16"></a>
</span><span id="__span-100-17"><a id="__codelineno-100-17" name="__codelineno-100-17" href="#__codelineno-100-17"></a><span class="sd">{% endfor %}</span>
</span><span id="__span-100-18"><a id="__codelineno-100-18" name="__codelineno-100-18" href="#__codelineno-100-18"></a><span class="sd">When all required args for a tool are known, you can propose next=&#39;confirm&#39; to run it.</span>
</span><span id="__span-100-19"><a id="__codelineno-100-19" name="__codelineno-100-19" href="#__codelineno-100-19"></a><span class="sd">&quot;&quot;&quot;</span>
</span></code></pre></div>
<p>The segment of the prompt definitions section lists the agent's goal and the available tools with their descriptions and argument specifications. 
This provides the LLM with information about what the agent is attempting to accomplish, and its capabilities and constraints.</p>
<p>Next, it's vital that the LLM provides its response in a consistent way that your agent can parse.
Add the following instructions for output formatting and guardrails:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-101-1"><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-101-2"><a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a><span class="sd">=== Instructions for JSON Generation ===</span>
</span><span id="__span-101-3"><a id="__codelineno-101-3" name="__codelineno-101-3" href="#__codelineno-101-3"></a><span class="sd">Your JSON format must be:</span>
</span><span id="__span-101-4"><a id="__codelineno-101-4" name="__codelineno-101-4" href="#__codelineno-101-4"></a><span class="sd">{</span>
</span><span id="__span-101-5"><a id="__codelineno-101-5" name="__codelineno-101-5" href="#__codelineno-101-5"></a><span class="sd">  &quot;response&quot;: &quot;&lt;plain text&gt;&quot;,</span>
</span><span id="__span-101-6"><a id="__codelineno-101-6" name="__codelineno-101-6" href="#__codelineno-101-6"></a><span class="sd">  &quot;next&quot;: &quot;&lt;question|confirm|pick-new-goal|done&gt;&quot;,</span>
</span><span id="__span-101-7"><a id="__codelineno-101-7" name="__codelineno-101-7" href="#__codelineno-101-7"></a><span class="sd">  &quot;tool&quot;: &quot;&lt;tool_name or null&gt;&quot;,</span>
</span><span id="__span-101-8"><a id="__codelineno-101-8" name="__codelineno-101-8" href="#__codelineno-101-8"></a><span class="sd">  &quot;args&quot;: {</span>
</span><span id="__span-101-9"><a id="__codelineno-101-9" name="__codelineno-101-9" href="#__codelineno-101-9"></a><span class="sd">    &quot;&lt;arg1&gt;&quot;: &quot;&lt;value1 or null&gt;&quot;,</span>
</span><span id="__span-101-10"><a id="__codelineno-101-10" name="__codelineno-101-10" href="#__codelineno-101-10"></a><span class="sd">    &quot;&lt;arg2&gt;&quot;: &quot;&lt;value2 or null&gt;&quot;,</span>
</span><span id="__span-101-11"><a id="__codelineno-101-11" name="__codelineno-101-11" href="#__codelineno-101-11"></a><span class="sd">    ...</span>
</span><span id="__span-101-12"><a id="__codelineno-101-12" name="__codelineno-101-12" href="#__codelineno-101-12"></a><span class="sd">  }</span>
</span><span id="__span-101-13"><a id="__codelineno-101-13" name="__codelineno-101-13" href="#__codelineno-101-13"></a><span class="sd">}</span>
</span><span id="__span-101-14"><a id="__codelineno-101-14" name="__codelineno-101-14" href="#__codelineno-101-14"></a><span class="sd">1) If any required argument is missing, set next=&#39;question&#39; and ask the user.</span>
</span><span id="__span-101-15"><a id="__codelineno-101-15" name="__codelineno-101-15" href="#__codelineno-101-15"></a><span class="sd">2) If all required arguments are known, set next=&#39;confirm&#39; and specify the tool.</span>
</span><span id="__span-101-16"><a id="__codelineno-101-16" name="__codelineno-101-16" href="#__codelineno-101-16"></a><span class="sd">   The user will confirm before the tool is run.</span>
</span><span id="__span-101-17"><a id="__codelineno-101-17" name="__codelineno-101-17" href="#__codelineno-101-17"></a><span class="sd">3) {{ toolchain_complete_guidance }}</span>
</span><span id="__span-101-18"><a id="__codelineno-101-18" name="__codelineno-101-18" href="#__codelineno-101-18"></a><span class="sd">4) response should be short and user-friendly.</span>
</span><span id="__span-101-19"><a id="__codelineno-101-19" name="__codelineno-101-19" href="#__codelineno-101-19"></a>
</span><span id="__span-101-20"><a id="__codelineno-101-20" name="__codelineno-101-20" href="#__codelineno-101-20"></a><span class="sd">Guardrails (always remember!)</span>
</span><span id="__span-101-21"><a id="__codelineno-101-21" name="__codelineno-101-21" href="#__codelineno-101-21"></a><span class="sd">1) If any required argument is missing, set next=&#39;question&#39; and ask the user.</span>
</span><span id="__span-101-22"><a id="__codelineno-101-22" name="__codelineno-101-22" href="#__codelineno-101-22"></a><span class="sd">2) ALWAYS ask a question in your response if next=&#39;question&#39;.</span>
</span><span id="__span-101-23"><a id="__codelineno-101-23" name="__codelineno-101-23" href="#__codelineno-101-23"></a><span class="sd">3) ALWAYS set next=&#39;confirm&#39; if you have arguments</span>
</span><span id="__span-101-24"><a id="__codelineno-101-24" name="__codelineno-101-24" href="#__codelineno-101-24"></a><span class="sd"> And respond with &quot;let&#39;s proceed with &lt;tool&gt; (and any other useful info)&quot; </span>
</span><span id="__span-101-25"><a id="__codelineno-101-25" name="__codelineno-101-25" href="#__codelineno-101-25"></a><span class="sd"> DON&#39;T set next=&#39;confirm&#39; if you have a question to ask.</span>
</span><span id="__span-101-26"><a id="__codelineno-101-26" name="__codelineno-101-26" href="#__codelineno-101-26"></a><span class="sd">EXAMPLE: If you have a question to ask, set next=&#39;question&#39; and ask the user.</span>
</span><span id="__span-101-27"><a id="__codelineno-101-27" name="__codelineno-101-27" href="#__codelineno-101-27"></a><span class="sd">4) You can carry over arguments from one tool to another.</span>
</span><span id="__span-101-28"><a id="__codelineno-101-28" name="__codelineno-101-28" href="#__codelineno-101-28"></a><span class="sd"> EXAMPLE: If you asked for an account ID, then use the conversation history to infer that argument going forward.</span>
</span><span id="__span-101-29"><a id="__codelineno-101-29" name="__codelineno-101-29" href="#__codelineno-101-29"></a><span class="sd">5) If ListAgents in the conversation history is force_confirm=&#39;False&#39;, you MUST check if the current tool contains userConfirmation. If it does, please ask the user to confirm details with the user. userConfirmation overrides force_confirm=&#39;False&#39;.</span>
</span><span id="__span-101-30"><a id="__codelineno-101-30" name="__codelineno-101-30" href="#__codelineno-101-30"></a><span class="sd">EXAMPLE: (force_confirm=&#39;False&#39; AND userConfirmation exists on tool) Would you like me to &lt;run tool&gt; with the following details: &lt;details&gt;?</span>
</span><span id="__span-101-31"><a id="__codelineno-101-31" name="__codelineno-101-31" href="#__codelineno-101-31"></a><span class="sd">&quot;&quot;&quot;</span>
</span></code></pre></div>
<p>This segment provides strict rules on the exact format the LLM should respond with, as well as guardrails to ensure that fields are set properly.
The guardrails section is particularly important as it provides detailed behavioral constraints that enable consistent responses. 
These rules prevent issues such as asking questions while proposing tool execution or forgetting to use the conversation history for argument inference.</p>
<p>Finally, complete the template with a validation prompt:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-102-1"><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-102-2"><a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a><span class="sd">{% if raw_json is not none %}</span>
</span><span id="__span-102-3"><a id="__codelineno-102-3" name="__codelineno-102-3" href="#__codelineno-102-3"></a>
</span><span id="__span-102-4"><a id="__codelineno-102-4" name="__codelineno-102-4" href="#__codelineno-102-4"></a><span class="sd">=== Validation Task ===</span>
</span><span id="__span-102-5"><a id="__codelineno-102-5" name="__codelineno-102-5" href="#__codelineno-102-5"></a><span class="sd">Validate and correct the following JSON if needed:</span>
</span><span id="__span-102-6"><a id="__codelineno-102-6" name="__codelineno-102-6" href="#__codelineno-102-6"></a><span class="sd">{{ raw_json_str }}</span>
</span><span id="__span-102-7"><a id="__codelineno-102-7" name="__codelineno-102-7" href="#__codelineno-102-7"></a>
</span><span id="__span-102-8"><a id="__codelineno-102-8" name="__codelineno-102-8" href="#__codelineno-102-8"></a><span class="sd">Check syntax, &#39;tool&#39; validity, &#39;args&#39; completeness, and set &#39;next&#39; appropriately. Return ONLY corrected JSON.</span>
</span><span id="__span-102-9"><a id="__codelineno-102-9" name="__codelineno-102-9" href="#__codelineno-102-9"></a><span class="sd">{% endif %}</span>
</span><span id="__span-102-10"><a id="__codelineno-102-10" name="__codelineno-102-10" href="#__codelineno-102-10"></a>
</span><span id="__span-102-11"><a id="__codelineno-102-11" name="__codelineno-102-11" href="#__codelineno-102-11"></a><span class="sd">{% if raw_json is not none %}</span>
</span><span id="__span-102-12"><a id="__codelineno-102-12" name="__codelineno-102-12" href="#__codelineno-102-12"></a><span class="sd">Begin by validating the provided JSON if necessary.</span>
</span><span id="__span-102-13"><a id="__codelineno-102-13" name="__codelineno-102-13" href="#__codelineno-102-13"></a><span class="sd">{% else %}</span>
</span><span id="__span-102-14"><a id="__codelineno-102-14" name="__codelineno-102-14" href="#__codelineno-102-14"></a><span class="sd">Begin by producing a valid JSON response for the next tool or question.</span>
</span><span id="__span-102-15"><a id="__codelineno-102-15" name="__codelineno-102-15" href="#__codelineno-102-15"></a><span class="sd">{% endif %}</span>
</span><span id="__span-102-16"><a id="__codelineno-102-16" name="__codelineno-102-16" href="#__codelineno-102-16"></a><span class="sd">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="__span-102-17"><a id="__codelineno-102-17" name="__codelineno-102-17" href="#__codelineno-102-17"></a><span class="p">)</span>
</span></code></pre></div>
<p>The validation section enables the template to handle both correct and incorrectly JSON formatted strings.
If the JSON is improperly formatted, the LLM is prompted to correct it before continuing with its other tasks.</p>
<p>All together, the template should look like this:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-103-1"><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a><span class="n">GENAI_PROMPT</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
</span><span id="__span-103-2"><a id="__codelineno-103-2" name="__codelineno-103-2" href="#__codelineno-103-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-103-3"><a id="__codelineno-103-3" name="__codelineno-103-3" href="#__codelineno-103-3"></a><span class="sd">You are an AI agent that helps fill required arguments for the tools described below. </span>
</span><span id="__span-103-4"><a id="__codelineno-103-4" name="__codelineno-103-4" href="#__codelineno-103-4"></a><span class="sd">You must respond with valid JSON ONLY, using the schema provided in the instructions.</span>
</span><span id="__span-103-5"><a id="__codelineno-103-5" name="__codelineno-103-5" href="#__codelineno-103-5"></a>
</span><span id="__span-103-6"><a id="__codelineno-103-6" name="__codelineno-103-6" href="#__codelineno-103-6"></a><span class="sd">=== Conversation History ===</span>
</span><span id="__span-103-7"><a id="__codelineno-103-7" name="__codelineno-103-7" href="#__codelineno-103-7"></a><span class="sd">This is the ongoing history to determine which tool and arguments to gather:</span>
</span><span id="__span-103-8"><a id="__codelineno-103-8" name="__codelineno-103-8" href="#__codelineno-103-8"></a><span class="sd">*BEGIN CONVERSATION HISTORY*</span>
</span><span id="__span-103-9"><a id="__codelineno-103-9" name="__codelineno-103-9" href="#__codelineno-103-9"></a><span class="sd">{{ conversation_history_json }}</span>
</span><span id="__span-103-10"><a id="__codelineno-103-10" name="__codelineno-103-10" href="#__codelineno-103-10"></a><span class="sd">*END CONVERSATION HISTORY*</span>
</span><span id="__span-103-11"><a id="__codelineno-103-11" name="__codelineno-103-11" href="#__codelineno-103-11"></a><span class="sd">REMINDER: You can use the conversation history to infer arguments for the tools.</span>
</span><span id="__span-103-12"><a id="__codelineno-103-12" name="__codelineno-103-12" href="#__codelineno-103-12"></a>
</span><span id="__span-103-13"><a id="__codelineno-103-13" name="__codelineno-103-13" href="#__codelineno-103-13"></a><span class="sd">{% if agent_goal.example_conversation_history %}</span>
</span><span id="__span-103-14"><a id="__codelineno-103-14" name="__codelineno-103-14" href="#__codelineno-103-14"></a><span class="sd">=== Example Conversation With These Tools ===</span>
</span><span id="__span-103-15"><a id="__codelineno-103-15" name="__codelineno-103-15" href="#__codelineno-103-15"></a><span class="sd">Use this example to understand how tools are invoked and arguments are gathered.</span>
</span><span id="__span-103-16"><a id="__codelineno-103-16" name="__codelineno-103-16" href="#__codelineno-103-16"></a><span class="sd">BEGIN EXAMPLE</span>
</span><span id="__span-103-17"><a id="__codelineno-103-17" name="__codelineno-103-17" href="#__codelineno-103-17"></a><span class="sd">{{ agent_goal.example_conversation_history }}</span>
</span><span id="__span-103-18"><a id="__codelineno-103-18" name="__codelineno-103-18" href="#__codelineno-103-18"></a><span class="sd">END EXAMPLE</span>
</span><span id="__span-103-19"><a id="__codelineno-103-19" name="__codelineno-103-19" href="#__codelineno-103-19"></a>
</span><span id="__span-103-20"><a id="__codelineno-103-20" name="__codelineno-103-20" href="#__codelineno-103-20"></a><span class="sd">{% endif %}</span>
</span><span id="__span-103-21"><a id="__codelineno-103-21" name="__codelineno-103-21" href="#__codelineno-103-21"></a><span class="sd">=== Tools Definitions ===</span>
</span><span id="__span-103-22"><a id="__codelineno-103-22" name="__codelineno-103-22" href="#__codelineno-103-22"></a><span class="sd">There are {{ agent_goal.tools|length }} available tools:</span>
</span><span id="__span-103-23"><a id="__codelineno-103-23" name="__codelineno-103-23" href="#__codelineno-103-23"></a><span class="sd">{{ agent_goal.tools|map(attribute=&#39;name&#39;)|join(&#39;, &#39;) }}</span>
</span><span id="__span-103-24"><a id="__codelineno-103-24" name="__codelineno-103-24" href="#__codelineno-103-24"></a><span class="sd">Goal: {{ agent_goal.description }}</span>
</span><span id="__span-103-25"><a id="__codelineno-103-25" name="__codelineno-103-25" href="#__codelineno-103-25"></a><span class="sd">Gather the necessary information for each tool in the sequence described above.</span>
</span><span id="__span-103-26"><a id="__codelineno-103-26" name="__codelineno-103-26" href="#__codelineno-103-26"></a><span class="sd">Only ask for arguments listed below. Do not add extra arguments.</span>
</span><span id="__span-103-27"><a id="__codelineno-103-27" name="__codelineno-103-27" href="#__codelineno-103-27"></a>
</span><span id="__span-103-28"><a id="__codelineno-103-28" name="__codelineno-103-28" href="#__codelineno-103-28"></a><span class="sd">{% for tool in agent_goal.tools %}</span>
</span><span id="__span-103-29"><a id="__codelineno-103-29" name="__codelineno-103-29" href="#__codelineno-103-29"></a><span class="sd">Tool name: {{ tool.name }}</span>
</span><span id="__span-103-30"><a id="__codelineno-103-30" name="__codelineno-103-30" href="#__codelineno-103-30"></a><span class="sd">  Description: {{ tool.description }}</span>
</span><span id="__span-103-31"><a id="__codelineno-103-31" name="__codelineno-103-31" href="#__codelineno-103-31"></a><span class="sd">  Required args:</span>
</span><span id="__span-103-32"><a id="__codelineno-103-32" name="__codelineno-103-32" href="#__codelineno-103-32"></a><span class="sd">{% for arg in tool.arguments %}</span>
</span><span id="__span-103-33"><a id="__codelineno-103-33" name="__codelineno-103-33" href="#__codelineno-103-33"></a><span class="sd">    - {{ arg.name }} ({{ arg.type }}): {{ arg.description }}</span>
</span><span id="__span-103-34"><a id="__codelineno-103-34" name="__codelineno-103-34" href="#__codelineno-103-34"></a><span class="sd">{% endfor %}</span>
</span><span id="__span-103-35"><a id="__codelineno-103-35" name="__codelineno-103-35" href="#__codelineno-103-35"></a>
</span><span id="__span-103-36"><a id="__codelineno-103-36" name="__codelineno-103-36" href="#__codelineno-103-36"></a><span class="sd">{% endfor %}</span>
</span><span id="__span-103-37"><a id="__codelineno-103-37" name="__codelineno-103-37" href="#__codelineno-103-37"></a><span class="sd">When all required args for a tool are known, you can propose next=&#39;confirm&#39; to run it.</span>
</span><span id="__span-103-38"><a id="__codelineno-103-38" name="__codelineno-103-38" href="#__codelineno-103-38"></a>
</span><span id="__span-103-39"><a id="__codelineno-103-39" name="__codelineno-103-39" href="#__codelineno-103-39"></a><span class="sd">=== Instructions for JSON Generation ===</span>
</span><span id="__span-103-40"><a id="__codelineno-103-40" name="__codelineno-103-40" href="#__codelineno-103-40"></a><span class="sd">Your JSON format must be:</span>
</span><span id="__span-103-41"><a id="__codelineno-103-41" name="__codelineno-103-41" href="#__codelineno-103-41"></a><span class="sd">{</span>
</span><span id="__span-103-42"><a id="__codelineno-103-42" name="__codelineno-103-42" href="#__codelineno-103-42"></a><span class="sd">  &quot;response&quot;: &quot;&lt;plain text&gt;&quot;,</span>
</span><span id="__span-103-43"><a id="__codelineno-103-43" name="__codelineno-103-43" href="#__codelineno-103-43"></a><span class="sd">  &quot;next&quot;: &quot;&lt;question|confirm|done&gt;&quot;,</span>
</span><span id="__span-103-44"><a id="__codelineno-103-44" name="__codelineno-103-44" href="#__codelineno-103-44"></a><span class="sd">  &quot;tool&quot;: &quot;&lt;tool_name or null&gt;&quot;,</span>
</span><span id="__span-103-45"><a id="__codelineno-103-45" name="__codelineno-103-45" href="#__codelineno-103-45"></a><span class="sd">  &quot;args&quot;: {</span>
</span><span id="__span-103-46"><a id="__codelineno-103-46" name="__codelineno-103-46" href="#__codelineno-103-46"></a><span class="sd">    &quot;&lt;arg1&gt;&quot;: &quot;&lt;value1 or null&gt;&quot;,</span>
</span><span id="__span-103-47"><a id="__codelineno-103-47" name="__codelineno-103-47" href="#__codelineno-103-47"></a><span class="sd">    &quot;&lt;arg2&gt;&quot;: &quot;&lt;value2 or null&gt;&quot;,</span>
</span><span id="__span-103-48"><a id="__codelineno-103-48" name="__codelineno-103-48" href="#__codelineno-103-48"></a><span class="sd">    ...</span>
</span><span id="__span-103-49"><a id="__codelineno-103-49" name="__codelineno-103-49" href="#__codelineno-103-49"></a><span class="sd">  }</span>
</span><span id="__span-103-50"><a id="__codelineno-103-50" name="__codelineno-103-50" href="#__codelineno-103-50"></a><span class="sd">}</span>
</span><span id="__span-103-51"><a id="__codelineno-103-51" name="__codelineno-103-51" href="#__codelineno-103-51"></a><span class="sd">1) If any required argument is missing, set next=&#39;question&#39; and ask the user.</span>
</span><span id="__span-103-52"><a id="__codelineno-103-52" name="__codelineno-103-52" href="#__codelineno-103-52"></a><span class="sd">2) If all required arguments are known, set next=&#39;confirm&#39; and specify the tool.</span>
</span><span id="__span-103-53"><a id="__codelineno-103-53" name="__codelineno-103-53" href="#__codelineno-103-53"></a><span class="sd">   The user will confirm before the tool is run.</span>
</span><span id="__span-103-54"><a id="__codelineno-103-54" name="__codelineno-103-54" href="#__codelineno-103-54"></a><span class="sd">3) {{ toolchain_complete_guidance }}</span>
</span><span id="__span-103-55"><a id="__codelineno-103-55" name="__codelineno-103-55" href="#__codelineno-103-55"></a><span class="sd">4) response should be short and user-friendly.</span>
</span><span id="__span-103-56"><a id="__codelineno-103-56" name="__codelineno-103-56" href="#__codelineno-103-56"></a>
</span><span id="__span-103-57"><a id="__codelineno-103-57" name="__codelineno-103-57" href="#__codelineno-103-57"></a><span class="sd">Guardrails (always remember!)</span>
</span><span id="__span-103-58"><a id="__codelineno-103-58" name="__codelineno-103-58" href="#__codelineno-103-58"></a><span class="sd">1) If any required argument is missing, set next=&#39;question&#39; and ask the user.</span>
</span><span id="__span-103-59"><a id="__codelineno-103-59" name="__codelineno-103-59" href="#__codelineno-103-59"></a><span class="sd">2) ALWAYS ask a question in your response if next=&#39;question&#39;.</span>
</span><span id="__span-103-60"><a id="__codelineno-103-60" name="__codelineno-103-60" href="#__codelineno-103-60"></a><span class="sd">3) ALWAYS set next=&#39;confirm&#39; if you have arguments</span>
</span><span id="__span-103-61"><a id="__codelineno-103-61" name="__codelineno-103-61" href="#__codelineno-103-61"></a><span class="sd"> And respond with &quot;let&#39;s proceed with &lt;tool&gt; (and any other useful info)&quot; </span>
</span><span id="__span-103-62"><a id="__codelineno-103-62" name="__codelineno-103-62" href="#__codelineno-103-62"></a><span class="sd"> DON&#39;T set next=&#39;confirm&#39; if you have a question to ask.</span>
</span><span id="__span-103-63"><a id="__codelineno-103-63" name="__codelineno-103-63" href="#__codelineno-103-63"></a><span class="sd">EXAMPLE: If you have a question to ask, set next=&#39;question&#39; and ask the user.</span>
</span><span id="__span-103-64"><a id="__codelineno-103-64" name="__codelineno-103-64" href="#__codelineno-103-64"></a><span class="sd">4) You can carry over arguments from one tool to another.</span>
</span><span id="__span-103-65"><a id="__codelineno-103-65" name="__codelineno-103-65" href="#__codelineno-103-65"></a><span class="sd"> EXAMPLE: If you asked for an account ID, then use the conversation history to infer that argument going forward.</span>
</span><span id="__span-103-66"><a id="__codelineno-103-66" name="__codelineno-103-66" href="#__codelineno-103-66"></a><span class="sd">5) If ListAgents in the conversation history is force_confirm=&#39;False&#39;, you MUST check if the current tool contains userConfirmation. If it does, please ask the user to confirm details with the user. userConfirmation overrides force_confirm=&#39;False&#39;.</span>
</span><span id="__span-103-67"><a id="__codelineno-103-67" name="__codelineno-103-67" href="#__codelineno-103-67"></a><span class="sd">EXAMPLE: (force_confirm=&#39;False&#39; AND userConfirmation exists on tool) Would you like me to &lt;run tool&gt; with the following details: &lt;details&gt;?</span>
</span><span id="__span-103-68"><a id="__codelineno-103-68" name="__codelineno-103-68" href="#__codelineno-103-68"></a>
</span><span id="__span-103-69"><a id="__codelineno-103-69" name="__codelineno-103-69" href="#__codelineno-103-69"></a><span class="sd">{% if raw_json is not none %}</span>
</span><span id="__span-103-70"><a id="__codelineno-103-70" name="__codelineno-103-70" href="#__codelineno-103-70"></a>
</span><span id="__span-103-71"><a id="__codelineno-103-71" name="__codelineno-103-71" href="#__codelineno-103-71"></a><span class="sd">=== Validation Task ===</span>
</span><span id="__span-103-72"><a id="__codelineno-103-72" name="__codelineno-103-72" href="#__codelineno-103-72"></a><span class="sd">Validate and correct the following JSON if needed:</span>
</span><span id="__span-103-73"><a id="__codelineno-103-73" name="__codelineno-103-73" href="#__codelineno-103-73"></a><span class="sd">{{ raw_json_str }}</span>
</span><span id="__span-103-74"><a id="__codelineno-103-74" name="__codelineno-103-74" href="#__codelineno-103-74"></a>
</span><span id="__span-103-75"><a id="__codelineno-103-75" name="__codelineno-103-75" href="#__codelineno-103-75"></a><span class="sd">Check syntax, &#39;tool&#39; validity, &#39;args&#39; completeness, and set &#39;next&#39; appropriately. Return ONLY corrected JSON.</span>
</span><span id="__span-103-76"><a id="__codelineno-103-76" name="__codelineno-103-76" href="#__codelineno-103-76"></a><span class="sd">{% endif %}</span>
</span><span id="__span-103-77"><a id="__codelineno-103-77" name="__codelineno-103-77" href="#__codelineno-103-77"></a>
</span><span id="__span-103-78"><a id="__codelineno-103-78" name="__codelineno-103-78" href="#__codelineno-103-78"></a><span class="sd">{% if raw_json is not none %}</span>
</span><span id="__span-103-79"><a id="__codelineno-103-79" name="__codelineno-103-79" href="#__codelineno-103-79"></a><span class="sd">Begin by validating the provided JSON if necessary.</span>
</span><span id="__span-103-80"><a id="__codelineno-103-80" name="__codelineno-103-80" href="#__codelineno-103-80"></a><span class="sd">{% else %}</span>
</span><span id="__span-103-81"><a id="__codelineno-103-81" name="__codelineno-103-81" href="#__codelineno-103-81"></a><span class="sd">Begin by producing a valid JSON response for the next tool or question.</span>
</span><span id="__span-103-82"><a id="__codelineno-103-82" name="__codelineno-103-82" href="#__codelineno-103-82"></a><span class="sd">{% endif %}</span>
</span><span id="__span-103-83"><a id="__codelineno-103-83" name="__codelineno-103-83" href="#__codelineno-103-83"></a><span class="sd">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="__span-103-84"><a id="__codelineno-103-84" name="__codelineno-103-84" href="#__codelineno-103-84"></a><span class="p">)</span>
</span></code></pre></div>
<p>Next, you'll create the prompt that will determine the next steps for your agent to take.</p>
<h4 id="defining-the-tool-completion-prompt">Defining the tool completion prompt<a class="headerlink" href="#defining-the-tool-completion-prompt" title="Permanent link">&para;</a></h4>
<p>The <code>TOOL_COMPLETION_PROMPT</code> instructs the LLM to analyze the successful tool results and determine the appropriate next steps. 
This prompt only requires minimal substitution, so a Python string formatting will suffice.</p>
<p>Add the following constant to your <code>prompts/prompts.py</code> file:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-104-1"><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a><span class="n">TOOL_COMPLETION_PROMPT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;### The &#39;</span><span class="si">{current_tool}</span><span class="s2">&#39; tool completed successfully </span>
</span><span id="__span-104-2"><a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a><span class="s2">with </span><span class="si">{dynamic_result}</span><span class="s2">. </span>
</span><span id="__span-104-3"><a id="__codelineno-104-3" name="__codelineno-104-3" href="#__codelineno-104-3"></a><span class="s2">INSTRUCTIONS: Parse this tool result as plain text, and use the system prompt </span>
</span><span id="__span-104-4"><a id="__codelineno-104-4" name="__codelineno-104-4" href="#__codelineno-104-4"></a><span class="s2">containing the list of tools in sequence and the conversation history (and </span>
</span><span id="__span-104-5"><a id="__codelineno-104-5" name="__codelineno-104-5" href="#__codelineno-104-5"></a><span class="s2">previous tool_results) to figure out next steps, if any. </span>
</span><span id="__span-104-6"><a id="__codelineno-104-6" name="__codelineno-104-6" href="#__codelineno-104-6"></a><span class="s2">You will need to use the tool_results to auto-fill arguments for subsequent </span>
</span><span id="__span-104-7"><a id="__codelineno-104-7" name="__codelineno-104-7" href="#__codelineno-104-7"></a><span class="s2">tools and also to figure out if all tools have been run. </span>
</span><span id="__span-104-8"><a id="__codelineno-104-8" name="__codelineno-104-8" href="#__codelineno-104-8"></a><span class="s2">{{&quot;next&quot;: &quot;&lt;question|confirm|pick-new-goal|done&gt;&quot;, &quot;tool&quot;: &quot;&lt;tool_name or null&gt;&quot;, &quot;args&quot;: {{&quot;&lt;arg1&gt;&quot;: &quot;&lt;value1 or null&gt;&quot;, &quot;&lt;arg2&gt;&quot;: &quot;&lt;value2 or null&gt;&quot;}}, &quot;response&quot;: &quot;&lt;plain text (can include </span><span class="se">\\</span><span class="s2">n line breaks)&gt;&quot;}}</span>
</span><span id="__span-104-9"><a id="__codelineno-104-9" name="__codelineno-104-9" href="#__codelineno-104-9"></a><span class="s2">ONLY return those json keys (next, tool, args, response), nothing else. </span>
</span><span id="__span-104-10"><a id="__codelineno-104-10" name="__codelineno-104-10" href="#__codelineno-104-10"></a><span class="s2">Next should be &quot;question&quot; if the tool is not the last one in the sequence. </span>
</span><span id="__span-104-11"><a id="__codelineno-104-11" name="__codelineno-104-11" href="#__codelineno-104-11"></a><span class="s2">Next should be &quot;done&quot; if the user is asking to be done with the chat.&quot;&quot;&quot;</span>
</span></code></pre></div>
<p>This template handles successful tool completion scenarios, instructing the LLM to use the results of the execution when determining the next step.
It also gives explicit instructions on exactly how to respond, which keys should be present, and the format of the output.</p>
<p>Next, you'll implement the prompt for handling missing user arguments.</p>
<h4 id="defining-the-missing-arguments-prompt">Defining the missing arguments prompt<a class="headerlink" href="#defining-the-missing-arguments-prompt" title="Permanent link">&para;</a></h4>
<p>If the user doesn't provide enough information to the agent, the agent needs to detect this and set the next action to prompt the user for the missing arguments.
This prompt only has a few variable substitutions, so a Python string formatting will suffice.</p>
<p>Add the missing arguments template to your <code>prompts/prompts.py</code> file:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-105-1"><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a><span class="n">MISSING_ARGS_PROMPT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;### INSTRUCTIONS set next=&#39;question&#39;, combine </span>
</span><span id="__span-105-2"><a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a><span class="s2">this response response=&#39;</span><span class="si">{response}</span><span class="s2">&#39; and following missing arguments for tool </span>
</span><span id="__span-105-3"><a id="__codelineno-105-3" name="__codelineno-105-3" href="#__codelineno-105-3"></a><span class="si">{current_tool}</span><span class="s2">: </span><span class="si">{missing_args}</span><span class="s2">. Only provide a valid JSON response without any </span>
</span><span id="__span-105-4"><a id="__codelineno-105-4" name="__codelineno-105-4" href="#__codelineno-105-4"></a><span class="s2">comments or metadata.&quot;&quot;&quot;</span>
</span></code></pre></div>
<p>This template provides the response, sets the next key to <code>question</code> to instruct the agent to prompt the user for more information, and specifies which tool is missing which argument.</p>
<h4 id="defining-the-toolchain-complete-prompt">Defining the toolchain complete prompt<a class="headerlink" href="#defining-the-toolchain-complete-prompt" title="Permanent link">&para;</a></h4>
<p>Finally, define the prompt that details what the LLM should do if no more tools are needed to complete the agent's goal.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-106-1"><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a><span class="n">TOOLCHAIN_COMPLETE_GUIDANCE_PROMPT</span> <span class="o">=</span> <span class="s2">&quot;If no more tools are needed (user_confirmed_tool_run has been run for all), set next=&#39;done&#39; and tool=&#39;&#39;.&quot;</span>
</span></code></pre></div>
<details>

<summary>
The <code>prompts/prompts.py</code> is complete and will need no more revisions. You can review the complete file and copy the code here.
</summary>

<br />
Hover your cursor over the code block to reveal the copy-code option.
<br />
<br />

[prompts/prompts](https://github.com/temporal-community/tutorial-temporal-ai-agent/blob/main/prompts/prompts.py)

<div class="language-python highlight"><pre><span></span><code><span id="__span-107-1"><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">jinja2</span><span class="w"> </span><span class="kn">import</span> <span class="n">Template</span>
</span><span id="__span-107-2"><a id="__codelineno-107-2" name="__codelineno-107-2" href="#__codelineno-107-2"></a>
</span><span id="__span-107-3"><a id="__codelineno-107-3" name="__codelineno-107-3" href="#__codelineno-107-3"></a><span class="c1"># Define the Jinja2 template</span>
</span><span id="__span-107-4"><a id="__codelineno-107-4" name="__codelineno-107-4" href="#__codelineno-107-4"></a><span class="n">GENAI_PROMPT</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span>
</span><span id="__span-107-5"><a id="__codelineno-107-5" name="__codelineno-107-5" href="#__codelineno-107-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-107-6"><a id="__codelineno-107-6" name="__codelineno-107-6" href="#__codelineno-107-6"></a><span class="sd">You are an AI agent that helps fill required arguments for the tools described below. </span>
</span><span id="__span-107-7"><a id="__codelineno-107-7" name="__codelineno-107-7" href="#__codelineno-107-7"></a><span class="sd">You must respond with valid JSON ONLY, using the schema provided in the instructions.</span>
</span><span id="__span-107-8"><a id="__codelineno-107-8" name="__codelineno-107-8" href="#__codelineno-107-8"></a>
</span><span id="__span-107-9"><a id="__codelineno-107-9" name="__codelineno-107-9" href="#__codelineno-107-9"></a><span class="sd">=== Conversation History ===</span>
</span><span id="__span-107-10"><a id="__codelineno-107-10" name="__codelineno-107-10" href="#__codelineno-107-10"></a><span class="sd">This is the ongoing history to determine which tool and arguments to gather:</span>
</span><span id="__span-107-11"><a id="__codelineno-107-11" name="__codelineno-107-11" href="#__codelineno-107-11"></a><span class="sd">*BEGIN CONVERSATION HISTORY*</span>
</span><span id="__span-107-12"><a id="__codelineno-107-12" name="__codelineno-107-12" href="#__codelineno-107-12"></a><span class="sd">{{ conversation_history_json }}</span>
</span><span id="__span-107-13"><a id="__codelineno-107-13" name="__codelineno-107-13" href="#__codelineno-107-13"></a><span class="sd">*END CONVERSATION HISTORY*</span>
</span><span id="__span-107-14"><a id="__codelineno-107-14" name="__codelineno-107-14" href="#__codelineno-107-14"></a><span class="sd">REMINDER: You can use the conversation history to infer arguments for the tools.</span>
</span><span id="__span-107-15"><a id="__codelineno-107-15" name="__codelineno-107-15" href="#__codelineno-107-15"></a>
</span><span id="__span-107-16"><a id="__codelineno-107-16" name="__codelineno-107-16" href="#__codelineno-107-16"></a><span class="sd">{% if agent_goal.example_conversation_history %}</span>
</span><span id="__span-107-17"><a id="__codelineno-107-17" name="__codelineno-107-17" href="#__codelineno-107-17"></a><span class="sd">=== Example Conversation With These Tools ===</span>
</span><span id="__span-107-18"><a id="__codelineno-107-18" name="__codelineno-107-18" href="#__codelineno-107-18"></a><span class="sd">Use this example to understand how tools are invoked and arguments are gathered.</span>
</span><span id="__span-107-19"><a id="__codelineno-107-19" name="__codelineno-107-19" href="#__codelineno-107-19"></a><span class="sd">BEGIN EXAMPLE</span>
</span><span id="__span-107-20"><a id="__codelineno-107-20" name="__codelineno-107-20" href="#__codelineno-107-20"></a><span class="sd">{{ agent_goal.example_conversation_history }}</span>
</span><span id="__span-107-21"><a id="__codelineno-107-21" name="__codelineno-107-21" href="#__codelineno-107-21"></a><span class="sd">END EXAMPLE</span>
</span><span id="__span-107-22"><a id="__codelineno-107-22" name="__codelineno-107-22" href="#__codelineno-107-22"></a>
</span><span id="__span-107-23"><a id="__codelineno-107-23" name="__codelineno-107-23" href="#__codelineno-107-23"></a><span class="sd">{% endif %}</span>
</span><span id="__span-107-24"><a id="__codelineno-107-24" name="__codelineno-107-24" href="#__codelineno-107-24"></a><span class="sd">=== Tools Definitions ===</span>
</span><span id="__span-107-25"><a id="__codelineno-107-25" name="__codelineno-107-25" href="#__codelineno-107-25"></a><span class="sd">There are {{ agent_goal.tools|length }} available tools:</span>
</span><span id="__span-107-26"><a id="__codelineno-107-26" name="__codelineno-107-26" href="#__codelineno-107-26"></a><span class="sd">{{ agent_goal.tools|map(attribute=&#39;name&#39;)|join(&#39;, &#39;) }}</span>
</span><span id="__span-107-27"><a id="__codelineno-107-27" name="__codelineno-107-27" href="#__codelineno-107-27"></a><span class="sd">Goal: {{ agent_goal.description }}</span>
</span><span id="__span-107-28"><a id="__codelineno-107-28" name="__codelineno-107-28" href="#__codelineno-107-28"></a><span class="sd">Gather the necessary information for each tool in the sequence described above.</span>
</span><span id="__span-107-29"><a id="__codelineno-107-29" name="__codelineno-107-29" href="#__codelineno-107-29"></a><span class="sd">Only ask for arguments listed below. Do not add extra arguments.</span>
</span><span id="__span-107-30"><a id="__codelineno-107-30" name="__codelineno-107-30" href="#__codelineno-107-30"></a>
</span><span id="__span-107-31"><a id="__codelineno-107-31" name="__codelineno-107-31" href="#__codelineno-107-31"></a><span class="sd">{% for tool in agent_goal.tools %}</span>
</span><span id="__span-107-32"><a id="__codelineno-107-32" name="__codelineno-107-32" href="#__codelineno-107-32"></a><span class="sd">Tool name: {{ tool.name }}</span>
</span><span id="__span-107-33"><a id="__codelineno-107-33" name="__codelineno-107-33" href="#__codelineno-107-33"></a><span class="sd">  Description: {{ tool.description }}</span>
</span><span id="__span-107-34"><a id="__codelineno-107-34" name="__codelineno-107-34" href="#__codelineno-107-34"></a><span class="sd">  Required args:</span>
</span><span id="__span-107-35"><a id="__codelineno-107-35" name="__codelineno-107-35" href="#__codelineno-107-35"></a><span class="sd">{% for arg in tool.arguments %}</span>
</span><span id="__span-107-36"><a id="__codelineno-107-36" name="__codelineno-107-36" href="#__codelineno-107-36"></a><span class="sd">    - {{ arg.name }} ({{ arg.type }}): {{ arg.description }}</span>
</span><span id="__span-107-37"><a id="__codelineno-107-37" name="__codelineno-107-37" href="#__codelineno-107-37"></a><span class="sd">{% endfor %}</span>
</span><span id="__span-107-38"><a id="__codelineno-107-38" name="__codelineno-107-38" href="#__codelineno-107-38"></a>
</span><span id="__span-107-39"><a id="__codelineno-107-39" name="__codelineno-107-39" href="#__codelineno-107-39"></a><span class="sd">{% endfor %}</span>
</span><span id="__span-107-40"><a id="__codelineno-107-40" name="__codelineno-107-40" href="#__codelineno-107-40"></a><span class="sd">When all required args for a tool are known, you can propose next=&#39;confirm&#39; to run it.</span>
</span><span id="__span-107-41"><a id="__codelineno-107-41" name="__codelineno-107-41" href="#__codelineno-107-41"></a>
</span><span id="__span-107-42"><a id="__codelineno-107-42" name="__codelineno-107-42" href="#__codelineno-107-42"></a><span class="sd">=== Instructions for JSON Generation ===</span>
</span><span id="__span-107-43"><a id="__codelineno-107-43" name="__codelineno-107-43" href="#__codelineno-107-43"></a><span class="sd">Your JSON format must be:</span>
</span><span id="__span-107-44"><a id="__codelineno-107-44" name="__codelineno-107-44" href="#__codelineno-107-44"></a><span class="sd">{</span>
</span><span id="__span-107-45"><a id="__codelineno-107-45" name="__codelineno-107-45" href="#__codelineno-107-45"></a><span class="sd">  &quot;response&quot;: &quot;&lt;plain text&gt;&quot;,</span>
</span><span id="__span-107-46"><a id="__codelineno-107-46" name="__codelineno-107-46" href="#__codelineno-107-46"></a><span class="sd">  &quot;next&quot;: &quot;&lt;question|confirm|done&gt;&quot;,</span>
</span><span id="__span-107-47"><a id="__codelineno-107-47" name="__codelineno-107-47" href="#__codelineno-107-47"></a><span class="sd">  &quot;tool&quot;: &quot;&lt;tool_name or null&gt;&quot;,</span>
</span><span id="__span-107-48"><a id="__codelineno-107-48" name="__codelineno-107-48" href="#__codelineno-107-48"></a><span class="sd">  &quot;args&quot;: {</span>
</span><span id="__span-107-49"><a id="__codelineno-107-49" name="__codelineno-107-49" href="#__codelineno-107-49"></a><span class="sd">    &quot;&lt;arg1&gt;&quot;: &quot;&lt;value1 or null&gt;&quot;,</span>
</span><span id="__span-107-50"><a id="__codelineno-107-50" name="__codelineno-107-50" href="#__codelineno-107-50"></a><span class="sd">    &quot;&lt;arg2&gt;&quot;: &quot;&lt;value2 or null&gt;&quot;,</span>
</span><span id="__span-107-51"><a id="__codelineno-107-51" name="__codelineno-107-51" href="#__codelineno-107-51"></a><span class="sd">    ...</span>
</span><span id="__span-107-52"><a id="__codelineno-107-52" name="__codelineno-107-52" href="#__codelineno-107-52"></a><span class="sd">  }</span>
</span><span id="__span-107-53"><a id="__codelineno-107-53" name="__codelineno-107-53" href="#__codelineno-107-53"></a><span class="sd">}</span>
</span><span id="__span-107-54"><a id="__codelineno-107-54" name="__codelineno-107-54" href="#__codelineno-107-54"></a><span class="sd">1) If any required argument is missing, set next=&#39;question&#39; and ask the user.</span>
</span><span id="__span-107-55"><a id="__codelineno-107-55" name="__codelineno-107-55" href="#__codelineno-107-55"></a><span class="sd">2) If all required arguments are known, set next=&#39;confirm&#39; and specify the tool.</span>
</span><span id="__span-107-56"><a id="__codelineno-107-56" name="__codelineno-107-56" href="#__codelineno-107-56"></a><span class="sd">   The user will confirm before the tool is run.</span>
</span><span id="__span-107-57"><a id="__codelineno-107-57" name="__codelineno-107-57" href="#__codelineno-107-57"></a><span class="sd">3) {{ toolchain_complete_guidance }}</span>
</span><span id="__span-107-58"><a id="__codelineno-107-58" name="__codelineno-107-58" href="#__codelineno-107-58"></a><span class="sd">4) response should be short and user-friendly.</span>
</span><span id="__span-107-59"><a id="__codelineno-107-59" name="__codelineno-107-59" href="#__codelineno-107-59"></a>
</span><span id="__span-107-60"><a id="__codelineno-107-60" name="__codelineno-107-60" href="#__codelineno-107-60"></a><span class="sd">Guardrails (always remember!)</span>
</span><span id="__span-107-61"><a id="__codelineno-107-61" name="__codelineno-107-61" href="#__codelineno-107-61"></a><span class="sd">1) If any required argument is missing, set next=&#39;question&#39; and ask the user.</span>
</span><span id="__span-107-62"><a id="__codelineno-107-62" name="__codelineno-107-62" href="#__codelineno-107-62"></a><span class="sd">1) ALWAYS ask a question in your response if next=&#39;question&#39;.</span>
</span><span id="__span-107-63"><a id="__codelineno-107-63" name="__codelineno-107-63" href="#__codelineno-107-63"></a><span class="sd">2) ALWAYS set next=&#39;confirm&#39; if you have arguments</span>
</span><span id="__span-107-64"><a id="__codelineno-107-64" name="__codelineno-107-64" href="#__codelineno-107-64"></a><span class="sd"> And respond with &quot;let&#39;s proceed with &lt;tool&gt; (and any other useful info)&quot; </span>
</span><span id="__span-107-65"><a id="__codelineno-107-65" name="__codelineno-107-65" href="#__codelineno-107-65"></a><span class="sd"> DON&#39;T set next=&#39;confirm&#39; if you have a question to ask.</span>
</span><span id="__span-107-66"><a id="__codelineno-107-66" name="__codelineno-107-66" href="#__codelineno-107-66"></a><span class="sd">EXAMPLE: If you have a question to ask, set next=&#39;question&#39; and ask the user.</span>
</span><span id="__span-107-67"><a id="__codelineno-107-67" name="__codelineno-107-67" href="#__codelineno-107-67"></a><span class="sd">3) You can carry over arguments from one tool to another.</span>
</span><span id="__span-107-68"><a id="__codelineno-107-68" name="__codelineno-107-68" href="#__codelineno-107-68"></a><span class="sd"> EXAMPLE: If you asked for an account ID, then use the conversation history to infer that argument going forward.</span>
</span><span id="__span-107-69"><a id="__codelineno-107-69" name="__codelineno-107-69" href="#__codelineno-107-69"></a><span class="sd">4) If ListAgents in the conversation history is force_confirm=&#39;False&#39;, you MUST check if the current tool contains userConfirmation. If it does, please ask the user to confirm details with the user. userConfirmation overrides force_confirm=&#39;False&#39;.</span>
</span><span id="__span-107-70"><a id="__codelineno-107-70" name="__codelineno-107-70" href="#__codelineno-107-70"></a><span class="sd">EXAMPLE: (force_confirm=&#39;False&#39; AND userConfirmation exists on tool) Would you like me to &lt;run tool&gt; with the following details: &lt;details&gt;?</span>
</span><span id="__span-107-71"><a id="__codelineno-107-71" name="__codelineno-107-71" href="#__codelineno-107-71"></a>
</span><span id="__span-107-72"><a id="__codelineno-107-72" name="__codelineno-107-72" href="#__codelineno-107-72"></a><span class="sd">{% if raw_json is not none %}</span>
</span><span id="__span-107-73"><a id="__codelineno-107-73" name="__codelineno-107-73" href="#__codelineno-107-73"></a>
</span><span id="__span-107-74"><a id="__codelineno-107-74" name="__codelineno-107-74" href="#__codelineno-107-74"></a><span class="sd">=== Validation Task ===</span>
</span><span id="__span-107-75"><a id="__codelineno-107-75" name="__codelineno-107-75" href="#__codelineno-107-75"></a><span class="sd">Validate and correct the following JSON if needed:</span>
</span><span id="__span-107-76"><a id="__codelineno-107-76" name="__codelineno-107-76" href="#__codelineno-107-76"></a><span class="sd">{{ raw_json_str }}</span>
</span><span id="__span-107-77"><a id="__codelineno-107-77" name="__codelineno-107-77" href="#__codelineno-107-77"></a>
</span><span id="__span-107-78"><a id="__codelineno-107-78" name="__codelineno-107-78" href="#__codelineno-107-78"></a><span class="sd">Check syntax, &#39;tool&#39; validity, &#39;args&#39; completeness, and set &#39;next&#39; appropriately. Return ONLY corrected JSON.</span>
</span><span id="__span-107-79"><a id="__codelineno-107-79" name="__codelineno-107-79" href="#__codelineno-107-79"></a><span class="sd">{% endif %}</span>
</span><span id="__span-107-80"><a id="__codelineno-107-80" name="__codelineno-107-80" href="#__codelineno-107-80"></a>
</span><span id="__span-107-81"><a id="__codelineno-107-81" name="__codelineno-107-81" href="#__codelineno-107-81"></a><span class="sd">{% if raw_json is not none %}</span>
</span><span id="__span-107-82"><a id="__codelineno-107-82" name="__codelineno-107-82" href="#__codelineno-107-82"></a><span class="sd">Begin by validating the provided JSON if necessary.</span>
</span><span id="__span-107-83"><a id="__codelineno-107-83" name="__codelineno-107-83" href="#__codelineno-107-83"></a><span class="sd">{% else %}</span>
</span><span id="__span-107-84"><a id="__codelineno-107-84" name="__codelineno-107-84" href="#__codelineno-107-84"></a><span class="sd">Begin by producing a valid JSON response for the next tool or question.</span>
</span><span id="__span-107-85"><a id="__codelineno-107-85" name="__codelineno-107-85" href="#__codelineno-107-85"></a><span class="sd">{% endif %}</span>
</span><span id="__span-107-86"><a id="__codelineno-107-86" name="__codelineno-107-86" href="#__codelineno-107-86"></a><span class="sd">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="__span-107-87"><a id="__codelineno-107-87" name="__codelineno-107-87" href="#__codelineno-107-87"></a><span class="p">)</span>
</span><span id="__span-107-88"><a id="__codelineno-107-88" name="__codelineno-107-88" href="#__codelineno-107-88"></a>
</span><span id="__span-107-89"><a id="__codelineno-107-89" name="__codelineno-107-89" href="#__codelineno-107-89"></a><span class="n">TOOL_COMPLETION_PROMPT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;### The &#39;</span><span class="si">{current_tool}</span><span class="s2">&#39; tool completed successfully </span>
</span><span id="__span-107-90"><a id="__codelineno-107-90" name="__codelineno-107-90" href="#__codelineno-107-90"></a><span class="s2">with </span><span class="si">{dynamic_result}</span><span class="s2">. </span>
</span><span id="__span-107-91"><a id="__codelineno-107-91" name="__codelineno-107-91" href="#__codelineno-107-91"></a><span class="s2">INSTRUCTIONS: Parse this tool result as plain text, and use the system prompt </span>
</span><span id="__span-107-92"><a id="__codelineno-107-92" name="__codelineno-107-92" href="#__codelineno-107-92"></a><span class="s2">containing the list of tools in sequence and the conversation history (and </span>
</span><span id="__span-107-93"><a id="__codelineno-107-93" name="__codelineno-107-93" href="#__codelineno-107-93"></a><span class="s2">previous tool_results) to figure out next steps, if any. </span>
</span><span id="__span-107-94"><a id="__codelineno-107-94" name="__codelineno-107-94" href="#__codelineno-107-94"></a><span class="s2">You will need to use the tool_results to auto-fill arguments for subsequent </span>
</span><span id="__span-107-95"><a id="__codelineno-107-95" name="__codelineno-107-95" href="#__codelineno-107-95"></a><span class="s2">tools and also to figure out if all tools have been run. </span>
</span><span id="__span-107-96"><a id="__codelineno-107-96" name="__codelineno-107-96" href="#__codelineno-107-96"></a><span class="s2">{{&quot;next&quot;: &quot;&lt;question|confirm|done&gt;&quot;, &quot;tool&quot;: &quot;&lt;tool_name or null&gt;&quot;, &quot;args&quot;: {{&quot;&lt;arg1&gt;&quot;: &quot;&lt;value1 or null&gt;&quot;, &quot;&lt;arg2&gt;&quot;: &quot;&lt;value2 or null&gt;&quot;}}, &quot;response&quot;: &quot;&lt;plain text (can include </span><span class="se">\\</span><span class="s2">n line breaks)&gt;&quot;}}</span>
</span><span id="__span-107-97"><a id="__codelineno-107-97" name="__codelineno-107-97" href="#__codelineno-107-97"></a><span class="s2">ONLY return those json keys (next, tool, args, response), nothing else. </span>
</span><span id="__span-107-98"><a id="__codelineno-107-98" name="__codelineno-107-98" href="#__codelineno-107-98"></a><span class="s2">Next should be &quot;question&quot; if the tool is not the last one in the sequence. </span>
</span><span id="__span-107-99"><a id="__codelineno-107-99" name="__codelineno-107-99" href="#__codelineno-107-99"></a><span class="s2">Next should be &quot;done&quot; if the user is asking to be done with the chat.&quot;&quot;&quot;</span>
</span><span id="__span-107-100"><a id="__codelineno-107-100" name="__codelineno-107-100" href="#__codelineno-107-100"></a>
</span><span id="__span-107-101"><a id="__codelineno-107-101" name="__codelineno-107-101" href="#__codelineno-107-101"></a>
</span><span id="__span-107-102"><a id="__codelineno-107-102" name="__codelineno-107-102" href="#__codelineno-107-102"></a><span class="n">MISSING_ARGS_PROMPT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;### INSTRUCTIONS set next=&#39;question&#39;, combine </span>
</span><span id="__span-107-103"><a id="__codelineno-107-103" name="__codelineno-107-103" href="#__codelineno-107-103"></a><span class="s2">this response response=&#39;</span><span class="si">{response}</span><span class="s2">&#39; and following missing arguments for tool </span>
</span><span id="__span-107-104"><a id="__codelineno-107-104" name="__codelineno-107-104" href="#__codelineno-107-104"></a><span class="si">{current_tool}</span><span class="s2">: </span><span class="si">{missing_args}</span><span class="s2">. Only provide a valid JSON response without any </span>
</span><span id="__span-107-105"><a id="__codelineno-107-105" name="__codelineno-107-105" href="#__codelineno-107-105"></a><span class="s2">comments or metadata.&quot;&quot;&quot;</span>
</span><span id="__span-107-106"><a id="__codelineno-107-106" name="__codelineno-107-106" href="#__codelineno-107-106"></a>
</span><span id="__span-107-107"><a id="__codelineno-107-107" name="__codelineno-107-107" href="#__codelineno-107-107"></a><span class="n">TOOLCHAIN_COMPLETE_GUIDANCE_PROMPT</span> <span class="o">=</span> <span class="s2">&quot;If no more tools are needed (user_confirmed_tool_run has been run for all), set next=&#39;done&#39; and tool=&#39;&#39;.&quot;</span>
</span></code></pre></div>
</details>

<p>Next, you'll build the functions that use these prompt templates to generate the actual prompts.</p>
<h3 id="building-the-prompt-generation-functions">Building the prompt generation functions<a class="headerlink" href="#building-the-prompt-generation-functions" title="Permanent link">&para;</a></h3>
<p>Now that you have the prompt templates built, you need to implement functions the agent can call to render them.</p>
<p>First, create <code>prompts/agent_prompt_generators.py</code> and add the following imports:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-108-1"><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-108-2"><a id="__codelineno-108-2" name="__codelineno-108-2" href="#__codelineno-108-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span id="__span-108-3"><a id="__codelineno-108-3" name="__codelineno-108-3" href="#__codelineno-108-3"></a>
</span><span id="__span-108-4"><a id="__codelineno-108-4" name="__codelineno-108-4" href="#__codelineno-108-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentGoal</span>
</span><span id="__span-108-5"><a id="__codelineno-108-5" name="__codelineno-108-5" href="#__codelineno-108-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConversationHistory</span><span class="p">,</span> <span class="n">ToolData</span>
</span><span id="__span-108-6"><a id="__codelineno-108-6" name="__codelineno-108-6" href="#__codelineno-108-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">prompts.prompts</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-108-7"><a id="__codelineno-108-7" name="__codelineno-108-7" href="#__codelineno-108-7"></a>    <span class="n">GENAI_PROMPT</span><span class="p">,</span>
</span><span id="__span-108-8"><a id="__codelineno-108-8" name="__codelineno-108-8" href="#__codelineno-108-8"></a>    <span class="n">MISSING_ARGS_PROMPT</span><span class="p">,</span>
</span><span id="__span-108-9"><a id="__codelineno-108-9" name="__codelineno-108-9" href="#__codelineno-108-9"></a>    <span class="n">TOOL_COMPLETION_PROMPT</span><span class="p">,</span>
</span><span id="__span-108-10"><a id="__codelineno-108-10" name="__codelineno-108-10" href="#__codelineno-108-10"></a>    <span class="n">TOOLCHAIN_COMPLETE_GUIDANCE_PROMPT</span><span class="p">,</span>
</span><span id="__span-108-11"><a id="__codelineno-108-11" name="__codelineno-108-11" href="#__codelineno-108-11"></a><span class="p">)</span>
</span></code></pre></div>
<p>Next, create the function to render the <code>GENAI_PROMPT</code>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-109-1"><a id="__codelineno-109-1" name="__codelineno-109-1" href="#__codelineno-109-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_genai_prompt</span><span class="p">(</span>
</span><span id="__span-109-2"><a id="__codelineno-109-2" name="__codelineno-109-2" href="#__codelineno-109-2"></a>    <span class="n">agent_goal</span><span class="p">:</span> <span class="n">AgentGoal</span><span class="p">,</span>
</span><span id="__span-109-3"><a id="__codelineno-109-3" name="__codelineno-109-3" href="#__codelineno-109-3"></a>    <span class="n">conversation_history</span><span class="p">:</span> <span class="n">ConversationHistory</span><span class="p">,</span>
</span><span id="__span-109-4"><a id="__codelineno-109-4" name="__codelineno-109-4" href="#__codelineno-109-4"></a>    <span class="n">raw_json</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ToolData</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-109-5"><a id="__codelineno-109-5" name="__codelineno-109-5" href="#__codelineno-109-5"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-109-6"><a id="__codelineno-109-6" name="__codelineno-109-6" href="#__codelineno-109-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-109-7"><a id="__codelineno-109-7" name="__codelineno-109-7" href="#__codelineno-109-7"></a><span class="sd">    Generates a concise prompt for producing or validating JSON instructions</span>
</span><span id="__span-109-8"><a id="__codelineno-109-8" name="__codelineno-109-8" href="#__codelineno-109-8"></a><span class="sd">    with the provided tools and conversation history.</span>
</span><span id="__span-109-9"><a id="__codelineno-109-9" name="__codelineno-109-9" href="#__codelineno-109-9"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-109-10"><a id="__codelineno-109-10" name="__codelineno-109-10" href="#__codelineno-109-10"></a>
</span><span id="__span-109-11"><a id="__codelineno-109-11" name="__codelineno-109-11" href="#__codelineno-109-11"></a>    <span class="c1"># Prepare template variables</span>
</span><span id="__span-109-12"><a id="__codelineno-109-12" name="__codelineno-109-12" href="#__codelineno-109-12"></a>    <span class="n">template_vars</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-109-13"><a id="__codelineno-109-13" name="__codelineno-109-13" href="#__codelineno-109-13"></a>        <span class="s2">&quot;agent_goal&quot;</span><span class="p">:</span> <span class="n">agent_goal</span><span class="p">,</span>
</span><span id="__span-109-14"><a id="__codelineno-109-14" name="__codelineno-109-14" href="#__codelineno-109-14"></a>        <span class="s2">&quot;conversation_history_json&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">conversation_history</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
</span><span id="__span-109-15"><a id="__codelineno-109-15" name="__codelineno-109-15" href="#__codelineno-109-15"></a>        <span class="s2">&quot;toolchain_complete_guidance&quot;</span><span class="p">:</span> <span class="n">TOOLCHAIN_COMPLETE_GUIDANCE_PROMPT</span><span class="p">,</span>
</span><span id="__span-109-16"><a id="__codelineno-109-16" name="__codelineno-109-16" href="#__codelineno-109-16"></a>        <span class="s2">&quot;raw_json&quot;</span><span class="p">:</span> <span class="n">raw_json</span><span class="p">,</span>
</span><span id="__span-109-17"><a id="__codelineno-109-17" name="__codelineno-109-17" href="#__codelineno-109-17"></a>        <span class="s2">&quot;raw_json_str&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="__span-109-18"><a id="__codelineno-109-18" name="__codelineno-109-18" href="#__codelineno-109-18"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">raw_json</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">raw_json</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-109-19"><a id="__codelineno-109-19" name="__codelineno-109-19" href="#__codelineno-109-19"></a>        <span class="p">),</span>
</span><span id="__span-109-20"><a id="__codelineno-109-20" name="__codelineno-109-20" href="#__codelineno-109-20"></a>    <span class="p">}</span>
</span><span id="__span-109-21"><a id="__codelineno-109-21" name="__codelineno-109-21" href="#__codelineno-109-21"></a>
</span><span id="__span-109-22"><a id="__codelineno-109-22" name="__codelineno-109-22" href="#__codelineno-109-22"></a>    <span class="k">return</span> <span class="n">GENAI_PROMPT</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">template_vars</span><span class="p">)</span>
</span></code></pre></div>
<p>This function creates the <code>template_vars</code> dictionary, assigns the parameters to the appropriate template variables, and then renders the <code>Jinja2</code> template, passing in the dictionary as <code>kwargs</code> to the <code>render</code> function.</p>
<p>Next, add the tool completion prompt generator:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-110-1"><a id="__codelineno-110-1" name="__codelineno-110-1" href="#__codelineno-110-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_tool_completion_prompt</span><span class="p">(</span><span class="n">current_tool</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dynamic_result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-110-2"><a id="__codelineno-110-2" name="__codelineno-110-2" href="#__codelineno-110-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-110-3"><a id="__codelineno-110-3" name="__codelineno-110-3" href="#__codelineno-110-3"></a><span class="sd">    Generates a prompt for handling tool completion and determining next steps.</span>
</span><span id="__span-110-4"><a id="__codelineno-110-4" name="__codelineno-110-4" href="#__codelineno-110-4"></a>
</span><span id="__span-110-5"><a id="__codelineno-110-5" name="__codelineno-110-5" href="#__codelineno-110-5"></a><span class="sd">    Args:</span>
</span><span id="__span-110-6"><a id="__codelineno-110-6" name="__codelineno-110-6" href="#__codelineno-110-6"></a><span class="sd">        current_tool: The name of the tool that just completed</span>
</span><span id="__span-110-7"><a id="__codelineno-110-7" name="__codelineno-110-7" href="#__codelineno-110-7"></a><span class="sd">        dynamic_result: The result data from the tool execution</span>
</span><span id="__span-110-8"><a id="__codelineno-110-8" name="__codelineno-110-8" href="#__codelineno-110-8"></a>
</span><span id="__span-110-9"><a id="__codelineno-110-9" name="__codelineno-110-9" href="#__codelineno-110-9"></a><span class="sd">    Returns:</span>
</span><span id="__span-110-10"><a id="__codelineno-110-10" name="__codelineno-110-10" href="#__codelineno-110-10"></a><span class="sd">        str: A formatted prompt string for the agent to process the tool completion</span>
</span><span id="__span-110-11"><a id="__codelineno-110-11" name="__codelineno-110-11" href="#__codelineno-110-11"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-110-12"><a id="__codelineno-110-12" name="__codelineno-110-12" href="#__codelineno-110-12"></a>    <span class="k">return</span> <span class="n">TOOL_COMPLETION_PROMPT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="__span-110-13"><a id="__codelineno-110-13" name="__codelineno-110-13" href="#__codelineno-110-13"></a>        <span class="n">current_tool</span><span class="o">=</span><span class="n">current_tool</span><span class="p">,</span> <span class="n">dynamic_result</span><span class="o">=</span><span class="n">dynamic_result</span>
</span><span id="__span-110-14"><a id="__codelineno-110-14" name="__codelineno-110-14" href="#__codelineno-110-14"></a>    <span class="p">)</span>
</span></code></pre></div>
<p>This function takes in the current tool, along with the dynamic result system prompt and returns the formatted <code>TOOL_COMPLETION_PROMPT</code> using the <code>.format</code> function.</p>
<p>Finally, add the prompt for handling missing arguments:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-111-1"><a id="__codelineno-111-1" name="__codelineno-111-1" href="#__codelineno-111-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_missing_args_prompt</span><span class="p">(</span>
</span><span id="__span-111-2"><a id="__codelineno-111-2" name="__codelineno-111-2" href="#__codelineno-111-2"></a>    <span class="n">current_tool</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">missing_args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-111-3"><a id="__codelineno-111-3" name="__codelineno-111-3" href="#__codelineno-111-3"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-111-4"><a id="__codelineno-111-4" name="__codelineno-111-4" href="#__codelineno-111-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-111-5"><a id="__codelineno-111-5" name="__codelineno-111-5" href="#__codelineno-111-5"></a><span class="sd">    Generates a prompt for handling missing arguments for a tool.</span>
</span><span id="__span-111-6"><a id="__codelineno-111-6" name="__codelineno-111-6" href="#__codelineno-111-6"></a>
</span><span id="__span-111-7"><a id="__codelineno-111-7" name="__codelineno-111-7" href="#__codelineno-111-7"></a><span class="sd">    Args:</span>
</span><span id="__span-111-8"><a id="__codelineno-111-8" name="__codelineno-111-8" href="#__codelineno-111-8"></a><span class="sd">        current_tool: The name of the tool that needs arguments</span>
</span><span id="__span-111-9"><a id="__codelineno-111-9" name="__codelineno-111-9" href="#__codelineno-111-9"></a><span class="sd">        tool_data: The current tool data containing the response</span>
</span><span id="__span-111-10"><a id="__codelineno-111-10" name="__codelineno-111-10" href="#__codelineno-111-10"></a><span class="sd">        missing_args: List of argument names that are missing</span>
</span><span id="__span-111-11"><a id="__codelineno-111-11" name="__codelineno-111-11" href="#__codelineno-111-11"></a>
</span><span id="__span-111-12"><a id="__codelineno-111-12" name="__codelineno-111-12" href="#__codelineno-111-12"></a><span class="sd">    Returns:</span>
</span><span id="__span-111-13"><a id="__codelineno-111-13" name="__codelineno-111-13" href="#__codelineno-111-13"></a><span class="sd">        str: A formatted prompt string for requesting missing arguments</span>
</span><span id="__span-111-14"><a id="__codelineno-111-14" name="__codelineno-111-14" href="#__codelineno-111-14"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-111-15"><a id="__codelineno-111-15" name="__codelineno-111-15" href="#__codelineno-111-15"></a>    <span class="k">return</span> <span class="n">MISSING_ARGS_PROMPT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="__span-111-16"><a id="__codelineno-111-16" name="__codelineno-111-16" href="#__codelineno-111-16"></a>        <span class="n">response</span><span class="o">=</span><span class="n">tool_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">),</span>
</span><span id="__span-111-17"><a id="__codelineno-111-17" name="__codelineno-111-17" href="#__codelineno-111-17"></a>        <span class="n">current_tool</span><span class="o">=</span><span class="n">current_tool</span><span class="p">,</span>
</span><span id="__span-111-18"><a id="__codelineno-111-18" name="__codelineno-111-18" href="#__codelineno-111-18"></a>        <span class="n">missing_args</span><span class="o">=</span><span class="n">missing_args</span><span class="p">,</span>
</span><span id="__span-111-19"><a id="__codelineno-111-19" name="__codelineno-111-19" href="#__codelineno-111-19"></a>    <span class="p">)</span>
</span></code></pre></div>
<p>This function gets the response from the current tool, and the arguments missing, then returns a the formatted <code>MISSING_ARGS_PROMPT</code>.</p>
<details>

<summary>
The <code>prompts/agent_prompt_generators.py</code> is complete and will need no more revisions. You can review the complete file and copy the code here.
</summary>

<br />
Hover your cursor over the code block to reveal the copy-code option.
<br />
<br />

[prompts/agent_prompt_generators.py](https://github.com/temporal-community/tutorial-temporal-ai-agent/blob/main/prompts/agent_prompt_generators.py)

<div class="language-python highlight"><pre><span></span><code><span id="__span-112-1"><a id="__codelineno-112-1" name="__codelineno-112-1" href="#__codelineno-112-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="__span-112-2"><a id="__codelineno-112-2" name="__codelineno-112-2" href="#__codelineno-112-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span id="__span-112-3"><a id="__codelineno-112-3" name="__codelineno-112-3" href="#__codelineno-112-3"></a>
</span><span id="__span-112-4"><a id="__codelineno-112-4" name="__codelineno-112-4" href="#__codelineno-112-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentGoal</span>
</span><span id="__span-112-5"><a id="__codelineno-112-5" name="__codelineno-112-5" href="#__codelineno-112-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConversationHistory</span><span class="p">,</span> <span class="n">ToolData</span>
</span><span id="__span-112-6"><a id="__codelineno-112-6" name="__codelineno-112-6" href="#__codelineno-112-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">prompts.prompts</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-112-7"><a id="__codelineno-112-7" name="__codelineno-112-7" href="#__codelineno-112-7"></a>    <span class="n">GENAI_PROMPT</span><span class="p">,</span>
</span><span id="__span-112-8"><a id="__codelineno-112-8" name="__codelineno-112-8" href="#__codelineno-112-8"></a>    <span class="n">MISSING_ARGS_PROMPT</span><span class="p">,</span>
</span><span id="__span-112-9"><a id="__codelineno-112-9" name="__codelineno-112-9" href="#__codelineno-112-9"></a>    <span class="n">TOOL_COMPLETION_PROMPT</span><span class="p">,</span>
</span><span id="__span-112-10"><a id="__codelineno-112-10" name="__codelineno-112-10" href="#__codelineno-112-10"></a>    <span class="n">TOOLCHAIN_COMPLETE_GUIDANCE_PROMPT</span><span class="p">,</span>
</span><span id="__span-112-11"><a id="__codelineno-112-11" name="__codelineno-112-11" href="#__codelineno-112-11"></a><span class="p">)</span>
</span><span id="__span-112-12"><a id="__codelineno-112-12" name="__codelineno-112-12" href="#__codelineno-112-12"></a>
</span><span id="__span-112-13"><a id="__codelineno-112-13" name="__codelineno-112-13" href="#__codelineno-112-13"></a>
</span><span id="__span-112-14"><a id="__codelineno-112-14" name="__codelineno-112-14" href="#__codelineno-112-14"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_genai_prompt</span><span class="p">(</span>
</span><span id="__span-112-15"><a id="__codelineno-112-15" name="__codelineno-112-15" href="#__codelineno-112-15"></a>    <span class="n">agent_goal</span><span class="p">:</span> <span class="n">AgentGoal</span><span class="p">,</span>
</span><span id="__span-112-16"><a id="__codelineno-112-16" name="__codelineno-112-16" href="#__codelineno-112-16"></a>    <span class="n">conversation_history</span><span class="p">:</span> <span class="n">ConversationHistory</span><span class="p">,</span>
</span><span id="__span-112-17"><a id="__codelineno-112-17" name="__codelineno-112-17" href="#__codelineno-112-17"></a>    <span class="n">raw_json</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ToolData</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="__span-112-18"><a id="__codelineno-112-18" name="__codelineno-112-18" href="#__codelineno-112-18"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-112-19"><a id="__codelineno-112-19" name="__codelineno-112-19" href="#__codelineno-112-19"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-112-20"><a id="__codelineno-112-20" name="__codelineno-112-20" href="#__codelineno-112-20"></a><span class="sd">    Generates a concise prompt for producing or validating JSON instructions</span>
</span><span id="__span-112-21"><a id="__codelineno-112-21" name="__codelineno-112-21" href="#__codelineno-112-21"></a><span class="sd">    with the provided tools and conversation history.</span>
</span><span id="__span-112-22"><a id="__codelineno-112-22" name="__codelineno-112-22" href="#__codelineno-112-22"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-112-23"><a id="__codelineno-112-23" name="__codelineno-112-23" href="#__codelineno-112-23"></a>
</span><span id="__span-112-24"><a id="__codelineno-112-24" name="__codelineno-112-24" href="#__codelineno-112-24"></a>    <span class="c1"># Prepare template variables</span>
</span><span id="__span-112-25"><a id="__codelineno-112-25" name="__codelineno-112-25" href="#__codelineno-112-25"></a>    <span class="n">template_vars</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-112-26"><a id="__codelineno-112-26" name="__codelineno-112-26" href="#__codelineno-112-26"></a>        <span class="s2">&quot;agent_goal&quot;</span><span class="p">:</span> <span class="n">agent_goal</span><span class="p">,</span>
</span><span id="__span-112-27"><a id="__codelineno-112-27" name="__codelineno-112-27" href="#__codelineno-112-27"></a>        <span class="s2">&quot;conversation_history_json&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">conversation_history</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
</span><span id="__span-112-28"><a id="__codelineno-112-28" name="__codelineno-112-28" href="#__codelineno-112-28"></a>        <span class="s2">&quot;toolchain_complete_guidance&quot;</span><span class="p">:</span> <span class="n">TOOLCHAIN_COMPLETE_GUIDANCE_PROMPT</span><span class="p">,</span>
</span><span id="__span-112-29"><a id="__codelineno-112-29" name="__codelineno-112-29" href="#__codelineno-112-29"></a>        <span class="s2">&quot;raw_json&quot;</span><span class="p">:</span> <span class="n">raw_json</span><span class="p">,</span>
</span><span id="__span-112-30"><a id="__codelineno-112-30" name="__codelineno-112-30" href="#__codelineno-112-30"></a>        <span class="s2">&quot;raw_json_str&quot;</span><span class="p">:</span> <span class="p">(</span>
</span><span id="__span-112-31"><a id="__codelineno-112-31" name="__codelineno-112-31" href="#__codelineno-112-31"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">raw_json</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">raw_json</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="__span-112-32"><a id="__codelineno-112-32" name="__codelineno-112-32" href="#__codelineno-112-32"></a>        <span class="p">),</span>
</span><span id="__span-112-33"><a id="__codelineno-112-33" name="__codelineno-112-33" href="#__codelineno-112-33"></a>    <span class="p">}</span>
</span><span id="__span-112-34"><a id="__codelineno-112-34" name="__codelineno-112-34" href="#__codelineno-112-34"></a>
</span><span id="__span-112-35"><a id="__codelineno-112-35" name="__codelineno-112-35" href="#__codelineno-112-35"></a>    <span class="k">return</span> <span class="n">GENAI_PROMPT</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">template_vars</span><span class="p">)</span>
</span><span id="__span-112-36"><a id="__codelineno-112-36" name="__codelineno-112-36" href="#__codelineno-112-36"></a>
</span><span id="__span-112-37"><a id="__codelineno-112-37" name="__codelineno-112-37" href="#__codelineno-112-37"></a>
</span><span id="__span-112-38"><a id="__codelineno-112-38" name="__codelineno-112-38" href="#__codelineno-112-38"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_tool_completion_prompt</span><span class="p">(</span><span class="n">current_tool</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dynamic_result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-112-39"><a id="__codelineno-112-39" name="__codelineno-112-39" href="#__codelineno-112-39"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-112-40"><a id="__codelineno-112-40" name="__codelineno-112-40" href="#__codelineno-112-40"></a><span class="sd">    Generates a prompt for handling tool completion and determining next steps.</span>
</span><span id="__span-112-41"><a id="__codelineno-112-41" name="__codelineno-112-41" href="#__codelineno-112-41"></a>
</span><span id="__span-112-42"><a id="__codelineno-112-42" name="__codelineno-112-42" href="#__codelineno-112-42"></a><span class="sd">    Args:</span>
</span><span id="__span-112-43"><a id="__codelineno-112-43" name="__codelineno-112-43" href="#__codelineno-112-43"></a><span class="sd">        current_tool: The name of the tool that just completed</span>
</span><span id="__span-112-44"><a id="__codelineno-112-44" name="__codelineno-112-44" href="#__codelineno-112-44"></a><span class="sd">        dynamic_result: The result data from the tool execution</span>
</span><span id="__span-112-45"><a id="__codelineno-112-45" name="__codelineno-112-45" href="#__codelineno-112-45"></a>
</span><span id="__span-112-46"><a id="__codelineno-112-46" name="__codelineno-112-46" href="#__codelineno-112-46"></a><span class="sd">    Returns:</span>
</span><span id="__span-112-47"><a id="__codelineno-112-47" name="__codelineno-112-47" href="#__codelineno-112-47"></a><span class="sd">        str: A formatted prompt string for the agent to process the tool completion</span>
</span><span id="__span-112-48"><a id="__codelineno-112-48" name="__codelineno-112-48" href="#__codelineno-112-48"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-112-49"><a id="__codelineno-112-49" name="__codelineno-112-49" href="#__codelineno-112-49"></a>    <span class="k">return</span> <span class="n">TOOL_COMPLETION_PROMPT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="__span-112-50"><a id="__codelineno-112-50" name="__codelineno-112-50" href="#__codelineno-112-50"></a>        <span class="n">current_tool</span><span class="o">=</span><span class="n">current_tool</span><span class="p">,</span> <span class="n">dynamic_result</span><span class="o">=</span><span class="n">dynamic_result</span>
</span><span id="__span-112-51"><a id="__codelineno-112-51" name="__codelineno-112-51" href="#__codelineno-112-51"></a>    <span class="p">)</span>
</span><span id="__span-112-52"><a id="__codelineno-112-52" name="__codelineno-112-52" href="#__codelineno-112-52"></a>
</span><span id="__span-112-53"><a id="__codelineno-112-53" name="__codelineno-112-53" href="#__codelineno-112-53"></a>
</span><span id="__span-112-54"><a id="__codelineno-112-54" name="__codelineno-112-54" href="#__codelineno-112-54"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_missing_args_prompt</span><span class="p">(</span>
</span><span id="__span-112-55"><a id="__codelineno-112-55" name="__codelineno-112-55" href="#__codelineno-112-55"></a>    <span class="n">current_tool</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">missing_args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="__span-112-56"><a id="__codelineno-112-56" name="__codelineno-112-56" href="#__codelineno-112-56"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-112-57"><a id="__codelineno-112-57" name="__codelineno-112-57" href="#__codelineno-112-57"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-112-58"><a id="__codelineno-112-58" name="__codelineno-112-58" href="#__codelineno-112-58"></a><span class="sd">    Generates a prompt for handling missing arguments for a tool.</span>
</span><span id="__span-112-59"><a id="__codelineno-112-59" name="__codelineno-112-59" href="#__codelineno-112-59"></a>
</span><span id="__span-112-60"><a id="__codelineno-112-60" name="__codelineno-112-60" href="#__codelineno-112-60"></a><span class="sd">    Args:</span>
</span><span id="__span-112-61"><a id="__codelineno-112-61" name="__codelineno-112-61" href="#__codelineno-112-61"></a><span class="sd">        current_tool: The name of the tool that needs arguments</span>
</span><span id="__span-112-62"><a id="__codelineno-112-62" name="__codelineno-112-62" href="#__codelineno-112-62"></a><span class="sd">        tool_data: The current tool data containing the response</span>
</span><span id="__span-112-63"><a id="__codelineno-112-63" name="__codelineno-112-63" href="#__codelineno-112-63"></a><span class="sd">        missing_args: List of argument names that are missing</span>
</span><span id="__span-112-64"><a id="__codelineno-112-64" name="__codelineno-112-64" href="#__codelineno-112-64"></a>
</span><span id="__span-112-65"><a id="__codelineno-112-65" name="__codelineno-112-65" href="#__codelineno-112-65"></a><span class="sd">    Returns:</span>
</span><span id="__span-112-66"><a id="__codelineno-112-66" name="__codelineno-112-66" href="#__codelineno-112-66"></a><span class="sd">        str: A formatted prompt string for requesting missing arguments</span>
</span><span id="__span-112-67"><a id="__codelineno-112-67" name="__codelineno-112-67" href="#__codelineno-112-67"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-112-68"><a id="__codelineno-112-68" name="__codelineno-112-68" href="#__codelineno-112-68"></a>    <span class="k">return</span> <span class="n">MISSING_ARGS_PROMPT</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="__span-112-69"><a id="__codelineno-112-69" name="__codelineno-112-69" href="#__codelineno-112-69"></a>        <span class="n">response</span><span class="o">=</span><span class="n">tool_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;response&quot;</span><span class="p">),</span>
</span><span id="__span-112-70"><a id="__codelineno-112-70" name="__codelineno-112-70" href="#__codelineno-112-70"></a>        <span class="n">current_tool</span><span class="o">=</span><span class="n">current_tool</span><span class="p">,</span>
</span><span id="__span-112-71"><a id="__codelineno-112-71" name="__codelineno-112-71" href="#__codelineno-112-71"></a>        <span class="n">missing_args</span><span class="o">=</span><span class="n">missing_args</span><span class="p">,</span>
</span><span id="__span-112-72"><a id="__codelineno-112-72" name="__codelineno-112-72" href="#__codelineno-112-72"></a>    <span class="p">)</span>
</span></code></pre></div>
</details>

<details>

<summary>
Before moving on to the next section, verify your files and directory structure is correct.
</summary>

<div class="language-text highlight"><pre><span></span><code><span id="__span-113-1"><a id="__codelineno-113-1" name="__codelineno-113-1" href="#__codelineno-113-1"></a>temporal-ai-agent/
</span><span id="__span-113-2"><a id="__codelineno-113-2" name="__codelineno-113-2" href="#__codelineno-113-2"></a>├── .env
</span><span id="__span-113-3"><a id="__codelineno-113-3" name="__codelineno-113-3" href="#__codelineno-113-3"></a>├── .gitignore
</span><span id="__span-113-4"><a id="__codelineno-113-4" name="__codelineno-113-4" href="#__codelineno-113-4"></a>├── .python-version
</span><span id="__span-113-5"><a id="__codelineno-113-5" name="__codelineno-113-5" href="#__codelineno-113-5"></a>├── README.md
</span><span id="__span-113-6"><a id="__codelineno-113-6" name="__codelineno-113-6" href="#__codelineno-113-6"></a>├── pyproject.toml
</span><span id="__span-113-7"><a id="__codelineno-113-7" name="__codelineno-113-7" href="#__codelineno-113-7"></a>├── uv.lock
</span><span id="__span-113-8"><a id="__codelineno-113-8" name="__codelineno-113-8" href="#__codelineno-113-8"></a>├── activities/
</span><span id="__span-113-9"><a id="__codelineno-113-9" name="__codelineno-113-9" href="#__codelineno-113-9"></a>|   ├── __init__.py
</span><span id="__span-113-10"><a id="__codelineno-113-10" name="__codelineno-113-10" href="#__codelineno-113-10"></a>|   └── activities.py
</span><span id="__span-113-11"><a id="__codelineno-113-11" name="__codelineno-113-11" href="#__codelineno-113-11"></a>├── models/
</span><span id="__span-113-12"><a id="__codelineno-113-12" name="__codelineno-113-12" href="#__codelineno-113-12"></a>│   ├── __init__.py
</span><span id="__span-113-13"><a id="__codelineno-113-13" name="__codelineno-113-13" href="#__codelineno-113-13"></a>│   ├── core.py
</span><span id="__span-113-14"><a id="__codelineno-113-14" name="__codelineno-113-14" href="#__codelineno-113-14"></a>│   └── requests.py
</span><span id="__span-113-15"><a id="__codelineno-113-15" name="__codelineno-113-15" href="#__codelineno-113-15"></a>├── prompts/
</span><span id="__span-113-16"><a id="__codelineno-113-16" name="__codelineno-113-16" href="#__codelineno-113-16"></a>│   ├── __init__.py
</span><span id="__span-113-17"><a id="__codelineno-113-17" name="__codelineno-113-17" href="#__codelineno-113-17"></a>│   ├── agent_prompt_generators.py
</span><span id="__span-113-18"><a id="__codelineno-113-18" name="__codelineno-113-18" href="#__codelineno-113-18"></a>│   └── prompts.py
</span><span id="__span-113-19"><a id="__codelineno-113-19" name="__codelineno-113-19" href="#__codelineno-113-19"></a>├── scripts/
</span><span id="__span-113-20"><a id="__codelineno-113-20" name="__codelineno-113-20" href="#__codelineno-113-20"></a>│   ├── create_invoice_test.py
</span><span id="__span-113-21"><a id="__codelineno-113-21" name="__codelineno-113-21" href="#__codelineno-113-21"></a>│   ├── find_events_test.py
</span><span id="__span-113-22"><a id="__codelineno-113-22" name="__codelineno-113-22" href="#__codelineno-113-22"></a>│   └── search_flights_test.py
</span><span id="__span-113-23"><a id="__codelineno-113-23" name="__codelineno-113-23" href="#__codelineno-113-23"></a>└── tools/
</span><span id="__span-113-24"><a id="__codelineno-113-24" name="__codelineno-113-24" href="#__codelineno-113-24"></a>    ├── __init__.py
</span><span id="__span-113-25"><a id="__codelineno-113-25" name="__codelineno-113-25" href="#__codelineno-113-25"></a>    ├── create_invoice.py
</span><span id="__span-113-26"><a id="__codelineno-113-26" name="__codelineno-113-26" href="#__codelineno-113-26"></a>    ├── find_events.py
</span><span id="__span-113-27"><a id="__codelineno-113-27" name="__codelineno-113-27" href="#__codelineno-113-27"></a>    ├── goal_registry.py
</span><span id="__span-113-28"><a id="__codelineno-113-28" name="__codelineno-113-28" href="#__codelineno-113-28"></a>    ├── search_flights.py
</span><span id="__span-113-29"><a id="__codelineno-113-29" name="__codelineno-113-29" href="#__codelineno-113-29"></a>    ├── tool_registry.py
</span><span id="__span-113-30"><a id="__codelineno-113-30" name="__codelineno-113-30" href="#__codelineno-113-30"></a>    └── data/
</span><span id="__span-113-31"><a id="__codelineno-113-31" name="__codelineno-113-31" href="#__codelineno-113-31"></a>        └── find_events_data.json
</span></code></pre></div>
</details>

<p>Now that you have the prompt rendering submodule implemented, you can implement the main agent Workflow.</p>
<h2 id="building-the-agent-workflow">Building the agent Workflow<a class="headerlink" href="#building-the-agent-workflow" title="Permanent link">&para;</a></h2>
<p>Agents need to manage conversations that involve multiple turns including user interaction, tool execution, and state management. 
The challenge is maintaining coherence across these sessions while handling failures, retries, and long-running interactions.
Your agent must coordinate several concurrent concerns such as validating user input against conversation context, determining when to execute tools, managing user input for tool execution, and maintaining conversation history that persists in the event of system failures. 
A traditional application would lose conversation state during failures, but Temporal Workflows provide durable execution that preserves context through any system interruption.</p>
<p>In this step, you will create the Temporal Workflow that orchestrates your agent's conversation loop. 
This Workflow handles user interactions, validates prompts, manages tool execution, and maintains conversation state, all while providing durability to the agent.</p>
<h3 id="creating-the-workflows-submodule">Creating the workflows submodule<a class="headerlink" href="#creating-the-workflows-submodule" title="Permanent link">&para;</a></h3>
<p>First, create the directory structure for your Workflow implementations:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-114-1"><a id="__codelineno-114-1" name="__codelineno-114-1" href="#__codelineno-114-1"></a>mkdir workflows
</span></code></pre></div>
<p>Next, create an empty <code>__init__.py</code> file in the directory to enable it as a submodule:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-115-1"><a id="__codelineno-115-1" name="__codelineno-115-1" href="#__codelineno-115-1"></a>touch workflows/__init__.py
</span></code></pre></div>
<p>Now that your <code>workflows</code> directory is a submodule, you will create a few helper functions for your Workflow.</p>
<h3 id="implementing-a-few-workflow-helper-functions">Implementing a few Workflow helper functions<a class="headerlink" href="#implementing-a-few-workflow-helper-functions" title="Permanent link">&para;</a></h3>
<p>Before implementing the Workflow, you will implement a few helper functions that perform repetitive operations like tool execution, argument validation, and conversation continuation.</p>
<p>First, create <code>workflows/workflow_helpers.py</code> and add the following import statements:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-116-1"><a id="__codelineno-116-1" name="__codelineno-116-1" href="#__codelineno-116-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
</span><span id="__span-116-2"><a id="__codelineno-116-2" name="__codelineno-116-2" href="#__codelineno-116-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Deque</span><span class="p">,</span> <span class="n">Dict</span>
</span><span id="__span-116-3"><a id="__codelineno-116-3" name="__codelineno-116-3" href="#__codelineno-116-3"></a>
</span><span id="__span-116-4"><a id="__codelineno-116-4" name="__codelineno-116-4" href="#__codelineno-116-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio</span><span class="w"> </span><span class="kn">import</span> <span class="n">workflow</span>
</span><span id="__span-116-5"><a id="__codelineno-116-5" name="__codelineno-116-5" href="#__codelineno-116-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">RetryPolicy</span>
</span><span id="__span-116-6"><a id="__codelineno-116-6" name="__codelineno-116-6" href="#__codelineno-116-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActivityError</span>
</span><span id="__span-116-7"><a id="__codelineno-116-7" name="__codelineno-116-7" href="#__codelineno-116-7"></a>
</span><span id="__span-116-8"><a id="__codelineno-116-8" name="__codelineno-116-8" href="#__codelineno-116-8"></a><span class="k">with</span> <span class="n">workflow</span><span class="o">.</span><span class="n">unsafe</span><span class="o">.</span><span class="n">imports_passed_through</span><span class="p">():</span>
</span><span id="__span-116-9"><a id="__codelineno-116-9" name="__codelineno-116-9" href="#__codelineno-116-9"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">activities.activities</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentActivities</span>
</span><span id="__span-116-10"><a id="__codelineno-116-10" name="__codelineno-116-10" href="#__codelineno-116-10"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConversationHistory</span><span class="p">,</span> <span class="n">ToolData</span><span class="p">,</span> <span class="n">ToolPromptInput</span>
</span><span id="__span-116-11"><a id="__codelineno-116-11" name="__codelineno-116-11" href="#__codelineno-116-11"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">prompts.agent_prompt_generators</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-116-12"><a id="__codelineno-116-12" name="__codelineno-116-12" href="#__codelineno-116-12"></a>        <span class="n">generate_missing_args_prompt</span><span class="p">,</span>
</span><span id="__span-116-13"><a id="__codelineno-116-13" name="__codelineno-116-13" href="#__codelineno-116-13"></a>        <span class="n">generate_tool_completion_prompt</span><span class="p">,</span>
</span><span id="__span-116-14"><a id="__codelineno-116-14" name="__codelineno-116-14" href="#__codelineno-116-14"></a>    <span class="p">)</span>
</span></code></pre></div>
<p>Like previous <code>import</code> statements, this section includes libraries from the Python standard library and Temporal libraries. 
However, there are also libraries being imported with the <code>with workflow.unsafe.imports_passed_through()</code> statement.
This statement is necessary when importing third-party libraries, including ones you implement, into a Workflow (or in this case, imported into a file that will be imported by the Workflow).
This is done for performance and determinism safety reasons, which you can read more about <a href="https://docs.temporal.io/develop/python/python-sdk-sandbox#passthrough-modules">in the Temporal documentation</a>.</p>
<p>Next, declare the following timeout constants:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-117-1"><a id="__codelineno-117-1" name="__codelineno-117-1" href="#__codelineno-117-1"></a><span class="n">TOOL_ACTIVITY_START_TO_CLOSE_TIMEOUT</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="__span-117-2"><a id="__codelineno-117-2" name="__codelineno-117-2" href="#__codelineno-117-2"></a><span class="n">TOOL_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="__span-117-3"><a id="__codelineno-117-3" name="__codelineno-117-3" href="#__codelineno-117-3"></a><span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="__span-117-4"><a id="__codelineno-117-4" name="__codelineno-117-4" href="#__codelineno-117-4"></a><span class="n">LLM_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span></code></pre></div>
<p>These timeout constants set sensible limits for tool execution and LLM calls, ensuring the calls have enough time to respond, but that the Workflow detects a failure within a reasonable amount of time.</p>
<h4 id="defining-the-tool-execution-activity-invocation-function">Defining the tool execution Activity invocation function<a class="headerlink" href="#defining-the-tool-execution-activity-invocation-function" title="Permanent link">&para;</a></h4>
<p>The first function you'll implement is the <code>handle_tool_execution</code> function.
Add the method header to the file:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-118-1"><a id="__codelineno-118-1" name="__codelineno-118-1" href="#__codelineno-118-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_tool_execution</span><span class="p">(</span>
</span><span id="__span-118-2"><a id="__codelineno-118-2" name="__codelineno-118-2" href="#__codelineno-118-2"></a>    <span class="n">current_tool</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-118-3"><a id="__codelineno-118-3" name="__codelineno-118-3" href="#__codelineno-118-3"></a>    <span class="n">tool_data</span><span class="p">:</span> <span class="n">ToolData</span><span class="p">,</span>
</span><span id="__span-118-4"><a id="__codelineno-118-4" name="__codelineno-118-4" href="#__codelineno-118-4"></a>    <span class="n">add_message_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-118-5"><a id="__codelineno-118-5" name="__codelineno-118-5" href="#__codelineno-118-5"></a>    <span class="n">prompt_queue</span><span class="p">:</span> <span class="n">Deque</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="__span-118-6"><a id="__codelineno-118-6" name="__codelineno-118-6" href="#__codelineno-118-6"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></code></pre></div>
<p>This function takes in the current tool to execute, the tool data, a callback that stores the conversation history, and a queue for prompts that the agent will execute later to continue its goal.
The function executes the tool as a dynamic Activity, and processes the results for the LLM to handle.</p>
<p>Add the code to invoke the Activity and process the results:</p>
<p><div class="language-python highlight"><pre><span></span><code><span id="__span-119-1"><a id="__codelineno-119-1" name="__codelineno-119-1" href="#__codelineno-119-1"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute a tool after confirmation and handle its result.&quot;&quot;&quot;</span>
</span><span id="__span-119-2"><a id="__codelineno-119-2" name="__codelineno-119-2" href="#__codelineno-119-2"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confirmed. Proceeding with tool: </span><span class="si">{</span><span class="n">current_tool</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-119-3"><a id="__codelineno-119-3" name="__codelineno-119-3" href="#__codelineno-119-3"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-119-4"><a id="__codelineno-119-4" name="__codelineno-119-4" href="#__codelineno-119-4"></a>        <span class="n">dynamic_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">execute_activity</span><span class="p">(</span>
</span><span id="__span-119-5"><a id="__codelineno-119-5" name="__codelineno-119-5" href="#__codelineno-119-5"></a>            <span class="n">current_tool</span><span class="p">,</span>
</span><span id="__span-119-6"><a id="__codelineno-119-6" name="__codelineno-119-6" href="#__codelineno-119-6"></a>            <span class="n">tool_data</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">],</span>
</span><span id="__span-119-7"><a id="__codelineno-119-7" name="__codelineno-119-7" href="#__codelineno-119-7"></a>            <span class="n">schedule_to_close_timeout</span><span class="o">=</span><span class="n">TOOL_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-119-8"><a id="__codelineno-119-8" name="__codelineno-119-8" href="#__codelineno-119-8"></a>            <span class="n">start_to_close_timeout</span><span class="o">=</span><span class="n">TOOL_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-119-9"><a id="__codelineno-119-9" name="__codelineno-119-9" href="#__codelineno-119-9"></a>            <span class="n">retry_policy</span><span class="o">=</span><span class="n">RetryPolicy</span><span class="p">(</span>
</span><span id="__span-119-10"><a id="__codelineno-119-10" name="__codelineno-119-10" href="#__codelineno-119-10"></a>                <span class="n">initial_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">backoff_coefficient</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-119-11"><a id="__codelineno-119-11" name="__codelineno-119-11" href="#__codelineno-119-11"></a>            <span class="p">),</span>
</span><span id="__span-119-12"><a id="__codelineno-119-12" name="__codelineno-119-12" href="#__codelineno-119-12"></a>        <span class="p">)</span>
</span><span id="__span-119-13"><a id="__codelineno-119-13" name="__codelineno-119-13" href="#__codelineno-119-13"></a>        <span class="n">dynamic_result</span><span class="p">[</span><span class="s2">&quot;tool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_tool</span>
</span><span id="__span-119-14"><a id="__codelineno-119-14" name="__codelineno-119-14" href="#__codelineno-119-14"></a>    <span class="k">except</span> <span class="n">ActivityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-119-15"><a id="__codelineno-119-15" name="__codelineno-119-15" href="#__codelineno-119-15"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tool execution failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-119-16"><a id="__codelineno-119-16" name="__codelineno-119-16" href="#__codelineno-119-16"></a>        <span class="n">dynamic_result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s2">&quot;tool&quot;</span><span class="p">:</span> <span class="n">current_tool</span><span class="p">}</span>
</span><span id="__span-119-17"><a id="__codelineno-119-17" name="__codelineno-119-17" href="#__codelineno-119-17"></a>
</span><span id="__span-119-18"><a id="__codelineno-119-18" name="__codelineno-119-18" href="#__codelineno-119-18"></a>    <span class="n">add_message_callback</span><span class="p">(</span><span class="s2">&quot;tool_result&quot;</span><span class="p">,</span> <span class="n">dynamic_result</span><span class="p">)</span>
</span><span id="__span-119-19"><a id="__codelineno-119-19" name="__codelineno-119-19" href="#__codelineno-119-19"></a>    <span class="n">prompt_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">generate_tool_completion_prompt</span><span class="p">(</span><span class="n">current_tool</span><span class="p">,</span> <span class="n">dynamic_result</span><span class="p">))</span>
</span></code></pre></div>
It executes the tool by calling the name of the tool, which gets handled by the dynamic Activity you implemented.
When calling the Activity, you specify the Activity timeouts using the constants you defined earlier.
Whether the Activity succeeds or fails, the result is stored to the conversation history using the <code>add_message_callback</code> that was passed in.
Then, the method invokes the <code>generate_tool_completion_prompt</code> function with the <code>current_tool</code> and result of the tool execution to create a prompt and add it to the <code>prompt_queue</code>, which the agent will handle on its next iteration.</p>
<h4 id="defining-the-missing-argument-handler-function">Defining the missing argument handler function<a class="headerlink" href="#defining-the-missing-argument-handler-function" title="Permanent link">&para;</a></h4>
<p>Next you'll create the function that checks and handles missing tool arguments.
Add the function header with the following arguments:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-120-1"><a id="__codelineno-120-1" name="__codelineno-120-1" href="#__codelineno-120-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_missing_args</span><span class="p">(</span>
</span><span id="__span-120-2"><a id="__codelineno-120-2" name="__codelineno-120-2" href="#__codelineno-120-2"></a>    <span class="n">current_tool</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-120-3"><a id="__codelineno-120-3" name="__codelineno-120-3" href="#__codelineno-120-3"></a>    <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-120-4"><a id="__codelineno-120-4" name="__codelineno-120-4" href="#__codelineno-120-4"></a>    <span class="n">tool_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-120-5"><a id="__codelineno-120-5" name="__codelineno-120-5" href="#__codelineno-120-5"></a>    <span class="n">prompt_queue</span><span class="p">:</span> <span class="n">Deque</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="__span-120-6"><a id="__codelineno-120-6" name="__codelineno-120-6" href="#__codelineno-120-6"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span></code></pre></div>
<p>This function takes in the <code>current_tool</code>, the <code>args</code> that were passed to the tool, the <code>tool_data</code> containing all data related to the tool, and the <code>prompt_queue</code> containing prompts the LLM still needs to act on.</p>
<p>Add the remaining code to check for any missing arguments:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-121-1"><a id="__codelineno-121-1" name="__codelineno-121-1" href="#__codelineno-121-1"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Check for missing arguments and handle them if found.&quot;&quot;&quot;</span>
</span><span id="__span-121-2"><a id="__codelineno-121-2" name="__codelineno-121-2" href="#__codelineno-121-2"></a>    <span class="n">missing_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="__span-121-3"><a id="__codelineno-121-3" name="__codelineno-121-3" href="#__codelineno-121-3"></a>
</span><span id="__span-121-4"><a id="__codelineno-121-4" name="__codelineno-121-4" href="#__codelineno-121-4"></a>    <span class="k">if</span> <span class="n">missing_args</span><span class="p">:</span>
</span><span id="__span-121-5"><a id="__codelineno-121-5" name="__codelineno-121-5" href="#__codelineno-121-5"></a>        <span class="n">prompt_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-121-6"><a id="__codelineno-121-6" name="__codelineno-121-6" href="#__codelineno-121-6"></a>            <span class="n">generate_missing_args_prompt</span><span class="p">(</span><span class="n">current_tool</span><span class="p">,</span> <span class="n">tool_data</span><span class="p">,</span> <span class="n">missing_args</span><span class="p">)</span>
</span><span id="__span-121-7"><a id="__codelineno-121-7" name="__codelineno-121-7" href="#__codelineno-121-7"></a>        <span class="p">)</span>
</span><span id="__span-121-8"><a id="__codelineno-121-8" name="__codelineno-121-8" href="#__codelineno-121-8"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-121-9"><a id="__codelineno-121-9" name="__codelineno-121-9" href="#__codelineno-121-9"></a>            <span class="sa">f</span><span class="s2">&quot;Missing arguments for tool: </span><span class="si">{</span><span class="n">current_tool</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-121-10"><a id="__codelineno-121-10" name="__codelineno-121-10" href="#__codelineno-121-10"></a>        <span class="p">)</span>
</span><span id="__span-121-11"><a id="__codelineno-121-11" name="__codelineno-121-11" href="#__codelineno-121-11"></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-121-12"><a id="__codelineno-121-12" name="__codelineno-121-12" href="#__codelineno-121-12"></a>    <span class="k">return</span> <span class="kc">False</span>
</span></code></pre></div>
<p>The tool arguments are checked, and if any are missing, the <code>generate_missing_args_prompt</code> is invoked and the result is added to the <code>prompt_queue</code> for the agent to execute on its next turn. The function then returns <code>True</code>.
Otherwise, no arguments were missing and the function returns <code>False</code>.</p>
<h4 id="defining-the-history-formatting-function">Defining the history formatting function<a class="headerlink" href="#defining-the-history-formatting-function" title="Permanent link">&para;</a></h4>
<p>Next you'll define functions for formatting the conversation history.</p>
<p>Add the following function to your code:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-122-1"><a id="__codelineno-122-1" name="__codelineno-122-1" href="#__codelineno-122-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">format_history</span><span class="p">(</span><span class="n">conversation_history</span><span class="p">:</span> <span class="n">ConversationHistory</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-122-2"><a id="__codelineno-122-2" name="__codelineno-122-2" href="#__codelineno-122-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Format the conversation history into a single string.&quot;&quot;&quot;</span>
</span><span id="__span-122-3"><a id="__codelineno-122-3" name="__codelineno-122-3" href="#__codelineno-122-3"></a>    <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">conversation_history</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span>
</span></code></pre></div>
<p>This function compacts responses from every message in the conversation history and returns it as a single string.</p>
<h4 id="defining-the-history-summarization-prompt-function">Defining the history summarization prompt function<a class="headerlink" href="#defining-the-history-summarization-prompt-function" title="Permanent link">&para;</a></h4>
<p>Now you'll use the previous function to generate a prompt for the LLM to summarize the conversation.</p>
<p>Add the following function to your code:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-123-1"><a id="__codelineno-123-1" name="__codelineno-123-1" href="#__codelineno-123-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">prompt_summary_with_history</span><span class="p">(</span>
</span><span id="__span-123-2"><a id="__codelineno-123-2" name="__codelineno-123-2" href="#__codelineno-123-2"></a>    <span class="n">conversation_history</span><span class="p">:</span> <span class="n">ConversationHistory</span><span class="p">,</span>
</span><span id="__span-123-3"><a id="__codelineno-123-3" name="__codelineno-123-3" href="#__codelineno-123-3"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-123-4"><a id="__codelineno-123-4" name="__codelineno-123-4" href="#__codelineno-123-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a prompt for summarizing the conversation.</span>
</span><span id="__span-123-5"><a id="__codelineno-123-5" name="__codelineno-123-5" href="#__codelineno-123-5"></a><span class="sd">    Used only for continue as new of the workflow.&quot;&quot;&quot;</span>
</span><span id="__span-123-6"><a id="__codelineno-123-6" name="__codelineno-123-6" href="#__codelineno-123-6"></a>    <span class="n">history_string</span> <span class="o">=</span> <span class="n">format_history</span><span class="p">(</span><span class="n">conversation_history</span><span class="p">)</span>
</span><span id="__span-123-7"><a id="__codelineno-123-7" name="__codelineno-123-7" href="#__codelineno-123-7"></a>    <span class="n">context_instructions</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Here is the conversation history between a user and a chatbot: </span><span class="si">{</span><span class="n">history_string</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-123-8"><a id="__codelineno-123-8" name="__codelineno-123-8" href="#__codelineno-123-8"></a>    <span class="n">actual_prompt</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-123-9"><a id="__codelineno-123-9" name="__codelineno-123-9" href="#__codelineno-123-9"></a>        <span class="s2">&quot;Please produce a two sentence summary of this conversation. &quot;</span>
</span><span id="__span-123-10"><a id="__codelineno-123-10" name="__codelineno-123-10" href="#__codelineno-123-10"></a>        <span class="s1">&#39;Put the summary in the format { &quot;summary&quot;: &quot;&lt;plain text&gt;&quot; }&#39;</span>
</span><span id="__span-123-11"><a id="__codelineno-123-11" name="__codelineno-123-11" href="#__codelineno-123-11"></a>    <span class="p">)</span>
</span><span id="__span-123-12"><a id="__codelineno-123-12" name="__codelineno-123-12" href="#__codelineno-123-12"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">context_instructions</span><span class="p">,</span> <span class="n">actual_prompt</span><span class="p">)</span>
</span></code></pre></div>
<p>The code calls the <code>format_history</code> function, then creates two variables, one containing the history and another containing the prompt.
It then returns both variables as a tuple.</p>
<h4 id="defining-the-function-to-handle-long-event-histories">Defining the function to handle long Event Histories<a class="headerlink" href="#defining-the-function-to-handle-long-event-histories" title="Permanent link">&para;</a></h4>
<p>Temporal Workflows have a limit on the length and size of a single Workflow Execution's Event History.
A Temporal Workflow will <a href="https://docs.temporal.io/workflow-execution/continue-as-new"><code>Continue-As-New</code></a> when the Event History reaches this limits, and will <em>continue</em> the execution in a <em>new</em> Workflow Execution, which in turn creates new Event History.
Due to the length of LLM responses, you will implement a function to determine if a <code>Continue-As-New</code> is needed.</p>
<p>First, define the function header:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-124-1"><a id="__codelineno-124-1" name="__codelineno-124-1" href="#__codelineno-124-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">continue_as_new_if_needed</span><span class="p">(</span>
</span><span id="__span-124-2"><a id="__codelineno-124-2" name="__codelineno-124-2" href="#__codelineno-124-2"></a>    <span class="n">conversation_history</span><span class="p">:</span> <span class="n">ConversationHistory</span><span class="p">,</span>
</span><span id="__span-124-3"><a id="__codelineno-124-3" name="__codelineno-124-3" href="#__codelineno-124-3"></a>    <span class="n">prompt_queue</span><span class="p">:</span> <span class="n">Deque</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="__span-124-4"><a id="__codelineno-124-4" name="__codelineno-124-4" href="#__codelineno-124-4"></a>    <span class="n">agent_goal</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="__span-124-5"><a id="__codelineno-124-5" name="__codelineno-124-5" href="#__codelineno-124-5"></a>    <span class="n">max_turns</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-124-6"><a id="__codelineno-124-6" name="__codelineno-124-6" href="#__codelineno-124-6"></a>    <span class="n">add_message_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-124-7"><a id="__codelineno-124-7" name="__codelineno-124-7" href="#__codelineno-124-7"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></code></pre></div>
<p>The function receives the <code>conversation_history</code> as your custom type, the <code>prompt_queue</code> as the pass-by-object <code>Deque</code> used to control the flow of prompts, the agent's goal, how many turns the conversation should last for, and a function callback to add this interaction to the conversation history.</p>
<p>Next, add the function implementation:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-125-1"><a id="__codelineno-125-1" name="__codelineno-125-1" href="#__codelineno-125-1"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle workflow continuation if message limit is reached.&quot;&quot;&quot;</span>
</span><span id="__span-125-2"><a id="__codelineno-125-2" name="__codelineno-125-2" href="#__codelineno-125-2"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conversation_history</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">max_turns</span><span class="p">:</span>
</span><span id="__span-125-3"><a id="__codelineno-125-3" name="__codelineno-125-3" href="#__codelineno-125-3"></a>        <span class="n">summary_context</span><span class="p">,</span> <span class="n">summary_prompt</span> <span class="o">=</span> <span class="n">prompt_summary_with_history</span><span class="p">(</span>
</span><span id="__span-125-4"><a id="__codelineno-125-4" name="__codelineno-125-4" href="#__codelineno-125-4"></a>            <span class="n">conversation_history</span>
</span><span id="__span-125-5"><a id="__codelineno-125-5" name="__codelineno-125-5" href="#__codelineno-125-5"></a>        <span class="p">)</span>
</span><span id="__span-125-6"><a id="__codelineno-125-6" name="__codelineno-125-6" href="#__codelineno-125-6"></a>        <span class="n">summary_input</span> <span class="o">=</span> <span class="n">ToolPromptInput</span><span class="p">(</span>
</span><span id="__span-125-7"><a id="__codelineno-125-7" name="__codelineno-125-7" href="#__codelineno-125-7"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">summary_prompt</span><span class="p">,</span> <span class="n">context_instructions</span><span class="o">=</span><span class="n">summary_context</span>
</span><span id="__span-125-8"><a id="__codelineno-125-8" name="__codelineno-125-8" href="#__codelineno-125-8"></a>        <span class="p">)</span>
</span><span id="__span-125-9"><a id="__codelineno-125-9" name="__codelineno-125-9" href="#__codelineno-125-9"></a>        <span class="n">conversation_summary</span> <span class="o">=</span> <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">start_activity_method</span><span class="p">(</span>
</span><span id="__span-125-10"><a id="__codelineno-125-10" name="__codelineno-125-10" href="#__codelineno-125-10"></a>            <span class="n">AgentActivities</span><span class="o">.</span><span class="n">agent_toolPlanner</span><span class="p">,</span>
</span><span id="__span-125-11"><a id="__codelineno-125-11" name="__codelineno-125-11" href="#__codelineno-125-11"></a>            <span class="n">summary_input</span><span class="p">,</span>
</span><span id="__span-125-12"><a id="__codelineno-125-12" name="__codelineno-125-12" href="#__codelineno-125-12"></a>            <span class="n">schedule_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-125-13"><a id="__codelineno-125-13" name="__codelineno-125-13" href="#__codelineno-125-13"></a>        <span class="p">)</span>
</span><span id="__span-125-14"><a id="__codelineno-125-14" name="__codelineno-125-14" href="#__codelineno-125-14"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Continuing as new after </span><span class="si">{</span><span class="n">max_turns</span><span class="si">}</span><span class="s2"> turns.&quot;</span><span class="p">)</span>
</span><span id="__span-125-15"><a id="__codelineno-125-15" name="__codelineno-125-15" href="#__codelineno-125-15"></a>        <span class="n">add_message_callback</span><span class="p">(</span><span class="s2">&quot;conversation_summary&quot;</span><span class="p">,</span> <span class="n">conversation_summary</span><span class="p">)</span>
</span><span id="__span-125-16"><a id="__codelineno-125-16" name="__codelineno-125-16" href="#__codelineno-125-16"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">continue_as_new</span><span class="p">(</span>
</span><span id="__span-125-17"><a id="__codelineno-125-17" name="__codelineno-125-17" href="#__codelineno-125-17"></a>            <span class="n">args</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-125-18"><a id="__codelineno-125-18" name="__codelineno-125-18" href="#__codelineno-125-18"></a>                <span class="p">{</span>
</span><span id="__span-125-19"><a id="__codelineno-125-19" name="__codelineno-125-19" href="#__codelineno-125-19"></a>                    <span class="s2">&quot;tool_params&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-125-20"><a id="__codelineno-125-20" name="__codelineno-125-20" href="#__codelineno-125-20"></a>                        <span class="s2">&quot;conversation_summary&quot;</span><span class="p">:</span> <span class="n">conversation_summary</span><span class="p">,</span>
</span><span id="__span-125-21"><a id="__codelineno-125-21" name="__codelineno-125-21" href="#__codelineno-125-21"></a>                        <span class="s2">&quot;prompt_queue&quot;</span><span class="p">:</span> <span class="n">prompt_queue</span><span class="p">,</span>
</span><span id="__span-125-22"><a id="__codelineno-125-22" name="__codelineno-125-22" href="#__codelineno-125-22"></a>                    <span class="p">},</span>
</span><span id="__span-125-23"><a id="__codelineno-125-23" name="__codelineno-125-23" href="#__codelineno-125-23"></a>                    <span class="s2">&quot;agent_goal&quot;</span><span class="p">:</span> <span class="n">agent_goal</span><span class="p">,</span>
</span><span id="__span-125-24"><a id="__codelineno-125-24" name="__codelineno-125-24" href="#__codelineno-125-24"></a>                <span class="p">}</span>
</span><span id="__span-125-25"><a id="__codelineno-125-25" name="__codelineno-125-25" href="#__codelineno-125-25"></a>            <span class="p">]</span>
</span><span id="__span-125-26"><a id="__codelineno-125-26" name="__codelineno-125-26" href="#__codelineno-125-26"></a>        <span class="p">)</span>
</span></code></pre></div>
<p>The function first checks if the conversation history's length is greater than or equal to the maximum number of turns specified.
If this evaluates to <code>true</code>, the function proceeds with its <code>Continue-As-New</code> process.
First it calls <code>prompt_summary_with_history</code> to create a summary and prompt context using the current history.
It then uses this output to create an input type, <code>ToolPromptInput</code>, based off of this summary for the agent to process.
Next it calls the <code>agent_toolPlanner</code> Activity with this input to invoke the LLM with this summarized context.
It then calls the <code>add_message_callback</code> function, which adds this event to the conversation history.
Finally, it invokes <code>workflow.continue_as_new</code> to perform the <code>Continue-As-New</code> operation, which results in a new Workflow Execution starting at this point in the Event History, and the current Workflow Execution closing.</p>
<h4 id="defining-the-prompt-entity-identification-function">Defining the prompt entity identification function<a class="headerlink" href="#defining-the-prompt-entity-identification-function" title="Permanent link">&para;</a></h4>
<p>Finally, add a function that returns a boolean it the prompt came from a user or not:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-126-1"><a id="__codelineno-126-1" name="__codelineno-126-1" href="#__codelineno-126-1"></a><span class="c1"># LLM-tagged prompts start with &quot;###&quot;</span>
</span><span id="__span-126-2"><a id="__codelineno-126-2" name="__codelineno-126-2" href="#__codelineno-126-2"></a><span class="c1"># all others are from the user</span>
</span><span id="__span-126-3"><a id="__codelineno-126-3" name="__codelineno-126-3" href="#__codelineno-126-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">is_user_prompt</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-126-4"><a id="__codelineno-126-4" name="__codelineno-126-4" href="#__codelineno-126-4"></a>    <span class="k">if</span> <span class="n">prompt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;###&quot;</span><span class="p">):</span>
</span><span id="__span-126-5"><a id="__codelineno-126-5" name="__codelineno-126-5" href="#__codelineno-126-5"></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-126-6"><a id="__codelineno-126-6" name="__codelineno-126-6" href="#__codelineno-126-6"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-126-7"><a id="__codelineno-126-7" name="__codelineno-126-7" href="#__codelineno-126-7"></a>        <span class="k">return</span> <span class="kc">True</span>
</span></code></pre></div>
<p>LLM prompts start with <code>###</code>, so any prompt that doesn't begin with that character sequence is a user prompt.</p>
<details>

<summary>
The <code>workflows/workflow_helpers.py</code> is complete and will need no more revisions. You can review the complete file and copy the code here.
</summary>

<br />
Hover your cursor over the code block to reveal the copy-code option.
<br />
<br />

[workflows/workflow_helpers.py](https://github.com/temporal-community/tutorial-temporal-ai-agent/blob/main/workflows/workflow_helpers.py)

<div class="language-python highlight"><pre><span></span><code><span id="__span-127-1"><a id="__codelineno-127-1" name="__codelineno-127-1" href="#__codelineno-127-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
</span><span id="__span-127-2"><a id="__codelineno-127-2" name="__codelineno-127-2" href="#__codelineno-127-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Deque</span><span class="p">,</span> <span class="n">Dict</span>
</span><span id="__span-127-3"><a id="__codelineno-127-3" name="__codelineno-127-3" href="#__codelineno-127-3"></a>
</span><span id="__span-127-4"><a id="__codelineno-127-4" name="__codelineno-127-4" href="#__codelineno-127-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio</span><span class="w"> </span><span class="kn">import</span> <span class="n">workflow</span>
</span><span id="__span-127-5"><a id="__codelineno-127-5" name="__codelineno-127-5" href="#__codelineno-127-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">RetryPolicy</span>
</span><span id="__span-127-6"><a id="__codelineno-127-6" name="__codelineno-127-6" href="#__codelineno-127-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActivityError</span>
</span><span id="__span-127-7"><a id="__codelineno-127-7" name="__codelineno-127-7" href="#__codelineno-127-7"></a>
</span><span id="__span-127-8"><a id="__codelineno-127-8" name="__codelineno-127-8" href="#__codelineno-127-8"></a><span class="k">with</span> <span class="n">workflow</span><span class="o">.</span><span class="n">unsafe</span><span class="o">.</span><span class="n">imports_passed_through</span><span class="p">():</span>
</span><span id="__span-127-9"><a id="__codelineno-127-9" name="__codelineno-127-9" href="#__codelineno-127-9"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">activities.activities</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentActivities</span>
</span><span id="__span-127-10"><a id="__codelineno-127-10" name="__codelineno-127-10" href="#__codelineno-127-10"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConversationHistory</span><span class="p">,</span> <span class="n">ToolData</span><span class="p">,</span> <span class="n">ToolPromptInput</span>
</span><span id="__span-127-11"><a id="__codelineno-127-11" name="__codelineno-127-11" href="#__codelineno-127-11"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">prompts.agent_prompt_generators</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-127-12"><a id="__codelineno-127-12" name="__codelineno-127-12" href="#__codelineno-127-12"></a>        <span class="n">generate_missing_args_prompt</span><span class="p">,</span>
</span><span id="__span-127-13"><a id="__codelineno-127-13" name="__codelineno-127-13" href="#__codelineno-127-13"></a>        <span class="n">generate_tool_completion_prompt</span><span class="p">,</span>
</span><span id="__span-127-14"><a id="__codelineno-127-14" name="__codelineno-127-14" href="#__codelineno-127-14"></a>    <span class="p">)</span>
</span><span id="__span-127-15"><a id="__codelineno-127-15" name="__codelineno-127-15" href="#__codelineno-127-15"></a>
</span><span id="__span-127-16"><a id="__codelineno-127-16" name="__codelineno-127-16" href="#__codelineno-127-16"></a>
</span><span id="__span-127-17"><a id="__codelineno-127-17" name="__codelineno-127-17" href="#__codelineno-127-17"></a><span class="n">TOOL_ACTIVITY_START_TO_CLOSE_TIMEOUT</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="__span-127-18"><a id="__codelineno-127-18" name="__codelineno-127-18" href="#__codelineno-127-18"></a><span class="n">TOOL_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="__span-127-19"><a id="__codelineno-127-19" name="__codelineno-127-19" href="#__codelineno-127-19"></a><span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="__span-127-20"><a id="__codelineno-127-20" name="__codelineno-127-20" href="#__codelineno-127-20"></a><span class="n">LLM_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="__span-127-21"><a id="__codelineno-127-21" name="__codelineno-127-21" href="#__codelineno-127-21"></a>
</span><span id="__span-127-22"><a id="__codelineno-127-22" name="__codelineno-127-22" href="#__codelineno-127-22"></a>
</span><span id="__span-127-23"><a id="__codelineno-127-23" name="__codelineno-127-23" href="#__codelineno-127-23"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_tool_execution</span><span class="p">(</span>
</span><span id="__span-127-24"><a id="__codelineno-127-24" name="__codelineno-127-24" href="#__codelineno-127-24"></a>    <span class="n">current_tool</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-127-25"><a id="__codelineno-127-25" name="__codelineno-127-25" href="#__codelineno-127-25"></a>    <span class="n">tool_data</span><span class="p">:</span> <span class="n">ToolData</span><span class="p">,</span>
</span><span id="__span-127-26"><a id="__codelineno-127-26" name="__codelineno-127-26" href="#__codelineno-127-26"></a>    <span class="n">add_message_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-127-27"><a id="__codelineno-127-27" name="__codelineno-127-27" href="#__codelineno-127-27"></a>    <span class="n">prompt_queue</span><span class="p">:</span> <span class="n">Deque</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="__span-127-28"><a id="__codelineno-127-28" name="__codelineno-127-28" href="#__codelineno-127-28"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-127-29"><a id="__codelineno-127-29" name="__codelineno-127-29" href="#__codelineno-127-29"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute a tool after confirmation and handle its result.&quot;&quot;&quot;</span>
</span><span id="__span-127-30"><a id="__codelineno-127-30" name="__codelineno-127-30" href="#__codelineno-127-30"></a>    <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confirmed. Proceeding with tool: </span><span class="si">{</span><span class="n">current_tool</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-127-31"><a id="__codelineno-127-31" name="__codelineno-127-31" href="#__codelineno-127-31"></a>
</span><span id="__span-127-32"><a id="__codelineno-127-32" name="__codelineno-127-32" href="#__codelineno-127-32"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-127-33"><a id="__codelineno-127-33" name="__codelineno-127-33" href="#__codelineno-127-33"></a>        <span class="n">dynamic_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">execute_activity</span><span class="p">(</span>
</span><span id="__span-127-34"><a id="__codelineno-127-34" name="__codelineno-127-34" href="#__codelineno-127-34"></a>            <span class="n">current_tool</span><span class="p">,</span>
</span><span id="__span-127-35"><a id="__codelineno-127-35" name="__codelineno-127-35" href="#__codelineno-127-35"></a>            <span class="n">tool_data</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">],</span>
</span><span id="__span-127-36"><a id="__codelineno-127-36" name="__codelineno-127-36" href="#__codelineno-127-36"></a>            <span class="n">schedule_to_close_timeout</span><span class="o">=</span><span class="n">TOOL_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-127-37"><a id="__codelineno-127-37" name="__codelineno-127-37" href="#__codelineno-127-37"></a>            <span class="n">start_to_close_timeout</span><span class="o">=</span><span class="n">TOOL_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-127-38"><a id="__codelineno-127-38" name="__codelineno-127-38" href="#__codelineno-127-38"></a>            <span class="n">retry_policy</span><span class="o">=</span><span class="n">RetryPolicy</span><span class="p">(</span>
</span><span id="__span-127-39"><a id="__codelineno-127-39" name="__codelineno-127-39" href="#__codelineno-127-39"></a>                <span class="n">initial_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">backoff_coefficient</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-127-40"><a id="__codelineno-127-40" name="__codelineno-127-40" href="#__codelineno-127-40"></a>            <span class="p">),</span>
</span><span id="__span-127-41"><a id="__codelineno-127-41" name="__codelineno-127-41" href="#__codelineno-127-41"></a>        <span class="p">)</span>
</span><span id="__span-127-42"><a id="__codelineno-127-42" name="__codelineno-127-42" href="#__codelineno-127-42"></a>        <span class="n">dynamic_result</span><span class="p">[</span><span class="s2">&quot;tool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_tool</span>
</span><span id="__span-127-43"><a id="__codelineno-127-43" name="__codelineno-127-43" href="#__codelineno-127-43"></a>    <span class="k">except</span> <span class="n">ActivityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-127-44"><a id="__codelineno-127-44" name="__codelineno-127-44" href="#__codelineno-127-44"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tool execution failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-127-45"><a id="__codelineno-127-45" name="__codelineno-127-45" href="#__codelineno-127-45"></a>        <span class="n">dynamic_result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="s2">&quot;tool&quot;</span><span class="p">:</span> <span class="n">current_tool</span><span class="p">}</span>
</span><span id="__span-127-46"><a id="__codelineno-127-46" name="__codelineno-127-46" href="#__codelineno-127-46"></a>
</span><span id="__span-127-47"><a id="__codelineno-127-47" name="__codelineno-127-47" href="#__codelineno-127-47"></a>    <span class="n">add_message_callback</span><span class="p">(</span><span class="s2">&quot;tool_result&quot;</span><span class="p">,</span> <span class="n">dynamic_result</span><span class="p">)</span>
</span><span id="__span-127-48"><a id="__codelineno-127-48" name="__codelineno-127-48" href="#__codelineno-127-48"></a>    <span class="n">prompt_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">generate_tool_completion_prompt</span><span class="p">(</span><span class="n">current_tool</span><span class="p">,</span> <span class="n">dynamic_result</span><span class="p">))</span>
</span><span id="__span-127-49"><a id="__codelineno-127-49" name="__codelineno-127-49" href="#__codelineno-127-49"></a>
</span><span id="__span-127-50"><a id="__codelineno-127-50" name="__codelineno-127-50" href="#__codelineno-127-50"></a>
</span><span id="__span-127-51"><a id="__codelineno-127-51" name="__codelineno-127-51" href="#__codelineno-127-51"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_missing_args</span><span class="p">(</span>
</span><span id="__span-127-52"><a id="__codelineno-127-52" name="__codelineno-127-52" href="#__codelineno-127-52"></a>    <span class="n">current_tool</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="__span-127-53"><a id="__codelineno-127-53" name="__codelineno-127-53" href="#__codelineno-127-53"></a>    <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-127-54"><a id="__codelineno-127-54" name="__codelineno-127-54" href="#__codelineno-127-54"></a>    <span class="n">tool_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-127-55"><a id="__codelineno-127-55" name="__codelineno-127-55" href="#__codelineno-127-55"></a>    <span class="n">prompt_queue</span><span class="p">:</span> <span class="n">Deque</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="__span-127-56"><a id="__codelineno-127-56" name="__codelineno-127-56" href="#__codelineno-127-56"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-127-57"><a id="__codelineno-127-57" name="__codelineno-127-57" href="#__codelineno-127-57"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Check for missing arguments and handle them if found.&quot;&quot;&quot;</span>
</span><span id="__span-127-58"><a id="__codelineno-127-58" name="__codelineno-127-58" href="#__codelineno-127-58"></a>    <span class="n">missing_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="__span-127-59"><a id="__codelineno-127-59" name="__codelineno-127-59" href="#__codelineno-127-59"></a>
</span><span id="__span-127-60"><a id="__codelineno-127-60" name="__codelineno-127-60" href="#__codelineno-127-60"></a>    <span class="k">if</span> <span class="n">missing_args</span><span class="p">:</span>
</span><span id="__span-127-61"><a id="__codelineno-127-61" name="__codelineno-127-61" href="#__codelineno-127-61"></a>        <span class="n">prompt_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-127-62"><a id="__codelineno-127-62" name="__codelineno-127-62" href="#__codelineno-127-62"></a>            <span class="n">generate_missing_args_prompt</span><span class="p">(</span><span class="n">current_tool</span><span class="p">,</span> <span class="n">tool_data</span><span class="p">,</span> <span class="n">missing_args</span><span class="p">)</span>
</span><span id="__span-127-63"><a id="__codelineno-127-63" name="__codelineno-127-63" href="#__codelineno-127-63"></a>        <span class="p">)</span>
</span><span id="__span-127-64"><a id="__codelineno-127-64" name="__codelineno-127-64" href="#__codelineno-127-64"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-127-65"><a id="__codelineno-127-65" name="__codelineno-127-65" href="#__codelineno-127-65"></a>            <span class="sa">f</span><span class="s2">&quot;Missing arguments for tool: </span><span class="si">{</span><span class="n">current_tool</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-127-66"><a id="__codelineno-127-66" name="__codelineno-127-66" href="#__codelineno-127-66"></a>        <span class="p">)</span>
</span><span id="__span-127-67"><a id="__codelineno-127-67" name="__codelineno-127-67" href="#__codelineno-127-67"></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="__span-127-68"><a id="__codelineno-127-68" name="__codelineno-127-68" href="#__codelineno-127-68"></a>    <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-127-69"><a id="__codelineno-127-69" name="__codelineno-127-69" href="#__codelineno-127-69"></a>
</span><span id="__span-127-70"><a id="__codelineno-127-70" name="__codelineno-127-70" href="#__codelineno-127-70"></a>
</span><span id="__span-127-71"><a id="__codelineno-127-71" name="__codelineno-127-71" href="#__codelineno-127-71"></a><span class="k">def</span><span class="w"> </span><span class="nf">format_history</span><span class="p">(</span><span class="n">conversation_history</span><span class="p">:</span> <span class="n">ConversationHistory</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-127-72"><a id="__codelineno-127-72" name="__codelineno-127-72" href="#__codelineno-127-72"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Format the conversation history into a single string.&quot;&quot;&quot;</span>
</span><span id="__span-127-73"><a id="__codelineno-127-73" name="__codelineno-127-73" href="#__codelineno-127-73"></a>    <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">conversation_history</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span>
</span><span id="__span-127-74"><a id="__codelineno-127-74" name="__codelineno-127-74" href="#__codelineno-127-74"></a>
</span><span id="__span-127-75"><a id="__codelineno-127-75" name="__codelineno-127-75" href="#__codelineno-127-75"></a>
</span><span id="__span-127-76"><a id="__codelineno-127-76" name="__codelineno-127-76" href="#__codelineno-127-76"></a><span class="k">def</span><span class="w"> </span><span class="nf">prompt_summary_with_history</span><span class="p">(</span>
</span><span id="__span-127-77"><a id="__codelineno-127-77" name="__codelineno-127-77" href="#__codelineno-127-77"></a>    <span class="n">conversation_history</span><span class="p">:</span> <span class="n">ConversationHistory</span><span class="p">,</span>
</span><span id="__span-127-78"><a id="__codelineno-127-78" name="__codelineno-127-78" href="#__codelineno-127-78"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-127-79"><a id="__codelineno-127-79" name="__codelineno-127-79" href="#__codelineno-127-79"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a prompt for summarizing the conversation.</span>
</span><span id="__span-127-80"><a id="__codelineno-127-80" name="__codelineno-127-80" href="#__codelineno-127-80"></a><span class="sd">    Used only for continue as new of the workflow.&quot;&quot;&quot;</span>
</span><span id="__span-127-81"><a id="__codelineno-127-81" name="__codelineno-127-81" href="#__codelineno-127-81"></a>    <span class="n">history_string</span> <span class="o">=</span> <span class="n">format_history</span><span class="p">(</span><span class="n">conversation_history</span><span class="p">)</span>
</span><span id="__span-127-82"><a id="__codelineno-127-82" name="__codelineno-127-82" href="#__codelineno-127-82"></a>    <span class="n">context_instructions</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Here is the conversation history between a user and a chatbot: </span><span class="si">{</span><span class="n">history_string</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-127-83"><a id="__codelineno-127-83" name="__codelineno-127-83" href="#__codelineno-127-83"></a>    <span class="n">actual_prompt</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-127-84"><a id="__codelineno-127-84" name="__codelineno-127-84" href="#__codelineno-127-84"></a>        <span class="s2">&quot;Please produce a two sentence summary of this conversation. &quot;</span>
</span><span id="__span-127-85"><a id="__codelineno-127-85" name="__codelineno-127-85" href="#__codelineno-127-85"></a>        <span class="s1">&#39;Put the summary in the format { &quot;summary&quot;: &quot;&lt;plain text&gt;&quot; }&#39;</span>
</span><span id="__span-127-86"><a id="__codelineno-127-86" name="__codelineno-127-86" href="#__codelineno-127-86"></a>    <span class="p">)</span>
</span><span id="__span-127-87"><a id="__codelineno-127-87" name="__codelineno-127-87" href="#__codelineno-127-87"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">context_instructions</span><span class="p">,</span> <span class="n">actual_prompt</span><span class="p">)</span>
</span><span id="__span-127-88"><a id="__codelineno-127-88" name="__codelineno-127-88" href="#__codelineno-127-88"></a>
</span><span id="__span-127-89"><a id="__codelineno-127-89" name="__codelineno-127-89" href="#__codelineno-127-89"></a>
</span><span id="__span-127-90"><a id="__codelineno-127-90" name="__codelineno-127-90" href="#__codelineno-127-90"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">continue_as_new_if_needed</span><span class="p">(</span>
</span><span id="__span-127-91"><a id="__codelineno-127-91" name="__codelineno-127-91" href="#__codelineno-127-91"></a>    <span class="n">conversation_history</span><span class="p">:</span> <span class="n">ConversationHistory</span><span class="p">,</span>
</span><span id="__span-127-92"><a id="__codelineno-127-92" name="__codelineno-127-92" href="#__codelineno-127-92"></a>    <span class="n">prompt_queue</span><span class="p">:</span> <span class="n">Deque</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
</span><span id="__span-127-93"><a id="__codelineno-127-93" name="__codelineno-127-93" href="#__codelineno-127-93"></a>    <span class="n">agent_goal</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="__span-127-94"><a id="__codelineno-127-94" name="__codelineno-127-94" href="#__codelineno-127-94"></a>    <span class="n">max_turns</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="__span-127-95"><a id="__codelineno-127-95" name="__codelineno-127-95" href="#__codelineno-127-95"></a>    <span class="n">add_message_callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="__span-127-96"><a id="__codelineno-127-96" name="__codelineno-127-96" href="#__codelineno-127-96"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-127-97"><a id="__codelineno-127-97" name="__codelineno-127-97" href="#__codelineno-127-97"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle workflow continuation if message limit is reached.&quot;&quot;&quot;</span>
</span><span id="__span-127-98"><a id="__codelineno-127-98" name="__codelineno-127-98" href="#__codelineno-127-98"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conversation_history</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">max_turns</span><span class="p">:</span>
</span><span id="__span-127-99"><a id="__codelineno-127-99" name="__codelineno-127-99" href="#__codelineno-127-99"></a>        <span class="n">summary_context</span><span class="p">,</span> <span class="n">summary_prompt</span> <span class="o">=</span> <span class="n">prompt_summary_with_history</span><span class="p">(</span>
</span><span id="__span-127-100"><a id="__codelineno-127-100" name="__codelineno-127-100" href="#__codelineno-127-100"></a>            <span class="n">conversation_history</span>
</span><span id="__span-127-101"><a id="__codelineno-127-101" name="__codelineno-127-101" href="#__codelineno-127-101"></a>        <span class="p">)</span>
</span><span id="__span-127-102"><a id="__codelineno-127-102" name="__codelineno-127-102" href="#__codelineno-127-102"></a>        <span class="n">summary_input</span> <span class="o">=</span> <span class="n">ToolPromptInput</span><span class="p">(</span>
</span><span id="__span-127-103"><a id="__codelineno-127-103" name="__codelineno-127-103" href="#__codelineno-127-103"></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">summary_prompt</span><span class="p">,</span> <span class="n">context_instructions</span><span class="o">=</span><span class="n">summary_context</span>
</span><span id="__span-127-104"><a id="__codelineno-127-104" name="__codelineno-127-104" href="#__codelineno-127-104"></a>        <span class="p">)</span>
</span><span id="__span-127-105"><a id="__codelineno-127-105" name="__codelineno-127-105" href="#__codelineno-127-105"></a>        <span class="n">conversation_summary</span> <span class="o">=</span> <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">start_activity_method</span><span class="p">(</span>
</span><span id="__span-127-106"><a id="__codelineno-127-106" name="__codelineno-127-106" href="#__codelineno-127-106"></a>            <span class="n">AgentActivities</span><span class="o">.</span><span class="n">agent_toolPlanner</span><span class="p">,</span>
</span><span id="__span-127-107"><a id="__codelineno-127-107" name="__codelineno-127-107" href="#__codelineno-127-107"></a>            <span class="n">summary_input</span><span class="p">,</span>
</span><span id="__span-127-108"><a id="__codelineno-127-108" name="__codelineno-127-108" href="#__codelineno-127-108"></a>            <span class="n">schedule_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-127-109"><a id="__codelineno-127-109" name="__codelineno-127-109" href="#__codelineno-127-109"></a>        <span class="p">)</span>
</span><span id="__span-127-110"><a id="__codelineno-127-110" name="__codelineno-127-110" href="#__codelineno-127-110"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Continuing as new after </span><span class="si">{</span><span class="n">max_turns</span><span class="si">}</span><span class="s2"> turns.&quot;</span><span class="p">)</span>
</span><span id="__span-127-111"><a id="__codelineno-127-111" name="__codelineno-127-111" href="#__codelineno-127-111"></a>        <span class="n">add_message_callback</span><span class="p">(</span><span class="s2">&quot;conversation_summary&quot;</span><span class="p">,</span> <span class="n">conversation_summary</span><span class="p">)</span>
</span><span id="__span-127-112"><a id="__codelineno-127-112" name="__codelineno-127-112" href="#__codelineno-127-112"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">continue_as_new</span><span class="p">(</span>
</span><span id="__span-127-113"><a id="__codelineno-127-113" name="__codelineno-127-113" href="#__codelineno-127-113"></a>            <span class="n">args</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-127-114"><a id="__codelineno-127-114" name="__codelineno-127-114" href="#__codelineno-127-114"></a>                <span class="p">{</span>
</span><span id="__span-127-115"><a id="__codelineno-127-115" name="__codelineno-127-115" href="#__codelineno-127-115"></a>                    <span class="s2">&quot;tool_params&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="__span-127-116"><a id="__codelineno-127-116" name="__codelineno-127-116" href="#__codelineno-127-116"></a>                        <span class="s2">&quot;conversation_summary&quot;</span><span class="p">:</span> <span class="n">conversation_summary</span><span class="p">,</span>
</span><span id="__span-127-117"><a id="__codelineno-127-117" name="__codelineno-127-117" href="#__codelineno-127-117"></a>                        <span class="s2">&quot;prompt_queue&quot;</span><span class="p">:</span> <span class="n">prompt_queue</span><span class="p">,</span>
</span><span id="__span-127-118"><a id="__codelineno-127-118" name="__codelineno-127-118" href="#__codelineno-127-118"></a>                    <span class="p">},</span>
</span><span id="__span-127-119"><a id="__codelineno-127-119" name="__codelineno-127-119" href="#__codelineno-127-119"></a>                    <span class="s2">&quot;agent_goal&quot;</span><span class="p">:</span> <span class="n">agent_goal</span><span class="p">,</span>
</span><span id="__span-127-120"><a id="__codelineno-127-120" name="__codelineno-127-120" href="#__codelineno-127-120"></a>                <span class="p">}</span>
</span><span id="__span-127-121"><a id="__codelineno-127-121" name="__codelineno-127-121" href="#__codelineno-127-121"></a>            <span class="p">]</span>
</span><span id="__span-127-122"><a id="__codelineno-127-122" name="__codelineno-127-122" href="#__codelineno-127-122"></a>        <span class="p">)</span>
</span><span id="__span-127-123"><a id="__codelineno-127-123" name="__codelineno-127-123" href="#__codelineno-127-123"></a>
</span><span id="__span-127-124"><a id="__codelineno-127-124" name="__codelineno-127-124" href="#__codelineno-127-124"></a>
</span><span id="__span-127-125"><a id="__codelineno-127-125" name="__codelineno-127-125" href="#__codelineno-127-125"></a><span class="c1"># LLM-tagged prompts start with &quot;###&quot;</span>
</span><span id="__span-127-126"><a id="__codelineno-127-126" name="__codelineno-127-126" href="#__codelineno-127-126"></a><span class="c1"># all others are from the user</span>
</span><span id="__span-127-127"><a id="__codelineno-127-127" name="__codelineno-127-127" href="#__codelineno-127-127"></a><span class="k">def</span><span class="w"> </span><span class="nf">is_user_prompt</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-127-128"><a id="__codelineno-127-128" name="__codelineno-127-128" href="#__codelineno-127-128"></a>    <span class="k">if</span> <span class="n">prompt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;###&quot;</span><span class="p">):</span>
</span><span id="__span-127-129"><a id="__codelineno-127-129" name="__codelineno-127-129" href="#__codelineno-127-129"></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="__span-127-130"><a id="__codelineno-127-130" name="__codelineno-127-130" href="#__codelineno-127-130"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-127-131"><a id="__codelineno-127-131" name="__codelineno-127-131" href="#__codelineno-127-131"></a>        <span class="k">return</span> <span class="kc">True</span>
</span></code></pre></div>
</details>

<p>Now that you have built out the supporting functions, you can build the agent Workflow.</p>
<h3 id="preparing-the-core-agent-workflow">Preparing the core agent Workflow<a class="headerlink" href="#preparing-the-core-agent-workflow" title="Permanent link">&para;</a></h3>
<p>The core agent Workflow is the primary driver of your agent.
It orchestrates LLM and tool execution, maintains conversation state, and makes decisions about what step to take next.
The Workflow will consist of the primary Workflow class and method, as well as a few Signals, Queries, and class methods.</p>
<p>First, create <code>workflows/agent_goal_workflow.py</code>, and add the necessary imports:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-128-1"><a id="__codelineno-128-1" name="__codelineno-128-1" href="#__codelineno-128-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
</span><span id="__span-128-2"><a id="__codelineno-128-2" name="__codelineno-128-2" href="#__codelineno-128-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
</span><span id="__span-128-3"><a id="__codelineno-128-3" name="__codelineno-128-3" href="#__codelineno-128-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Deque</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="__span-128-4"><a id="__codelineno-128-4" name="__codelineno-128-4" href="#__codelineno-128-4"></a>
</span><span id="__span-128-5"><a id="__codelineno-128-5" name="__codelineno-128-5" href="#__codelineno-128-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio</span><span class="w"> </span><span class="kn">import</span> <span class="n">workflow</span>
</span><span id="__span-128-6"><a id="__codelineno-128-6" name="__codelineno-128-6" href="#__codelineno-128-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">RetryPolicy</span>
</span><span id="__span-128-7"><a id="__codelineno-128-7" name="__codelineno-128-7" href="#__codelineno-128-7"></a>
</span><span id="__span-128-8"><a id="__codelineno-128-8" name="__codelineno-128-8" href="#__codelineno-128-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentGoal</span>
</span><span id="__span-128-9"><a id="__codelineno-128-9" name="__codelineno-128-9" href="#__codelineno-128-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-128-10"><a id="__codelineno-128-10" name="__codelineno-128-10" href="#__codelineno-128-10"></a>    <span class="n">ConversationHistory</span><span class="p">,</span>
</span><span id="__span-128-11"><a id="__codelineno-128-11" name="__codelineno-128-11" href="#__codelineno-128-11"></a>    <span class="n">CurrentTool</span><span class="p">,</span>
</span><span id="__span-128-12"><a id="__codelineno-128-12" name="__codelineno-128-12" href="#__codelineno-128-12"></a>    <span class="n">EnvLookupInput</span><span class="p">,</span>
</span><span id="__span-128-13"><a id="__codelineno-128-13" name="__codelineno-128-13" href="#__codelineno-128-13"></a>    <span class="n">EnvLookupOutput</span><span class="p">,</span>
</span><span id="__span-128-14"><a id="__codelineno-128-14" name="__codelineno-128-14" href="#__codelineno-128-14"></a>    <span class="n">ToolData</span><span class="p">,</span>
</span><span id="__span-128-15"><a id="__codelineno-128-15" name="__codelineno-128-15" href="#__codelineno-128-15"></a>    <span class="n">ValidationInput</span><span class="p">,</span>
</span><span id="__span-128-16"><a id="__codelineno-128-16" name="__codelineno-128-16" href="#__codelineno-128-16"></a><span class="p">)</span>
</span><span id="__span-128-17"><a id="__codelineno-128-17" name="__codelineno-128-17" href="#__codelineno-128-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">workflows</span><span class="w"> </span><span class="kn">import</span> <span class="n">workflow_helpers</span> <span class="k">as</span> <span class="n">helpers</span>
</span><span id="__span-128-18"><a id="__codelineno-128-18" name="__codelineno-128-18" href="#__codelineno-128-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">workflows.workflow_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-128-19"><a id="__codelineno-128-19" name="__codelineno-128-19" href="#__codelineno-128-19"></a>    <span class="n">LLM_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-128-20"><a id="__codelineno-128-20" name="__codelineno-128-20" href="#__codelineno-128-20"></a>    <span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-128-21"><a id="__codelineno-128-21" name="__codelineno-128-21" href="#__codelineno-128-21"></a><span class="p">)</span>
</span><span id="__span-128-22"><a id="__codelineno-128-22" name="__codelineno-128-22" href="#__codelineno-128-22"></a>
</span><span id="__span-128-23"><a id="__codelineno-128-23" name="__codelineno-128-23" href="#__codelineno-128-23"></a><span class="k">with</span> <span class="n">workflow</span><span class="o">.</span><span class="n">unsafe</span><span class="o">.</span><span class="n">imports_passed_through</span><span class="p">():</span>
</span><span id="__span-128-24"><a id="__codelineno-128-24" name="__codelineno-128-24" href="#__codelineno-128-24"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">activities.activities</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentActivities</span>
</span><span id="__span-128-25"><a id="__codelineno-128-25" name="__codelineno-128-25" href="#__codelineno-128-25"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">CombinedInput</span><span class="p">,</span> <span class="n">ToolPromptInput</span>
</span><span id="__span-128-26"><a id="__codelineno-128-26" name="__codelineno-128-26" href="#__codelineno-128-26"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">prompts.agent_prompt_generators</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_genai_prompt</span>
</span><span id="__span-128-27"><a id="__codelineno-128-27" name="__codelineno-128-27" href="#__codelineno-128-27"></a>
</span><span id="__span-128-28"><a id="__codelineno-128-28" name="__codelineno-128-28" href="#__codelineno-128-28"></a><span class="c1"># Constants</span>
</span><span id="__span-128-29"><a id="__codelineno-128-29" name="__codelineno-128-29" href="#__codelineno-128-29"></a><span class="n">MAX_TURNS_BEFORE_CONTINUE</span> <span class="o">=</span> <span class="mi">250</span>
</span></code></pre></div>
<p>These imports bring in the necessary types, helper functions, and constants you have defined so far, as well as libraries from the Temporal and Python standard library. 
You also added the <code>MAX_TURNS_BEFORE_CONTINUE</code> constant, and set the value to <code>250</code>.
The agent will use this value with the <code>continue_as_new_if_needed</code> helper function you implemented to decide if it should <a href="https://docs.temporal.io/workflow-execution/continue-as-new"><code>Continue-As-New</code></a>.
For the sake of this agent and its goal, <code>250</code> turns should be an adequate number </p>
<h4 id="defining-the-agent-class-and-constructor">Defining the agent class and constructor<a class="headerlink" href="#defining-the-agent-class-and-constructor" title="Permanent link">&para;</a></h4>
<p>You define a Temporal Workflow by creating a Python class.
Create the <code>AgentGoalWorkflow</code> class, decorate it with <code>@workflow.defn</code>, and define the <code>__init__</code> method:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-129-1"><a id="__codelineno-129-1" name="__codelineno-129-1" href="#__codelineno-129-1"></a><span class="nd">@workflow</span><span class="o">.</span><span class="n">defn</span>
</span><span id="__span-129-2"><a id="__codelineno-129-2" name="__codelineno-129-2" href="#__codelineno-129-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentGoalWorkflow</span><span class="p">:</span>
</span><span id="__span-129-3"><a id="__codelineno-129-3" name="__codelineno-129-3" href="#__codelineno-129-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Workflow that manages tool execution with user confirmation and conversation history.&quot;&quot;&quot;</span>
</span><span id="__span-129-4"><a id="__codelineno-129-4" name="__codelineno-129-4" href="#__codelineno-129-4"></a>
</span><span id="__span-129-5"><a id="__codelineno-129-5" name="__codelineno-129-5" href="#__codelineno-129-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-129-6"><a id="__codelineno-129-6" name="__codelineno-129-6" href="#__codelineno-129-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">:</span> <span class="n">ConversationHistory</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="__span-129-7"><a id="__codelineno-129-7" name="__codelineno-129-7" href="#__codelineno-129-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">:</span> <span class="n">Deque</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
</span><span id="__span-129-8"><a id="__codelineno-129-8" name="__codelineno-129-8" href="#__codelineno-129-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-129-9"><a id="__codelineno-129-9" name="__codelineno-129-9" href="#__codelineno-129-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ToolData</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-129-10"><a id="__codelineno-129-10" name="__codelineno-129-10" href="#__codelineno-129-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AgentGoal</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-129-11"><a id="__codelineno-129-11" name="__codelineno-129-11" href="#__codelineno-129-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_confirm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-129-12"><a id="__codelineno-129-12" name="__codelineno-129-12" href="#__codelineno-129-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">show_tool_args_confirmation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-129-13"><a id="__codelineno-129-13" name="__codelineno-129-13" href="#__codelineno-129-13"></a>            <span class="kc">True</span>  <span class="c1"># set from env file in activity lookup_wf_env_settings</span>
</span><span id="__span-129-14"><a id="__codelineno-129-14" name="__codelineno-129-14" href="#__codelineno-129-14"></a>        <span class="p">)</span>
</span><span id="__span-129-15"><a id="__codelineno-129-15" name="__codelineno-129-15" href="#__codelineno-129-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-129-16"><a id="__codelineno-129-16" name="__codelineno-129-16" href="#__codelineno-129-16"></a>            <span class="kc">False</span>  <span class="c1"># indicates that we have confirmation to proceed to run tool</span>
</span><span id="__span-129-17"><a id="__codelineno-129-17" name="__codelineno-129-17" href="#__codelineno-129-17"></a>        <span class="p">)</span>
</span></code></pre></div>
<p>Your Workflow must be decorated with the <code>@workflow.defn</code> decorator.
This is what distinguishes it as a Temporal Workflow.
While a Workflow isn't required to have a <code>__init__</code> method, your agent will benefit from instance variables.</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>conversation_history</code></td>
<td>A record of the entire chat conversation history</td>
</tr>
<tr>
<td><code>prompt_queue</code></td>
<td>A queue maintaining tasks left for the agent to process</td>
</tr>
<tr>
<td><code>chat_ended</code></td>
<td>A boolean to determine if the chat has ended or not</td>
</tr>
<tr>
<td><code>tool_data</code></td>
<td>A record of the current tool data</td>
</tr>
<tr>
<td><code>goal</code></td>
<td>The agent's goal</td>
</tr>
<tr>
<td><code>waiting_for_confirm</code></td>
<td>A boolean signifying if the agent is ready to execute the tool</td>
</tr>
<tr>
<td><code>show_tool_args_confirmation</code></td>
<td>A boolean to determine if extra confirmation is necessary before executing tools</td>
</tr>
<tr>
<td><code>confirmed</code></td>
<td>A boolean for determining if the agent is confirmed to proceed</td>
</tr>
</tbody>
</table>
<p>Next, you'll begin implementing the main Workflow method.</p>
<h4 id="defining-the-agent-control-variables">Defining the agent control variables<a class="headerlink" href="#defining-the-agent-control-variables" title="Permanent link">&para;</a></h4>
<p>Every Temporal Workflow has a singular entry point, also known as the Workflow method.
This method is decorated with the <code>@workflow.run</code> decorator.
Your Workflow method will contain the primary business logic for your agent.</p>
<p>Declare the method header for your agent's Workflow method:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-130-1"><a id="__codelineno-130-1" name="__codelineno-130-1" href="#__codelineno-130-1"></a>    <span class="nd">@workflow</span><span class="o">.</span><span class="n">run</span>
</span><span id="__span-130-2"><a id="__codelineno-130-2" name="__codelineno-130-2" href="#__codelineno-130-2"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combined_input</span><span class="p">:</span> <span class="n">CombinedInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></code></pre></div>
<p>The Workflow method must be decorated with the <code>@workflow.run</code> decorator, and must be implemented using Python's <code>asyncio</code> library.
This method takes in one argument, a type you defined named <code>CombinedInput</code>, and returns a <code>str</code>.
Recall that <code>CombinedInput</code> contains the <code>AgentGoal</code> and <code>AgentGoalWorkflowParams</code> types.</p>
<p>Add the next few lines of code to the <code>run</code> method to assign values to a few parameters:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-131-1"><a id="__codelineno-131-1" name="__codelineno-131-1" href="#__codelineno-131-1"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Main workflow execution method.&quot;&quot;&quot;</span>
</span><span id="__span-131-2"><a id="__codelineno-131-2" name="__codelineno-131-2" href="#__codelineno-131-2"></a>        <span class="c1"># setup phase, starts with blank tool_params and agent_goal prompt as defined in tools/goal_registry.py</span>
</span><span id="__span-131-3"><a id="__codelineno-131-3" name="__codelineno-131-3" href="#__codelineno-131-3"></a>        <span class="n">params</span> <span class="o">=</span> <span class="n">combined_input</span><span class="o">.</span><span class="n">tool_params</span>
</span><span id="__span-131-4"><a id="__codelineno-131-4" name="__codelineno-131-4" href="#__codelineno-131-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">goal</span> <span class="o">=</span> <span class="n">combined_input</span><span class="o">.</span><span class="n">agent_goal</span>
</span><span id="__span-131-5"><a id="__codelineno-131-5" name="__codelineno-131-5" href="#__codelineno-131-5"></a>
</span><span id="__span-131-6"><a id="__codelineno-131-6" name="__codelineno-131-6" href="#__codelineno-131-6"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_wf_env_settings</span><span class="p">()</span>
</span></code></pre></div>
<p>The last line calls a method, <code>lookup_wf_env_settings</code>, that hasn't been defined yet, so define that as a method within the <code>AgentGoalWorkflow</code> class but not within the scope of your <code>run</code> method:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-132-1"><a id="__codelineno-132-1" name="__codelineno-132-1" href="#__codelineno-132-1"></a>    <span class="c1"># look up env settings in an activity so they&#39;re part of history</span>
</span><span id="__span-132-2"><a id="__codelineno-132-2" name="__codelineno-132-2" href="#__codelineno-132-2"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lookup_wf_env_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-132-3"><a id="__codelineno-132-3" name="__codelineno-132-3" href="#__codelineno-132-3"></a>        <span class="n">env_lookup_input</span> <span class="o">=</span> <span class="n">EnvLookupInput</span><span class="p">(</span>
</span><span id="__span-132-4"><a id="__codelineno-132-4" name="__codelineno-132-4" href="#__codelineno-132-4"></a>            <span class="n">show_confirm_env_var_name</span><span class="o">=</span><span class="s2">&quot;SHOW_CONFIRM&quot;</span><span class="p">,</span>
</span><span id="__span-132-5"><a id="__codelineno-132-5" name="__codelineno-132-5" href="#__codelineno-132-5"></a>            <span class="n">show_confirm_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-132-6"><a id="__codelineno-132-6" name="__codelineno-132-6" href="#__codelineno-132-6"></a>        <span class="p">)</span>
</span><span id="__span-132-7"><a id="__codelineno-132-7" name="__codelineno-132-7" href="#__codelineno-132-7"></a>        <span class="n">env_output</span><span class="p">:</span> <span class="n">EnvLookupOutput</span> <span class="o">=</span> <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">execute_activity_method</span><span class="p">(</span>
</span><span id="__span-132-8"><a id="__codelineno-132-8" name="__codelineno-132-8" href="#__codelineno-132-8"></a>            <span class="n">AgentActivities</span><span class="o">.</span><span class="n">get_wf_env_vars</span><span class="p">,</span>
</span><span id="__span-132-9"><a id="__codelineno-132-9" name="__codelineno-132-9" href="#__codelineno-132-9"></a>            <span class="n">env_lookup_input</span><span class="p">,</span>
</span><span id="__span-132-10"><a id="__codelineno-132-10" name="__codelineno-132-10" href="#__codelineno-132-10"></a>            <span class="n">start_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-132-11"><a id="__codelineno-132-11" name="__codelineno-132-11" href="#__codelineno-132-11"></a>            <span class="n">retry_policy</span><span class="o">=</span><span class="n">RetryPolicy</span><span class="p">(</span>
</span><span id="__span-132-12"><a id="__codelineno-132-12" name="__codelineno-132-12" href="#__codelineno-132-12"></a>                <span class="n">initial_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">backoff_coefficient</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-132-13"><a id="__codelineno-132-13" name="__codelineno-132-13" href="#__codelineno-132-13"></a>            <span class="p">),</span>
</span><span id="__span-132-14"><a id="__codelineno-132-14" name="__codelineno-132-14" href="#__codelineno-132-14"></a>        <span class="p">)</span>
</span><span id="__span-132-15"><a id="__codelineno-132-15" name="__codelineno-132-15" href="#__codelineno-132-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">show_tool_args_confirmation</span> <span class="o">=</span> <span class="n">env_output</span><span class="o">.</span><span class="n">show_confirm</span>
</span></code></pre></div>
<p>This method invokes the <code>get_wf_env_vars</code> Activity to read the environment variables and store them appropriately.</p>
<details>

<summary>
Checkpoint: Your file should currently look like this:
</summary>
Hover your cursor over the code block to reveal the copy-code option.
<br />

<div class="language-python highlight"><pre><span></span><code><span id="__span-133-1"><a id="__codelineno-133-1" name="__codelineno-133-1" href="#__codelineno-133-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
</span><span id="__span-133-2"><a id="__codelineno-133-2" name="__codelineno-133-2" href="#__codelineno-133-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
</span><span id="__span-133-3"><a id="__codelineno-133-3" name="__codelineno-133-3" href="#__codelineno-133-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Deque</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="__span-133-4"><a id="__codelineno-133-4" name="__codelineno-133-4" href="#__codelineno-133-4"></a>
</span><span id="__span-133-5"><a id="__codelineno-133-5" name="__codelineno-133-5" href="#__codelineno-133-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio</span><span class="w"> </span><span class="kn">import</span> <span class="n">workflow</span>
</span><span id="__span-133-6"><a id="__codelineno-133-6" name="__codelineno-133-6" href="#__codelineno-133-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">RetryPolicy</span>
</span><span id="__span-133-7"><a id="__codelineno-133-7" name="__codelineno-133-7" href="#__codelineno-133-7"></a>
</span><span id="__span-133-8"><a id="__codelineno-133-8" name="__codelineno-133-8" href="#__codelineno-133-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentGoal</span><span class="p">,</span> <span class="n">ConversationHistory</span><span class="p">,</span> <span class="n">CurrentTool</span>
</span><span id="__span-133-9"><a id="__codelineno-133-9" name="__codelineno-133-9" href="#__codelineno-133-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">EnvLookupInput</span><span class="p">,</span> <span class="n">EnvLookupOutput</span><span class="p">,</span> <span class="n">ToolData</span><span class="p">,</span> <span class="n">ValidationInput</span>
</span><span id="__span-133-10"><a id="__codelineno-133-10" name="__codelineno-133-10" href="#__codelineno-133-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">workflows</span><span class="w"> </span><span class="kn">import</span> <span class="n">workflow_helpers</span> <span class="k">as</span> <span class="n">helpers</span>
</span><span id="__span-133-11"><a id="__codelineno-133-11" name="__codelineno-133-11" href="#__codelineno-133-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">workflows.workflow_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-133-12"><a id="__codelineno-133-12" name="__codelineno-133-12" href="#__codelineno-133-12"></a>    <span class="n">LLM_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-133-13"><a id="__codelineno-133-13" name="__codelineno-133-13" href="#__codelineno-133-13"></a>    <span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-133-14"><a id="__codelineno-133-14" name="__codelineno-133-14" href="#__codelineno-133-14"></a><span class="p">)</span>
</span><span id="__span-133-15"><a id="__codelineno-133-15" name="__codelineno-133-15" href="#__codelineno-133-15"></a>
</span><span id="__span-133-16"><a id="__codelineno-133-16" name="__codelineno-133-16" href="#__codelineno-133-16"></a><span class="k">with</span> <span class="n">workflow</span><span class="o">.</span><span class="n">unsafe</span><span class="o">.</span><span class="n">imports_passed_through</span><span class="p">():</span>
</span><span id="__span-133-17"><a id="__codelineno-133-17" name="__codelineno-133-17" href="#__codelineno-133-17"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">activities.activities</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentActivities</span>
</span><span id="__span-133-18"><a id="__codelineno-133-18" name="__codelineno-133-18" href="#__codelineno-133-18"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">CombinedInput</span><span class="p">,</span> <span class="n">ToolPromptInput</span>
</span><span id="__span-133-19"><a id="__codelineno-133-19" name="__codelineno-133-19" href="#__codelineno-133-19"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">prompts.agent_prompt_generators</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_genai_prompt</span>
</span><span id="__span-133-20"><a id="__codelineno-133-20" name="__codelineno-133-20" href="#__codelineno-133-20"></a>
</span><span id="__span-133-21"><a id="__codelineno-133-21" name="__codelineno-133-21" href="#__codelineno-133-21"></a><span class="c1"># Constants</span>
</span><span id="__span-133-22"><a id="__codelineno-133-22" name="__codelineno-133-22" href="#__codelineno-133-22"></a><span class="n">MAX_TURNS_BEFORE_CONTINUE</span> <span class="o">=</span> <span class="mi">250</span>
</span><span id="__span-133-23"><a id="__codelineno-133-23" name="__codelineno-133-23" href="#__codelineno-133-23"></a>
</span><span id="__span-133-24"><a id="__codelineno-133-24" name="__codelineno-133-24" href="#__codelineno-133-24"></a><span class="nd">@workflow</span><span class="o">.</span><span class="n">defn</span>
</span><span id="__span-133-25"><a id="__codelineno-133-25" name="__codelineno-133-25" href="#__codelineno-133-25"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentGoalWorkflow</span><span class="p">:</span>
</span><span id="__span-133-26"><a id="__codelineno-133-26" name="__codelineno-133-26" href="#__codelineno-133-26"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Workflow that manages tool execution with user confirmation and conversation history.&quot;&quot;&quot;</span>
</span><span id="__span-133-27"><a id="__codelineno-133-27" name="__codelineno-133-27" href="#__codelineno-133-27"></a>
</span><span id="__span-133-28"><a id="__codelineno-133-28" name="__codelineno-133-28" href="#__codelineno-133-28"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-133-29"><a id="__codelineno-133-29" name="__codelineno-133-29" href="#__codelineno-133-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">:</span> <span class="n">ConversationHistory</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="__span-133-30"><a id="__codelineno-133-30" name="__codelineno-133-30" href="#__codelineno-133-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">:</span> <span class="n">Deque</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
</span><span id="__span-133-31"><a id="__codelineno-133-31" name="__codelineno-133-31" href="#__codelineno-133-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-133-32"><a id="__codelineno-133-32" name="__codelineno-133-32" href="#__codelineno-133-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ToolData</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-133-33"><a id="__codelineno-133-33" name="__codelineno-133-33" href="#__codelineno-133-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AgentGoal</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-133-34"><a id="__codelineno-133-34" name="__codelineno-133-34" href="#__codelineno-133-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_confirm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-133-35"><a id="__codelineno-133-35" name="__codelineno-133-35" href="#__codelineno-133-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">show_tool_args_confirmation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-133-36"><a id="__codelineno-133-36" name="__codelineno-133-36" href="#__codelineno-133-36"></a>            <span class="kc">True</span>  <span class="c1"># set from env file in activity lookup_wf_env_settings</span>
</span><span id="__span-133-37"><a id="__codelineno-133-37" name="__codelineno-133-37" href="#__codelineno-133-37"></a>        <span class="p">)</span>
</span><span id="__span-133-38"><a id="__codelineno-133-38" name="__codelineno-133-38" href="#__codelineno-133-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-133-39"><a id="__codelineno-133-39" name="__codelineno-133-39" href="#__codelineno-133-39"></a>            <span class="kc">False</span>  <span class="c1"># indicates that we have confirmation to proceed to run tool</span>
</span><span id="__span-133-40"><a id="__codelineno-133-40" name="__codelineno-133-40" href="#__codelineno-133-40"></a>        <span class="p">)</span>
</span><span id="__span-133-41"><a id="__codelineno-133-41" name="__codelineno-133-41" href="#__codelineno-133-41"></a>
</span><span id="__span-133-42"><a id="__codelineno-133-42" name="__codelineno-133-42" href="#__codelineno-133-42"></a>    <span class="nd">@workflow</span><span class="o">.</span><span class="n">run</span>
</span><span id="__span-133-43"><a id="__codelineno-133-43" name="__codelineno-133-43" href="#__codelineno-133-43"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combined_input</span><span class="p">:</span> <span class="n">CombinedInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-133-44"><a id="__codelineno-133-44" name="__codelineno-133-44" href="#__codelineno-133-44"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Main workflow execution method.&quot;&quot;&quot;</span>
</span><span id="__span-133-45"><a id="__codelineno-133-45" name="__codelineno-133-45" href="#__codelineno-133-45"></a>        <span class="c1"># setup phase, starts with blank tool_params and agent_goal prompt as defined in tools/goal_registry.py</span>
</span><span id="__span-133-46"><a id="__codelineno-133-46" name="__codelineno-133-46" href="#__codelineno-133-46"></a>        <span class="n">params</span> <span class="o">=</span> <span class="n">combined_input</span><span class="o">.</span><span class="n">tool_params</span>
</span><span id="__span-133-47"><a id="__codelineno-133-47" name="__codelineno-133-47" href="#__codelineno-133-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">goal</span> <span class="o">=</span> <span class="n">combined_input</span><span class="o">.</span><span class="n">agent_goal</span>
</span><span id="__span-133-48"><a id="__codelineno-133-48" name="__codelineno-133-48" href="#__codelineno-133-48"></a>
</span><span id="__span-133-49"><a id="__codelineno-133-49" name="__codelineno-133-49" href="#__codelineno-133-49"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_wf_env_settings</span><span class="p">()</span>
</span><span id="__span-133-50"><a id="__codelineno-133-50" name="__codelineno-133-50" href="#__codelineno-133-50"></a>
</span><span id="__span-133-51"><a id="__codelineno-133-51" name="__codelineno-133-51" href="#__codelineno-133-51"></a>    <span class="c1"># look up env settings in an activity so they&#39;re part of history</span>
</span><span id="__span-133-52"><a id="__codelineno-133-52" name="__codelineno-133-52" href="#__codelineno-133-52"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lookup_wf_env_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-133-53"><a id="__codelineno-133-53" name="__codelineno-133-53" href="#__codelineno-133-53"></a>        <span class="n">env_lookup_input</span> <span class="o">=</span> <span class="n">EnvLookupInput</span><span class="p">(</span>
</span><span id="__span-133-54"><a id="__codelineno-133-54" name="__codelineno-133-54" href="#__codelineno-133-54"></a>            <span class="n">show_confirm_env_var_name</span><span class="o">=</span><span class="s2">&quot;SHOW_CONFIRM&quot;</span><span class="p">,</span>
</span><span id="__span-133-55"><a id="__codelineno-133-55" name="__codelineno-133-55" href="#__codelineno-133-55"></a>            <span class="n">show_confirm_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-133-56"><a id="__codelineno-133-56" name="__codelineno-133-56" href="#__codelineno-133-56"></a>        <span class="p">)</span>
</span><span id="__span-133-57"><a id="__codelineno-133-57" name="__codelineno-133-57" href="#__codelineno-133-57"></a>        <span class="n">env_output</span><span class="p">:</span> <span class="n">EnvLookupOutput</span> <span class="o">=</span> <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">execute_activity_method</span><span class="p">(</span>
</span><span id="__span-133-58"><a id="__codelineno-133-58" name="__codelineno-133-58" href="#__codelineno-133-58"></a>            <span class="n">AgentActivities</span><span class="o">.</span><span class="n">get_wf_env_vars</span><span class="p">,</span>
</span><span id="__span-133-59"><a id="__codelineno-133-59" name="__codelineno-133-59" href="#__codelineno-133-59"></a>            <span class="n">env_lookup_input</span><span class="p">,</span>
</span><span id="__span-133-60"><a id="__codelineno-133-60" name="__codelineno-133-60" href="#__codelineno-133-60"></a>            <span class="n">start_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-133-61"><a id="__codelineno-133-61" name="__codelineno-133-61" href="#__codelineno-133-61"></a>            <span class="n">retry_policy</span><span class="o">=</span><span class="n">RetryPolicy</span><span class="p">(</span>
</span><span id="__span-133-62"><a id="__codelineno-133-62" name="__codelineno-133-62" href="#__codelineno-133-62"></a>                <span class="n">initial_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">backoff_coefficient</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-133-63"><a id="__codelineno-133-63" name="__codelineno-133-63" href="#__codelineno-133-63"></a>            <span class="p">),</span>
</span><span id="__span-133-64"><a id="__codelineno-133-64" name="__codelineno-133-64" href="#__codelineno-133-64"></a>        <span class="p">)</span>
</span><span id="__span-133-65"><a id="__codelineno-133-65" name="__codelineno-133-65" href="#__codelineno-133-65"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">show_tool_args_confirmation</span> <span class="o">=</span> <span class="n">env_output</span><span class="o">.</span><span class="n">show_confirm</span>
</span></code></pre></div>
</details>

<p>Next, add the final lines of code to finish instantiating the instance and local variables within the <code>run</code> method:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-134-1"><a id="__codelineno-134-1" name="__codelineno-134-1" href="#__codelineno-134-1"></a>        <span class="k">if</span> <span class="n">params</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">:</span>
</span><span id="__span-134-2"><a id="__codelineno-134-2" name="__codelineno-134-2" href="#__codelineno-134-2"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">)</span>
</span><span id="__span-134-3"><a id="__codelineno-134-3" name="__codelineno-134-3" href="#__codelineno-134-3"></a>
</span><span id="__span-134-4"><a id="__codelineno-134-4" name="__codelineno-134-4" href="#__codelineno-134-4"></a>        <span class="n">waiting_for_confirm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-134-5"><a id="__codelineno-134-5" name="__codelineno-134-5" href="#__codelineno-134-5"></a>        <span class="n">current_tool</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CurrentTool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></code></pre></div>
<p>If the parameters include a prompt, they are added to the <code>prompt_queue</code> for the agent to process.
The <code>prompt_queue</code> is source of truth for tasks that the agent needs to execute to complete its goal.
Tasks will be added throughout the lifecycle, which will drive execution forward.</p>
<p>Finally, you set the waiting for confirmation variable to false and the current tool to None.
These variables will change as the agent processes the various tasks to complete its goal.</p>
<p>Now that you've defined the class and instantiated the control variables, you can build the core agent loop.</p>
<h3 id="implementing-the-core-agent-loop">Implementing the core agent loop<a class="headerlink" href="#implementing-the-core-agent-loop" title="Permanent link">&para;</a></h3>
<p>The core of the agent's logic, processing, and validation takes place within a single main loop.
Every iteration of the loop is considered a turn.
The agent may perform an action in a turn, or set up an action to be performed on the next turn, and <code>continue</code> the loop to end its turn.
This loop will run indefinitely until the agent determines it achieved its goal and returns the final result.</p>
<h4 id="handling-the-await-conditions-and-exit-condition">Handling the await conditions and exit condition<a class="headerlink" href="#handling-the-await-conditions-and-exit-condition" title="Permanent link">&para;</a></h4>
<p>The first step is to create the loop and handle the await and exit conditions.
Add the following lines of code within the run method directly following the <code>await self.lookup_wf_env_settings()</code> line:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-135-1"><a id="__codelineno-135-1" name="__codelineno-135-1" href="#__codelineno-135-1"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="__span-135-2"><a id="__codelineno-135-2" name="__codelineno-135-2" href="#__codelineno-135-2"></a>            <span class="c1"># wait indefinitely for input from signals - user_prompt, end_chat, or confirm as defined below</span>
</span><span id="__span-135-3"><a id="__codelineno-135-3" name="__codelineno-135-3" href="#__codelineno-135-3"></a>            <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">wait_condition</span><span class="p">(</span>
</span><span id="__span-135-4"><a id="__codelineno-135-4" name="__codelineno-135-4" href="#__codelineno-135-4"></a>                <span class="k">lambda</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span>
</span><span id="__span-135-5"><a id="__codelineno-135-5" name="__codelineno-135-5" href="#__codelineno-135-5"></a>            <span class="p">)</span>
</span><span id="__span-135-6"><a id="__codelineno-135-6" name="__codelineno-135-6" href="#__codelineno-135-6"></a>
</span><span id="__span-135-7"><a id="__codelineno-135-7" name="__codelineno-135-7" href="#__codelineno-135-7"></a>            <span class="c1"># handle chat should end. When chat ends, push conversation history to workflow results.</span>
</span><span id="__span-135-8"><a id="__codelineno-135-8" name="__codelineno-135-8" href="#__codelineno-135-8"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span><span class="p">:</span>
</span><span id="__span-135-9"><a id="__codelineno-135-9" name="__codelineno-135-9" href="#__codelineno-135-9"></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></div>
<p>This section creates the loop, and then immediately awaits for a condition to become true so it can proceed.
The conditions it's waiting on is for either something to be added to the <code>prompt_queue</code> so the agent has something to process,
the chat end either later in the loop or via Signal, or for the user to confirm execution.
Once any of these three conditions is met, it continues execution. 
The agent then checks to see if the <code>self.chat_ended</code> instance variable is <code>True</code>, indicating that the agent can halt execution.
If so, the agent will return the conversation history stored in the <code>self.conversation</code> instance variable, and the Workflow Execution will close.</p>
<h4 id="executing-the-tool">Executing the tool<a class="headerlink" href="#executing-the-tool" title="Permanent link">&para;</a></h4>
<p>Next, your agent will determine if it is appropriate to execute a the tool, and if it is, invoke an Activity to do so.</p>
<p>Continue by adding the following code to execute the tool:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-136-1"><a id="__codelineno-136-1" name="__codelineno-136-1" href="#__codelineno-136-1"></a>            <span class="c1"># Execute the tool</span>
</span><span id="__span-136-2"><a id="__codelineno-136-2" name="__codelineno-136-2" href="#__codelineno-136-2"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ready_for_tool_execution</span><span class="p">()</span> <span class="ow">and</span> <span class="n">current_tool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-136-3"><a id="__codelineno-136-3" name="__codelineno-136-3" href="#__codelineno-136-3"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_tool</span><span class="p">(</span><span class="n">current_tool</span><span class="p">)</span>
</span><span id="__span-136-4"><a id="__codelineno-136-4" name="__codelineno-136-4" href="#__codelineno-136-4"></a>                <span class="k">continue</span>
</span></code></pre></div>
<p>Before the agent executes a tool, the agent confirms that the tool meets the requirements for execution and that the current tool is not <code>None</code>.
If both of these checks evaluate to <code>True</code>, the agent executes the tool.
Once the tool has completed execution, it <code>continue</code>s the loop, meaning it skips all further execution and returns to the top of the loop, ready to begin another iteration.</p>
<h4 id="adding-in-a-few-more-helper-methods">Adding in a few more helper methods<a class="headerlink" href="#adding-in-a-few-more-helper-methods" title="Permanent link">&para;</a></h4>
<p>Next, implement three helper method that the tool execution code block called, but had not yet implemented.</p>
<p>The first checks if the tool is ready for execution.
Leave the <code>run</code> and append this new method to your class:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-137-1"><a id="__codelineno-137-1" name="__codelineno-137-1" href="#__codelineno-137-1"></a>    <span class="c1"># define if we&#39;re ready for tool execution</span>
</span><span id="__span-137-2"><a id="__codelineno-137-2" name="__codelineno-137-2" href="#__codelineno-137-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ready_for_tool_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-137-3"><a id="__codelineno-137-3" name="__codelineno-137-3" href="#__codelineno-137-3"></a>
</span><span id="__span-137-4"><a id="__codelineno-137-4" name="__codelineno-137-4" href="#__codelineno-137-4"></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="__span-137-5"><a id="__codelineno-137-5" name="__codelineno-137-5" href="#__codelineno-137-5"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_confirm</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="__span-137-6"><a id="__codelineno-137-6" name="__codelineno-137-6" href="#__codelineno-137-6"></a>        <span class="p">)</span>
</span></code></pre></div>
<p>This method checks if the user confirmed execution via <code>self.confirmed</code>, if the agent has confirmed it has the data it needs to execute via <code>self.waiting_for_confirm</code>, and if <code>self.tool_data</code> is set.
If this evaluates to <code>True</code>, the tool is ready for execution and the method returns <code>True</code>.</p>
<p>The second method executes the tool.
Leave the <code>run</code> and append this new method to your class:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-138-1"><a id="__codelineno-138-1" name="__codelineno-138-1" href="#__codelineno-138-1"></a>    <span class="c1"># execute the tool - set self.waiting_for_confirm to False if we&#39;re not waiting for confirm anymore</span>
</span><span id="__span-138-2"><a id="__codelineno-138-2" name="__codelineno-138-2" href="#__codelineno-138-2"></a>    <span class="c1"># (always the case if it works successfully)</span>
</span><span id="__span-138-3"><a id="__codelineno-138-3" name="__codelineno-138-3" href="#__codelineno-138-3"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_tool</span><span class="p">:</span> <span class="n">CurrentTool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-138-4"><a id="__codelineno-138-4" name="__codelineno-138-4" href="#__codelineno-138-4"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-138-5"><a id="__codelineno-138-5" name="__codelineno-138-5" href="#__codelineno-138-5"></a>            <span class="sa">f</span><span class="s2">&quot;workflow step: user has confirmed, executing the tool </span><span class="si">{</span><span class="n">current_tool</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-138-6"><a id="__codelineno-138-6" name="__codelineno-138-6" href="#__codelineno-138-6"></a>        <span class="p">)</span>
</span><span id="__span-138-7"><a id="__codelineno-138-7" name="__codelineno-138-7" href="#__codelineno-138-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-138-8"><a id="__codelineno-138-8" name="__codelineno-138-8" href="#__codelineno-138-8"></a>        <span class="n">confirmed_tool_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-138-9"><a id="__codelineno-138-9" name="__codelineno-138-9" href="#__codelineno-138-9"></a>        <span class="n">confirmed_tool_data</span><span class="p">[</span><span class="s2">&quot;next&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;confirm&quot;</span>
</span><span id="__span-138-10"><a id="__codelineno-138-10" name="__codelineno-138-10" href="#__codelineno-138-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s2">&quot;user_confirmed_tool_run&quot;</span><span class="p">,</span> <span class="n">confirmed_tool_data</span><span class="p">)</span>
</span><span id="__span-138-11"><a id="__codelineno-138-11" name="__codelineno-138-11" href="#__codelineno-138-11"></a>
</span><span id="__span-138-12"><a id="__codelineno-138-12" name="__codelineno-138-12" href="#__codelineno-138-12"></a>        <span class="c1"># execute the tool by key as defined in tools/__init__.py</span>
</span><span id="__span-138-13"><a id="__codelineno-138-13" name="__codelineno-138-13" href="#__codelineno-138-13"></a>        <span class="k">await</span> <span class="n">helpers</span><span class="o">.</span><span class="n">handle_tool_execution</span><span class="p">(</span>
</span><span id="__span-138-14"><a id="__codelineno-138-14" name="__codelineno-138-14" href="#__codelineno-138-14"></a>            <span class="n">current_tool</span><span class="p">,</span>
</span><span id="__span-138-15"><a id="__codelineno-138-15" name="__codelineno-138-15" href="#__codelineno-138-15"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="p">,</span>
</span><span id="__span-138-16"><a id="__codelineno-138-16" name="__codelineno-138-16" href="#__codelineno-138-16"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">,</span>
</span><span id="__span-138-17"><a id="__codelineno-138-17" name="__codelineno-138-17" href="#__codelineno-138-17"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">,</span>
</span><span id="__span-138-18"><a id="__codelineno-138-18" name="__codelineno-138-18" href="#__codelineno-138-18"></a>        <span class="p">)</span>
</span><span id="__span-138-19"><a id="__codelineno-138-19" name="__codelineno-138-19" href="#__codelineno-138-19"></a>
</span><span id="__span-138-20"><a id="__codelineno-138-20" name="__codelineno-138-20" href="#__codelineno-138-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_confirm</span> <span class="o">=</span> <span class="kc">False</span>
</span></code></pre></div>
<p>This method resets the <code>self.confirmed</code> variable, makes a copy of the tool data to then modify, and adds a message to the conversation history with this modified tool data.
It then uses the <code>handle_tool_execution</code> function to invoke the tool as an Activity.
Once the Activity has completed, it returns the <code>waiting_for_confirm</code> variable.
On a successful execution, the <code>self.waiting_for_confirm</code> instance variable is set to <code>False</code>, resetting it and preparing the agent for its next turn in the conversation.</p>
<p>And finally, the <code>execute_tool</code> helper method called yet another helper method, the <code>add_message</code> method.
This method adds messages to the conversation history.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-139-1"><a id="__codelineno-139-1" name="__codelineno-139-1" href="#__codelineno-139-1"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-139-2"><a id="__codelineno-139-2" name="__codelineno-139-2" href="#__codelineno-139-2"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a message to the conversation history.</span>
</span><span id="__span-139-3"><a id="__codelineno-139-3" name="__codelineno-139-3" href="#__codelineno-139-3"></a>
</span><span id="__span-139-4"><a id="__codelineno-139-4" name="__codelineno-139-4" href="#__codelineno-139-4"></a><span class="sd">        Args:</span>
</span><span id="__span-139-5"><a id="__codelineno-139-5" name="__codelineno-139-5" href="#__codelineno-139-5"></a><span class="sd">            actor: The entity that generated the message (e.g., &quot;user&quot;, &quot;agent&quot;)</span>
</span><span id="__span-139-6"><a id="__codelineno-139-6" name="__codelineno-139-6" href="#__codelineno-139-6"></a><span class="sd">            response: The message content, either as a string or structured data</span>
</span><span id="__span-139-7"><a id="__codelineno-139-7" name="__codelineno-139-7" href="#__codelineno-139-7"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-139-8"><a id="__codelineno-139-8" name="__codelineno-139-8" href="#__codelineno-139-8"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-139-9"><a id="__codelineno-139-9" name="__codelineno-139-9" href="#__codelineno-139-9"></a>            <span class="n">response_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="__span-139-10"><a id="__codelineno-139-10" name="__codelineno-139-10" href="#__codelineno-139-10"></a>            <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">actor</span><span class="si">}</span><span class="s2"> message: </span><span class="si">{</span><span class="n">response_str</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-139-11"><a id="__codelineno-139-11" name="__codelineno-139-11" href="#__codelineno-139-11"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-139-12"><a id="__codelineno-139-12" name="__codelineno-139-12" href="#__codelineno-139-12"></a>            <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">actor</span><span class="si">}</span><span class="s2"> message: </span><span class="si">{</span><span class="n">response</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-139-13"><a id="__codelineno-139-13" name="__codelineno-139-13" href="#__codelineno-139-13"></a>
</span><span id="__span-139-14"><a id="__codelineno-139-14" name="__codelineno-139-14" href="#__codelineno-139-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-139-15"><a id="__codelineno-139-15" name="__codelineno-139-15" href="#__codelineno-139-15"></a>            <span class="p">{</span><span class="s2">&quot;actor&quot;</span><span class="p">:</span> <span class="n">actor</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">}</span>
</span><span id="__span-139-16"><a id="__codelineno-139-16" name="__codelineno-139-16" href="#__codelineno-139-16"></a>        <span class="p">)</span>
</span></code></pre></div>
<p>The method checks to see if the <code>response</code> parameter passed in is a <code>dict</code> or <code>str</code>.
It then removes the first 100 characters, which contain boilerplate LLM response, and adds the message to the <code>self.conversation_history</code> instance variable.</p>
<details>

<summary>
Checkpoint: Your file should currently look like this:
</summary>
Hover your cursor over the code block to reveal the copy-code option.
<br />

<div class="language-python highlight"><pre><span></span><code><span id="__span-140-1"><a id="__codelineno-140-1" name="__codelineno-140-1" href="#__codelineno-140-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
</span><span id="__span-140-2"><a id="__codelineno-140-2" name="__codelineno-140-2" href="#__codelineno-140-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
</span><span id="__span-140-3"><a id="__codelineno-140-3" name="__codelineno-140-3" href="#__codelineno-140-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Deque</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="__span-140-4"><a id="__codelineno-140-4" name="__codelineno-140-4" href="#__codelineno-140-4"></a>
</span><span id="__span-140-5"><a id="__codelineno-140-5" name="__codelineno-140-5" href="#__codelineno-140-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio</span><span class="w"> </span><span class="kn">import</span> <span class="n">workflow</span>
</span><span id="__span-140-6"><a id="__codelineno-140-6" name="__codelineno-140-6" href="#__codelineno-140-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">RetryPolicy</span>
</span><span id="__span-140-7"><a id="__codelineno-140-7" name="__codelineno-140-7" href="#__codelineno-140-7"></a>
</span><span id="__span-140-8"><a id="__codelineno-140-8" name="__codelineno-140-8" href="#__codelineno-140-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentGoal</span><span class="p">,</span> <span class="n">ConversationHistory</span><span class="p">,</span> <span class="n">CurrentTool</span>
</span><span id="__span-140-9"><a id="__codelineno-140-9" name="__codelineno-140-9" href="#__codelineno-140-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">EnvLookupInput</span><span class="p">,</span> <span class="n">EnvLookupOutput</span><span class="p">,</span> <span class="n">ToolData</span><span class="p">,</span> <span class="n">ValidationInput</span>
</span><span id="__span-140-10"><a id="__codelineno-140-10" name="__codelineno-140-10" href="#__codelineno-140-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">workflows</span><span class="w"> </span><span class="kn">import</span> <span class="n">workflow_helpers</span> <span class="k">as</span> <span class="n">helpers</span>
</span><span id="__span-140-11"><a id="__codelineno-140-11" name="__codelineno-140-11" href="#__codelineno-140-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">workflows.workflow_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-140-12"><a id="__codelineno-140-12" name="__codelineno-140-12" href="#__codelineno-140-12"></a>    <span class="n">LLM_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-140-13"><a id="__codelineno-140-13" name="__codelineno-140-13" href="#__codelineno-140-13"></a>    <span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-140-14"><a id="__codelineno-140-14" name="__codelineno-140-14" href="#__codelineno-140-14"></a><span class="p">)</span>
</span><span id="__span-140-15"><a id="__codelineno-140-15" name="__codelineno-140-15" href="#__codelineno-140-15"></a>
</span><span id="__span-140-16"><a id="__codelineno-140-16" name="__codelineno-140-16" href="#__codelineno-140-16"></a><span class="k">with</span> <span class="n">workflow</span><span class="o">.</span><span class="n">unsafe</span><span class="o">.</span><span class="n">imports_passed_through</span><span class="p">():</span>
</span><span id="__span-140-17"><a id="__codelineno-140-17" name="__codelineno-140-17" href="#__codelineno-140-17"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">activities.activities</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentActivities</span>
</span><span id="__span-140-18"><a id="__codelineno-140-18" name="__codelineno-140-18" href="#__codelineno-140-18"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">CombinedInput</span><span class="p">,</span> <span class="n">ToolPromptInput</span>
</span><span id="__span-140-19"><a id="__codelineno-140-19" name="__codelineno-140-19" href="#__codelineno-140-19"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">prompts.agent_prompt_generators</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_genai_prompt</span>
</span><span id="__span-140-20"><a id="__codelineno-140-20" name="__codelineno-140-20" href="#__codelineno-140-20"></a>
</span><span id="__span-140-21"><a id="__codelineno-140-21" name="__codelineno-140-21" href="#__codelineno-140-21"></a><span class="c1"># Constants</span>
</span><span id="__span-140-22"><a id="__codelineno-140-22" name="__codelineno-140-22" href="#__codelineno-140-22"></a><span class="n">MAX_TURNS_BEFORE_CONTINUE</span> <span class="o">=</span> <span class="mi">250</span>
</span><span id="__span-140-23"><a id="__codelineno-140-23" name="__codelineno-140-23" href="#__codelineno-140-23"></a>
</span><span id="__span-140-24"><a id="__codelineno-140-24" name="__codelineno-140-24" href="#__codelineno-140-24"></a><span class="nd">@workflow</span><span class="o">.</span><span class="n">defn</span>
</span><span id="__span-140-25"><a id="__codelineno-140-25" name="__codelineno-140-25" href="#__codelineno-140-25"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentGoalWorkflow</span><span class="p">:</span>
</span><span id="__span-140-26"><a id="__codelineno-140-26" name="__codelineno-140-26" href="#__codelineno-140-26"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Workflow that manages tool execution with user confirmation and conversation history.&quot;&quot;&quot;</span>
</span><span id="__span-140-27"><a id="__codelineno-140-27" name="__codelineno-140-27" href="#__codelineno-140-27"></a>
</span><span id="__span-140-28"><a id="__codelineno-140-28" name="__codelineno-140-28" href="#__codelineno-140-28"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-140-29"><a id="__codelineno-140-29" name="__codelineno-140-29" href="#__codelineno-140-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">:</span> <span class="n">ConversationHistory</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="__span-140-30"><a id="__codelineno-140-30" name="__codelineno-140-30" href="#__codelineno-140-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">:</span> <span class="n">Deque</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
</span><span id="__span-140-31"><a id="__codelineno-140-31" name="__codelineno-140-31" href="#__codelineno-140-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-140-32"><a id="__codelineno-140-32" name="__codelineno-140-32" href="#__codelineno-140-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ToolData</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-140-33"><a id="__codelineno-140-33" name="__codelineno-140-33" href="#__codelineno-140-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AgentGoal</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-140-34"><a id="__codelineno-140-34" name="__codelineno-140-34" href="#__codelineno-140-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_confirm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-140-35"><a id="__codelineno-140-35" name="__codelineno-140-35" href="#__codelineno-140-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">show_tool_args_confirmation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-140-36"><a id="__codelineno-140-36" name="__codelineno-140-36" href="#__codelineno-140-36"></a>            <span class="kc">True</span>  <span class="c1"># set from env file in activity lookup_wf_env_settings</span>
</span><span id="__span-140-37"><a id="__codelineno-140-37" name="__codelineno-140-37" href="#__codelineno-140-37"></a>        <span class="p">)</span>
</span><span id="__span-140-38"><a id="__codelineno-140-38" name="__codelineno-140-38" href="#__codelineno-140-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-140-39"><a id="__codelineno-140-39" name="__codelineno-140-39" href="#__codelineno-140-39"></a>            <span class="kc">False</span>  <span class="c1"># indicates that we have confirmation to proceed to run tool</span>
</span><span id="__span-140-40"><a id="__codelineno-140-40" name="__codelineno-140-40" href="#__codelineno-140-40"></a>        <span class="p">)</span>
</span><span id="__span-140-41"><a id="__codelineno-140-41" name="__codelineno-140-41" href="#__codelineno-140-41"></a>
</span><span id="__span-140-42"><a id="__codelineno-140-42" name="__codelineno-140-42" href="#__codelineno-140-42"></a>    <span class="nd">@workflow</span><span class="o">.</span><span class="n">run</span>
</span><span id="__span-140-43"><a id="__codelineno-140-43" name="__codelineno-140-43" href="#__codelineno-140-43"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combined_input</span><span class="p">:</span> <span class="n">CombinedInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-140-44"><a id="__codelineno-140-44" name="__codelineno-140-44" href="#__codelineno-140-44"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Main workflow execution method.&quot;&quot;&quot;</span>
</span><span id="__span-140-45"><a id="__codelineno-140-45" name="__codelineno-140-45" href="#__codelineno-140-45"></a>        <span class="c1"># setup phase, starts with blank tool_params and agent_goal prompt as defined in tools/goal_registry.py</span>
</span><span id="__span-140-46"><a id="__codelineno-140-46" name="__codelineno-140-46" href="#__codelineno-140-46"></a>        <span class="n">params</span> <span class="o">=</span> <span class="n">combined_input</span><span class="o">.</span><span class="n">tool_params</span>
</span><span id="__span-140-47"><a id="__codelineno-140-47" name="__codelineno-140-47" href="#__codelineno-140-47"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">goal</span> <span class="o">=</span> <span class="n">combined_input</span><span class="o">.</span><span class="n">agent_goal</span>
</span><span id="__span-140-48"><a id="__codelineno-140-48" name="__codelineno-140-48" href="#__codelineno-140-48"></a>
</span><span id="__span-140-49"><a id="__codelineno-140-49" name="__codelineno-140-49" href="#__codelineno-140-49"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_wf_env_settings</span><span class="p">()</span> 
</span><span id="__span-140-50"><a id="__codelineno-140-50" name="__codelineno-140-50" href="#__codelineno-140-50"></a>
</span><span id="__span-140-51"><a id="__codelineno-140-51" name="__codelineno-140-51" href="#__codelineno-140-51"></a>        <span class="k">if</span> <span class="n">params</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">:</span>
</span><span id="__span-140-52"><a id="__codelineno-140-52" name="__codelineno-140-52" href="#__codelineno-140-52"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">)</span>
</span><span id="__span-140-53"><a id="__codelineno-140-53" name="__codelineno-140-53" href="#__codelineno-140-53"></a>
</span><span id="__span-140-54"><a id="__codelineno-140-54" name="__codelineno-140-54" href="#__codelineno-140-54"></a>        <span class="n">current_tool</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CurrentTool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-140-55"><a id="__codelineno-140-55" name="__codelineno-140-55" href="#__codelineno-140-55"></a>
</span><span id="__span-140-56"><a id="__codelineno-140-56" name="__codelineno-140-56" href="#__codelineno-140-56"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="__span-140-57"><a id="__codelineno-140-57" name="__codelineno-140-57" href="#__codelineno-140-57"></a>            <span class="c1"># wait indefinitely for input from signals - user_prompt, end_chat, or confirm as defined below</span>
</span><span id="__span-140-58"><a id="__codelineno-140-58" name="__codelineno-140-58" href="#__codelineno-140-58"></a>            <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">wait_condition</span><span class="p">(</span>
</span><span id="__span-140-59"><a id="__codelineno-140-59" name="__codelineno-140-59" href="#__codelineno-140-59"></a>                <span class="k">lambda</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span>
</span><span id="__span-140-60"><a id="__codelineno-140-60" name="__codelineno-140-60" href="#__codelineno-140-60"></a>            <span class="p">)</span>
</span><span id="__span-140-61"><a id="__codelineno-140-61" name="__codelineno-140-61" href="#__codelineno-140-61"></a>
</span><span id="__span-140-62"><a id="__codelineno-140-62" name="__codelineno-140-62" href="#__codelineno-140-62"></a>            <span class="c1"># handle chat should end. When chat ends, push conversation history to workflow results.</span>
</span><span id="__span-140-63"><a id="__codelineno-140-63" name="__codelineno-140-63" href="#__codelineno-140-63"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span><span class="p">:</span>
</span><span id="__span-140-64"><a id="__codelineno-140-64" name="__codelineno-140-64" href="#__codelineno-140-64"></a>                <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Chat-end signal received. Chat ending.&quot;</span><span class="p">)</span>
</span><span id="__span-140-65"><a id="__codelineno-140-65" name="__codelineno-140-65" href="#__codelineno-140-65"></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-140-66"><a id="__codelineno-140-66" name="__codelineno-140-66" href="#__codelineno-140-66"></a>
</span><span id="__span-140-67"><a id="__codelineno-140-67" name="__codelineno-140-67" href="#__codelineno-140-67"></a>            <span class="c1"># Execute the tool</span>
</span><span id="__span-140-68"><a id="__codelineno-140-68" name="__codelineno-140-68" href="#__codelineno-140-68"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ready_for_tool_execution</span><span class="p">()</span> <span class="ow">and</span> <span class="n">current_tool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-140-69"><a id="__codelineno-140-69" name="__codelineno-140-69" href="#__codelineno-140-69"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_tool</span><span class="p">(</span><span class="n">current_tool</span><span class="p">)</span>
</span><span id="__span-140-70"><a id="__codelineno-140-70" name="__codelineno-140-70" href="#__codelineno-140-70"></a>                <span class="k">continue</span>
</span><span id="__span-140-71"><a id="__codelineno-140-71" name="__codelineno-140-71" href="#__codelineno-140-71"></a>
</span><span id="__span-140-72"><a id="__codelineno-140-72" name="__codelineno-140-72" href="#__codelineno-140-72"></a>    <span class="c1"># look up env settings in an activity so they&#39;re part of history</span>
</span><span id="__span-140-73"><a id="__codelineno-140-73" name="__codelineno-140-73" href="#__codelineno-140-73"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lookup_wf_env_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-140-74"><a id="__codelineno-140-74" name="__codelineno-140-74" href="#__codelineno-140-74"></a>        <span class="n">env_lookup_input</span> <span class="o">=</span> <span class="n">EnvLookupInput</span><span class="p">(</span>
</span><span id="__span-140-75"><a id="__codelineno-140-75" name="__codelineno-140-75" href="#__codelineno-140-75"></a>            <span class="n">show_confirm_env_var_name</span><span class="o">=</span><span class="s2">&quot;SHOW_CONFIRM&quot;</span><span class="p">,</span>
</span><span id="__span-140-76"><a id="__codelineno-140-76" name="__codelineno-140-76" href="#__codelineno-140-76"></a>            <span class="n">show_confirm_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-140-77"><a id="__codelineno-140-77" name="__codelineno-140-77" href="#__codelineno-140-77"></a>        <span class="p">)</span>
</span><span id="__span-140-78"><a id="__codelineno-140-78" name="__codelineno-140-78" href="#__codelineno-140-78"></a>        <span class="n">env_output</span><span class="p">:</span> <span class="n">EnvLookupOutput</span> <span class="o">=</span> <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">execute_activity_method</span><span class="p">(</span>
</span><span id="__span-140-79"><a id="__codelineno-140-79" name="__codelineno-140-79" href="#__codelineno-140-79"></a>            <span class="n">AgentActivities</span><span class="o">.</span><span class="n">get_wf_env_vars</span><span class="p">,</span>
</span><span id="__span-140-80"><a id="__codelineno-140-80" name="__codelineno-140-80" href="#__codelineno-140-80"></a>            <span class="n">env_lookup_input</span><span class="p">,</span>
</span><span id="__span-140-81"><a id="__codelineno-140-81" name="__codelineno-140-81" href="#__codelineno-140-81"></a>            <span class="n">start_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-140-82"><a id="__codelineno-140-82" name="__codelineno-140-82" href="#__codelineno-140-82"></a>            <span class="n">retry_policy</span><span class="o">=</span><span class="n">RetryPolicy</span><span class="p">(</span>
</span><span id="__span-140-83"><a id="__codelineno-140-83" name="__codelineno-140-83" href="#__codelineno-140-83"></a>                <span class="n">initial_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">backoff_coefficient</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-140-84"><a id="__codelineno-140-84" name="__codelineno-140-84" href="#__codelineno-140-84"></a>            <span class="p">),</span>
</span><span id="__span-140-85"><a id="__codelineno-140-85" name="__codelineno-140-85" href="#__codelineno-140-85"></a>        <span class="p">)</span>
</span><span id="__span-140-86"><a id="__codelineno-140-86" name="__codelineno-140-86" href="#__codelineno-140-86"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">show_tool_args_confirmation</span> <span class="o">=</span> <span class="n">env_output</span><span class="o">.</span><span class="n">show_confirm</span>
</span><span id="__span-140-87"><a id="__codelineno-140-87" name="__codelineno-140-87" href="#__codelineno-140-87"></a>
</span><span id="__span-140-88"><a id="__codelineno-140-88" name="__codelineno-140-88" href="#__codelineno-140-88"></a>    <span class="c1"># define if we&#39;re ready for tool execution</span>
</span><span id="__span-140-89"><a id="__codelineno-140-89" name="__codelineno-140-89" href="#__codelineno-140-89"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ready_for_tool_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-140-90"><a id="__codelineno-140-90" name="__codelineno-140-90" href="#__codelineno-140-90"></a>
</span><span id="__span-140-91"><a id="__codelineno-140-91" name="__codelineno-140-91" href="#__codelineno-140-91"></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="__span-140-92"><a id="__codelineno-140-92" name="__codelineno-140-92" href="#__codelineno-140-92"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_confirm</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="__span-140-93"><a id="__codelineno-140-93" name="__codelineno-140-93" href="#__codelineno-140-93"></a>        <span class="p">)</span>
</span><span id="__span-140-94"><a id="__codelineno-140-94" name="__codelineno-140-94" href="#__codelineno-140-94"></a>
</span><span id="__span-140-95"><a id="__codelineno-140-95" name="__codelineno-140-95" href="#__codelineno-140-95"></a>    <span class="c1"># execute the tool - set self.waiting_for_confirm to False if we&#39;re not waiting for confirm anymore</span>
</span><span id="__span-140-96"><a id="__codelineno-140-96" name="__codelineno-140-96" href="#__codelineno-140-96"></a>    <span class="c1"># (always the case if it works successfully)</span>
</span><span id="__span-140-97"><a id="__codelineno-140-97" name="__codelineno-140-97" href="#__codelineno-140-97"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_tool</span><span class="p">:</span> <span class="n">CurrentTool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-140-98"><a id="__codelineno-140-98" name="__codelineno-140-98" href="#__codelineno-140-98"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-140-99"><a id="__codelineno-140-99" name="__codelineno-140-99" href="#__codelineno-140-99"></a>            <span class="sa">f</span><span class="s2">&quot;workflow step: user has confirmed, executing the tool </span><span class="si">{</span><span class="n">current_tool</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-140-100"><a id="__codelineno-140-100" name="__codelineno-140-100" href="#__codelineno-140-100"></a>        <span class="p">)</span>
</span><span id="__span-140-101"><a id="__codelineno-140-101" name="__codelineno-140-101" href="#__codelineno-140-101"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-140-102"><a id="__codelineno-140-102" name="__codelineno-140-102" href="#__codelineno-140-102"></a>        <span class="n">confirmed_tool_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-140-103"><a id="__codelineno-140-103" name="__codelineno-140-103" href="#__codelineno-140-103"></a>        <span class="n">confirmed_tool_data</span><span class="p">[</span><span class="s2">&quot;next&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;confirm&quot;</span>
</span><span id="__span-140-104"><a id="__codelineno-140-104" name="__codelineno-140-104" href="#__codelineno-140-104"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s2">&quot;user_confirmed_tool_run&quot;</span><span class="p">,</span> <span class="n">confirmed_tool_data</span><span class="p">)</span>
</span><span id="__span-140-105"><a id="__codelineno-140-105" name="__codelineno-140-105" href="#__codelineno-140-105"></a>
</span><span id="__span-140-106"><a id="__codelineno-140-106" name="__codelineno-140-106" href="#__codelineno-140-106"></a>        <span class="c1"># execute the tool by key as defined in tools/__init__.py</span>
</span><span id="__span-140-107"><a id="__codelineno-140-107" name="__codelineno-140-107" href="#__codelineno-140-107"></a>        <span class="k">await</span> <span class="n">helpers</span><span class="o">.</span><span class="n">handle_tool_execution</span><span class="p">(</span>
</span><span id="__span-140-108"><a id="__codelineno-140-108" name="__codelineno-140-108" href="#__codelineno-140-108"></a>            <span class="n">current_tool</span><span class="p">,</span>
</span><span id="__span-140-109"><a id="__codelineno-140-109" name="__codelineno-140-109" href="#__codelineno-140-109"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="p">,</span>
</span><span id="__span-140-110"><a id="__codelineno-140-110" name="__codelineno-140-110" href="#__codelineno-140-110"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">,</span>
</span><span id="__span-140-111"><a id="__codelineno-140-111" name="__codelineno-140-111" href="#__codelineno-140-111"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">,</span>
</span><span id="__span-140-112"><a id="__codelineno-140-112" name="__codelineno-140-112" href="#__codelineno-140-112"></a>        <span class="p">)</span>
</span><span id="__span-140-113"><a id="__codelineno-140-113" name="__codelineno-140-113" href="#__codelineno-140-113"></a>
</span><span id="__span-140-114"><a id="__codelineno-140-114" name="__codelineno-140-114" href="#__codelineno-140-114"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_confirm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-140-115"><a id="__codelineno-140-115" name="__codelineno-140-115" href="#__codelineno-140-115"></a>
</span><span id="__span-140-116"><a id="__codelineno-140-116" name="__codelineno-140-116" href="#__codelineno-140-116"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-140-117"><a id="__codelineno-140-117" name="__codelineno-140-117" href="#__codelineno-140-117"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a message to the conversation history.</span>
</span><span id="__span-140-118"><a id="__codelineno-140-118" name="__codelineno-140-118" href="#__codelineno-140-118"></a>
</span><span id="__span-140-119"><a id="__codelineno-140-119" name="__codelineno-140-119" href="#__codelineno-140-119"></a><span class="sd">        Args:</span>
</span><span id="__span-140-120"><a id="__codelineno-140-120" name="__codelineno-140-120" href="#__codelineno-140-120"></a><span class="sd">            actor: The entity that generated the message (e.g., &quot;user&quot;, &quot;agent&quot;)</span>
</span><span id="__span-140-121"><a id="__codelineno-140-121" name="__codelineno-140-121" href="#__codelineno-140-121"></a><span class="sd">            response: The message content, either as a string or structured data</span>
</span><span id="__span-140-122"><a id="__codelineno-140-122" name="__codelineno-140-122" href="#__codelineno-140-122"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-140-123"><a id="__codelineno-140-123" name="__codelineno-140-123" href="#__codelineno-140-123"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-140-124"><a id="__codelineno-140-124" name="__codelineno-140-124" href="#__codelineno-140-124"></a>            <span class="n">response_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="__span-140-125"><a id="__codelineno-140-125" name="__codelineno-140-125" href="#__codelineno-140-125"></a>            <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">actor</span><span class="si">}</span><span class="s2"> message: </span><span class="si">{</span><span class="n">response_str</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-140-126"><a id="__codelineno-140-126" name="__codelineno-140-126" href="#__codelineno-140-126"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-140-127"><a id="__codelineno-140-127" name="__codelineno-140-127" href="#__codelineno-140-127"></a>            <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">actor</span><span class="si">}</span><span class="s2"> message: </span><span class="si">{</span><span class="n">response</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-140-128"><a id="__codelineno-140-128" name="__codelineno-140-128" href="#__codelineno-140-128"></a>
</span><span id="__span-140-129"><a id="__codelineno-140-129" name="__codelineno-140-129" href="#__codelineno-140-129"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-140-130"><a id="__codelineno-140-130" name="__codelineno-140-130" href="#__codelineno-140-130"></a>            <span class="p">{</span><span class="s2">&quot;actor&quot;</span><span class="p">:</span> <span class="n">actor</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">}</span>
</span><span id="__span-140-131"><a id="__codelineno-140-131" name="__codelineno-140-131" href="#__codelineno-140-131"></a>        <span class="p">)</span>
</span></code></pre></div>
</details>

<h4 id="validating-user-prompts">Validating user prompts<a class="headerlink" href="#validating-user-prompts" title="Permanent link">&para;</a></h4>
<p>Before processing any input from the user, the agent needs to validate it.
You defined Activities in a prior section to validate the data, and now your Workflow will invoke them.</p>
<p>Continue by adding the prompt processing logic within the core agent loop:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-141-1"><a id="__codelineno-141-1" name="__codelineno-141-1" href="#__codelineno-141-1"></a>            <span class="c1"># process forward on the prompt queue if any</span>
</span><span id="__span-141-2"><a id="__codelineno-141-2" name="__codelineno-141-2" href="#__codelineno-141-2"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">:</span>
</span><span id="__span-141-3"><a id="__codelineno-141-3" name="__codelineno-141-3" href="#__codelineno-141-3"></a>                <span class="c1"># get most recent prompt</span>
</span><span id="__span-141-4"><a id="__codelineno-141-4" name="__codelineno-141-4" href="#__codelineno-141-4"></a>                <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
</span><span id="__span-141-5"><a id="__codelineno-141-5" name="__codelineno-141-5" href="#__codelineno-141-5"></a>                <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-141-6"><a id="__codelineno-141-6" name="__codelineno-141-6" href="#__codelineno-141-6"></a>                    <span class="sa">f</span><span class="s2">&quot;workflow step: processing message on the prompt queue, message is </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-141-7"><a id="__codelineno-141-7" name="__codelineno-141-7" href="#__codelineno-141-7"></a>                <span class="p">)</span>
</span><span id="__span-141-8"><a id="__codelineno-141-8" name="__codelineno-141-8" href="#__codelineno-141-8"></a>
</span><span id="__span-141-9"><a id="__codelineno-141-9" name="__codelineno-141-9" href="#__codelineno-141-9"></a>                <span class="c1"># Validate user-provided prompts</span>
</span><span id="__span-141-10"><a id="__codelineno-141-10" name="__codelineno-141-10" href="#__codelineno-141-10"></a>                <span class="k">if</span> <span class="n">helpers</span><span class="o">.</span><span class="n">is_user_prompt</span><span class="p">(</span><span class="n">prompt</span><span class="p">):</span>
</span><span id="__span-141-11"><a id="__codelineno-141-11" name="__codelineno-141-11" href="#__codelineno-141-11"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
</span><span id="__span-141-12"><a id="__codelineno-141-12" name="__codelineno-141-12" href="#__codelineno-141-12"></a>
</span><span id="__span-141-13"><a id="__codelineno-141-13" name="__codelineno-141-13" href="#__codelineno-141-13"></a>                    <span class="c1"># Validate the prompt before proceeding</span>
</span><span id="__span-141-14"><a id="__codelineno-141-14" name="__codelineno-141-14" href="#__codelineno-141-14"></a>                    <span class="n">validation_input</span> <span class="o">=</span> <span class="n">ValidationInput</span><span class="p">(</span>
</span><span id="__span-141-15"><a id="__codelineno-141-15" name="__codelineno-141-15" href="#__codelineno-141-15"></a>                        <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
</span><span id="__span-141-16"><a id="__codelineno-141-16" name="__codelineno-141-16" href="#__codelineno-141-16"></a>                        <span class="n">conversation_history</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">,</span>
</span><span id="__span-141-17"><a id="__codelineno-141-17" name="__codelineno-141-17" href="#__codelineno-141-17"></a>                        <span class="n">agent_goal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span>
</span><span id="__span-141-18"><a id="__codelineno-141-18" name="__codelineno-141-18" href="#__codelineno-141-18"></a>                    <span class="p">)</span>
</span><span id="__span-141-19"><a id="__codelineno-141-19" name="__codelineno-141-19" href="#__codelineno-141-19"></a>                    <span class="n">validation_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">execute_activity_method</span><span class="p">(</span>
</span><span id="__span-141-20"><a id="__codelineno-141-20" name="__codelineno-141-20" href="#__codelineno-141-20"></a>                        <span class="n">AgentActivities</span><span class="o">.</span><span class="n">agent_validatePrompt</span><span class="p">,</span>
</span><span id="__span-141-21"><a id="__codelineno-141-21" name="__codelineno-141-21" href="#__codelineno-141-21"></a>                        <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">validation_input</span><span class="p">],</span>
</span><span id="__span-141-22"><a id="__codelineno-141-22" name="__codelineno-141-22" href="#__codelineno-141-22"></a>                        <span class="n">schedule_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-141-23"><a id="__codelineno-141-23" name="__codelineno-141-23" href="#__codelineno-141-23"></a>                        <span class="n">start_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-141-24"><a id="__codelineno-141-24" name="__codelineno-141-24" href="#__codelineno-141-24"></a>                        <span class="n">retry_policy</span><span class="o">=</span><span class="n">RetryPolicy</span><span class="p">(</span>
</span><span id="__span-141-25"><a id="__codelineno-141-25" name="__codelineno-141-25" href="#__codelineno-141-25"></a>                            <span class="n">initial_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">backoff_coefficient</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-141-26"><a id="__codelineno-141-26" name="__codelineno-141-26" href="#__codelineno-141-26"></a>                        <span class="p">),</span>
</span><span id="__span-141-27"><a id="__codelineno-141-27" name="__codelineno-141-27" href="#__codelineno-141-27"></a>                    <span class="p">)</span>
</span><span id="__span-141-28"><a id="__codelineno-141-28" name="__codelineno-141-28" href="#__codelineno-141-28"></a>
</span><span id="__span-141-29"><a id="__codelineno-141-29" name="__codelineno-141-29" href="#__codelineno-141-29"></a>                    <span class="c1"># If validation fails, provide that feedback to the user - i.e., &quot;your words make no sense, puny human&quot; end this iteration of processing</span>
</span><span id="__span-141-30"><a id="__codelineno-141-30" name="__codelineno-141-30" href="#__codelineno-141-30"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">validationResult</span><span class="p">:</span>
</span><span id="__span-141-31"><a id="__codelineno-141-31" name="__codelineno-141-31" href="#__codelineno-141-31"></a>                        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="__span-141-32"><a id="__codelineno-141-32" name="__codelineno-141-32" href="#__codelineno-141-32"></a>                            <span class="sa">f</span><span class="s2">&quot;Prompt validation failed: </span><span class="si">{</span><span class="n">validation_result</span><span class="o">.</span><span class="n">validationFailedReason</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-141-33"><a id="__codelineno-141-33" name="__codelineno-141-33" href="#__codelineno-141-33"></a>                        <span class="p">)</span>
</span><span id="__span-141-34"><a id="__codelineno-141-34" name="__codelineno-141-34" href="#__codelineno-141-34"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span>
</span><span id="__span-141-35"><a id="__codelineno-141-35" name="__codelineno-141-35" href="#__codelineno-141-35"></a>                            <span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">validationFailedReason</span>
</span><span id="__span-141-36"><a id="__codelineno-141-36" name="__codelineno-141-36" href="#__codelineno-141-36"></a>                        <span class="p">)</span>
</span><span id="__span-141-37"><a id="__codelineno-141-37" name="__codelineno-141-37" href="#__codelineno-141-37"></a>                        <span class="k">continue</span>
</span></code></pre></div>
<p>The validation code first checks to see if there are any prompts in the queue.
If so, it removes the most recent prompt for processing.
Next is calls the <code>is_user_prompt</code> helper function you defined earlier to determine who the author of the prompt is.
If the prompt is from the agent, the validation step is skipped.
However, if the prompt is from a user, it is validated.
The agent creates a <code>ValidationInput</code> variable containing the prompt, the conversation history, and the agent's goal.
The agent then executes the <code>agent_validatePrompt</code> Activity, passing the <code>ValidationInput</code> variable as input.
If the validation passes, the Workflow proceeds execution.
However, if the validation fails, the agent logs the error, adds it to conversation history and, resets to the beginning using <code>continue</code>, where it will inform the user of the error and await a response.</p>
<p>It's important to recall that within <code>agent_validatePrompt</code>, regardless of success the Activity calls the <code>agent_toolPlanner</code> method.
This provides a reason why the validation failed, if necessary.</p>
<h4 id="generating-a-context-aware-prompt">Generating a context-aware prompt<a class="headerlink" href="#generating-a-context-aware-prompt" title="Permanent link">&para;</a></h4>
<p>Upon successful validation, the Workflow invokes another Activity to generate a context-aware prompt for the LLM to use.</p>
<p>Continue by adding the call to the <code>generate_genai_prompt</code> function you implemented in the <code>prompts</code> submodule to your code:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-142-1"><a id="__codelineno-142-1" name="__codelineno-142-1" href="#__codelineno-142-1"></a>                <span class="c1"># If valid, proceed with generating the context and prompt</span>
</span><span id="__span-142-2"><a id="__codelineno-142-2" name="__codelineno-142-2" href="#__codelineno-142-2"></a>                <span class="n">context_instructions</span> <span class="o">=</span> <span class="n">generate_genai_prompt</span><span class="p">(</span>
</span><span id="__span-142-3"><a id="__codelineno-142-3" name="__codelineno-142-3" href="#__codelineno-142-3"></a>                    <span class="n">agent_goal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span>
</span><span id="__span-142-4"><a id="__codelineno-142-4" name="__codelineno-142-4" href="#__codelineno-142-4"></a>                    <span class="n">conversation_history</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">,</span>
</span><span id="__span-142-5"><a id="__codelineno-142-5" name="__codelineno-142-5" href="#__codelineno-142-5"></a>                    <span class="n">raw_json</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="p">,</span>
</span><span id="__span-142-6"><a id="__codelineno-142-6" name="__codelineno-142-6" href="#__codelineno-142-6"></a>                <span class="p">)</span>
</span></code></pre></div>
<p>This function call takes the agent's goal, the current conversation history, and the tool's data as input to generate the prompt.
Recall that the tool data may be blank, for example, on the first iteration as a tool hasn't been selected.
The prompt template handles this and only renders the data if it exists.</p>
<h4 id="executing-the-tool-planner">Executing the tool planner<a class="headerlink" href="#executing-the-tool-planner" title="Permanent link">&para;</a></h4>
<p>Now that the prompt is constructed, you can use the LLM to plan which tool to use.</p>
<p>Add the following code call the <code>agent_toolPlanner</code> Activity and process the results:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-143-1"><a id="__codelineno-143-1" name="__codelineno-143-1" href="#__codelineno-143-1"></a>                <span class="n">prompt_input</span> <span class="o">=</span> <span class="n">ToolPromptInput</span><span class="p">(</span>
</span><span id="__span-143-2"><a id="__codelineno-143-2" name="__codelineno-143-2" href="#__codelineno-143-2"></a>                    <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span> <span class="n">context_instructions</span><span class="o">=</span><span class="n">context_instructions</span>
</span><span id="__span-143-3"><a id="__codelineno-143-3" name="__codelineno-143-3" href="#__codelineno-143-3"></a>                <span class="p">)</span>
</span><span id="__span-143-4"><a id="__codelineno-143-4" name="__codelineno-143-4" href="#__codelineno-143-4"></a>
</span><span id="__span-143-5"><a id="__codelineno-143-5" name="__codelineno-143-5" href="#__codelineno-143-5"></a>                <span class="c1"># connect to LLM and execute to get next steps</span>
</span><span id="__span-143-6"><a id="__codelineno-143-6" name="__codelineno-143-6" href="#__codelineno-143-6"></a>                <span class="n">tool_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">execute_activity_method</span><span class="p">(</span>
</span><span id="__span-143-7"><a id="__codelineno-143-7" name="__codelineno-143-7" href="#__codelineno-143-7"></a>                    <span class="n">AgentActivities</span><span class="o">.</span><span class="n">agent_toolPlanner</span><span class="p">,</span>
</span><span id="__span-143-8"><a id="__codelineno-143-8" name="__codelineno-143-8" href="#__codelineno-143-8"></a>                    <span class="n">prompt_input</span><span class="p">,</span>
</span><span id="__span-143-9"><a id="__codelineno-143-9" name="__codelineno-143-9" href="#__codelineno-143-9"></a>                    <span class="n">schedule_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-143-10"><a id="__codelineno-143-10" name="__codelineno-143-10" href="#__codelineno-143-10"></a>                    <span class="n">start_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-143-11"><a id="__codelineno-143-11" name="__codelineno-143-11" href="#__codelineno-143-11"></a>                    <span class="n">retry_policy</span><span class="o">=</span><span class="n">RetryPolicy</span><span class="p">(</span>
</span><span id="__span-143-12"><a id="__codelineno-143-12" name="__codelineno-143-12" href="#__codelineno-143-12"></a>                        <span class="n">initial_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">backoff_coefficient</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-143-13"><a id="__codelineno-143-13" name="__codelineno-143-13" href="#__codelineno-143-13"></a>                    <span class="p">),</span>
</span><span id="__span-143-14"><a id="__codelineno-143-14" name="__codelineno-143-14" href="#__codelineno-143-14"></a>                <span class="p">)</span>
</span><span id="__span-143-15"><a id="__codelineno-143-15" name="__codelineno-143-15" href="#__codelineno-143-15"></a>
</span><span id="__span-143-16"><a id="__codelineno-143-16" name="__codelineno-143-16" href="#__codelineno-143-16"></a>                <span class="n">tool_data</span><span class="p">[</span><span class="s2">&quot;force_confirm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_tool_args_confirmation</span>
</span><span id="__span-143-17"><a id="__codelineno-143-17" name="__codelineno-143-17" href="#__codelineno-143-17"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span> <span class="o">=</span> <span class="n">ToolData</span><span class="p">(</span><span class="o">**</span><span class="n">tool_data</span><span class="p">)</span>
</span><span id="__span-143-18"><a id="__codelineno-143-18" name="__codelineno-143-18" href="#__codelineno-143-18"></a>
</span><span id="__span-143-19"><a id="__codelineno-143-19" name="__codelineno-143-19" href="#__codelineno-143-19"></a>                <span class="c1"># process the tool as dictated by the prompt response - what to do next, and with which tool</span>
</span><span id="__span-143-20"><a id="__codelineno-143-20" name="__codelineno-143-20" href="#__codelineno-143-20"></a>                <span class="n">next_step</span> <span class="o">=</span> <span class="n">tool_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;next&quot;</span><span class="p">)</span>
</span><span id="__span-143-21"><a id="__codelineno-143-21" name="__codelineno-143-21" href="#__codelineno-143-21"></a>                <span class="n">current_tool</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CurrentTool</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool&quot;</span><span class="p">)</span>
</span><span id="__span-143-22"><a id="__codelineno-143-22" name="__codelineno-143-22" href="#__codelineno-143-22"></a>
</span><span id="__span-143-23"><a id="__codelineno-143-23" name="__codelineno-143-23" href="#__codelineno-143-23"></a>                <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-143-24"><a id="__codelineno-143-24" name="__codelineno-143-24" href="#__codelineno-143-24"></a>                    <span class="sa">f</span><span class="s2">&quot;next_step: </span><span class="si">{</span><span class="n">next_step</span><span class="si">}</span><span class="s2">, current tool is </span><span class="si">{</span><span class="n">current_tool</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-143-25"><a id="__codelineno-143-25" name="__codelineno-143-25" href="#__codelineno-143-25"></a>                <span class="p">)</span>
</span></code></pre></div>
<p>Before the agent executes the Activity, it creates a variable using your type <code>ToolPromptInput</code> that contains the prompt and context.
It then invokes the <code>agent_toolPlanner</code> Activity, passing in this variable.
The Activity makes a call to the LLM with the prompt to determine what tool the agent should use to proceed with the next step of its goal, and returns the response as a <code>dict</code>.
If the <code>SHOW_CONFIRM</code> environment variable was set to <code>True</code>, then the <code>force_confirm</code> key is also set to <code>True</code>.
Next, the <code>self.tool_data</code> instance variable is updated with the data returned from the Activity execution.
It then sets the <code>next_step</code> and <code>current_tool</code> variables to prepare for the next phase of execution.</p>
<h4 id="determining-the-next_step">Determining the <code>next_step</code><a class="headerlink" href="#determining-the-next_step" title="Permanent link">&para;</a></h4>
<p>The <code>next_step</code> variable contains the next action the LLM decided the agent should take to achieve its goal.
This variable can only contain the value <code>question</code>, <code>confirm</code>, and <code>done</code>, which the agent interprets and acts on.
When the value is <code>question</code>, the agent asks a clarifying question of the user, such as requesting a missing parameter.
This is handled automatically via the prompt.
However, <code>confirm</code> and <code>done</code> require custom logic.</p>
<p>Add the following code to implement the path for these options:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-144-1"><a id="__codelineno-144-1" name="__codelineno-144-1" href="#__codelineno-144-1"></a>                <span class="c1"># make sure we&#39;re ready to run the tool &amp; have everything we need</span>
</span><span id="__span-144-2"><a id="__codelineno-144-2" name="__codelineno-144-2" href="#__codelineno-144-2"></a>                <span class="k">if</span> <span class="n">next_step</span> <span class="o">==</span> <span class="s2">&quot;confirm&quot;</span> <span class="ow">and</span> <span class="n">current_tool</span><span class="p">:</span>
</span><span id="__span-144-3"><a id="__codelineno-144-3" name="__codelineno-144-3" href="#__codelineno-144-3"></a>                    <span class="n">args</span> <span class="o">=</span> <span class="n">tool_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-144-4"><a id="__codelineno-144-4" name="__codelineno-144-4" href="#__codelineno-144-4"></a>                    <span class="c1"># if we&#39;re missing arguments, ask for them</span>
</span><span id="__span-144-5"><a id="__codelineno-144-5" name="__codelineno-144-5" href="#__codelineno-144-5"></a>                    <span class="k">if</span> <span class="k">await</span> <span class="n">helpers</span><span class="o">.</span><span class="n">handle_missing_args</span><span class="p">(</span>
</span><span id="__span-144-6"><a id="__codelineno-144-6" name="__codelineno-144-6" href="#__codelineno-144-6"></a>                        <span class="n">current_tool</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">tool_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span>
</span><span id="__span-144-7"><a id="__codelineno-144-7" name="__codelineno-144-7" href="#__codelineno-144-7"></a>                    <span class="p">):</span>
</span><span id="__span-144-8"><a id="__codelineno-144-8" name="__codelineno-144-8" href="#__codelineno-144-8"></a>                        <span class="k">continue</span>
</span><span id="__span-144-9"><a id="__codelineno-144-9" name="__codelineno-144-9" href="#__codelineno-144-9"></a>
</span><span id="__span-144-10"><a id="__codelineno-144-10" name="__codelineno-144-10" href="#__codelineno-144-10"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_confirm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-144-11"><a id="__codelineno-144-11" name="__codelineno-144-11" href="#__codelineno-144-11"></a>
</span><span id="__span-144-12"><a id="__codelineno-144-12" name="__codelineno-144-12" href="#__codelineno-144-12"></a>                    <span class="c1"># We have needed arguments, if we want to force the user to confirm, set that up</span>
</span><span id="__span-144-13"><a id="__codelineno-144-13" name="__codelineno-144-13" href="#__codelineno-144-13"></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_tool_args_confirmation</span><span class="p">:</span>
</span><span id="__span-144-14"><a id="__codelineno-144-14" name="__codelineno-144-14" href="#__codelineno-144-14"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># set that we&#39;re not confirmed</span>
</span><span id="__span-144-15"><a id="__codelineno-144-15" name="__codelineno-144-15" href="#__codelineno-144-15"></a>                        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for user confirm signal...&quot;</span><span class="p">)</span>
</span><span id="__span-144-16"><a id="__codelineno-144-16" name="__codelineno-144-16" href="#__codelineno-144-16"></a>                    <span class="c1"># if we have all needed arguments (handled above) and not holding for a debugging confirm, proceed:</span>
</span><span id="__span-144-17"><a id="__codelineno-144-17" name="__codelineno-144-17" href="#__codelineno-144-17"></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-144-18"><a id="__codelineno-144-18" name="__codelineno-144-18" href="#__codelineno-144-18"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-144-19"><a id="__codelineno-144-19" name="__codelineno-144-19" href="#__codelineno-144-19"></a>
</span><span id="__span-144-20"><a id="__codelineno-144-20" name="__codelineno-144-20" href="#__codelineno-144-20"></a>                <span class="c1"># else if the next step is to be done with the conversation such as if the user requests it via asking to &quot;end conversation&quot;</span>
</span><span id="__span-144-21"><a id="__codelineno-144-21" name="__codelineno-144-21" href="#__codelineno-144-21"></a>                <span class="k">elif</span> <span class="n">next_step</span> <span class="o">==</span> <span class="s2">&quot;done&quot;</span><span class="p">:</span>
</span><span id="__span-144-22"><a id="__codelineno-144-22" name="__codelineno-144-22" href="#__codelineno-144-22"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">tool_data</span><span class="p">)</span>
</span><span id="__span-144-23"><a id="__codelineno-144-23" name="__codelineno-144-23" href="#__codelineno-144-23"></a>
</span><span id="__span-144-24"><a id="__codelineno-144-24" name="__codelineno-144-24" href="#__codelineno-144-24"></a>                    <span class="c1"># here we could send conversation to AI for analysis</span>
</span><span id="__span-144-25"><a id="__codelineno-144-25" name="__codelineno-144-25" href="#__codelineno-144-25"></a>
</span><span id="__span-144-26"><a id="__codelineno-144-26" name="__codelineno-144-26" href="#__codelineno-144-26"></a>                    <span class="c1"># end the workflow</span>
</span><span id="__span-144-27"><a id="__codelineno-144-27" name="__codelineno-144-27" href="#__codelineno-144-27"></a>                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">)</span>
</span></code></pre></div>
<p>If <code>next_step</code> is set to <code>confirm</code>, then the user confirmed their choice and the LLM has chosen to continue executing.
If both <code>confirm</code> and <code>current_tool</code> have something assigned to them, the agent checks for missing arguments using the <code>handle_missing_args</code> function.
Remember that if the <code>handle_missing_args</code> function determines an argument is missing, it adds a new prompt to the <code>prompt_queue</code> so the agent asks the user on the next turn.
If an argument is missing, the prompt is added and the agent <code>continue</code>s, leading to the user being asked for the missing argument.
If no argument is missing, then <code>self.waiting_for_confirm</code> is set to <code>True</code>, which indicates that the agent is ready to execute the tool.</p>
<p>It then checks if <code>self.show_tools_args_confirmation</code> was set.
If so, <code>self.confirmed</code> is set to <code>False</code>, forcing the user to confirm again on the next turn.
Otherwise, <code>self.confirmed</code> is set to <code>True</code>, and the user approved the tool execution on the next turn.</p>
<p>However, if <code>next_step</code> is set to <code>done</code>, the LLM determined that the goal is complete, and no more work is necessary.
The agent wraps up by adding a final message to the conversation history, and then returns the conversation history, closing the Workflow Execution.</p>
<h4 id="handling-a-long-running-execution">Handling a long running execution<a class="headerlink" href="#handling-a-long-running-execution" title="Permanent link">&para;</a></h4>
<p>The final segment of the agent loop handles long running execution.
Temporal Workflows have a limit on the size of a single Workflow Execution's Event History.
If the Event History is too long, then the agent should perform a <a href="https://docs.temporal.io/workflow-execution/continue-as-new"><code>Continue-As-New</code></a> operation to prevent a potential failure.</p>
<p>Add the following code to check and execute a <code>Continue-As-New</code> if necessary:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-145-1"><a id="__codelineno-145-1" name="__codelineno-145-1" href="#__codelineno-145-1"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">tool_data</span><span class="p">)</span>
</span><span id="__span-145-2"><a id="__codelineno-145-2" name="__codelineno-145-2" href="#__codelineno-145-2"></a>                <span class="k">await</span> <span class="n">helpers</span><span class="o">.</span><span class="n">continue_as_new_if_needed</span><span class="p">(</span>
</span><span id="__span-145-3"><a id="__codelineno-145-3" name="__codelineno-145-3" href="#__codelineno-145-3"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">,</span>
</span><span id="__span-145-4"><a id="__codelineno-145-4" name="__codelineno-145-4" href="#__codelineno-145-4"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">,</span>
</span><span id="__span-145-5"><a id="__codelineno-145-5" name="__codelineno-145-5" href="#__codelineno-145-5"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span>
</span><span id="__span-145-6"><a id="__codelineno-145-6" name="__codelineno-145-6" href="#__codelineno-145-6"></a>                    <span class="n">MAX_TURNS_BEFORE_CONTINUE</span><span class="p">,</span>
</span><span id="__span-145-7"><a id="__codelineno-145-7" name="__codelineno-145-7" href="#__codelineno-145-7"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">,</span>
</span><span id="__span-145-8"><a id="__codelineno-145-8" name="__codelineno-145-8" href="#__codelineno-145-8"></a>                <span class="p">)</span>
</span></code></pre></div>
<p>First, the current tool data is added to the conversation history.
Before, you defined a helper function <code>continue_as_new_if_needed</code> to determine if the Workflow should perform the <code>Continue-As-New</code> operation.
This function makes its decision based on the number of turns the agent completed prior to calling the function.
If it is greater, then the agent performs the <code>Continue-As-New</code> operation.</p>
<details>

<summary>
Checkpoint: Your file should currently look like this:
</summary>
Hover your cursor over the code block to reveal the copy-code option.
<br />

<div class="language-python highlight"><pre><span></span><code><span id="__span-146-1"><a id="__codelineno-146-1" name="__codelineno-146-1" href="#__codelineno-146-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
</span><span id="__span-146-2"><a id="__codelineno-146-2" name="__codelineno-146-2" href="#__codelineno-146-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
</span><span id="__span-146-3"><a id="__codelineno-146-3" name="__codelineno-146-3" href="#__codelineno-146-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Deque</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="__span-146-4"><a id="__codelineno-146-4" name="__codelineno-146-4" href="#__codelineno-146-4"></a>
</span><span id="__span-146-5"><a id="__codelineno-146-5" name="__codelineno-146-5" href="#__codelineno-146-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio</span><span class="w"> </span><span class="kn">import</span> <span class="n">workflow</span>
</span><span id="__span-146-6"><a id="__codelineno-146-6" name="__codelineno-146-6" href="#__codelineno-146-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">RetryPolicy</span>
</span><span id="__span-146-7"><a id="__codelineno-146-7" name="__codelineno-146-7" href="#__codelineno-146-7"></a>
</span><span id="__span-146-8"><a id="__codelineno-146-8" name="__codelineno-146-8" href="#__codelineno-146-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentGoal</span>
</span><span id="__span-146-9"><a id="__codelineno-146-9" name="__codelineno-146-9" href="#__codelineno-146-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-146-10"><a id="__codelineno-146-10" name="__codelineno-146-10" href="#__codelineno-146-10"></a>    <span class="n">ConversationHistory</span><span class="p">,</span>
</span><span id="__span-146-11"><a id="__codelineno-146-11" name="__codelineno-146-11" href="#__codelineno-146-11"></a>    <span class="n">CurrentTool</span><span class="p">,</span>
</span><span id="__span-146-12"><a id="__codelineno-146-12" name="__codelineno-146-12" href="#__codelineno-146-12"></a>    <span class="n">EnvLookupInput</span><span class="p">,</span>
</span><span id="__span-146-13"><a id="__codelineno-146-13" name="__codelineno-146-13" href="#__codelineno-146-13"></a>    <span class="n">EnvLookupOutput</span><span class="p">,</span>
</span><span id="__span-146-14"><a id="__codelineno-146-14" name="__codelineno-146-14" href="#__codelineno-146-14"></a>    <span class="n">ToolData</span><span class="p">,</span>
</span><span id="__span-146-15"><a id="__codelineno-146-15" name="__codelineno-146-15" href="#__codelineno-146-15"></a>    <span class="n">ValidationInput</span><span class="p">,</span>
</span><span id="__span-146-16"><a id="__codelineno-146-16" name="__codelineno-146-16" href="#__codelineno-146-16"></a><span class="p">)</span>
</span><span id="__span-146-17"><a id="__codelineno-146-17" name="__codelineno-146-17" href="#__codelineno-146-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">workflows</span><span class="w"> </span><span class="kn">import</span> <span class="n">workflow_helpers</span> <span class="k">as</span> <span class="n">helpers</span>
</span><span id="__span-146-18"><a id="__codelineno-146-18" name="__codelineno-146-18" href="#__codelineno-146-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">workflows.workflow_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-146-19"><a id="__codelineno-146-19" name="__codelineno-146-19" href="#__codelineno-146-19"></a>    <span class="n">LLM_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-146-20"><a id="__codelineno-146-20" name="__codelineno-146-20" href="#__codelineno-146-20"></a>    <span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-146-21"><a id="__codelineno-146-21" name="__codelineno-146-21" href="#__codelineno-146-21"></a><span class="p">)</span>
</span><span id="__span-146-22"><a id="__codelineno-146-22" name="__codelineno-146-22" href="#__codelineno-146-22"></a>
</span><span id="__span-146-23"><a id="__codelineno-146-23" name="__codelineno-146-23" href="#__codelineno-146-23"></a><span class="k">with</span> <span class="n">workflow</span><span class="o">.</span><span class="n">unsafe</span><span class="o">.</span><span class="n">imports_passed_through</span><span class="p">():</span>
</span><span id="__span-146-24"><a id="__codelineno-146-24" name="__codelineno-146-24" href="#__codelineno-146-24"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">activities.activities</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentActivities</span>
</span><span id="__span-146-25"><a id="__codelineno-146-25" name="__codelineno-146-25" href="#__codelineno-146-25"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">CombinedInput</span><span class="p">,</span> <span class="n">ToolPromptInput</span>
</span><span id="__span-146-26"><a id="__codelineno-146-26" name="__codelineno-146-26" href="#__codelineno-146-26"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">prompts.agent_prompt_generators</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_genai_prompt</span>
</span><span id="__span-146-27"><a id="__codelineno-146-27" name="__codelineno-146-27" href="#__codelineno-146-27"></a>
</span><span id="__span-146-28"><a id="__codelineno-146-28" name="__codelineno-146-28" href="#__codelineno-146-28"></a><span class="c1"># Constants</span>
</span><span id="__span-146-29"><a id="__codelineno-146-29" name="__codelineno-146-29" href="#__codelineno-146-29"></a><span class="n">MAX_TURNS_BEFORE_CONTINUE</span> <span class="o">=</span> <span class="mi">250</span>
</span><span id="__span-146-30"><a id="__codelineno-146-30" name="__codelineno-146-30" href="#__codelineno-146-30"></a>
</span><span id="__span-146-31"><a id="__codelineno-146-31" name="__codelineno-146-31" href="#__codelineno-146-31"></a>
</span><span id="__span-146-32"><a id="__codelineno-146-32" name="__codelineno-146-32" href="#__codelineno-146-32"></a><span class="nd">@workflow</span><span class="o">.</span><span class="n">defn</span>
</span><span id="__span-146-33"><a id="__codelineno-146-33" name="__codelineno-146-33" href="#__codelineno-146-33"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentGoalWorkflow</span><span class="p">:</span>
</span><span id="__span-146-34"><a id="__codelineno-146-34" name="__codelineno-146-34" href="#__codelineno-146-34"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Workflow that manages tool execution with user confirmation and conversation history.&quot;&quot;&quot;</span>
</span><span id="__span-146-35"><a id="__codelineno-146-35" name="__codelineno-146-35" href="#__codelineno-146-35"></a>
</span><span id="__span-146-36"><a id="__codelineno-146-36" name="__codelineno-146-36" href="#__codelineno-146-36"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-146-37"><a id="__codelineno-146-37" name="__codelineno-146-37" href="#__codelineno-146-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">:</span> <span class="n">ConversationHistory</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="__span-146-38"><a id="__codelineno-146-38" name="__codelineno-146-38" href="#__codelineno-146-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">:</span> <span class="n">Deque</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
</span><span id="__span-146-39"><a id="__codelineno-146-39" name="__codelineno-146-39" href="#__codelineno-146-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-146-40"><a id="__codelineno-146-40" name="__codelineno-146-40" href="#__codelineno-146-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ToolData</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-146-41"><a id="__codelineno-146-41" name="__codelineno-146-41" href="#__codelineno-146-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AgentGoal</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-146-42"><a id="__codelineno-146-42" name="__codelineno-146-42" href="#__codelineno-146-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_confirm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-146-43"><a id="__codelineno-146-43" name="__codelineno-146-43" href="#__codelineno-146-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">show_tool_args_confirmation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-146-44"><a id="__codelineno-146-44" name="__codelineno-146-44" href="#__codelineno-146-44"></a>            <span class="kc">True</span>  <span class="c1"># set from env file in activity lookup_wf_env_settings</span>
</span><span id="__span-146-45"><a id="__codelineno-146-45" name="__codelineno-146-45" href="#__codelineno-146-45"></a>        <span class="p">)</span>
</span><span id="__span-146-46"><a id="__codelineno-146-46" name="__codelineno-146-46" href="#__codelineno-146-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-146-47"><a id="__codelineno-146-47" name="__codelineno-146-47" href="#__codelineno-146-47"></a>            <span class="kc">False</span>  <span class="c1"># indicates that we have confirmation to proceed to run tool</span>
</span><span id="__span-146-48"><a id="__codelineno-146-48" name="__codelineno-146-48" href="#__codelineno-146-48"></a>        <span class="p">)</span>
</span><span id="__span-146-49"><a id="__codelineno-146-49" name="__codelineno-146-49" href="#__codelineno-146-49"></a>
</span><span id="__span-146-50"><a id="__codelineno-146-50" name="__codelineno-146-50" href="#__codelineno-146-50"></a>    <span class="c1"># see ../api/main.py#temporal_client.start_workflow() for how the input parameters are set</span>
</span><span id="__span-146-51"><a id="__codelineno-146-51" name="__codelineno-146-51" href="#__codelineno-146-51"></a>    <span class="nd">@workflow</span><span class="o">.</span><span class="n">run</span>
</span><span id="__span-146-52"><a id="__codelineno-146-52" name="__codelineno-146-52" href="#__codelineno-146-52"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combined_input</span><span class="p">:</span> <span class="n">CombinedInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-146-53"><a id="__codelineno-146-53" name="__codelineno-146-53" href="#__codelineno-146-53"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Main workflow execution method.&quot;&quot;&quot;</span>
</span><span id="__span-146-54"><a id="__codelineno-146-54" name="__codelineno-146-54" href="#__codelineno-146-54"></a>        <span class="c1"># setup phase, starts with blank tool_params and agent_goal prompt as defined in tools/goal_registry.py</span>
</span><span id="__span-146-55"><a id="__codelineno-146-55" name="__codelineno-146-55" href="#__codelineno-146-55"></a>        <span class="n">params</span> <span class="o">=</span> <span class="n">combined_input</span><span class="o">.</span><span class="n">tool_params</span>
</span><span id="__span-146-56"><a id="__codelineno-146-56" name="__codelineno-146-56" href="#__codelineno-146-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">goal</span> <span class="o">=</span> <span class="n">combined_input</span><span class="o">.</span><span class="n">agent_goal</span>
</span><span id="__span-146-57"><a id="__codelineno-146-57" name="__codelineno-146-57" href="#__codelineno-146-57"></a>
</span><span id="__span-146-58"><a id="__codelineno-146-58" name="__codelineno-146-58" href="#__codelineno-146-58"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_wf_env_settings</span><span class="p">()</span>
</span><span id="__span-146-59"><a id="__codelineno-146-59" name="__codelineno-146-59" href="#__codelineno-146-59"></a>
</span><span id="__span-146-60"><a id="__codelineno-146-60" name="__codelineno-146-60" href="#__codelineno-146-60"></a>        <span class="k">if</span> <span class="n">params</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">:</span>
</span><span id="__span-146-61"><a id="__codelineno-146-61" name="__codelineno-146-61" href="#__codelineno-146-61"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">)</span>
</span><span id="__span-146-62"><a id="__codelineno-146-62" name="__codelineno-146-62" href="#__codelineno-146-62"></a>
</span><span id="__span-146-63"><a id="__codelineno-146-63" name="__codelineno-146-63" href="#__codelineno-146-63"></a>        <span class="n">current_tool</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CurrentTool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-146-64"><a id="__codelineno-146-64" name="__codelineno-146-64" href="#__codelineno-146-64"></a>
</span><span id="__span-146-65"><a id="__codelineno-146-65" name="__codelineno-146-65" href="#__codelineno-146-65"></a>        <span class="c1"># This is the main interactive loop. Main responsibilities:</span>
</span><span id="__span-146-66"><a id="__codelineno-146-66" name="__codelineno-146-66" href="#__codelineno-146-66"></a>        <span class="c1">#   - reacting to user input (from signals)</span>
</span><span id="__span-146-67"><a id="__codelineno-146-67" name="__codelineno-146-67" href="#__codelineno-146-67"></a>        <span class="c1">#   - validating user input to make sure it makes sense with the current goal and tools</span>
</span><span id="__span-146-68"><a id="__codelineno-146-68" name="__codelineno-146-68" href="#__codelineno-146-68"></a>        <span class="c1">#   - calling the LLM through activities to determine next steps and prompts</span>
</span><span id="__span-146-69"><a id="__codelineno-146-69" name="__codelineno-146-69" href="#__codelineno-146-69"></a>        <span class="c1">#   - executing the selected tools via Activities</span>
</span><span id="__span-146-70"><a id="__codelineno-146-70" name="__codelineno-146-70" href="#__codelineno-146-70"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="__span-146-71"><a id="__codelineno-146-71" name="__codelineno-146-71" href="#__codelineno-146-71"></a>            <span class="c1"># wait indefinitely for input from signals - user_prompt, end_chat, or confirm as defined below</span>
</span><span id="__span-146-72"><a id="__codelineno-146-72" name="__codelineno-146-72" href="#__codelineno-146-72"></a>            <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">wait_condition</span><span class="p">(</span>
</span><span id="__span-146-73"><a id="__codelineno-146-73" name="__codelineno-146-73" href="#__codelineno-146-73"></a>                <span class="k">lambda</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span>
</span><span id="__span-146-74"><a id="__codelineno-146-74" name="__codelineno-146-74" href="#__codelineno-146-74"></a>            <span class="p">)</span>
</span><span id="__span-146-75"><a id="__codelineno-146-75" name="__codelineno-146-75" href="#__codelineno-146-75"></a>
</span><span id="__span-146-76"><a id="__codelineno-146-76" name="__codelineno-146-76" href="#__codelineno-146-76"></a>            <span class="c1"># handle chat should end. When chat ends, push conversation history to workflow results.</span>
</span><span id="__span-146-77"><a id="__codelineno-146-77" name="__codelineno-146-77" href="#__codelineno-146-77"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span><span class="p">:</span>
</span><span id="__span-146-78"><a id="__codelineno-146-78" name="__codelineno-146-78" href="#__codelineno-146-78"></a>                <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Chat-end signal received. Chat ending.&quot;</span><span class="p">)</span>
</span><span id="__span-146-79"><a id="__codelineno-146-79" name="__codelineno-146-79" href="#__codelineno-146-79"></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-146-80"><a id="__codelineno-146-80" name="__codelineno-146-80" href="#__codelineno-146-80"></a>
</span><span id="__span-146-81"><a id="__codelineno-146-81" name="__codelineno-146-81" href="#__codelineno-146-81"></a>            <span class="c1"># Execute the tool</span>
</span><span id="__span-146-82"><a id="__codelineno-146-82" name="__codelineno-146-82" href="#__codelineno-146-82"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ready_for_tool_execution</span><span class="p">()</span> <span class="ow">and</span> <span class="n">current_tool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-146-83"><a id="__codelineno-146-83" name="__codelineno-146-83" href="#__codelineno-146-83"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_tool</span><span class="p">(</span><span class="n">current_tool</span><span class="p">)</span>
</span><span id="__span-146-84"><a id="__codelineno-146-84" name="__codelineno-146-84" href="#__codelineno-146-84"></a>                <span class="k">continue</span>
</span><span id="__span-146-85"><a id="__codelineno-146-85" name="__codelineno-146-85" href="#__codelineno-146-85"></a>
</span><span id="__span-146-86"><a id="__codelineno-146-86" name="__codelineno-146-86" href="#__codelineno-146-86"></a>            <span class="c1"># process forward on the prompt queue if any</span>
</span><span id="__span-146-87"><a id="__codelineno-146-87" name="__codelineno-146-87" href="#__codelineno-146-87"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">:</span>
</span><span id="__span-146-88"><a id="__codelineno-146-88" name="__codelineno-146-88" href="#__codelineno-146-88"></a>                <span class="c1"># get most recent prompt</span>
</span><span id="__span-146-89"><a id="__codelineno-146-89" name="__codelineno-146-89" href="#__codelineno-146-89"></a>                <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
</span><span id="__span-146-90"><a id="__codelineno-146-90" name="__codelineno-146-90" href="#__codelineno-146-90"></a>                <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-146-91"><a id="__codelineno-146-91" name="__codelineno-146-91" href="#__codelineno-146-91"></a>                    <span class="sa">f</span><span class="s2">&quot;workflow step: processing message on the prompt queue, message is </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-146-92"><a id="__codelineno-146-92" name="__codelineno-146-92" href="#__codelineno-146-92"></a>                <span class="p">)</span>
</span><span id="__span-146-93"><a id="__codelineno-146-93" name="__codelineno-146-93" href="#__codelineno-146-93"></a>
</span><span id="__span-146-94"><a id="__codelineno-146-94" name="__codelineno-146-94" href="#__codelineno-146-94"></a>                <span class="c1"># Validate user-provided prompts</span>
</span><span id="__span-146-95"><a id="__codelineno-146-95" name="__codelineno-146-95" href="#__codelineno-146-95"></a>                <span class="k">if</span> <span class="n">helpers</span><span class="o">.</span><span class="n">is_user_prompt</span><span class="p">(</span><span class="n">prompt</span><span class="p">):</span>
</span><span id="__span-146-96"><a id="__codelineno-146-96" name="__codelineno-146-96" href="#__codelineno-146-96"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
</span><span id="__span-146-97"><a id="__codelineno-146-97" name="__codelineno-146-97" href="#__codelineno-146-97"></a>
</span><span id="__span-146-98"><a id="__codelineno-146-98" name="__codelineno-146-98" href="#__codelineno-146-98"></a>                    <span class="c1"># Validate the prompt before proceeding</span>
</span><span id="__span-146-99"><a id="__codelineno-146-99" name="__codelineno-146-99" href="#__codelineno-146-99"></a>                    <span class="n">validation_input</span> <span class="o">=</span> <span class="n">ValidationInput</span><span class="p">(</span>
</span><span id="__span-146-100"><a id="__codelineno-146-100" name="__codelineno-146-100" href="#__codelineno-146-100"></a>                        <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
</span><span id="__span-146-101"><a id="__codelineno-146-101" name="__codelineno-146-101" href="#__codelineno-146-101"></a>                        <span class="n">conversation_history</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">,</span>
</span><span id="__span-146-102"><a id="__codelineno-146-102" name="__codelineno-146-102" href="#__codelineno-146-102"></a>                        <span class="n">agent_goal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span>
</span><span id="__span-146-103"><a id="__codelineno-146-103" name="__codelineno-146-103" href="#__codelineno-146-103"></a>                    <span class="p">)</span>
</span><span id="__span-146-104"><a id="__codelineno-146-104" name="__codelineno-146-104" href="#__codelineno-146-104"></a>                    <span class="n">validation_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">execute_activity_method</span><span class="p">(</span>
</span><span id="__span-146-105"><a id="__codelineno-146-105" name="__codelineno-146-105" href="#__codelineno-146-105"></a>                        <span class="n">AgentActivities</span><span class="o">.</span><span class="n">agent_validatePrompt</span><span class="p">,</span>
</span><span id="__span-146-106"><a id="__codelineno-146-106" name="__codelineno-146-106" href="#__codelineno-146-106"></a>                        <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">validation_input</span><span class="p">],</span>
</span><span id="__span-146-107"><a id="__codelineno-146-107" name="__codelineno-146-107" href="#__codelineno-146-107"></a>                        <span class="n">schedule_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-146-108"><a id="__codelineno-146-108" name="__codelineno-146-108" href="#__codelineno-146-108"></a>                        <span class="n">start_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-146-109"><a id="__codelineno-146-109" name="__codelineno-146-109" href="#__codelineno-146-109"></a>                        <span class="n">retry_policy</span><span class="o">=</span><span class="n">RetryPolicy</span><span class="p">(</span>
</span><span id="__span-146-110"><a id="__codelineno-146-110" name="__codelineno-146-110" href="#__codelineno-146-110"></a>                            <span class="n">initial_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">backoff_coefficient</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-146-111"><a id="__codelineno-146-111" name="__codelineno-146-111" href="#__codelineno-146-111"></a>                        <span class="p">),</span>
</span><span id="__span-146-112"><a id="__codelineno-146-112" name="__codelineno-146-112" href="#__codelineno-146-112"></a>                    <span class="p">)</span>
</span><span id="__span-146-113"><a id="__codelineno-146-113" name="__codelineno-146-113" href="#__codelineno-146-113"></a>
</span><span id="__span-146-114"><a id="__codelineno-146-114" name="__codelineno-146-114" href="#__codelineno-146-114"></a>                    <span class="c1"># If validation fails, provide that feedback to the user - i.e., &quot;your words make no sense, puny human&quot; end this iteration of processing</span>
</span><span id="__span-146-115"><a id="__codelineno-146-115" name="__codelineno-146-115" href="#__codelineno-146-115"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">validationResult</span><span class="p">:</span>
</span><span id="__span-146-116"><a id="__codelineno-146-116" name="__codelineno-146-116" href="#__codelineno-146-116"></a>                        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="__span-146-117"><a id="__codelineno-146-117" name="__codelineno-146-117" href="#__codelineno-146-117"></a>                            <span class="sa">f</span><span class="s2">&quot;Prompt validation failed: </span><span class="si">{</span><span class="n">validation_result</span><span class="o">.</span><span class="n">validationFailedReason</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-146-118"><a id="__codelineno-146-118" name="__codelineno-146-118" href="#__codelineno-146-118"></a>                        <span class="p">)</span>
</span><span id="__span-146-119"><a id="__codelineno-146-119" name="__codelineno-146-119" href="#__codelineno-146-119"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span>
</span><span id="__span-146-120"><a id="__codelineno-146-120" name="__codelineno-146-120" href="#__codelineno-146-120"></a>                            <span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">validationFailedReason</span>
</span><span id="__span-146-121"><a id="__codelineno-146-121" name="__codelineno-146-121" href="#__codelineno-146-121"></a>                        <span class="p">)</span>
</span><span id="__span-146-122"><a id="__codelineno-146-122" name="__codelineno-146-122" href="#__codelineno-146-122"></a>                        <span class="k">continue</span>
</span><span id="__span-146-123"><a id="__codelineno-146-123" name="__codelineno-146-123" href="#__codelineno-146-123"></a>
</span><span id="__span-146-124"><a id="__codelineno-146-124" name="__codelineno-146-124" href="#__codelineno-146-124"></a>                <span class="c1"># If valid, proceed with generating the context and prompt</span>
</span><span id="__span-146-125"><a id="__codelineno-146-125" name="__codelineno-146-125" href="#__codelineno-146-125"></a>                <span class="n">context_instructions</span> <span class="o">=</span> <span class="n">generate_genai_prompt</span><span class="p">(</span>
</span><span id="__span-146-126"><a id="__codelineno-146-126" name="__codelineno-146-126" href="#__codelineno-146-126"></a>                    <span class="n">agent_goal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span>
</span><span id="__span-146-127"><a id="__codelineno-146-127" name="__codelineno-146-127" href="#__codelineno-146-127"></a>                    <span class="n">conversation_history</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">,</span>
</span><span id="__span-146-128"><a id="__codelineno-146-128" name="__codelineno-146-128" href="#__codelineno-146-128"></a>                    <span class="n">raw_json</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="p">,</span>
</span><span id="__span-146-129"><a id="__codelineno-146-129" name="__codelineno-146-129" href="#__codelineno-146-129"></a>                <span class="p">)</span>
</span><span id="__span-146-130"><a id="__codelineno-146-130" name="__codelineno-146-130" href="#__codelineno-146-130"></a>
</span><span id="__span-146-131"><a id="__codelineno-146-131" name="__codelineno-146-131" href="#__codelineno-146-131"></a>                <span class="n">prompt_input</span> <span class="o">=</span> <span class="n">ToolPromptInput</span><span class="p">(</span>
</span><span id="__span-146-132"><a id="__codelineno-146-132" name="__codelineno-146-132" href="#__codelineno-146-132"></a>                    <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span> <span class="n">context_instructions</span><span class="o">=</span><span class="n">context_instructions</span>
</span><span id="__span-146-133"><a id="__codelineno-146-133" name="__codelineno-146-133" href="#__codelineno-146-133"></a>                <span class="p">)</span>
</span><span id="__span-146-134"><a id="__codelineno-146-134" name="__codelineno-146-134" href="#__codelineno-146-134"></a>
</span><span id="__span-146-135"><a id="__codelineno-146-135" name="__codelineno-146-135" href="#__codelineno-146-135"></a>                <span class="c1"># connect to LLM and execute to get next steps</span>
</span><span id="__span-146-136"><a id="__codelineno-146-136" name="__codelineno-146-136" href="#__codelineno-146-136"></a>                <span class="n">tool_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">execute_activity_method</span><span class="p">(</span>
</span><span id="__span-146-137"><a id="__codelineno-146-137" name="__codelineno-146-137" href="#__codelineno-146-137"></a>                    <span class="n">AgentActivities</span><span class="o">.</span><span class="n">agent_toolPlanner</span><span class="p">,</span>
</span><span id="__span-146-138"><a id="__codelineno-146-138" name="__codelineno-146-138" href="#__codelineno-146-138"></a>                    <span class="n">prompt_input</span><span class="p">,</span>
</span><span id="__span-146-139"><a id="__codelineno-146-139" name="__codelineno-146-139" href="#__codelineno-146-139"></a>                    <span class="n">schedule_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-146-140"><a id="__codelineno-146-140" name="__codelineno-146-140" href="#__codelineno-146-140"></a>                    <span class="n">start_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-146-141"><a id="__codelineno-146-141" name="__codelineno-146-141" href="#__codelineno-146-141"></a>                    <span class="n">retry_policy</span><span class="o">=</span><span class="n">RetryPolicy</span><span class="p">(</span>
</span><span id="__span-146-142"><a id="__codelineno-146-142" name="__codelineno-146-142" href="#__codelineno-146-142"></a>                        <span class="n">initial_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">backoff_coefficient</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-146-143"><a id="__codelineno-146-143" name="__codelineno-146-143" href="#__codelineno-146-143"></a>                    <span class="p">),</span>
</span><span id="__span-146-144"><a id="__codelineno-146-144" name="__codelineno-146-144" href="#__codelineno-146-144"></a>                <span class="p">)</span>
</span><span id="__span-146-145"><a id="__codelineno-146-145" name="__codelineno-146-145" href="#__codelineno-146-145"></a>
</span><span id="__span-146-146"><a id="__codelineno-146-146" name="__codelineno-146-146" href="#__codelineno-146-146"></a>                <span class="n">tool_data</span><span class="p">[</span><span class="s2">&quot;force_confirm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_tool_args_confirmation</span>
</span><span id="__span-146-147"><a id="__codelineno-146-147" name="__codelineno-146-147" href="#__codelineno-146-147"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span> <span class="o">=</span> <span class="n">ToolData</span><span class="p">(</span><span class="o">**</span><span class="n">tool_data</span><span class="p">)</span>
</span><span id="__span-146-148"><a id="__codelineno-146-148" name="__codelineno-146-148" href="#__codelineno-146-148"></a>
</span><span id="__span-146-149"><a id="__codelineno-146-149" name="__codelineno-146-149" href="#__codelineno-146-149"></a>                <span class="c1"># process the tool as dictated by the prompt response - what to do next, and with which tool</span>
</span><span id="__span-146-150"><a id="__codelineno-146-150" name="__codelineno-146-150" href="#__codelineno-146-150"></a>                <span class="n">next_step</span> <span class="o">=</span> <span class="n">tool_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;next&quot;</span><span class="p">)</span>
</span><span id="__span-146-151"><a id="__codelineno-146-151" name="__codelineno-146-151" href="#__codelineno-146-151"></a>                <span class="n">current_tool</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CurrentTool</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool&quot;</span><span class="p">)</span>
</span><span id="__span-146-152"><a id="__codelineno-146-152" name="__codelineno-146-152" href="#__codelineno-146-152"></a>
</span><span id="__span-146-153"><a id="__codelineno-146-153" name="__codelineno-146-153" href="#__codelineno-146-153"></a>                <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-146-154"><a id="__codelineno-146-154" name="__codelineno-146-154" href="#__codelineno-146-154"></a>                    <span class="sa">f</span><span class="s2">&quot;next_step: </span><span class="si">{</span><span class="n">next_step</span><span class="si">}</span><span class="s2">, current tool is </span><span class="si">{</span><span class="n">current_tool</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-146-155"><a id="__codelineno-146-155" name="__codelineno-146-155" href="#__codelineno-146-155"></a>                <span class="p">)</span>
</span><span id="__span-146-156"><a id="__codelineno-146-156" name="__codelineno-146-156" href="#__codelineno-146-156"></a>
</span><span id="__span-146-157"><a id="__codelineno-146-157" name="__codelineno-146-157" href="#__codelineno-146-157"></a>                <span class="c1"># make sure we&#39;re ready to run the tool &amp; have everything we need</span>
</span><span id="__span-146-158"><a id="__codelineno-146-158" name="__codelineno-146-158" href="#__codelineno-146-158"></a>                <span class="k">if</span> <span class="n">next_step</span> <span class="o">==</span> <span class="s2">&quot;confirm&quot;</span> <span class="ow">and</span> <span class="n">current_tool</span><span class="p">:</span>
</span><span id="__span-146-159"><a id="__codelineno-146-159" name="__codelineno-146-159" href="#__codelineno-146-159"></a>                    <span class="n">args</span> <span class="o">=</span> <span class="n">tool_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-146-160"><a id="__codelineno-146-160" name="__codelineno-146-160" href="#__codelineno-146-160"></a>                    <span class="c1"># if we&#39;re missing arguments, ask for them</span>
</span><span id="__span-146-161"><a id="__codelineno-146-161" name="__codelineno-146-161" href="#__codelineno-146-161"></a>                    <span class="k">if</span> <span class="k">await</span> <span class="n">helpers</span><span class="o">.</span><span class="n">handle_missing_args</span><span class="p">(</span>
</span><span id="__span-146-162"><a id="__codelineno-146-162" name="__codelineno-146-162" href="#__codelineno-146-162"></a>                        <span class="n">current_tool</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">tool_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span>
</span><span id="__span-146-163"><a id="__codelineno-146-163" name="__codelineno-146-163" href="#__codelineno-146-163"></a>                    <span class="p">):</span>
</span><span id="__span-146-164"><a id="__codelineno-146-164" name="__codelineno-146-164" href="#__codelineno-146-164"></a>                        <span class="k">continue</span>
</span><span id="__span-146-165"><a id="__codelineno-146-165" name="__codelineno-146-165" href="#__codelineno-146-165"></a>
</span><span id="__span-146-166"><a id="__codelineno-146-166" name="__codelineno-146-166" href="#__codelineno-146-166"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_confirm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-146-167"><a id="__codelineno-146-167" name="__codelineno-146-167" href="#__codelineno-146-167"></a>
</span><span id="__span-146-168"><a id="__codelineno-146-168" name="__codelineno-146-168" href="#__codelineno-146-168"></a>                    <span class="c1"># We have needed arguments, if we want to force the user to confirm, set that up</span>
</span><span id="__span-146-169"><a id="__codelineno-146-169" name="__codelineno-146-169" href="#__codelineno-146-169"></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_tool_args_confirmation</span><span class="p">:</span>
</span><span id="__span-146-170"><a id="__codelineno-146-170" name="__codelineno-146-170" href="#__codelineno-146-170"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># set that we&#39;re not confirmed</span>
</span><span id="__span-146-171"><a id="__codelineno-146-171" name="__codelineno-146-171" href="#__codelineno-146-171"></a>                        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for user confirm signal...&quot;</span><span class="p">)</span>
</span><span id="__span-146-172"><a id="__codelineno-146-172" name="__codelineno-146-172" href="#__codelineno-146-172"></a>                    <span class="c1"># if we have all needed arguments (handled above) and not holding for a debugging confirm, proceed:</span>
</span><span id="__span-146-173"><a id="__codelineno-146-173" name="__codelineno-146-173" href="#__codelineno-146-173"></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-146-174"><a id="__codelineno-146-174" name="__codelineno-146-174" href="#__codelineno-146-174"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-146-175"><a id="__codelineno-146-175" name="__codelineno-146-175" href="#__codelineno-146-175"></a>
</span><span id="__span-146-176"><a id="__codelineno-146-176" name="__codelineno-146-176" href="#__codelineno-146-176"></a>                <span class="c1"># else if the next step is to be done with the conversation such as if the user requests it via asking to &quot;end conversation&quot;</span>
</span><span id="__span-146-177"><a id="__codelineno-146-177" name="__codelineno-146-177" href="#__codelineno-146-177"></a>                <span class="k">elif</span> <span class="n">next_step</span> <span class="o">==</span> <span class="s2">&quot;done&quot;</span><span class="p">:</span>
</span><span id="__span-146-178"><a id="__codelineno-146-178" name="__codelineno-146-178" href="#__codelineno-146-178"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">tool_data</span><span class="p">)</span>
</span><span id="__span-146-179"><a id="__codelineno-146-179" name="__codelineno-146-179" href="#__codelineno-146-179"></a>
</span><span id="__span-146-180"><a id="__codelineno-146-180" name="__codelineno-146-180" href="#__codelineno-146-180"></a>                    <span class="c1"># here we could send conversation to AI for analysis</span>
</span><span id="__span-146-181"><a id="__codelineno-146-181" name="__codelineno-146-181" href="#__codelineno-146-181"></a>
</span><span id="__span-146-182"><a id="__codelineno-146-182" name="__codelineno-146-182" href="#__codelineno-146-182"></a>                    <span class="c1"># end the workflow</span>
</span><span id="__span-146-183"><a id="__codelineno-146-183" name="__codelineno-146-183" href="#__codelineno-146-183"></a>                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">)</span>
</span><span id="__span-146-184"><a id="__codelineno-146-184" name="__codelineno-146-184" href="#__codelineno-146-184"></a>
</span><span id="__span-146-185"><a id="__codelineno-146-185" name="__codelineno-146-185" href="#__codelineno-146-185"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">tool_data</span><span class="p">)</span>
</span><span id="__span-146-186"><a id="__codelineno-146-186" name="__codelineno-146-186" href="#__codelineno-146-186"></a>                <span class="k">await</span> <span class="n">helpers</span><span class="o">.</span><span class="n">continue_as_new_if_needed</span><span class="p">(</span>
</span><span id="__span-146-187"><a id="__codelineno-146-187" name="__codelineno-146-187" href="#__codelineno-146-187"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">,</span>
</span><span id="__span-146-188"><a id="__codelineno-146-188" name="__codelineno-146-188" href="#__codelineno-146-188"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">,</span>
</span><span id="__span-146-189"><a id="__codelineno-146-189" name="__codelineno-146-189" href="#__codelineno-146-189"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span>
</span><span id="__span-146-190"><a id="__codelineno-146-190" name="__codelineno-146-190" href="#__codelineno-146-190"></a>                    <span class="n">MAX_TURNS_BEFORE_CONTINUE</span><span class="p">,</span>
</span><span id="__span-146-191"><a id="__codelineno-146-191" name="__codelineno-146-191" href="#__codelineno-146-191"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">,</span>
</span><span id="__span-146-192"><a id="__codelineno-146-192" name="__codelineno-146-192" href="#__codelineno-146-192"></a>                <span class="p">)</span>
</span><span id="__span-146-193"><a id="__codelineno-146-193" name="__codelineno-146-193" href="#__codelineno-146-193"></a>
</span><span id="__span-146-194"><a id="__codelineno-146-194" name="__codelineno-146-194" href="#__codelineno-146-194"></a>    <span class="c1"># look up env settings in an activity so they&#39;re part of history</span>
</span><span id="__span-146-195"><a id="__codelineno-146-195" name="__codelineno-146-195" href="#__codelineno-146-195"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lookup_wf_env_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-146-196"><a id="__codelineno-146-196" name="__codelineno-146-196" href="#__codelineno-146-196"></a>        <span class="n">env_lookup_input</span> <span class="o">=</span> <span class="n">EnvLookupInput</span><span class="p">(</span>
</span><span id="__span-146-197"><a id="__codelineno-146-197" name="__codelineno-146-197" href="#__codelineno-146-197"></a>            <span class="n">show_confirm_env_var_name</span><span class="o">=</span><span class="s2">&quot;SHOW_CONFIRM&quot;</span><span class="p">,</span>
</span><span id="__span-146-198"><a id="__codelineno-146-198" name="__codelineno-146-198" href="#__codelineno-146-198"></a>            <span class="n">show_confirm_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-146-199"><a id="__codelineno-146-199" name="__codelineno-146-199" href="#__codelineno-146-199"></a>        <span class="p">)</span>
</span><span id="__span-146-200"><a id="__codelineno-146-200" name="__codelineno-146-200" href="#__codelineno-146-200"></a>        <span class="n">env_output</span><span class="p">:</span> <span class="n">EnvLookupOutput</span> <span class="o">=</span> <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">execute_activity_method</span><span class="p">(</span>
</span><span id="__span-146-201"><a id="__codelineno-146-201" name="__codelineno-146-201" href="#__codelineno-146-201"></a>            <span class="n">AgentActivities</span><span class="o">.</span><span class="n">get_wf_env_vars</span><span class="p">,</span>
</span><span id="__span-146-202"><a id="__codelineno-146-202" name="__codelineno-146-202" href="#__codelineno-146-202"></a>            <span class="n">env_lookup_input</span><span class="p">,</span>
</span><span id="__span-146-203"><a id="__codelineno-146-203" name="__codelineno-146-203" href="#__codelineno-146-203"></a>            <span class="n">start_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-146-204"><a id="__codelineno-146-204" name="__codelineno-146-204" href="#__codelineno-146-204"></a>            <span class="n">retry_policy</span><span class="o">=</span><span class="n">RetryPolicy</span><span class="p">(</span>
</span><span id="__span-146-205"><a id="__codelineno-146-205" name="__codelineno-146-205" href="#__codelineno-146-205"></a>                <span class="n">initial_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">backoff_coefficient</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-146-206"><a id="__codelineno-146-206" name="__codelineno-146-206" href="#__codelineno-146-206"></a>            <span class="p">),</span>
</span><span id="__span-146-207"><a id="__codelineno-146-207" name="__codelineno-146-207" href="#__codelineno-146-207"></a>        <span class="p">)</span>
</span><span id="__span-146-208"><a id="__codelineno-146-208" name="__codelineno-146-208" href="#__codelineno-146-208"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">show_tool_args_confirmation</span> <span class="o">=</span> <span class="n">env_output</span><span class="o">.</span><span class="n">show_confirm</span>
</span><span id="__span-146-209"><a id="__codelineno-146-209" name="__codelineno-146-209" href="#__codelineno-146-209"></a>
</span><span id="__span-146-210"><a id="__codelineno-146-210" name="__codelineno-146-210" href="#__codelineno-146-210"></a>    <span class="c1"># define if we&#39;re ready for tool execution</span>
</span><span id="__span-146-211"><a id="__codelineno-146-211" name="__codelineno-146-211" href="#__codelineno-146-211"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ready_for_tool_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-146-212"><a id="__codelineno-146-212" name="__codelineno-146-212" href="#__codelineno-146-212"></a>
</span><span id="__span-146-213"><a id="__codelineno-146-213" name="__codelineno-146-213" href="#__codelineno-146-213"></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="__span-146-214"><a id="__codelineno-146-214" name="__codelineno-146-214" href="#__codelineno-146-214"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_confirm</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="__span-146-215"><a id="__codelineno-146-215" name="__codelineno-146-215" href="#__codelineno-146-215"></a>        <span class="p">)</span>
</span><span id="__span-146-216"><a id="__codelineno-146-216" name="__codelineno-146-216" href="#__codelineno-146-216"></a>
</span><span id="__span-146-217"><a id="__codelineno-146-217" name="__codelineno-146-217" href="#__codelineno-146-217"></a>    <span class="c1"># execute the tool - set self.waiting_for_confirm to False if we&#39;re not waiting for confirm anymore</span>
</span><span id="__span-146-218"><a id="__codelineno-146-218" name="__codelineno-146-218" href="#__codelineno-146-218"></a>    <span class="c1"># (always the case if it works successfully)</span>
</span><span id="__span-146-219"><a id="__codelineno-146-219" name="__codelineno-146-219" href="#__codelineno-146-219"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_tool</span><span class="p">:</span> <span class="n">CurrentTool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-146-220"><a id="__codelineno-146-220" name="__codelineno-146-220" href="#__codelineno-146-220"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-146-221"><a id="__codelineno-146-221" name="__codelineno-146-221" href="#__codelineno-146-221"></a>            <span class="sa">f</span><span class="s2">&quot;workflow step: user has confirmed, executing the tool </span><span class="si">{</span><span class="n">current_tool</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-146-222"><a id="__codelineno-146-222" name="__codelineno-146-222" href="#__codelineno-146-222"></a>        <span class="p">)</span>
</span><span id="__span-146-223"><a id="__codelineno-146-223" name="__codelineno-146-223" href="#__codelineno-146-223"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-146-224"><a id="__codelineno-146-224" name="__codelineno-146-224" href="#__codelineno-146-224"></a>        <span class="n">confirmed_tool_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-146-225"><a id="__codelineno-146-225" name="__codelineno-146-225" href="#__codelineno-146-225"></a>        <span class="n">confirmed_tool_data</span><span class="p">[</span><span class="s2">&quot;next&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;confirm&quot;</span>
</span><span id="__span-146-226"><a id="__codelineno-146-226" name="__codelineno-146-226" href="#__codelineno-146-226"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s2">&quot;user_confirmed_tool_run&quot;</span><span class="p">,</span> <span class="n">confirmed_tool_data</span><span class="p">)</span>
</span><span id="__span-146-227"><a id="__codelineno-146-227" name="__codelineno-146-227" href="#__codelineno-146-227"></a>
</span><span id="__span-146-228"><a id="__codelineno-146-228" name="__codelineno-146-228" href="#__codelineno-146-228"></a>        <span class="c1"># execute the tool by key as defined in tools/__init__.py</span>
</span><span id="__span-146-229"><a id="__codelineno-146-229" name="__codelineno-146-229" href="#__codelineno-146-229"></a>        <span class="k">await</span> <span class="n">helpers</span><span class="o">.</span><span class="n">handle_tool_execution</span><span class="p">(</span>
</span><span id="__span-146-230"><a id="__codelineno-146-230" name="__codelineno-146-230" href="#__codelineno-146-230"></a>            <span class="n">current_tool</span><span class="p">,</span>
</span><span id="__span-146-231"><a id="__codelineno-146-231" name="__codelineno-146-231" href="#__codelineno-146-231"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="p">,</span>
</span><span id="__span-146-232"><a id="__codelineno-146-232" name="__codelineno-146-232" href="#__codelineno-146-232"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">,</span>
</span><span id="__span-146-233"><a id="__codelineno-146-233" name="__codelineno-146-233" href="#__codelineno-146-233"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">,</span>
</span><span id="__span-146-234"><a id="__codelineno-146-234" name="__codelineno-146-234" href="#__codelineno-146-234"></a>        <span class="p">)</span>
</span><span id="__span-146-235"><a id="__codelineno-146-235" name="__codelineno-146-235" href="#__codelineno-146-235"></a>
</span><span id="__span-146-236"><a id="__codelineno-146-236" name="__codelineno-146-236" href="#__codelineno-146-236"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_confirm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-146-237"><a id="__codelineno-146-237" name="__codelineno-146-237" href="#__codelineno-146-237"></a>
</span><span id="__span-146-238"><a id="__codelineno-146-238" name="__codelineno-146-238" href="#__codelineno-146-238"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-146-239"><a id="__codelineno-146-239" name="__codelineno-146-239" href="#__codelineno-146-239"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a message to the conversation history.</span>
</span><span id="__span-146-240"><a id="__codelineno-146-240" name="__codelineno-146-240" href="#__codelineno-146-240"></a>
</span><span id="__span-146-241"><a id="__codelineno-146-241" name="__codelineno-146-241" href="#__codelineno-146-241"></a><span class="sd">        Args:</span>
</span><span id="__span-146-242"><a id="__codelineno-146-242" name="__codelineno-146-242" href="#__codelineno-146-242"></a><span class="sd">            actor: The entity that generated the message (e.g., &quot;user&quot;, &quot;agent&quot;)</span>
</span><span id="__span-146-243"><a id="__codelineno-146-243" name="__codelineno-146-243" href="#__codelineno-146-243"></a><span class="sd">            response: The message content, either as a string or structured data</span>
</span><span id="__span-146-244"><a id="__codelineno-146-244" name="__codelineno-146-244" href="#__codelineno-146-244"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-146-245"><a id="__codelineno-146-245" name="__codelineno-146-245" href="#__codelineno-146-245"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-146-246"><a id="__codelineno-146-246" name="__codelineno-146-246" href="#__codelineno-146-246"></a>            <span class="n">response_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="__span-146-247"><a id="__codelineno-146-247" name="__codelineno-146-247" href="#__codelineno-146-247"></a>            <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">actor</span><span class="si">}</span><span class="s2"> message: </span><span class="si">{</span><span class="n">response_str</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-146-248"><a id="__codelineno-146-248" name="__codelineno-146-248" href="#__codelineno-146-248"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-146-249"><a id="__codelineno-146-249" name="__codelineno-146-249" href="#__codelineno-146-249"></a>            <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">actor</span><span class="si">}</span><span class="s2"> message: </span><span class="si">{</span><span class="n">response</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-146-250"><a id="__codelineno-146-250" name="__codelineno-146-250" href="#__codelineno-146-250"></a>
</span><span id="__span-146-251"><a id="__codelineno-146-251" name="__codelineno-146-251" href="#__codelineno-146-251"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-146-252"><a id="__codelineno-146-252" name="__codelineno-146-252" href="#__codelineno-146-252"></a>            <span class="p">{</span><span class="s2">&quot;actor&quot;</span><span class="p">:</span> <span class="n">actor</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">}</span>
</span><span id="__span-146-253"><a id="__codelineno-146-253" name="__codelineno-146-253" href="#__codelineno-146-253"></a>        <span class="p">)</span>
</span><span id="__span-146-254"><a id="__codelineno-146-254" name="__codelineno-146-254" href="#__codelineno-146-254"></a>
</span><span id="__span-146-255"><a id="__codelineno-146-255" name="__codelineno-146-255" href="#__codelineno-146-255"></a>    <span class="c1"># Signal that comes from api/main.py via a post to /send-prompt</span>
</span><span id="__span-146-256"><a id="__codelineno-146-256" name="__codelineno-146-256" href="#__codelineno-146-256"></a>    <span class="nd">@workflow</span><span class="o">.</span><span class="n">signal</span>
</span><span id="__span-146-257"><a id="__codelineno-146-257" name="__codelineno-146-257" href="#__codelineno-146-257"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">user_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-146-258"><a id="__codelineno-146-258" name="__codelineno-146-258" href="#__codelineno-146-258"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Signal handler for receiving user prompts.&quot;&quot;&quot;</span>
</span><span id="__span-146-259"><a id="__codelineno-146-259" name="__codelineno-146-259" href="#__codelineno-146-259"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;signal received: user_prompt, prompt is </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-146-260"><a id="__codelineno-146-260" name="__codelineno-146-260" href="#__codelineno-146-260"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span><span class="p">:</span>
</span><span id="__span-146-261"><a id="__codelineno-146-261" name="__codelineno-146-261" href="#__codelineno-146-261"></a>            <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message dropped due to chat closed: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-146-262"><a id="__codelineno-146-262" name="__codelineno-146-262" href="#__codelineno-146-262"></a>            <span class="k">return</span>
</span><span id="__span-146-263"><a id="__codelineno-146-263" name="__codelineno-146-263" href="#__codelineno-146-263"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
</span></code></pre></div>
</details>

<p>Finally, you are going to implement a method for external Temporal Clients to send and retrieve information to and from the Workflow Execution while it's running.</p>
<h3 id="communicating-with-the-workflow">Communicating with the Workflow<a class="headerlink" href="#communicating-with-the-workflow" title="Permanent link">&para;</a></h3>
<p>Temporal Workflows allow data to be sent and retrieved during a running execution.
These features are known as <a href="https://docs.temporal.io/encyclopedia/workflow-message-passing">Signals and Queries</a>.</p>
<p>Look back at the core event loop in the Workflow, specifically the <code>await</code> line at the very top of the loop:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-147-1"><a id="__codelineno-147-1" name="__codelineno-147-1" href="#__codelineno-147-1"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="__span-147-2"><a id="__codelineno-147-2" name="__codelineno-147-2" href="#__codelineno-147-2"></a>            <span class="c1"># wait indefinitely for input from signals - user_prompt, end_chat, or confirm as defined below</span>
</span><span id="__span-147-3"><a id="__codelineno-147-3" name="__codelineno-147-3" href="#__codelineno-147-3"></a>            <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">wait_condition</span><span class="p">(</span>
</span><span id="__span-147-4"><a id="__codelineno-147-4" name="__codelineno-147-4" href="#__codelineno-147-4"></a>                <span class="k">lambda</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span>
</span><span id="__span-147-5"><a id="__codelineno-147-5" name="__codelineno-147-5" href="#__codelineno-147-5"></a>            <span class="p">)</span>
</span></code></pre></div>
<p>You may have noticed the <code>chat_ended</code> variable was never changed, or the user's input was never added to the <code>prompt_queue</code>.
This is done via sending Signals to your running Workflow Execution.</p>
<h4 id="accepting-the-users-input">Accepting the users input<a class="headerlink" href="#accepting-the-users-input" title="Permanent link">&para;</a></h4>
<p>To accept user input and add it to the <code>prompt_queue</code>, define a Signal handler as a method within your <code>agent_goal_workflow.py</code> file, outside of the <code>run</code> function, and underneath your other helper functions.</p>
<p>Add the Signal handler to your code:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-148-1"><a id="__codelineno-148-1" name="__codelineno-148-1" href="#__codelineno-148-1"></a>    <span class="c1"># Signal that comes from api/main.py via a post to /send-prompt</span>
</span><span id="__span-148-2"><a id="__codelineno-148-2" name="__codelineno-148-2" href="#__codelineno-148-2"></a>    <span class="nd">@workflow</span><span class="o">.</span><span class="n">signal</span>
</span><span id="__span-148-3"><a id="__codelineno-148-3" name="__codelineno-148-3" href="#__codelineno-148-3"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">user_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-148-4"><a id="__codelineno-148-4" name="__codelineno-148-4" href="#__codelineno-148-4"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Signal handler for receiving user prompts.&quot;&quot;&quot;</span>
</span><span id="__span-148-5"><a id="__codelineno-148-5" name="__codelineno-148-5" href="#__codelineno-148-5"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;signal received: user_prompt, prompt is </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-148-6"><a id="__codelineno-148-6" name="__codelineno-148-6" href="#__codelineno-148-6"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span><span class="p">:</span>
</span><span id="__span-148-7"><a id="__codelineno-148-7" name="__codelineno-148-7" href="#__codelineno-148-7"></a>            <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message dropped due to chat closed: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-148-8"><a id="__codelineno-148-8" name="__codelineno-148-8" href="#__codelineno-148-8"></a>            <span class="k">return</span>
</span><span id="__span-148-9"><a id="__codelineno-148-9" name="__codelineno-148-9" href="#__codelineno-148-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
</span></code></pre></div>
<p>A Signal handler is an <code>async</code> method that is decorated with the <code>@workflow.signal</code> decorator.
When the Signal is received, it is logged, and then the agent checks to see if the chat has ended.
If it has, the Signal is dropped as no more processing work should take place. 
This is important, as it handles the edge case of the small amount of time between when the agent finishes, but prior to the Workflow Execution closing.
Then the prompt is added to the end of the <code>prompt_queue</code> for the agent to eventually process.</p>
<h4 id="confirming-the-users-request">Confirming the users request<a class="headerlink" href="#confirming-the-users-request" title="Permanent link">&para;</a></h4>
<p>Another Signal to implement is the user confirming the use of a tool, specifically when <code>SHOW_CONFIRM</code> is set to <code>True</code>.</p>
<p>Add the following Signal handler to the bottom of your file:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-149-1"><a id="__codelineno-149-1" name="__codelineno-149-1" href="#__codelineno-149-1"></a>    <span class="c1"># Signal that comes from api/main.py via a post to /confirm</span>
</span><span id="__span-149-2"><a id="__codelineno-149-2" name="__codelineno-149-2" href="#__codelineno-149-2"></a>    <span class="nd">@workflow</span><span class="o">.</span><span class="n">signal</span>
</span><span id="__span-149-3"><a id="__codelineno-149-3" name="__codelineno-149-3" href="#__codelineno-149-3"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">confirm</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-149-4"><a id="__codelineno-149-4" name="__codelineno-149-4" href="#__codelineno-149-4"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Signal handler for user confirmation of tool execution.&quot;&quot;&quot;</span>
</span><span id="__span-149-5"><a id="__codelineno-149-5" name="__codelineno-149-5" href="#__codelineno-149-5"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received user signal: confirmation&quot;</span><span class="p">)</span>
</span><span id="__span-149-6"><a id="__codelineno-149-6" name="__codelineno-149-6" href="#__codelineno-149-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">=</span> <span class="kc">True</span>
</span></code></pre></div>
<p>This code implements the Signal handler method, decorates it with <code>@workflow.signal</code>, and logs that the Signal was received. 
It then sets the <code>self.confirmed</code> instance variable to <code>True</code>, which will unblock the main agent loop.</p>
<h4 id="ending-the-chat">Ending the chat<a class="headerlink" href="#ending-the-chat" title="Permanent link">&para;</a></h4>
<p>The last Signal handler your agent needs is to allow the user to end the chat.</p>
<p>Add the following Signal handler to the bottom of your file:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-150-1"><a id="__codelineno-150-1" name="__codelineno-150-1" href="#__codelineno-150-1"></a>    <span class="c1"># Signal that comes from api/main.py via a post to /end-chat</span>
</span><span id="__span-150-2"><a id="__codelineno-150-2" name="__codelineno-150-2" href="#__codelineno-150-2"></a>    <span class="nd">@workflow</span><span class="o">.</span><span class="n">signal</span>
</span><span id="__span-150-3"><a id="__codelineno-150-3" name="__codelineno-150-3" href="#__codelineno-150-3"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">end_chat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-150-4"><a id="__codelineno-150-4" name="__codelineno-150-4" href="#__codelineno-150-4"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Signal handler for ending the chat session.&quot;&quot;&quot;</span>
</span><span id="__span-150-5"><a id="__codelineno-150-5" name="__codelineno-150-5" href="#__codelineno-150-5"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;signal received: end_chat&quot;</span><span class="p">)</span>
</span><span id="__span-150-6"><a id="__codelineno-150-6" name="__codelineno-150-6" href="#__codelineno-150-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span> <span class="o">=</span> <span class="kc">True</span>
</span></code></pre></div>
<p>Similar to the previous Signal handler, this is a decorated method that sets an instance variable to <code>True</code>, in this case the <code>self.chat_ended</code> variable.</p>
<p>Sending information to a Workflow may not be the only action you want to do.
You may also want to retrieve some information during its execution.
Temporal provides this capability with <code>Queries</code>.</p>
<h4 id="retrieving-the-conversing-history">Retrieving the conversing history<a class="headerlink" href="#retrieving-the-conversing-history" title="Permanent link">&para;</a></h4>
<p>Implementing a Query is similar to implementing a Signal:
You define a method and decorate it.
However, the method can't be <code>async</code>, and the decorator is <code>@workflow.query</code>.</p>
<p>Add the following Query to the bottom of your file, to retrieve the conversation history:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-151-1"><a id="__codelineno-151-1" name="__codelineno-151-1" href="#__codelineno-151-1"></a>    <span class="nd">@workflow</span><span class="o">.</span><span class="n">query</span>
</span><span id="__span-151-2"><a id="__codelineno-151-2" name="__codelineno-151-2" href="#__codelineno-151-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_conversation_history</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConversationHistory</span><span class="p">:</span>
</span><span id="__span-151-3"><a id="__codelineno-151-3" name="__codelineno-151-3" href="#__codelineno-151-3"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Query handler to retrieve the full conversation history.&quot;&quot;&quot;</span>
</span><span id="__span-151-4"><a id="__codelineno-151-4" name="__codelineno-151-4" href="#__codelineno-151-4"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span>
</span></code></pre></div>
<p>This Query returns the current conversation history that is stored in the <code>self.conversation_history</code> instance variable.</p>
<h4 id="retrieving-the-latest-tool-data">Retrieving the latest tool data<a class="headerlink" href="#retrieving-the-latest-tool-data" title="Permanent link">&para;</a></h4>
<p>The final Query returns the latest tool data.</p>
<p>Add the following code to the bottom of your file to implement it:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-152-1"><a id="__codelineno-152-1" name="__codelineno-152-1" href="#__codelineno-152-1"></a>    <span class="nd">@workflow</span><span class="o">.</span><span class="n">query</span>
</span><span id="__span-152-2"><a id="__codelineno-152-2" name="__codelineno-152-2" href="#__codelineno-152-2"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_latest_tool_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ToolData</span><span class="p">]:</span>
</span><span id="__span-152-3"><a id="__codelineno-152-3" name="__codelineno-152-3" href="#__codelineno-152-3"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Query handler to retrieve the latest tool data response if available.&quot;&quot;&quot;</span>
</span><span id="__span-152-4"><a id="__codelineno-152-4" name="__codelineno-152-4" href="#__codelineno-152-4"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span>
</span></code></pre></div>
<p>This Query returns the current tool data, if available, that is stored in the <code>self.tool_data</code> instance variable.</p>
<p>Your Workflow now has the necessary Signals and Queries for a client API to properly communicate with it and implement a user interface on top of it.</p>
<details>

<summary>
The <code>workflows/agent_goal_workflow.py</code> is complete and will need no more revisions. You can review the complete file and copy the code here.
</summary>

<br />
Hover your cursor over the code block to reveal the copy-code option.
<br />
<br />

[workflows/agent_goal_workflow.py](https://github.com/temporal-community/tutorial-temporal-ai-agent/blob/main/workflows/agent_goal_workflow.py)

<div class="language-python highlight"><pre><span></span><code><span id="__span-153-1"><a id="__codelineno-153-1" name="__codelineno-153-1" href="#__codelineno-153-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
</span><span id="__span-153-2"><a id="__codelineno-153-2" name="__codelineno-153-2" href="#__codelineno-153-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
</span><span id="__span-153-3"><a id="__codelineno-153-3" name="__codelineno-153-3" href="#__codelineno-153-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Deque</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="__span-153-4"><a id="__codelineno-153-4" name="__codelineno-153-4" href="#__codelineno-153-4"></a>
</span><span id="__span-153-5"><a id="__codelineno-153-5" name="__codelineno-153-5" href="#__codelineno-153-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio</span><span class="w"> </span><span class="kn">import</span> <span class="n">workflow</span>
</span><span id="__span-153-6"><a id="__codelineno-153-6" name="__codelineno-153-6" href="#__codelineno-153-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">RetryPolicy</span>
</span><span id="__span-153-7"><a id="__codelineno-153-7" name="__codelineno-153-7" href="#__codelineno-153-7"></a>
</span><span id="__span-153-8"><a id="__codelineno-153-8" name="__codelineno-153-8" href="#__codelineno-153-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentGoal</span>
</span><span id="__span-153-9"><a id="__codelineno-153-9" name="__codelineno-153-9" href="#__codelineno-153-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-153-10"><a id="__codelineno-153-10" name="__codelineno-153-10" href="#__codelineno-153-10"></a>    <span class="n">ConversationHistory</span><span class="p">,</span>
</span><span id="__span-153-11"><a id="__codelineno-153-11" name="__codelineno-153-11" href="#__codelineno-153-11"></a>    <span class="n">CurrentTool</span><span class="p">,</span>
</span><span id="__span-153-12"><a id="__codelineno-153-12" name="__codelineno-153-12" href="#__codelineno-153-12"></a>    <span class="n">EnvLookupInput</span><span class="p">,</span>
</span><span id="__span-153-13"><a id="__codelineno-153-13" name="__codelineno-153-13" href="#__codelineno-153-13"></a>    <span class="n">EnvLookupOutput</span><span class="p">,</span>
</span><span id="__span-153-14"><a id="__codelineno-153-14" name="__codelineno-153-14" href="#__codelineno-153-14"></a>    <span class="n">ToolData</span><span class="p">,</span>
</span><span id="__span-153-15"><a id="__codelineno-153-15" name="__codelineno-153-15" href="#__codelineno-153-15"></a>    <span class="n">ValidationInput</span><span class="p">,</span>
</span><span id="__span-153-16"><a id="__codelineno-153-16" name="__codelineno-153-16" href="#__codelineno-153-16"></a><span class="p">)</span>
</span><span id="__span-153-17"><a id="__codelineno-153-17" name="__codelineno-153-17" href="#__codelineno-153-17"></a><span class="kn">from</span><span class="w"> </span><span class="nn">workflows</span><span class="w"> </span><span class="kn">import</span> <span class="n">workflow_helpers</span> <span class="k">as</span> <span class="n">helpers</span>
</span><span id="__span-153-18"><a id="__codelineno-153-18" name="__codelineno-153-18" href="#__codelineno-153-18"></a><span class="kn">from</span><span class="w"> </span><span class="nn">workflows.workflow_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="__span-153-19"><a id="__codelineno-153-19" name="__codelineno-153-19" href="#__codelineno-153-19"></a>    <span class="n">LLM_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-153-20"><a id="__codelineno-153-20" name="__codelineno-153-20" href="#__codelineno-153-20"></a>    <span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-153-21"><a id="__codelineno-153-21" name="__codelineno-153-21" href="#__codelineno-153-21"></a><span class="p">)</span>
</span><span id="__span-153-22"><a id="__codelineno-153-22" name="__codelineno-153-22" href="#__codelineno-153-22"></a>
</span><span id="__span-153-23"><a id="__codelineno-153-23" name="__codelineno-153-23" href="#__codelineno-153-23"></a><span class="k">with</span> <span class="n">workflow</span><span class="o">.</span><span class="n">unsafe</span><span class="o">.</span><span class="n">imports_passed_through</span><span class="p">():</span>
</span><span id="__span-153-24"><a id="__codelineno-153-24" name="__codelineno-153-24" href="#__codelineno-153-24"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">activities.activities</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentActivities</span>
</span><span id="__span-153-25"><a id="__codelineno-153-25" name="__codelineno-153-25" href="#__codelineno-153-25"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">CombinedInput</span><span class="p">,</span> <span class="n">ToolPromptInput</span>
</span><span id="__span-153-26"><a id="__codelineno-153-26" name="__codelineno-153-26" href="#__codelineno-153-26"></a>    <span class="kn">from</span><span class="w"> </span><span class="nn">prompts.agent_prompt_generators</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_genai_prompt</span>
</span><span id="__span-153-27"><a id="__codelineno-153-27" name="__codelineno-153-27" href="#__codelineno-153-27"></a>
</span><span id="__span-153-28"><a id="__codelineno-153-28" name="__codelineno-153-28" href="#__codelineno-153-28"></a><span class="c1"># Constants</span>
</span><span id="__span-153-29"><a id="__codelineno-153-29" name="__codelineno-153-29" href="#__codelineno-153-29"></a><span class="n">MAX_TURNS_BEFORE_CONTINUE</span> <span class="o">=</span> <span class="mi">250</span>
</span><span id="__span-153-30"><a id="__codelineno-153-30" name="__codelineno-153-30" href="#__codelineno-153-30"></a>
</span><span id="__span-153-31"><a id="__codelineno-153-31" name="__codelineno-153-31" href="#__codelineno-153-31"></a>
</span><span id="__span-153-32"><a id="__codelineno-153-32" name="__codelineno-153-32" href="#__codelineno-153-32"></a><span class="nd">@workflow</span><span class="o">.</span><span class="n">defn</span>
</span><span id="__span-153-33"><a id="__codelineno-153-33" name="__codelineno-153-33" href="#__codelineno-153-33"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentGoalWorkflow</span><span class="p">:</span>
</span><span id="__span-153-34"><a id="__codelineno-153-34" name="__codelineno-153-34" href="#__codelineno-153-34"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Workflow that manages tool execution with user confirmation and conversation history.&quot;&quot;&quot;</span>
</span><span id="__span-153-35"><a id="__codelineno-153-35" name="__codelineno-153-35" href="#__codelineno-153-35"></a>
</span><span id="__span-153-36"><a id="__codelineno-153-36" name="__codelineno-153-36" href="#__codelineno-153-36"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-153-37"><a id="__codelineno-153-37" name="__codelineno-153-37" href="#__codelineno-153-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">:</span> <span class="n">ConversationHistory</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[]}</span>
</span><span id="__span-153-38"><a id="__codelineno-153-38" name="__codelineno-153-38" href="#__codelineno-153-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">:</span> <span class="n">Deque</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
</span><span id="__span-153-39"><a id="__codelineno-153-39" name="__codelineno-153-39" href="#__codelineno-153-39"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-153-40"><a id="__codelineno-153-40" name="__codelineno-153-40" href="#__codelineno-153-40"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ToolData</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-153-41"><a id="__codelineno-153-41" name="__codelineno-153-41" href="#__codelineno-153-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AgentGoal</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-153-42"><a id="__codelineno-153-42" name="__codelineno-153-42" href="#__codelineno-153-42"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_confirm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-153-43"><a id="__codelineno-153-43" name="__codelineno-153-43" href="#__codelineno-153-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">show_tool_args_confirmation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-153-44"><a id="__codelineno-153-44" name="__codelineno-153-44" href="#__codelineno-153-44"></a>            <span class="kc">True</span>  <span class="c1"># set from env file in activity lookup_wf_env_settings</span>
</span><span id="__span-153-45"><a id="__codelineno-153-45" name="__codelineno-153-45" href="#__codelineno-153-45"></a>        <span class="p">)</span>
</span><span id="__span-153-46"><a id="__codelineno-153-46" name="__codelineno-153-46" href="#__codelineno-153-46"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="__span-153-47"><a id="__codelineno-153-47" name="__codelineno-153-47" href="#__codelineno-153-47"></a>            <span class="kc">False</span>  <span class="c1"># indicates that we have confirmation to proceed to run tool</span>
</span><span id="__span-153-48"><a id="__codelineno-153-48" name="__codelineno-153-48" href="#__codelineno-153-48"></a>        <span class="p">)</span>
</span><span id="__span-153-49"><a id="__codelineno-153-49" name="__codelineno-153-49" href="#__codelineno-153-49"></a>
</span><span id="__span-153-50"><a id="__codelineno-153-50" name="__codelineno-153-50" href="#__codelineno-153-50"></a>    <span class="c1"># see ../api/main.py#temporal_client.start_workflow() for how the input parameters are set</span>
</span><span id="__span-153-51"><a id="__codelineno-153-51" name="__codelineno-153-51" href="#__codelineno-153-51"></a>    <span class="nd">@workflow</span><span class="o">.</span><span class="n">run</span>
</span><span id="__span-153-52"><a id="__codelineno-153-52" name="__codelineno-153-52" href="#__codelineno-153-52"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combined_input</span><span class="p">:</span> <span class="n">CombinedInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-153-53"><a id="__codelineno-153-53" name="__codelineno-153-53" href="#__codelineno-153-53"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Main workflow execution method.&quot;&quot;&quot;</span>
</span><span id="__span-153-54"><a id="__codelineno-153-54" name="__codelineno-153-54" href="#__codelineno-153-54"></a>        <span class="c1"># setup phase, starts with blank tool_params and agent_goal prompt as defined in tools/goal_registry.py</span>
</span><span id="__span-153-55"><a id="__codelineno-153-55" name="__codelineno-153-55" href="#__codelineno-153-55"></a>        <span class="n">params</span> <span class="o">=</span> <span class="n">combined_input</span><span class="o">.</span><span class="n">tool_params</span>
</span><span id="__span-153-56"><a id="__codelineno-153-56" name="__codelineno-153-56" href="#__codelineno-153-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">goal</span> <span class="o">=</span> <span class="n">combined_input</span><span class="o">.</span><span class="n">agent_goal</span>
</span><span id="__span-153-57"><a id="__codelineno-153-57" name="__codelineno-153-57" href="#__codelineno-153-57"></a>
</span><span id="__span-153-58"><a id="__codelineno-153-58" name="__codelineno-153-58" href="#__codelineno-153-58"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_wf_env_settings</span><span class="p">()</span>
</span><span id="__span-153-59"><a id="__codelineno-153-59" name="__codelineno-153-59" href="#__codelineno-153-59"></a>
</span><span id="__span-153-60"><a id="__codelineno-153-60" name="__codelineno-153-60" href="#__codelineno-153-60"></a>        <span class="k">if</span> <span class="n">params</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">:</span>
</span><span id="__span-153-61"><a id="__codelineno-153-61" name="__codelineno-153-61" href="#__codelineno-153-61"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">)</span>
</span><span id="__span-153-62"><a id="__codelineno-153-62" name="__codelineno-153-62" href="#__codelineno-153-62"></a>
</span><span id="__span-153-63"><a id="__codelineno-153-63" name="__codelineno-153-63" href="#__codelineno-153-63"></a>        <span class="n">current_tool</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CurrentTool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-153-64"><a id="__codelineno-153-64" name="__codelineno-153-64" href="#__codelineno-153-64"></a>
</span><span id="__span-153-65"><a id="__codelineno-153-65" name="__codelineno-153-65" href="#__codelineno-153-65"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="__span-153-66"><a id="__codelineno-153-66" name="__codelineno-153-66" href="#__codelineno-153-66"></a>            <span class="c1"># wait indefinitely for input from signals - user_prompt, end_chat, or confirm as defined below</span>
</span><span id="__span-153-67"><a id="__codelineno-153-67" name="__codelineno-153-67" href="#__codelineno-153-67"></a>            <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">wait_condition</span><span class="p">(</span>
</span><span id="__span-153-68"><a id="__codelineno-153-68" name="__codelineno-153-68" href="#__codelineno-153-68"></a>                <span class="k">lambda</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span>
</span><span id="__span-153-69"><a id="__codelineno-153-69" name="__codelineno-153-69" href="#__codelineno-153-69"></a>            <span class="p">)</span>
</span><span id="__span-153-70"><a id="__codelineno-153-70" name="__codelineno-153-70" href="#__codelineno-153-70"></a>
</span><span id="__span-153-71"><a id="__codelineno-153-71" name="__codelineno-153-71" href="#__codelineno-153-71"></a>            <span class="c1"># handle chat should end. When chat ends, push conversation history to workflow results.</span>
</span><span id="__span-153-72"><a id="__codelineno-153-72" name="__codelineno-153-72" href="#__codelineno-153-72"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span><span class="p">:</span>
</span><span id="__span-153-73"><a id="__codelineno-153-73" name="__codelineno-153-73" href="#__codelineno-153-73"></a>                <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Chat-end signal received. Chat ending.&quot;</span><span class="p">)</span>
</span><span id="__span-153-74"><a id="__codelineno-153-74" name="__codelineno-153-74" href="#__codelineno-153-74"></a>                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-153-75"><a id="__codelineno-153-75" name="__codelineno-153-75" href="#__codelineno-153-75"></a>
</span><span id="__span-153-76"><a id="__codelineno-153-76" name="__codelineno-153-76" href="#__codelineno-153-76"></a>            <span class="c1"># Execute the tool</span>
</span><span id="__span-153-77"><a id="__codelineno-153-77" name="__codelineno-153-77" href="#__codelineno-153-77"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ready_for_tool_execution</span><span class="p">()</span> <span class="ow">and</span> <span class="n">current_tool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-153-78"><a id="__codelineno-153-78" name="__codelineno-153-78" href="#__codelineno-153-78"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_tool</span><span class="p">(</span><span class="n">current_tool</span><span class="p">)</span>
</span><span id="__span-153-79"><a id="__codelineno-153-79" name="__codelineno-153-79" href="#__codelineno-153-79"></a>                <span class="k">continue</span>
</span><span id="__span-153-80"><a id="__codelineno-153-80" name="__codelineno-153-80" href="#__codelineno-153-80"></a>
</span><span id="__span-153-81"><a id="__codelineno-153-81" name="__codelineno-153-81" href="#__codelineno-153-81"></a>            <span class="c1"># process forward on the prompt queue if any</span>
</span><span id="__span-153-82"><a id="__codelineno-153-82" name="__codelineno-153-82" href="#__codelineno-153-82"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">:</span>
</span><span id="__span-153-83"><a id="__codelineno-153-83" name="__codelineno-153-83" href="#__codelineno-153-83"></a>                <span class="c1"># get most recent prompt</span>
</span><span id="__span-153-84"><a id="__codelineno-153-84" name="__codelineno-153-84" href="#__codelineno-153-84"></a>                <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
</span><span id="__span-153-85"><a id="__codelineno-153-85" name="__codelineno-153-85" href="#__codelineno-153-85"></a>                <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-153-86"><a id="__codelineno-153-86" name="__codelineno-153-86" href="#__codelineno-153-86"></a>                    <span class="sa">f</span><span class="s2">&quot;workflow step: processing message on the prompt queue, message is </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-153-87"><a id="__codelineno-153-87" name="__codelineno-153-87" href="#__codelineno-153-87"></a>                <span class="p">)</span>
</span><span id="__span-153-88"><a id="__codelineno-153-88" name="__codelineno-153-88" href="#__codelineno-153-88"></a>
</span><span id="__span-153-89"><a id="__codelineno-153-89" name="__codelineno-153-89" href="#__codelineno-153-89"></a>                <span class="c1"># Validate user-provided prompts</span>
</span><span id="__span-153-90"><a id="__codelineno-153-90" name="__codelineno-153-90" href="#__codelineno-153-90"></a>                <span class="k">if</span> <span class="n">helpers</span><span class="o">.</span><span class="n">is_user_prompt</span><span class="p">(</span><span class="n">prompt</span><span class="p">):</span>
</span><span id="__span-153-91"><a id="__codelineno-153-91" name="__codelineno-153-91" href="#__codelineno-153-91"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
</span><span id="__span-153-92"><a id="__codelineno-153-92" name="__codelineno-153-92" href="#__codelineno-153-92"></a>
</span><span id="__span-153-93"><a id="__codelineno-153-93" name="__codelineno-153-93" href="#__codelineno-153-93"></a>                    <span class="c1"># Validate the prompt before proceeding</span>
</span><span id="__span-153-94"><a id="__codelineno-153-94" name="__codelineno-153-94" href="#__codelineno-153-94"></a>                    <span class="n">validation_input</span> <span class="o">=</span> <span class="n">ValidationInput</span><span class="p">(</span>
</span><span id="__span-153-95"><a id="__codelineno-153-95" name="__codelineno-153-95" href="#__codelineno-153-95"></a>                        <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
</span><span id="__span-153-96"><a id="__codelineno-153-96" name="__codelineno-153-96" href="#__codelineno-153-96"></a>                        <span class="n">conversation_history</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">,</span>
</span><span id="__span-153-97"><a id="__codelineno-153-97" name="__codelineno-153-97" href="#__codelineno-153-97"></a>                        <span class="n">agent_goal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span>
</span><span id="__span-153-98"><a id="__codelineno-153-98" name="__codelineno-153-98" href="#__codelineno-153-98"></a>                    <span class="p">)</span>
</span><span id="__span-153-99"><a id="__codelineno-153-99" name="__codelineno-153-99" href="#__codelineno-153-99"></a>                    <span class="n">validation_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">execute_activity_method</span><span class="p">(</span>
</span><span id="__span-153-100"><a id="__codelineno-153-100" name="__codelineno-153-100" href="#__codelineno-153-100"></a>                        <span class="n">AgentActivities</span><span class="o">.</span><span class="n">agent_validatePrompt</span><span class="p">,</span>
</span><span id="__span-153-101"><a id="__codelineno-153-101" name="__codelineno-153-101" href="#__codelineno-153-101"></a>                        <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">validation_input</span><span class="p">],</span>
</span><span id="__span-153-102"><a id="__codelineno-153-102" name="__codelineno-153-102" href="#__codelineno-153-102"></a>                        <span class="n">schedule_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-153-103"><a id="__codelineno-153-103" name="__codelineno-153-103" href="#__codelineno-153-103"></a>                        <span class="n">start_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-153-104"><a id="__codelineno-153-104" name="__codelineno-153-104" href="#__codelineno-153-104"></a>                        <span class="n">retry_policy</span><span class="o">=</span><span class="n">RetryPolicy</span><span class="p">(</span>
</span><span id="__span-153-105"><a id="__codelineno-153-105" name="__codelineno-153-105" href="#__codelineno-153-105"></a>                            <span class="n">initial_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">backoff_coefficient</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-153-106"><a id="__codelineno-153-106" name="__codelineno-153-106" href="#__codelineno-153-106"></a>                        <span class="p">),</span>
</span><span id="__span-153-107"><a id="__codelineno-153-107" name="__codelineno-153-107" href="#__codelineno-153-107"></a>                    <span class="p">)</span>
</span><span id="__span-153-108"><a id="__codelineno-153-108" name="__codelineno-153-108" href="#__codelineno-153-108"></a>
</span><span id="__span-153-109"><a id="__codelineno-153-109" name="__codelineno-153-109" href="#__codelineno-153-109"></a>                    <span class="c1"># If validation fails, provide that feedback to the user - i.e., &quot;your words make no sense, puny human&quot; end this iteration of processing</span>
</span><span id="__span-153-110"><a id="__codelineno-153-110" name="__codelineno-153-110" href="#__codelineno-153-110"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">validationResult</span><span class="p">:</span>
</span><span id="__span-153-111"><a id="__codelineno-153-111" name="__codelineno-153-111" href="#__codelineno-153-111"></a>                        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="__span-153-112"><a id="__codelineno-153-112" name="__codelineno-153-112" href="#__codelineno-153-112"></a>                            <span class="sa">f</span><span class="s2">&quot;Prompt validation failed: </span><span class="si">{</span><span class="n">validation_result</span><span class="o">.</span><span class="n">validationFailedReason</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-153-113"><a id="__codelineno-153-113" name="__codelineno-153-113" href="#__codelineno-153-113"></a>                        <span class="p">)</span>
</span><span id="__span-153-114"><a id="__codelineno-153-114" name="__codelineno-153-114" href="#__codelineno-153-114"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span>
</span><span id="__span-153-115"><a id="__codelineno-153-115" name="__codelineno-153-115" href="#__codelineno-153-115"></a>                            <span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">validationFailedReason</span>
</span><span id="__span-153-116"><a id="__codelineno-153-116" name="__codelineno-153-116" href="#__codelineno-153-116"></a>                        <span class="p">)</span>
</span><span id="__span-153-117"><a id="__codelineno-153-117" name="__codelineno-153-117" href="#__codelineno-153-117"></a>                        <span class="k">continue</span>
</span><span id="__span-153-118"><a id="__codelineno-153-118" name="__codelineno-153-118" href="#__codelineno-153-118"></a>
</span><span id="__span-153-119"><a id="__codelineno-153-119" name="__codelineno-153-119" href="#__codelineno-153-119"></a>                <span class="c1"># If valid, proceed with generating the context and prompt</span>
</span><span id="__span-153-120"><a id="__codelineno-153-120" name="__codelineno-153-120" href="#__codelineno-153-120"></a>                <span class="n">context_instructions</span> <span class="o">=</span> <span class="n">generate_genai_prompt</span><span class="p">(</span>
</span><span id="__span-153-121"><a id="__codelineno-153-121" name="__codelineno-153-121" href="#__codelineno-153-121"></a>                    <span class="n">agent_goal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span>
</span><span id="__span-153-122"><a id="__codelineno-153-122" name="__codelineno-153-122" href="#__codelineno-153-122"></a>                    <span class="n">conversation_history</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">,</span>
</span><span id="__span-153-123"><a id="__codelineno-153-123" name="__codelineno-153-123" href="#__codelineno-153-123"></a>                    <span class="n">raw_json</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="p">,</span>
</span><span id="__span-153-124"><a id="__codelineno-153-124" name="__codelineno-153-124" href="#__codelineno-153-124"></a>                <span class="p">)</span>
</span><span id="__span-153-125"><a id="__codelineno-153-125" name="__codelineno-153-125" href="#__codelineno-153-125"></a>
</span><span id="__span-153-126"><a id="__codelineno-153-126" name="__codelineno-153-126" href="#__codelineno-153-126"></a>                <span class="n">prompt_input</span> <span class="o">=</span> <span class="n">ToolPromptInput</span><span class="p">(</span>
</span><span id="__span-153-127"><a id="__codelineno-153-127" name="__codelineno-153-127" href="#__codelineno-153-127"></a>                    <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span> <span class="n">context_instructions</span><span class="o">=</span><span class="n">context_instructions</span>
</span><span id="__span-153-128"><a id="__codelineno-153-128" name="__codelineno-153-128" href="#__codelineno-153-128"></a>                <span class="p">)</span>
</span><span id="__span-153-129"><a id="__codelineno-153-129" name="__codelineno-153-129" href="#__codelineno-153-129"></a>
</span><span id="__span-153-130"><a id="__codelineno-153-130" name="__codelineno-153-130" href="#__codelineno-153-130"></a>                <span class="c1"># connect to LLM and execute to get next steps</span>
</span><span id="__span-153-131"><a id="__codelineno-153-131" name="__codelineno-153-131" href="#__codelineno-153-131"></a>                <span class="n">tool_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">execute_activity_method</span><span class="p">(</span>
</span><span id="__span-153-132"><a id="__codelineno-153-132" name="__codelineno-153-132" href="#__codelineno-153-132"></a>                    <span class="n">AgentActivities</span><span class="o">.</span><span class="n">agent_toolPlanner</span><span class="p">,</span>
</span><span id="__span-153-133"><a id="__codelineno-153-133" name="__codelineno-153-133" href="#__codelineno-153-133"></a>                    <span class="n">prompt_input</span><span class="p">,</span>
</span><span id="__span-153-134"><a id="__codelineno-153-134" name="__codelineno-153-134" href="#__codelineno-153-134"></a>                    <span class="n">schedule_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_SCHEDULE_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-153-135"><a id="__codelineno-153-135" name="__codelineno-153-135" href="#__codelineno-153-135"></a>                    <span class="n">start_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-153-136"><a id="__codelineno-153-136" name="__codelineno-153-136" href="#__codelineno-153-136"></a>                    <span class="n">retry_policy</span><span class="o">=</span><span class="n">RetryPolicy</span><span class="p">(</span>
</span><span id="__span-153-137"><a id="__codelineno-153-137" name="__codelineno-153-137" href="#__codelineno-153-137"></a>                        <span class="n">initial_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">backoff_coefficient</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-153-138"><a id="__codelineno-153-138" name="__codelineno-153-138" href="#__codelineno-153-138"></a>                    <span class="p">),</span>
</span><span id="__span-153-139"><a id="__codelineno-153-139" name="__codelineno-153-139" href="#__codelineno-153-139"></a>                <span class="p">)</span>
</span><span id="__span-153-140"><a id="__codelineno-153-140" name="__codelineno-153-140" href="#__codelineno-153-140"></a>
</span><span id="__span-153-141"><a id="__codelineno-153-141" name="__codelineno-153-141" href="#__codelineno-153-141"></a>                <span class="n">tool_data</span><span class="p">[</span><span class="s2">&quot;force_confirm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_tool_args_confirmation</span>
</span><span id="__span-153-142"><a id="__codelineno-153-142" name="__codelineno-153-142" href="#__codelineno-153-142"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span> <span class="o">=</span> <span class="n">ToolData</span><span class="p">(</span><span class="o">**</span><span class="n">tool_data</span><span class="p">)</span>
</span><span id="__span-153-143"><a id="__codelineno-153-143" name="__codelineno-153-143" href="#__codelineno-153-143"></a>
</span><span id="__span-153-144"><a id="__codelineno-153-144" name="__codelineno-153-144" href="#__codelineno-153-144"></a>                <span class="c1"># process the tool as dictated by the prompt response - what to do next, and with which tool</span>
</span><span id="__span-153-145"><a id="__codelineno-153-145" name="__codelineno-153-145" href="#__codelineno-153-145"></a>                <span class="n">next_step</span> <span class="o">=</span> <span class="n">tool_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;next&quot;</span><span class="p">)</span>
</span><span id="__span-153-146"><a id="__codelineno-153-146" name="__codelineno-153-146" href="#__codelineno-153-146"></a>                <span class="n">current_tool</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CurrentTool</span><span class="p">]</span> <span class="o">=</span> <span class="n">tool_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tool&quot;</span><span class="p">)</span>
</span><span id="__span-153-147"><a id="__codelineno-153-147" name="__codelineno-153-147" href="#__codelineno-153-147"></a>
</span><span id="__span-153-148"><a id="__codelineno-153-148" name="__codelineno-153-148" href="#__codelineno-153-148"></a>                <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-153-149"><a id="__codelineno-153-149" name="__codelineno-153-149" href="#__codelineno-153-149"></a>                    <span class="sa">f</span><span class="s2">&quot;next_step: </span><span class="si">{</span><span class="n">next_step</span><span class="si">}</span><span class="s2">, current tool is </span><span class="si">{</span><span class="n">current_tool</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-153-150"><a id="__codelineno-153-150" name="__codelineno-153-150" href="#__codelineno-153-150"></a>                <span class="p">)</span>
</span><span id="__span-153-151"><a id="__codelineno-153-151" name="__codelineno-153-151" href="#__codelineno-153-151"></a>
</span><span id="__span-153-152"><a id="__codelineno-153-152" name="__codelineno-153-152" href="#__codelineno-153-152"></a>                <span class="c1"># make sure we&#39;re ready to run the tool &amp; have everything we need</span>
</span><span id="__span-153-153"><a id="__codelineno-153-153" name="__codelineno-153-153" href="#__codelineno-153-153"></a>                <span class="k">if</span> <span class="n">next_step</span> <span class="o">==</span> <span class="s2">&quot;confirm&quot;</span> <span class="ow">and</span> <span class="n">current_tool</span><span class="p">:</span>
</span><span id="__span-153-154"><a id="__codelineno-153-154" name="__codelineno-153-154" href="#__codelineno-153-154"></a>                    <span class="n">args</span> <span class="o">=</span> <span class="n">tool_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="__span-153-155"><a id="__codelineno-153-155" name="__codelineno-153-155" href="#__codelineno-153-155"></a>                    <span class="c1"># if we&#39;re missing arguments, ask for them</span>
</span><span id="__span-153-156"><a id="__codelineno-153-156" name="__codelineno-153-156" href="#__codelineno-153-156"></a>                    <span class="k">if</span> <span class="k">await</span> <span class="n">helpers</span><span class="o">.</span><span class="n">handle_missing_args</span><span class="p">(</span>
</span><span id="__span-153-157"><a id="__codelineno-153-157" name="__codelineno-153-157" href="#__codelineno-153-157"></a>                        <span class="n">current_tool</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">tool_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span>
</span><span id="__span-153-158"><a id="__codelineno-153-158" name="__codelineno-153-158" href="#__codelineno-153-158"></a>                    <span class="p">):</span>
</span><span id="__span-153-159"><a id="__codelineno-153-159" name="__codelineno-153-159" href="#__codelineno-153-159"></a>                        <span class="k">continue</span>
</span><span id="__span-153-160"><a id="__codelineno-153-160" name="__codelineno-153-160" href="#__codelineno-153-160"></a>
</span><span id="__span-153-161"><a id="__codelineno-153-161" name="__codelineno-153-161" href="#__codelineno-153-161"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_confirm</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-153-162"><a id="__codelineno-153-162" name="__codelineno-153-162" href="#__codelineno-153-162"></a>
</span><span id="__span-153-163"><a id="__codelineno-153-163" name="__codelineno-153-163" href="#__codelineno-153-163"></a>                    <span class="c1"># We have needed arguments, if we want to force the user to confirm, set that up</span>
</span><span id="__span-153-164"><a id="__codelineno-153-164" name="__codelineno-153-164" href="#__codelineno-153-164"></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_tool_args_confirmation</span><span class="p">:</span>
</span><span id="__span-153-165"><a id="__codelineno-153-165" name="__codelineno-153-165" href="#__codelineno-153-165"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># set that we&#39;re not confirmed</span>
</span><span id="__span-153-166"><a id="__codelineno-153-166" name="__codelineno-153-166" href="#__codelineno-153-166"></a>                        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for user confirm signal...&quot;</span><span class="p">)</span>
</span><span id="__span-153-167"><a id="__codelineno-153-167" name="__codelineno-153-167" href="#__codelineno-153-167"></a>                    <span class="c1"># if we have all needed arguments (handled above) and not holding for a debugging confirm, proceed:</span>
</span><span id="__span-153-168"><a id="__codelineno-153-168" name="__codelineno-153-168" href="#__codelineno-153-168"></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-153-169"><a id="__codelineno-153-169" name="__codelineno-153-169" href="#__codelineno-153-169"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-153-170"><a id="__codelineno-153-170" name="__codelineno-153-170" href="#__codelineno-153-170"></a>
</span><span id="__span-153-171"><a id="__codelineno-153-171" name="__codelineno-153-171" href="#__codelineno-153-171"></a>                <span class="c1"># else if the next step is to be done with the conversation such as if the user requests it via asking to &quot;end conversation&quot;</span>
</span><span id="__span-153-172"><a id="__codelineno-153-172" name="__codelineno-153-172" href="#__codelineno-153-172"></a>                <span class="k">elif</span> <span class="n">next_step</span> <span class="o">==</span> <span class="s2">&quot;done&quot;</span><span class="p">:</span>
</span><span id="__span-153-173"><a id="__codelineno-153-173" name="__codelineno-153-173" href="#__codelineno-153-173"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">tool_data</span><span class="p">)</span>
</span><span id="__span-153-174"><a id="__codelineno-153-174" name="__codelineno-153-174" href="#__codelineno-153-174"></a>
</span><span id="__span-153-175"><a id="__codelineno-153-175" name="__codelineno-153-175" href="#__codelineno-153-175"></a>                    <span class="c1"># here we could send conversation to AI for analysis</span>
</span><span id="__span-153-176"><a id="__codelineno-153-176" name="__codelineno-153-176" href="#__codelineno-153-176"></a>
</span><span id="__span-153-177"><a id="__codelineno-153-177" name="__codelineno-153-177" href="#__codelineno-153-177"></a>                    <span class="c1"># end the workflow</span>
</span><span id="__span-153-178"><a id="__codelineno-153-178" name="__codelineno-153-178" href="#__codelineno-153-178"></a>                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">)</span>
</span><span id="__span-153-179"><a id="__codelineno-153-179" name="__codelineno-153-179" href="#__codelineno-153-179"></a>
</span><span id="__span-153-180"><a id="__codelineno-153-180" name="__codelineno-153-180" href="#__codelineno-153-180"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">tool_data</span><span class="p">)</span>
</span><span id="__span-153-181"><a id="__codelineno-153-181" name="__codelineno-153-181" href="#__codelineno-153-181"></a>                <span class="k">await</span> <span class="n">helpers</span><span class="o">.</span><span class="n">continue_as_new_if_needed</span><span class="p">(</span>
</span><span id="__span-153-182"><a id="__codelineno-153-182" name="__codelineno-153-182" href="#__codelineno-153-182"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">,</span>
</span><span id="__span-153-183"><a id="__codelineno-153-183" name="__codelineno-153-183" href="#__codelineno-153-183"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">,</span>
</span><span id="__span-153-184"><a id="__codelineno-153-184" name="__codelineno-153-184" href="#__codelineno-153-184"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">,</span>
</span><span id="__span-153-185"><a id="__codelineno-153-185" name="__codelineno-153-185" href="#__codelineno-153-185"></a>                    <span class="n">MAX_TURNS_BEFORE_CONTINUE</span><span class="p">,</span>
</span><span id="__span-153-186"><a id="__codelineno-153-186" name="__codelineno-153-186" href="#__codelineno-153-186"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">,</span>
</span><span id="__span-153-187"><a id="__codelineno-153-187" name="__codelineno-153-187" href="#__codelineno-153-187"></a>                <span class="p">)</span>
</span><span id="__span-153-188"><a id="__codelineno-153-188" name="__codelineno-153-188" href="#__codelineno-153-188"></a>
</span><span id="__span-153-189"><a id="__codelineno-153-189" name="__codelineno-153-189" href="#__codelineno-153-189"></a>    <span class="c1"># look up env settings in an activity so they&#39;re part of history</span>
</span><span id="__span-153-190"><a id="__codelineno-153-190" name="__codelineno-153-190" href="#__codelineno-153-190"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lookup_wf_env_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-153-191"><a id="__codelineno-153-191" name="__codelineno-153-191" href="#__codelineno-153-191"></a>        <span class="n">env_lookup_input</span> <span class="o">=</span> <span class="n">EnvLookupInput</span><span class="p">(</span>
</span><span id="__span-153-192"><a id="__codelineno-153-192" name="__codelineno-153-192" href="#__codelineno-153-192"></a>            <span class="n">show_confirm_env_var_name</span><span class="o">=</span><span class="s2">&quot;SHOW_CONFIRM&quot;</span><span class="p">,</span>
</span><span id="__span-153-193"><a id="__codelineno-153-193" name="__codelineno-153-193" href="#__codelineno-153-193"></a>            <span class="n">show_confirm_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-153-194"><a id="__codelineno-153-194" name="__codelineno-153-194" href="#__codelineno-153-194"></a>        <span class="p">)</span>
</span><span id="__span-153-195"><a id="__codelineno-153-195" name="__codelineno-153-195" href="#__codelineno-153-195"></a>        <span class="n">env_output</span><span class="p">:</span> <span class="n">EnvLookupOutput</span> <span class="o">=</span> <span class="k">await</span> <span class="n">workflow</span><span class="o">.</span><span class="n">execute_activity_method</span><span class="p">(</span>
</span><span id="__span-153-196"><a id="__codelineno-153-196" name="__codelineno-153-196" href="#__codelineno-153-196"></a>            <span class="n">AgentActivities</span><span class="o">.</span><span class="n">get_wf_env_vars</span><span class="p">,</span>
</span><span id="__span-153-197"><a id="__codelineno-153-197" name="__codelineno-153-197" href="#__codelineno-153-197"></a>            <span class="n">env_lookup_input</span><span class="p">,</span>
</span><span id="__span-153-198"><a id="__codelineno-153-198" name="__codelineno-153-198" href="#__codelineno-153-198"></a>            <span class="n">start_to_close_timeout</span><span class="o">=</span><span class="n">LLM_ACTIVITY_START_TO_CLOSE_TIMEOUT</span><span class="p">,</span>
</span><span id="__span-153-199"><a id="__codelineno-153-199" name="__codelineno-153-199" href="#__codelineno-153-199"></a>            <span class="n">retry_policy</span><span class="o">=</span><span class="n">RetryPolicy</span><span class="p">(</span>
</span><span id="__span-153-200"><a id="__codelineno-153-200" name="__codelineno-153-200" href="#__codelineno-153-200"></a>                <span class="n">initial_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">backoff_coefficient</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-153-201"><a id="__codelineno-153-201" name="__codelineno-153-201" href="#__codelineno-153-201"></a>            <span class="p">),</span>
</span><span id="__span-153-202"><a id="__codelineno-153-202" name="__codelineno-153-202" href="#__codelineno-153-202"></a>        <span class="p">)</span>
</span><span id="__span-153-203"><a id="__codelineno-153-203" name="__codelineno-153-203" href="#__codelineno-153-203"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">show_tool_args_confirmation</span> <span class="o">=</span> <span class="n">env_output</span><span class="o">.</span><span class="n">show_confirm</span>
</span><span id="__span-153-204"><a id="__codelineno-153-204" name="__codelineno-153-204" href="#__codelineno-153-204"></a>
</span><span id="__span-153-205"><a id="__codelineno-153-205" name="__codelineno-153-205" href="#__codelineno-153-205"></a>    <span class="c1"># define if we&#39;re ready for tool execution</span>
</span><span id="__span-153-206"><a id="__codelineno-153-206" name="__codelineno-153-206" href="#__codelineno-153-206"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ready_for_tool_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="__span-153-207"><a id="__codelineno-153-207" name="__codelineno-153-207" href="#__codelineno-153-207"></a>
</span><span id="__span-153-208"><a id="__codelineno-153-208" name="__codelineno-153-208" href="#__codelineno-153-208"></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="__span-153-209"><a id="__codelineno-153-209" name="__codelineno-153-209" href="#__codelineno-153-209"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_confirm</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="__span-153-210"><a id="__codelineno-153-210" name="__codelineno-153-210" href="#__codelineno-153-210"></a>        <span class="p">)</span>
</span><span id="__span-153-211"><a id="__codelineno-153-211" name="__codelineno-153-211" href="#__codelineno-153-211"></a>
</span><span id="__span-153-212"><a id="__codelineno-153-212" name="__codelineno-153-212" href="#__codelineno-153-212"></a>    <span class="c1"># execute the tool - set self.waiting_for_confirm to False if we&#39;re not waiting for confirm anymore</span>
</span><span id="__span-153-213"><a id="__codelineno-153-213" name="__codelineno-153-213" href="#__codelineno-153-213"></a>    <span class="c1"># (always the case if it works successfully)</span>
</span><span id="__span-153-214"><a id="__codelineno-153-214" name="__codelineno-153-214" href="#__codelineno-153-214"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_tool</span><span class="p">:</span> <span class="n">CurrentTool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-153-215"><a id="__codelineno-153-215" name="__codelineno-153-215" href="#__codelineno-153-215"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="__span-153-216"><a id="__codelineno-153-216" name="__codelineno-153-216" href="#__codelineno-153-216"></a>            <span class="sa">f</span><span class="s2">&quot;workflow step: user has confirmed, executing the tool </span><span class="si">{</span><span class="n">current_tool</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-153-217"><a id="__codelineno-153-217" name="__codelineno-153-217" href="#__codelineno-153-217"></a>        <span class="p">)</span>
</span><span id="__span-153-218"><a id="__codelineno-153-218" name="__codelineno-153-218" href="#__codelineno-153-218"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-153-219"><a id="__codelineno-153-219" name="__codelineno-153-219" href="#__codelineno-153-219"></a>        <span class="n">confirmed_tool_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-153-220"><a id="__codelineno-153-220" name="__codelineno-153-220" href="#__codelineno-153-220"></a>        <span class="n">confirmed_tool_data</span><span class="p">[</span><span class="s2">&quot;next&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;confirm&quot;</span>
</span><span id="__span-153-221"><a id="__codelineno-153-221" name="__codelineno-153-221" href="#__codelineno-153-221"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s2">&quot;user_confirmed_tool_run&quot;</span><span class="p">,</span> <span class="n">confirmed_tool_data</span><span class="p">)</span>
</span><span id="__span-153-222"><a id="__codelineno-153-222" name="__codelineno-153-222" href="#__codelineno-153-222"></a>
</span><span id="__span-153-223"><a id="__codelineno-153-223" name="__codelineno-153-223" href="#__codelineno-153-223"></a>        <span class="c1"># execute the tool by key as defined in tools/__init__.py</span>
</span><span id="__span-153-224"><a id="__codelineno-153-224" name="__codelineno-153-224" href="#__codelineno-153-224"></a>        <span class="k">await</span> <span class="n">helpers</span><span class="o">.</span><span class="n">handle_tool_execution</span><span class="p">(</span>
</span><span id="__span-153-225"><a id="__codelineno-153-225" name="__codelineno-153-225" href="#__codelineno-153-225"></a>            <span class="n">current_tool</span><span class="p">,</span>
</span><span id="__span-153-226"><a id="__codelineno-153-226" name="__codelineno-153-226" href="#__codelineno-153-226"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span><span class="p">,</span>
</span><span id="__span-153-227"><a id="__codelineno-153-227" name="__codelineno-153-227" href="#__codelineno-153-227"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">,</span>
</span><span id="__span-153-228"><a id="__codelineno-153-228" name="__codelineno-153-228" href="#__codelineno-153-228"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="p">,</span>
</span><span id="__span-153-229"><a id="__codelineno-153-229" name="__codelineno-153-229" href="#__codelineno-153-229"></a>        <span class="p">)</span>
</span><span id="__span-153-230"><a id="__codelineno-153-230" name="__codelineno-153-230" href="#__codelineno-153-230"></a>
</span><span id="__span-153-231"><a id="__codelineno-153-231" name="__codelineno-153-231" href="#__codelineno-153-231"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_for_confirm</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-153-232"><a id="__codelineno-153-232" name="__codelineno-153-232" href="#__codelineno-153-232"></a>
</span><span id="__span-153-233"><a id="__codelineno-153-233" name="__codelineno-153-233" href="#__codelineno-153-233"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-153-234"><a id="__codelineno-153-234" name="__codelineno-153-234" href="#__codelineno-153-234"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a message to the conversation history.</span>
</span><span id="__span-153-235"><a id="__codelineno-153-235" name="__codelineno-153-235" href="#__codelineno-153-235"></a>
</span><span id="__span-153-236"><a id="__codelineno-153-236" name="__codelineno-153-236" href="#__codelineno-153-236"></a><span class="sd">        Args:</span>
</span><span id="__span-153-237"><a id="__codelineno-153-237" name="__codelineno-153-237" href="#__codelineno-153-237"></a><span class="sd">            actor: The entity that generated the message (e.g., &quot;user&quot;, &quot;agent&quot;)</span>
</span><span id="__span-153-238"><a id="__codelineno-153-238" name="__codelineno-153-238" href="#__codelineno-153-238"></a><span class="sd">            response: The message content, either as a string or structured data</span>
</span><span id="__span-153-239"><a id="__codelineno-153-239" name="__codelineno-153-239" href="#__codelineno-153-239"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-153-240"><a id="__codelineno-153-240" name="__codelineno-153-240" href="#__codelineno-153-240"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="__span-153-241"><a id="__codelineno-153-241" name="__codelineno-153-241" href="#__codelineno-153-241"></a>            <span class="n">response_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="__span-153-242"><a id="__codelineno-153-242" name="__codelineno-153-242" href="#__codelineno-153-242"></a>            <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">actor</span><span class="si">}</span><span class="s2"> message: </span><span class="si">{</span><span class="n">response_str</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-153-243"><a id="__codelineno-153-243" name="__codelineno-153-243" href="#__codelineno-153-243"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-153-244"><a id="__codelineno-153-244" name="__codelineno-153-244" href="#__codelineno-153-244"></a>            <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">actor</span><span class="si">}</span><span class="s2"> message: </span><span class="si">{</span><span class="n">response</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="__span-153-245"><a id="__codelineno-153-245" name="__codelineno-153-245" href="#__codelineno-153-245"></a>
</span><span id="__span-153-246"><a id="__codelineno-153-246" name="__codelineno-153-246" href="#__codelineno-153-246"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="__span-153-247"><a id="__codelineno-153-247" name="__codelineno-153-247" href="#__codelineno-153-247"></a>            <span class="p">{</span><span class="s2">&quot;actor&quot;</span><span class="p">:</span> <span class="n">actor</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">}</span>
</span><span id="__span-153-248"><a id="__codelineno-153-248" name="__codelineno-153-248" href="#__codelineno-153-248"></a>        <span class="p">)</span>
</span><span id="__span-153-249"><a id="__codelineno-153-249" name="__codelineno-153-249" href="#__codelineno-153-249"></a>
</span><span id="__span-153-250"><a id="__codelineno-153-250" name="__codelineno-153-250" href="#__codelineno-153-250"></a>    <span class="c1"># Signal that comes from api/main.py via a post to /send-prompt</span>
</span><span id="__span-153-251"><a id="__codelineno-153-251" name="__codelineno-153-251" href="#__codelineno-153-251"></a>    <span class="nd">@workflow</span><span class="o">.</span><span class="n">signal</span>
</span><span id="__span-153-252"><a id="__codelineno-153-252" name="__codelineno-153-252" href="#__codelineno-153-252"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">user_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-153-253"><a id="__codelineno-153-253" name="__codelineno-153-253" href="#__codelineno-153-253"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Signal handler for receiving user prompts.&quot;&quot;&quot;</span>
</span><span id="__span-153-254"><a id="__codelineno-153-254" name="__codelineno-153-254" href="#__codelineno-153-254"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;signal received: user_prompt, prompt is </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-153-255"><a id="__codelineno-153-255" name="__codelineno-153-255" href="#__codelineno-153-255"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span><span class="p">:</span>
</span><span id="__span-153-256"><a id="__codelineno-153-256" name="__codelineno-153-256" href="#__codelineno-153-256"></a>            <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message dropped due to chat closed: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-153-257"><a id="__codelineno-153-257" name="__codelineno-153-257" href="#__codelineno-153-257"></a>            <span class="k">return</span>
</span><span id="__span-153-258"><a id="__codelineno-153-258" name="__codelineno-153-258" href="#__codelineno-153-258"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
</span><span id="__span-153-259"><a id="__codelineno-153-259" name="__codelineno-153-259" href="#__codelineno-153-259"></a>
</span><span id="__span-153-260"><a id="__codelineno-153-260" name="__codelineno-153-260" href="#__codelineno-153-260"></a>    <span class="c1"># Signal that comes from api/main.py via a post to /confirm</span>
</span><span id="__span-153-261"><a id="__codelineno-153-261" name="__codelineno-153-261" href="#__codelineno-153-261"></a>    <span class="nd">@workflow</span><span class="o">.</span><span class="n">signal</span>
</span><span id="__span-153-262"><a id="__codelineno-153-262" name="__codelineno-153-262" href="#__codelineno-153-262"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">confirm</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-153-263"><a id="__codelineno-153-263" name="__codelineno-153-263" href="#__codelineno-153-263"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Signal handler for user confirmation of tool execution.&quot;&quot;&quot;</span>
</span><span id="__span-153-264"><a id="__codelineno-153-264" name="__codelineno-153-264" href="#__codelineno-153-264"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received user signal: confirmation&quot;</span><span class="p">)</span>
</span><span id="__span-153-265"><a id="__codelineno-153-265" name="__codelineno-153-265" href="#__codelineno-153-265"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">confirmed</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-153-266"><a id="__codelineno-153-266" name="__codelineno-153-266" href="#__codelineno-153-266"></a>
</span><span id="__span-153-267"><a id="__codelineno-153-267" name="__codelineno-153-267" href="#__codelineno-153-267"></a>    <span class="c1"># Signal that comes from api/main.py via a post to /end-chat</span>
</span><span id="__span-153-268"><a id="__codelineno-153-268" name="__codelineno-153-268" href="#__codelineno-153-268"></a>    <span class="nd">@workflow</span><span class="o">.</span><span class="n">signal</span>
</span><span id="__span-153-269"><a id="__codelineno-153-269" name="__codelineno-153-269" href="#__codelineno-153-269"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">end_chat</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-153-270"><a id="__codelineno-153-270" name="__codelineno-153-270" href="#__codelineno-153-270"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Signal handler for ending the chat session.&quot;&quot;&quot;</span>
</span><span id="__span-153-271"><a id="__codelineno-153-271" name="__codelineno-153-271" href="#__codelineno-153-271"></a>        <span class="n">workflow</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;signal received: end_chat&quot;</span><span class="p">)</span>
</span><span id="__span-153-272"><a id="__codelineno-153-272" name="__codelineno-153-272" href="#__codelineno-153-272"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">chat_ended</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-153-273"><a id="__codelineno-153-273" name="__codelineno-153-273" href="#__codelineno-153-273"></a>
</span><span id="__span-153-274"><a id="__codelineno-153-274" name="__codelineno-153-274" href="#__codelineno-153-274"></a>    <span class="nd">@workflow</span><span class="o">.</span><span class="n">query</span>
</span><span id="__span-153-275"><a id="__codelineno-153-275" name="__codelineno-153-275" href="#__codelineno-153-275"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_conversation_history</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConversationHistory</span><span class="p">:</span>
</span><span id="__span-153-276"><a id="__codelineno-153-276" name="__codelineno-153-276" href="#__codelineno-153-276"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Query handler to retrieve the full conversation history.&quot;&quot;&quot;</span>
</span><span id="__span-153-277"><a id="__codelineno-153-277" name="__codelineno-153-277" href="#__codelineno-153-277"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span>
</span><span id="__span-153-278"><a id="__codelineno-153-278" name="__codelineno-153-278" href="#__codelineno-153-278"></a>
</span><span id="__span-153-279"><a id="__codelineno-153-279" name="__codelineno-153-279" href="#__codelineno-153-279"></a>    <span class="nd">@workflow</span><span class="o">.</span><span class="n">query</span>
</span><span id="__span-153-280"><a id="__codelineno-153-280" name="__codelineno-153-280" href="#__codelineno-153-280"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_latest_tool_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ToolData</span><span class="p">]:</span>
</span><span id="__span-153-281"><a id="__codelineno-153-281" name="__codelineno-153-281" href="#__codelineno-153-281"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Query handler to retrieve the latest tool data response if available.&quot;&quot;&quot;</span>
</span><span id="__span-153-282"><a id="__codelineno-153-282" name="__codelineno-153-282" href="#__codelineno-153-282"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tool_data</span>
</span></code></pre></div>

</details>

<p>This Workflow demonstrates the key patterns for building durable AI agents.
It is event-driven, handling interactions with Signals and Queries, it validates user prompts and implements guardrails, it requires confirmation for tool execution, it maintains state and context across failures, and it's observable. 
The duration of the Workflow Execution is irrelevant.
Thanks to Temporal, the session could go on for minutes, hours, days, or even weeks.</p>
<details>

<summary>
Before moving on to the next section, verify your files and directory structure is correct.
</summary>

<div class="language-text highlight"><pre><span></span><code><span id="__span-154-1"><a id="__codelineno-154-1" name="__codelineno-154-1" href="#__codelineno-154-1"></a>temporal-ai-agent/
</span><span id="__span-154-2"><a id="__codelineno-154-2" name="__codelineno-154-2" href="#__codelineno-154-2"></a>├── .env
</span><span id="__span-154-3"><a id="__codelineno-154-3" name="__codelineno-154-3" href="#__codelineno-154-3"></a>├── .gitignore
</span><span id="__span-154-4"><a id="__codelineno-154-4" name="__codelineno-154-4" href="#__codelineno-154-4"></a>├── .python-version
</span><span id="__span-154-5"><a id="__codelineno-154-5" name="__codelineno-154-5" href="#__codelineno-154-5"></a>├── README.md
</span><span id="__span-154-6"><a id="__codelineno-154-6" name="__codelineno-154-6" href="#__codelineno-154-6"></a>├── pyproject.toml
</span><span id="__span-154-7"><a id="__codelineno-154-7" name="__codelineno-154-7" href="#__codelineno-154-7"></a>├── uv.lock
</span><span id="__span-154-8"><a id="__codelineno-154-8" name="__codelineno-154-8" href="#__codelineno-154-8"></a>├── activities/
</span><span id="__span-154-9"><a id="__codelineno-154-9" name="__codelineno-154-9" href="#__codelineno-154-9"></a>|   ├── __init__.py
</span><span id="__span-154-10"><a id="__codelineno-154-10" name="__codelineno-154-10" href="#__codelineno-154-10"></a>|   └── activities.py
</span><span id="__span-154-11"><a id="__codelineno-154-11" name="__codelineno-154-11" href="#__codelineno-154-11"></a>├── models/
</span><span id="__span-154-12"><a id="__codelineno-154-12" name="__codelineno-154-12" href="#__codelineno-154-12"></a>│   ├── __init__.py
</span><span id="__span-154-13"><a id="__codelineno-154-13" name="__codelineno-154-13" href="#__codelineno-154-13"></a>│   ├── core.py
</span><span id="__span-154-14"><a id="__codelineno-154-14" name="__codelineno-154-14" href="#__codelineno-154-14"></a>│   └── requests.py
</span><span id="__span-154-15"><a id="__codelineno-154-15" name="__codelineno-154-15" href="#__codelineno-154-15"></a>├── prompts/
</span><span id="__span-154-16"><a id="__codelineno-154-16" name="__codelineno-154-16" href="#__codelineno-154-16"></a>│   ├── __init__.py
</span><span id="__span-154-17"><a id="__codelineno-154-17" name="__codelineno-154-17" href="#__codelineno-154-17"></a>│   ├── agent_prompt_generators.py
</span><span id="__span-154-18"><a id="__codelineno-154-18" name="__codelineno-154-18" href="#__codelineno-154-18"></a>│   └── prompts.py
</span><span id="__span-154-19"><a id="__codelineno-154-19" name="__codelineno-154-19" href="#__codelineno-154-19"></a>├── scripts/
</span><span id="__span-154-20"><a id="__codelineno-154-20" name="__codelineno-154-20" href="#__codelineno-154-20"></a>│   ├── create_invoice_test.py
</span><span id="__span-154-21"><a id="__codelineno-154-21" name="__codelineno-154-21" href="#__codelineno-154-21"></a>│   ├── find_events_test.py
</span><span id="__span-154-22"><a id="__codelineno-154-22" name="__codelineno-154-22" href="#__codelineno-154-22"></a>│   └── search_flights_test.py
</span><span id="__span-154-23"><a id="__codelineno-154-23" name="__codelineno-154-23" href="#__codelineno-154-23"></a>├── tools/
</span><span id="__span-154-24"><a id="__codelineno-154-24" name="__codelineno-154-24" href="#__codelineno-154-24"></a>│   ├── __init__.py
</span><span id="__span-154-25"><a id="__codelineno-154-25" name="__codelineno-154-25" href="#__codelineno-154-25"></a>│   ├── create_invoice.py
</span><span id="__span-154-26"><a id="__codelineno-154-26" name="__codelineno-154-26" href="#__codelineno-154-26"></a>│   ├── find_events.py
</span><span id="__span-154-27"><a id="__codelineno-154-27" name="__codelineno-154-27" href="#__codelineno-154-27"></a>│   ├── goal_registry.py
</span><span id="__span-154-28"><a id="__codelineno-154-28" name="__codelineno-154-28" href="#__codelineno-154-28"></a>│   ├── search_flights.py
</span><span id="__span-154-29"><a id="__codelineno-154-29" name="__codelineno-154-29" href="#__codelineno-154-29"></a>│   ├── tool_registry.py
</span><span id="__span-154-30"><a id="__codelineno-154-30" name="__codelineno-154-30" href="#__codelineno-154-30"></a>│   └── data/
</span><span id="__span-154-31"><a id="__codelineno-154-31" name="__codelineno-154-31" href="#__codelineno-154-31"></a>|       └── find_events_data.json
</span><span id="__span-154-32"><a id="__codelineno-154-32" name="__codelineno-154-32" href="#__codelineno-154-32"></a>└── workflows/
</span><span id="__span-154-33"><a id="__codelineno-154-33" name="__codelineno-154-33" href="#__codelineno-154-33"></a>    ├── __init__.py
</span><span id="__span-154-34"><a id="__codelineno-154-34" name="__codelineno-154-34" href="#__codelineno-154-34"></a>    ├── agent_goal_workflow.py
</span><span id="__span-154-35"><a id="__codelineno-154-35" name="__codelineno-154-35" href="#__codelineno-154-35"></a>    └── workflow_helpers.py
</span></code></pre></div>

</details>

<p>In the next section, you will implement the Temporal Worker, which is responsible for executing your Workflow and Activities.</p>
<h2 id="building-the-temporal-worker">Building the Temporal Worker<a class="headerlink" href="#building-the-temporal-worker" title="Permanent link">&para;</a></h2>
<p>Temporal Workflows are not run by executing the <code>agent_goal_workflow.py</code> file.
Workflows, Activities, Signal and Query handling, and all Temporal operations are handled by Temporal <a href="https://docs.temporal.io/workers#worker">Workers</a>.</p>
<h3 id="creating-the-temporal-client">Creating the Temporal client<a class="headerlink" href="#creating-the-temporal-client" title="Permanent link">&para;</a></h3>
<p>A Worker uses a Temporal client to communicate with the Temporal service to coordinate execution.
A Temporal client is also used to request execution of Temporal Workflows.
Since this application will require multiple Temporal clients, you will implement a <code>shared</code> submodule that others can call to create a Temporal client.
This reduces the need for duplicate code and potentially incorrectly setting the Task Queue. </p>
<p>First, create the <code>shared</code> directory and a blank <code>__init__.py</code> file to create the submodule:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-155-1"><a id="__codelineno-155-1" name="__codelineno-155-1" href="#__codelineno-155-1"></a>mkdir<span class="w"> </span>shared
</span><span id="__span-155-2"><a id="__codelineno-155-2" name="__codelineno-155-2" href="#__codelineno-155-2"></a>touch<span class="w"> </span>shared/__init__.py
</span></code></pre></div>
<p>Next, create the file <code>config.py</code> within the <code>shared</code> directory and add the following <code>import</code> statements:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-156-1"><a id="__codelineno-156-1" name="__codelineno-156-1" href="#__codelineno-156-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-156-2"><a id="__codelineno-156-2" name="__codelineno-156-2" href="#__codelineno-156-2"></a>
</span><span id="__span-156-3"><a id="__codelineno-156-3" name="__codelineno-156-3" href="#__codelineno-156-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
</span><span id="__span-156-4"><a id="__codelineno-156-4" name="__codelineno-156-4" href="#__codelineno-156-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.client</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>
</span><span id="__span-156-5"><a id="__codelineno-156-5" name="__codelineno-156-5" href="#__codelineno-156-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.service</span><span class="w"> </span><span class="kn">import</span> <span class="n">TLSConfig</span>
</span></code></pre></div>
<p>You'll then load in the environment variables you specified earlier. 
If you are running this tutorial using the local development server, these are commented out in your <code>.env</code> file and will use the default settings.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-157-1"><a id="__codelineno-157-1" name="__codelineno-157-1" href="#__codelineno-157-1"></a><span class="n">load_dotenv</span><span class="p">(</span><span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-157-2"><a id="__codelineno-157-2" name="__codelineno-157-2" href="#__codelineno-157-2"></a>
</span><span id="__span-157-3"><a id="__codelineno-157-3" name="__codelineno-157-3" href="#__codelineno-157-3"></a><span class="c1"># Temporal connection settings</span>
</span><span id="__span-157-4"><a id="__codelineno-157-4" name="__codelineno-157-4" href="#__codelineno-157-4"></a><span class="n">TEMPORAL_ADDRESS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TEMPORAL_ADDRESS&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost:7233&quot;</span><span class="p">)</span>
</span><span id="__span-157-5"><a id="__codelineno-157-5" name="__codelineno-157-5" href="#__codelineno-157-5"></a><span class="n">TEMPORAL_NAMESPACE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TEMPORAL_NAMESPACE&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span>
</span><span id="__span-157-6"><a id="__codelineno-157-6" name="__codelineno-157-6" href="#__codelineno-157-6"></a><span class="n">TEMPORAL_TASK_QUEUE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TEMPORAL_TASK_QUEUE&quot;</span><span class="p">,</span> <span class="s2">&quot;agent-task-queue&quot;</span><span class="p">)</span>
</span><span id="__span-157-7"><a id="__codelineno-157-7" name="__codelineno-157-7" href="#__codelineno-157-7"></a>
</span><span id="__span-157-8"><a id="__codelineno-157-8" name="__codelineno-157-8" href="#__codelineno-157-8"></a><span class="c1"># Authentication settings</span>
</span><span id="__span-157-9"><a id="__codelineno-157-9" name="__codelineno-157-9" href="#__codelineno-157-9"></a><span class="n">TEMPORAL_TLS_CERT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TEMPORAL_TLS_CERT&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-157-10"><a id="__codelineno-157-10" name="__codelineno-157-10" href="#__codelineno-157-10"></a><span class="n">TEMPORAL_TLS_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TEMPORAL_TLS_KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-157-11"><a id="__codelineno-157-11" name="__codelineno-157-11" href="#__codelineno-157-11"></a><span class="n">TEMPORAL_API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TEMPORAL_API_KEY&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>Finally, add the code to configure a Temporal client:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-158-1"><a id="__codelineno-158-1" name="__codelineno-158-1" href="#__codelineno-158-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_temporal_client</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Client</span><span class="p">:</span>
</span><span id="__span-158-2"><a id="__codelineno-158-2" name="__codelineno-158-2" href="#__codelineno-158-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-158-3"><a id="__codelineno-158-3" name="__codelineno-158-3" href="#__codelineno-158-3"></a><span class="sd">    Creates a Temporal client based on environment configuration.</span>
</span><span id="__span-158-4"><a id="__codelineno-158-4" name="__codelineno-158-4" href="#__codelineno-158-4"></a><span class="sd">    Supports local server, mTLS, and API key authentication methods.</span>
</span><span id="__span-158-5"><a id="__codelineno-158-5" name="__codelineno-158-5" href="#__codelineno-158-5"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-158-6"><a id="__codelineno-158-6" name="__codelineno-158-6" href="#__codelineno-158-6"></a>    <span class="c1"># Default to no TLS for local development</span>
</span><span id="__span-158-7"><a id="__codelineno-158-7" name="__codelineno-158-7" href="#__codelineno-158-7"></a>    <span class="n">tls_config</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-158-8"><a id="__codelineno-158-8" name="__codelineno-158-8" href="#__codelineno-158-8"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Address: </span><span class="si">{</span><span class="n">TEMPORAL_ADDRESS</span><span class="si">}</span><span class="s2">, Namespace </span><span class="si">{</span><span class="n">TEMPORAL_NAMESPACE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-158-9"><a id="__codelineno-158-9" name="__codelineno-158-9" href="#__codelineno-158-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(If unset, then will try to connect to local server)&quot;</span><span class="p">)</span>
</span><span id="__span-158-10"><a id="__codelineno-158-10" name="__codelineno-158-10" href="#__codelineno-158-10"></a>
</span><span id="__span-158-11"><a id="__codelineno-158-11" name="__codelineno-158-11" href="#__codelineno-158-11"></a>    <span class="c1"># Configure mTLS if certificate and key are provided</span>
</span><span id="__span-158-12"><a id="__codelineno-158-12" name="__codelineno-158-12" href="#__codelineno-158-12"></a>    <span class="k">if</span> <span class="n">TEMPORAL_TLS_CERT</span> <span class="ow">and</span> <span class="n">TEMPORAL_TLS_KEY</span><span class="p">:</span>
</span><span id="__span-158-13"><a id="__codelineno-158-13" name="__codelineno-158-13" href="#__codelineno-158-13"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TLS cert: </span><span class="si">{</span><span class="n">TEMPORAL_TLS_CERT</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-158-14"><a id="__codelineno-158-14" name="__codelineno-158-14" href="#__codelineno-158-14"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TLS key: </span><span class="si">{</span><span class="n">TEMPORAL_TLS_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-158-15"><a id="__codelineno-158-15" name="__codelineno-158-15" href="#__codelineno-158-15"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TEMPORAL_TLS_CERT</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="__span-158-16"><a id="__codelineno-158-16" name="__codelineno-158-16" href="#__codelineno-158-16"></a>            <span class="n">client_cert</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="__span-158-17"><a id="__codelineno-158-17" name="__codelineno-158-17" href="#__codelineno-158-17"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TEMPORAL_TLS_KEY</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="__span-158-18"><a id="__codelineno-158-18" name="__codelineno-158-18" href="#__codelineno-158-18"></a>            <span class="n">client_key</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="__span-158-19"><a id="__codelineno-158-19" name="__codelineno-158-19" href="#__codelineno-158-19"></a>        <span class="n">tls_config</span> <span class="o">=</span> <span class="n">TLSConfig</span><span class="p">(</span>
</span><span id="__span-158-20"><a id="__codelineno-158-20" name="__codelineno-158-20" href="#__codelineno-158-20"></a>            <span class="n">client_cert</span><span class="o">=</span><span class="n">client_cert</span><span class="p">,</span>
</span><span id="__span-158-21"><a id="__codelineno-158-21" name="__codelineno-158-21" href="#__codelineno-158-21"></a>            <span class="n">client_private_key</span><span class="o">=</span><span class="n">client_key</span><span class="p">,</span>
</span><span id="__span-158-22"><a id="__codelineno-158-22" name="__codelineno-158-22" href="#__codelineno-158-22"></a>        <span class="p">)</span>
</span><span id="__span-158-23"><a id="__codelineno-158-23" name="__codelineno-158-23" href="#__codelineno-158-23"></a>
</span><span id="__span-158-24"><a id="__codelineno-158-24" name="__codelineno-158-24" href="#__codelineno-158-24"></a>    <span class="c1"># Use API key authentication if provided</span>
</span><span id="__span-158-25"><a id="__codelineno-158-25" name="__codelineno-158-25" href="#__codelineno-158-25"></a>    <span class="k">if</span> <span class="n">TEMPORAL_API_KEY</span><span class="p">:</span>
</span><span id="__span-158-26"><a id="__codelineno-158-26" name="__codelineno-158-26" href="#__codelineno-158-26"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API key: </span><span class="si">{</span><span class="n">TEMPORAL_API_KEY</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-158-27"><a id="__codelineno-158-27" name="__codelineno-158-27" href="#__codelineno-158-27"></a>        <span class="k">return</span> <span class="k">await</span> <span class="n">Client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
</span><span id="__span-158-28"><a id="__codelineno-158-28" name="__codelineno-158-28" href="#__codelineno-158-28"></a>            <span class="n">TEMPORAL_ADDRESS</span><span class="p">,</span>
</span><span id="__span-158-29"><a id="__codelineno-158-29" name="__codelineno-158-29" href="#__codelineno-158-29"></a>            <span class="n">namespace</span><span class="o">=</span><span class="n">TEMPORAL_NAMESPACE</span><span class="p">,</span>
</span><span id="__span-158-30"><a id="__codelineno-158-30" name="__codelineno-158-30" href="#__codelineno-158-30"></a>            <span class="n">api_key</span><span class="o">=</span><span class="n">TEMPORAL_API_KEY</span><span class="p">,</span>
</span><span id="__span-158-31"><a id="__codelineno-158-31" name="__codelineno-158-31" href="#__codelineno-158-31"></a>            <span class="n">tls</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Always use TLS with API key</span>
</span><span id="__span-158-32"><a id="__codelineno-158-32" name="__codelineno-158-32" href="#__codelineno-158-32"></a>        <span class="p">)</span>
</span><span id="__span-158-33"><a id="__codelineno-158-33" name="__codelineno-158-33" href="#__codelineno-158-33"></a>
</span><span id="__span-158-34"><a id="__codelineno-158-34" name="__codelineno-158-34" href="#__codelineno-158-34"></a>    <span class="c1"># Use mTLS or local connection</span>
</span><span id="__span-158-35"><a id="__codelineno-158-35" name="__codelineno-158-35" href="#__codelineno-158-35"></a>    <span class="k">return</span> <span class="k">await</span> <span class="n">Client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
</span><span id="__span-158-36"><a id="__codelineno-158-36" name="__codelineno-158-36" href="#__codelineno-158-36"></a>        <span class="n">TEMPORAL_ADDRESS</span><span class="p">,</span>
</span><span id="__span-158-37"><a id="__codelineno-158-37" name="__codelineno-158-37" href="#__codelineno-158-37"></a>        <span class="n">namespace</span><span class="o">=</span><span class="n">TEMPORAL_NAMESPACE</span><span class="p">,</span>
</span><span id="__span-158-38"><a id="__codelineno-158-38" name="__codelineno-158-38" href="#__codelineno-158-38"></a>        <span class="n">tls</span><span class="o">=</span><span class="n">tls_config</span><span class="p">,</span>
</span><span id="__span-158-39"><a id="__codelineno-158-39" name="__codelineno-158-39" href="#__codelineno-158-39"></a>    <span class="p">)</span>
</span></code></pre></div>
<p>This code checks whether or not you configured TLS certs for secure connection or a Temporal API key for connection to Temporal Cloud.
It then returns a configured Temporal client, ready to communicate with the Temporal service.</p>
<h3 id="configuring-the-worker">Configuring the Worker<a class="headerlink" href="#configuring-the-worker" title="Permanent link">&para;</a></h3>
<p>Now that you have a reusable way of creating a Temporal client, you can use that to configure your Temporal Worker.</p>
<p>Start by creating the <code>worker</code> directory:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-159-1"><a id="__codelineno-159-1" name="__codelineno-159-1" href="#__codelineno-159-1"></a>mkdir<span class="w"> </span>worker
</span></code></pre></div>
<p>Then, create the file <code>worker.py</code> in the <code>worker</code> directory and add the following <code>import</code> statements:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-160-1"><a id="__codelineno-160-1" name="__codelineno-160-1" href="#__codelineno-160-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-160-2"><a id="__codelineno-160-2" name="__codelineno-160-2" href="#__codelineno-160-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">concurrent.futures</span>
</span><span id="__span-160-3"><a id="__codelineno-160-3" name="__codelineno-160-3" href="#__codelineno-160-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-160-4"><a id="__codelineno-160-4" name="__codelineno-160-4" href="#__codelineno-160-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-160-5"><a id="__codelineno-160-5" name="__codelineno-160-5" href="#__codelineno-160-5"></a>
</span><span id="__span-160-6"><a id="__codelineno-160-6" name="__codelineno-160-6" href="#__codelineno-160-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
</span><span id="__span-160-7"><a id="__codelineno-160-7" name="__codelineno-160-7" href="#__codelineno-160-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.worker</span><span class="w"> </span><span class="kn">import</span> <span class="n">Worker</span>
</span><span id="__span-160-8"><a id="__codelineno-160-8" name="__codelineno-160-8" href="#__codelineno-160-8"></a>
</span><span id="__span-160-9"><a id="__codelineno-160-9" name="__codelineno-160-9" href="#__codelineno-160-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">activities.activities</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentActivities</span><span class="p">,</span> <span class="n">dynamic_tool_activity</span>
</span><span id="__span-160-10"><a id="__codelineno-160-10" name="__codelineno-160-10" href="#__codelineno-160-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">shared.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">TEMPORAL_TASK_QUEUE</span><span class="p">,</span> <span class="n">get_temporal_client</span>
</span><span id="__span-160-11"><a id="__codelineno-160-11" name="__codelineno-160-11" href="#__codelineno-160-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">workflows.agent_goal_workflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentGoalWorkflow</span>
</span></code></pre></div>
<p>These <code>import</code> statements include libraries from the standard library, third-party packages such as <code>dotenv</code> and the <code>temporalio.worker</code> library, as well as a few of the libraries you implemented.
A Worker must register the Workflows and Activities it intends to execute, so it must import them, as well as the function for creating the Temporal client.</p>
<p>Next, create the <code>main</code> method and add the code responsible for initializing a few variables, including creating the Temporal client and creating an instance of your <code>AgentActivities</code> class.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-161-1"><a id="__codelineno-161-1" name="__codelineno-161-1" href="#__codelineno-161-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
</span><span id="__span-161-2"><a id="__codelineno-161-2" name="__codelineno-161-2" href="#__codelineno-161-2"></a>    <span class="c1"># Load environment variables</span>
</span><span id="__span-161-3"><a id="__codelineno-161-3" name="__codelineno-161-3" href="#__codelineno-161-3"></a>    <span class="n">load_dotenv</span><span class="p">(</span><span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-161-4"><a id="__codelineno-161-4" name="__codelineno-161-4" href="#__codelineno-161-4"></a>
</span><span id="__span-161-5"><a id="__codelineno-161-5" name="__codelineno-161-5" href="#__codelineno-161-5"></a>    <span class="c1"># Print LLM configuration info</span>
</span><span id="__span-161-6"><a id="__codelineno-161-6" name="__codelineno-161-6" href="#__codelineno-161-6"></a>    <span class="n">llm_model</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LLM_MODEL&quot;</span><span class="p">,</span> <span class="s2">&quot;openai/gpt-4&quot;</span><span class="p">)</span>
</span><span id="__span-161-7"><a id="__codelineno-161-7" name="__codelineno-161-7" href="#__codelineno-161-7"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Worker will use LLM model: </span><span class="si">{</span><span class="n">llm_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-161-8"><a id="__codelineno-161-8" name="__codelineno-161-8" href="#__codelineno-161-8"></a>
</span><span id="__span-161-9"><a id="__codelineno-161-9" name="__codelineno-161-9" href="#__codelineno-161-9"></a>    <span class="c1"># Create the client</span>
</span><span id="__span-161-10"><a id="__codelineno-161-10" name="__codelineno-161-10" href="#__codelineno-161-10"></a>    <span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_temporal_client</span><span class="p">()</span>
</span><span id="__span-161-11"><a id="__codelineno-161-11" name="__codelineno-161-11" href="#__codelineno-161-11"></a>
</span><span id="__span-161-12"><a id="__codelineno-161-12" name="__codelineno-161-12" href="#__codelineno-161-12"></a>    <span class="c1"># Initialize the activities class</span>
</span><span id="__span-161-13"><a id="__codelineno-161-13" name="__codelineno-161-13" href="#__codelineno-161-13"></a>    <span class="n">activities</span> <span class="o">=</span> <span class="n">AgentActivities</span><span class="p">()</span>
</span><span id="__span-161-14"><a id="__codelineno-161-14" name="__codelineno-161-14" href="#__codelineno-161-14"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AgentActivities initialized with LLM model: </span><span class="si">{</span><span class="n">llm_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-161-15"><a id="__codelineno-161-15" name="__codelineno-161-15" href="#__codelineno-161-15"></a>
</span><span id="__span-161-16"><a id="__codelineno-161-16" name="__codelineno-161-16" href="#__codelineno-161-16"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Worker ready to process tasks!&quot;</span><span class="p">)</span>
</span><span id="__span-161-17"><a id="__codelineno-161-17" name="__codelineno-161-17" href="#__codelineno-161-17"></a>    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">)</span>
</span></code></pre></div>
<p>This code loads the in the environment variables from your <code>.env</code> file.
It uses the <code>LLM_MODEL</code> environment variable to print which model the agent will call, defaulting to OpenAI's GPT-4 if none is set.
It then creates a Temporal client, and an instance of your <code>AgentActivities</code> class before setting the log level to <code>WARN</code>.</p>
<p>Finally, add the code to configure and start your Worker:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-162-1"><a id="__codelineno-162-1" name="__codelineno-162-1" href="#__codelineno-162-1"></a>    <span class="c1"># Run the worker</span>
</span><span id="__span-162-2"><a id="__codelineno-162-2" name="__codelineno-162-2" href="#__codelineno-162-2"></a>    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="k">as</span> <span class="n">activity_executor</span><span class="p">:</span>
</span><span id="__span-162-3"><a id="__codelineno-162-3" name="__codelineno-162-3" href="#__codelineno-162-3"></a>        <span class="n">worker</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">(</span>
</span><span id="__span-162-4"><a id="__codelineno-162-4" name="__codelineno-162-4" href="#__codelineno-162-4"></a>            <span class="n">client</span><span class="p">,</span>
</span><span id="__span-162-5"><a id="__codelineno-162-5" name="__codelineno-162-5" href="#__codelineno-162-5"></a>            <span class="n">task_queue</span><span class="o">=</span><span class="n">TEMPORAL_TASK_QUEUE</span><span class="p">,</span>
</span><span id="__span-162-6"><a id="__codelineno-162-6" name="__codelineno-162-6" href="#__codelineno-162-6"></a>            <span class="n">workflows</span><span class="o">=</span><span class="p">[</span><span class="n">AgentGoalWorkflow</span><span class="p">],</span>
</span><span id="__span-162-7"><a id="__codelineno-162-7" name="__codelineno-162-7" href="#__codelineno-162-7"></a>            <span class="n">activities</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-162-8"><a id="__codelineno-162-8" name="__codelineno-162-8" href="#__codelineno-162-8"></a>                <span class="n">activities</span><span class="o">.</span><span class="n">agent_validatePrompt</span><span class="p">,</span>
</span><span id="__span-162-9"><a id="__codelineno-162-9" name="__codelineno-162-9" href="#__codelineno-162-9"></a>                <span class="n">activities</span><span class="o">.</span><span class="n">agent_toolPlanner</span><span class="p">,</span>
</span><span id="__span-162-10"><a id="__codelineno-162-10" name="__codelineno-162-10" href="#__codelineno-162-10"></a>                <span class="n">activities</span><span class="o">.</span><span class="n">get_wf_env_vars</span><span class="p">,</span>
</span><span id="__span-162-11"><a id="__codelineno-162-11" name="__codelineno-162-11" href="#__codelineno-162-11"></a>                <span class="n">dynamic_tool_activity</span><span class="p">,</span>
</span><span id="__span-162-12"><a id="__codelineno-162-12" name="__codelineno-162-12" href="#__codelineno-162-12"></a>            <span class="p">],</span>
</span><span id="__span-162-13"><a id="__codelineno-162-13" name="__codelineno-162-13" href="#__codelineno-162-13"></a>            <span class="n">activity_executor</span><span class="o">=</span><span class="n">activity_executor</span><span class="p">,</span>
</span><span id="__span-162-14"><a id="__codelineno-162-14" name="__codelineno-162-14" href="#__codelineno-162-14"></a>        <span class="p">)</span>
</span><span id="__span-162-15"><a id="__codelineno-162-15" name="__codelineno-162-15" href="#__codelineno-162-15"></a>
</span><span id="__span-162-16"><a id="__codelineno-162-16" name="__codelineno-162-16" href="#__codelineno-162-16"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting worker, connecting to task queue: </span><span class="si">{</span><span class="n">TEMPORAL_TASK_QUEUE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-162-17"><a id="__codelineno-162-17" name="__codelineno-162-17" href="#__codelineno-162-17"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ready to begin processing...&quot;</span><span class="p">)</span>
</span><span id="__span-162-18"><a id="__codelineno-162-18" name="__codelineno-162-18" href="#__codelineno-162-18"></a>        <span class="k">await</span> <span class="n">worker</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span><span id="__span-162-19"><a id="__codelineno-162-19" name="__codelineno-162-19" href="#__codelineno-162-19"></a>
</span><span id="__span-162-20"><a id="__codelineno-162-20" name="__codelineno-162-20" href="#__codelineno-162-20"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-162-21"><a id="__codelineno-162-21" name="__codelineno-162-21" href="#__codelineno-162-21"></a>    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</span></code></pre></div>
<p>The code creates a <code>ThreadPoolExecutor</code> for the Worker to use as the <code>activity_executor</code>.
Since an agent's tools can be either <code>async</code> or not, you must use one of the synchronous safe methods for Activity execution.
You can read more about this in <a href="https://docs.temporal.io/develop/python/python-sdk-sync-vs-async">the Python SDK documentation</a>.</p>
<p>Next, the Worker object is created, passing in the <code>client</code>, the <code>task_queue</code>, the <code>activity_executor</code>, and then registering the individual Workflows and Activities the Worker can execute.
The Worker is then started with <code>await worker.run()</code>, which creates a long-running process that will poll the Temporal service, executing Workflow and Activities when they are requested.</p>
<p>Finally, the standard <code>if __name__ == "__main__"</code> calls the main function when you run <code>worker.py</code>, starting the Worker.</p>
<p>Now that you have implemented your Worker, verify that it runs.</p>
<h3 id="testing-the-worker">Testing the Worker<a class="headerlink" href="#testing-the-worker" title="Permanent link">&para;</a></h3>
<p>Before starting the Worker, you need to start a Temporal service. 
To start the local development server, open a terminal and run the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-163-1"><a id="__codelineno-163-1" name="__codelineno-163-1" href="#__codelineno-163-1"></a>temporal<span class="w"> </span>server<span class="w"> </span>start-dev
</span></code></pre></div>
<p>This starts a local Temporal service running on port 7233 with the web UI running on port 8233.
The output of this command should resemble (The exact version numbers may not match):</p>
<div class="language-output highlight"><pre><span></span><code><span id="__span-164-1"><a id="__codelineno-164-1" name="__codelineno-164-1" href="#__codelineno-164-1"></a><span class="go">CLI 1.1.1 (Server 1.25.1, UI 2.31.2)</span>
</span><span id="__span-164-2"><a id="__codelineno-164-2" name="__codelineno-164-2" href="#__codelineno-164-2"></a>
</span><span id="__span-164-3"><a id="__codelineno-164-3" name="__codelineno-164-3" href="#__codelineno-164-3"></a><span class="go">Server:  localhost:7233</span>
</span><span id="__span-164-4"><a id="__codelineno-164-4" name="__codelineno-164-4" href="#__codelineno-164-4"></a><span class="go">UI:      http://localhost:8233</span>
</span><span id="__span-164-5"><a id="__codelineno-164-5" name="__codelineno-164-5" href="#__codelineno-164-5"></a><span class="go">Metrics: http://localhost:53697/metrics</span>
</span></code></pre></div>
<p>Next, open another terminal and run your Worker:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-165-1"><a id="__codelineno-165-1" name="__codelineno-165-1" href="#__codelineno-165-1"></a>uv<span class="w"> </span>run<span class="w"> </span>worker/worker.py
</span></code></pre></div>
<p>Your Worker should start, and the output should be:</p>
<div class="language-output highlight"><pre><span></span><code><span id="__span-166-1"><a id="__codelineno-166-1" name="__codelineno-166-1" href="#__codelineno-166-1"></a><span class="go">Worker will use LLM model: openai/gpt-4o</span>
</span><span id="__span-166-2"><a id="__codelineno-166-2" name="__codelineno-166-2" href="#__codelineno-166-2"></a><span class="go">Address: localhost:7233, Namespace default</span>
</span><span id="__span-166-3"><a id="__codelineno-166-3" name="__codelineno-166-3" href="#__codelineno-166-3"></a><span class="go">(If unset, then will try to connect to local server)</span>
</span><span id="__span-166-4"><a id="__codelineno-166-4" name="__codelineno-166-4" href="#__codelineno-166-4"></a><span class="go">AgentActivities initialized with LLM model: openai/gpt-4o</span>
</span><span id="__span-166-5"><a id="__codelineno-166-5" name="__codelineno-166-5" href="#__codelineno-166-5"></a><span class="go">Worker ready to process tasks!</span>
</span><span id="__span-166-6"><a id="__codelineno-166-6" name="__codelineno-166-6" href="#__codelineno-166-6"></a><span class="go">Starting worker, connecting to task queue: agent-task-queue</span>
</span><span id="__span-166-7"><a id="__codelineno-166-7" name="__codelineno-166-7" href="#__codelineno-166-7"></a><span class="go">Ready to begin processing...</span>
</span></code></pre></div>
<p>The command will not exit, but will persist; this is expected.
It is waiting for Workflows and Activity tasks to execute.
If your Worker is running successfully, that's as much as you can test for the moment.
Kill both the worker and Temporal service by pressing <code>CTRL-C</code> in each terminal.</p>
<details>

<summary>
Before moving on to the next section, verify that your files and directory structure are correct.
</summary>

<div class="language-text highlight"><pre><span></span><code><span id="__span-167-1"><a id="__codelineno-167-1" name="__codelineno-167-1" href="#__codelineno-167-1"></a>temporal-ai-agent/
</span><span id="__span-167-2"><a id="__codelineno-167-2" name="__codelineno-167-2" href="#__codelineno-167-2"></a>├── .env
</span><span id="__span-167-3"><a id="__codelineno-167-3" name="__codelineno-167-3" href="#__codelineno-167-3"></a>├── .gitignore
</span><span id="__span-167-4"><a id="__codelineno-167-4" name="__codelineno-167-4" href="#__codelineno-167-4"></a>├── .python-version
</span><span id="__span-167-5"><a id="__codelineno-167-5" name="__codelineno-167-5" href="#__codelineno-167-5"></a>├── README.md
</span><span id="__span-167-6"><a id="__codelineno-167-6" name="__codelineno-167-6" href="#__codelineno-167-6"></a>├── pyproject.toml
</span><span id="__span-167-7"><a id="__codelineno-167-7" name="__codelineno-167-7" href="#__codelineno-167-7"></a>├── uv.lock
</span><span id="__span-167-8"><a id="__codelineno-167-8" name="__codelineno-167-8" href="#__codelineno-167-8"></a>├── activities/
</span><span id="__span-167-9"><a id="__codelineno-167-9" name="__codelineno-167-9" href="#__codelineno-167-9"></a>|   ├── __init__.py
</span><span id="__span-167-10"><a id="__codelineno-167-10" name="__codelineno-167-10" href="#__codelineno-167-10"></a>|   └── activities.py
</span><span id="__span-167-11"><a id="__codelineno-167-11" name="__codelineno-167-11" href="#__codelineno-167-11"></a>├── models/
</span><span id="__span-167-12"><a id="__codelineno-167-12" name="__codelineno-167-12" href="#__codelineno-167-12"></a>│   ├── __init__.py
</span><span id="__span-167-13"><a id="__codelineno-167-13" name="__codelineno-167-13" href="#__codelineno-167-13"></a>│   ├── core.py
</span><span id="__span-167-14"><a id="__codelineno-167-14" name="__codelineno-167-14" href="#__codelineno-167-14"></a>│   └── requests.py
</span><span id="__span-167-15"><a id="__codelineno-167-15" name="__codelineno-167-15" href="#__codelineno-167-15"></a>├── prompts/
</span><span id="__span-167-16"><a id="__codelineno-167-16" name="__codelineno-167-16" href="#__codelineno-167-16"></a>│   ├── __init__.py
</span><span id="__span-167-17"><a id="__codelineno-167-17" name="__codelineno-167-17" href="#__codelineno-167-17"></a>│   ├── agent_prompt_generators.py
</span><span id="__span-167-18"><a id="__codelineno-167-18" name="__codelineno-167-18" href="#__codelineno-167-18"></a>│   └── prompts.py
</span><span id="__span-167-19"><a id="__codelineno-167-19" name="__codelineno-167-19" href="#__codelineno-167-19"></a>├── scripts/
</span><span id="__span-167-20"><a id="__codelineno-167-20" name="__codelineno-167-20" href="#__codelineno-167-20"></a>│   ├── create_invoice_test.py
</span><span id="__span-167-21"><a id="__codelineno-167-21" name="__codelineno-167-21" href="#__codelineno-167-21"></a>│   ├── find_events_test.py
</span><span id="__span-167-22"><a id="__codelineno-167-22" name="__codelineno-167-22" href="#__codelineno-167-22"></a>│   └── search_flights_test.py
</span><span id="__span-167-23"><a id="__codelineno-167-23" name="__codelineno-167-23" href="#__codelineno-167-23"></a>├── tools/
</span><span id="__span-167-24"><a id="__codelineno-167-24" name="__codelineno-167-24" href="#__codelineno-167-24"></a>│   ├── __init__.py
</span><span id="__span-167-25"><a id="__codelineno-167-25" name="__codelineno-167-25" href="#__codelineno-167-25"></a>│   ├── create_invoice.py
</span><span id="__span-167-26"><a id="__codelineno-167-26" name="__codelineno-167-26" href="#__codelineno-167-26"></a>│   ├── find_events.py
</span><span id="__span-167-27"><a id="__codelineno-167-27" name="__codelineno-167-27" href="#__codelineno-167-27"></a>│   ├── goal_registry.py
</span><span id="__span-167-28"><a id="__codelineno-167-28" name="__codelineno-167-28" href="#__codelineno-167-28"></a>│   ├── search_flights.py
</span><span id="__span-167-29"><a id="__codelineno-167-29" name="__codelineno-167-29" href="#__codelineno-167-29"></a>│   ├── tool_registry.py
</span><span id="__span-167-30"><a id="__codelineno-167-30" name="__codelineno-167-30" href="#__codelineno-167-30"></a>│   └── data/
</span><span id="__span-167-31"><a id="__codelineno-167-31" name="__codelineno-167-31" href="#__codelineno-167-31"></a>|       └── find_events_data.json
</span><span id="__span-167-32"><a id="__codelineno-167-32" name="__codelineno-167-32" href="#__codelineno-167-32"></a>├── worker/
</span><span id="__span-167-33"><a id="__codelineno-167-33" name="__codelineno-167-33" href="#__codelineno-167-33"></a>│   └── worker.py
</span><span id="__span-167-34"><a id="__codelineno-167-34" name="__codelineno-167-34" href="#__codelineno-167-34"></a>└── workflows/
</span><span id="__span-167-35"><a id="__codelineno-167-35" name="__codelineno-167-35" href="#__codelineno-167-35"></a>    ├── __init__.py
</span><span id="__span-167-36"><a id="__codelineno-167-36" name="__codelineno-167-36" href="#__codelineno-167-36"></a>    ├── agent_goal_workflow.py
</span><span id="__span-167-37"><a id="__codelineno-167-37" name="__codelineno-167-37" href="#__codelineno-167-37"></a>    └── workflow_helpers.py
</span></code></pre></div>

</details>

<p>Next, you will implement a REST API that will serve as the backend service for invoking your agent.</p>
<h2 id="building-a-rest-api-for-interacting-with-your-agent">Building a REST API for interacting with your agent<a class="headerlink" href="#building-a-rest-api-for-interacting-with-your-agent" title="Permanent link">&para;</a></h2>
<p>Now that you have your agent implemented, you need a way for client applications to interact with it. 
Temporal provides client libraries, but having an API to manage invoking a Workflow, sending Signals and Queries, and managing various Workflow Executions is a typical pattern for managing Temporal Workflows.</p>
<p>In this step, you will create a backend API that will serve as the interface for interacting with your agent. 
You'll use the <a href="https://fastapi.tiangolo.com/">FastAPI</a> framework to build this.
FastAPI is a great choice to pair with Temporal, as it's an async Python backend that supports type hints.</p>
<h3 id="setting-up-the-fastapi-application">Setting up the FastAPI application<a class="headerlink" href="#setting-up-the-fastapi-application" title="Permanent link">&para;</a></h3>
<p>First, create the directory structure for your FastAPI application:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-168-1"><a id="__codelineno-168-1" name="__codelineno-168-1" href="#__codelineno-168-1"></a>mkdir api
</span></code></pre></div>
<p>Next, create the API file at <code>api/main.py</code> and include the following <code>import</code> statements:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-169-1"><a id="__codelineno-169-1" name="__codelineno-169-1" href="#__codelineno-169-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-169-2"><a id="__codelineno-169-2" name="__codelineno-169-2" href="#__codelineno-169-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
</span><span id="__span-169-3"><a id="__codelineno-169-3" name="__codelineno-169-3" href="#__codelineno-169-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>
</span><span id="__span-169-4"><a id="__codelineno-169-4" name="__codelineno-169-4" href="#__codelineno-169-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
</span><span id="__span-169-5"><a id="__codelineno-169-5" name="__codelineno-169-5" href="#__codelineno-169-5"></a>
</span><span id="__span-169-6"><a id="__codelineno-169-6" name="__codelineno-169-6" href="#__codelineno-169-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
</span><span id="__span-169-7"><a id="__codelineno-169-7" name="__codelineno-169-7" href="#__codelineno-169-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
</span><span id="__span-169-8"><a id="__codelineno-169-8" name="__codelineno-169-8" href="#__codelineno-169-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>
</span><span id="__span-169-9"><a id="__codelineno-169-9" name="__codelineno-169-9" href="#__codelineno-169-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.api.enums.v1</span><span class="w"> </span><span class="kn">import</span> <span class="n">WorkflowExecutionStatus</span>
</span><span id="__span-169-10"><a id="__codelineno-169-10" name="__codelineno-169-10" href="#__codelineno-169-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.client</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>
</span><span id="__span-169-11"><a id="__codelineno-169-11" name="__codelineno-169-11" href="#__codelineno-169-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TemporalError</span>
</span><span id="__span-169-12"><a id="__codelineno-169-12" name="__codelineno-169-12" href="#__codelineno-169-12"></a>
</span><span id="__span-169-13"><a id="__codelineno-169-13" name="__codelineno-169-13" href="#__codelineno-169-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentGoalWorkflowParams</span><span class="p">,</span> <span class="n">CombinedInput</span><span class="p">,</span> <span class="n">ConversationHistory</span>
</span><span id="__span-169-14"><a id="__codelineno-169-14" name="__codelineno-169-14" href="#__codelineno-169-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">shared.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">TEMPORAL_TASK_QUEUE</span><span class="p">,</span> <span class="n">get_temporal_client</span>
</span><span id="__span-169-15"><a id="__codelineno-169-15" name="__codelineno-169-15" href="#__codelineno-169-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tools.goal_registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">goal_event_flight_invoice</span>
</span><span id="__span-169-16"><a id="__codelineno-169-16" name="__codelineno-169-16" href="#__codelineno-169-16"></a><span class="kn">from</span><span class="w"> </span><span class="nn">workflows.agent_goal_workflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentGoalWorkflow</span>
</span></code></pre></div>
<p>This imports various packages from the standard library, third-party libraries including FastAPI and Temporal, and a few of your custom libraries.
The API imported the <code>AgentGoalWorkflow</code> so it can invoke it, the <code>goal_event_flight_invoice</code> for specification of the goal, the <code>get_temporal_client</code> function and <code>TEMPORAL_TASK_QUEUE</code> constant for communicating with the Temporal service, and a few of your custom types for proper communication with the Workflow.</p>
<p>Next, add the code to configure and instantiate the FastAPI object:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-170-1"><a id="__codelineno-170-1" name="__codelineno-170-1" href="#__codelineno-170-1"></a><span class="n">temporal_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Client</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-170-2"><a id="__codelineno-170-2" name="__codelineno-170-2" href="#__codelineno-170-2"></a>
</span><span id="__span-170-3"><a id="__codelineno-170-3" name="__codelineno-170-3" href="#__codelineno-170-3"></a>
</span><span id="__span-170-4"><a id="__codelineno-170-4" name="__codelineno-170-4" href="#__codelineno-170-4"></a><span class="nd">@asynccontextmanager</span>
</span><span id="__span-170-5"><a id="__codelineno-170-5" name="__codelineno-170-5" href="#__codelineno-170-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
</span><span id="__span-170-6"><a id="__codelineno-170-6" name="__codelineno-170-6" href="#__codelineno-170-6"></a>    <span class="k">global</span> <span class="n">temporal_client</span>
</span><span id="__span-170-7"><a id="__codelineno-170-7" name="__codelineno-170-7" href="#__codelineno-170-7"></a>    <span class="c1"># Create the Temporal client</span>
</span><span id="__span-170-8"><a id="__codelineno-170-8" name="__codelineno-170-8" href="#__codelineno-170-8"></a>    <span class="n">temporal_client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_temporal_client</span><span class="p">()</span>
</span><span id="__span-170-9"><a id="__codelineno-170-9" name="__codelineno-170-9" href="#__codelineno-170-9"></a>    <span class="k">yield</span>
</span><span id="__span-170-10"><a id="__codelineno-170-10" name="__codelineno-170-10" href="#__codelineno-170-10"></a>
</span><span id="__span-170-11"><a id="__codelineno-170-11" name="__codelineno-170-11" href="#__codelineno-170-11"></a>
</span><span id="__span-170-12"><a id="__codelineno-170-12" name="__codelineno-170-12" href="#__codelineno-170-12"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">lifespan</span><span class="o">=</span><span class="n">lifespan</span><span class="p">)</span>
</span><span id="__span-170-13"><a id="__codelineno-170-13" name="__codelineno-170-13" href="#__codelineno-170-13"></a>
</span><span id="__span-170-14"><a id="__codelineno-170-14" name="__codelineno-170-14" href="#__codelineno-170-14"></a><span class="c1"># Load environment variables</span>
</span><span id="__span-170-15"><a id="__codelineno-170-15" name="__codelineno-170-15" href="#__codelineno-170-15"></a><span class="n">load_dotenv</span><span class="p">()</span>
</span><span id="__span-170-16"><a id="__codelineno-170-16" name="__codelineno-170-16" href="#__codelineno-170-16"></a>
</span><span id="__span-170-17"><a id="__codelineno-170-17" name="__codelineno-170-17" href="#__codelineno-170-17"></a><span class="n">AGENT_GOAL</span> <span class="o">=</span> <span class="n">goal_event_flight_invoice</span>
</span></code></pre></div>
<p>This creates a Temporal client, then uses the <code>lifespan</code> function to call the <code>get_temporal_client</code> function.
The <code>lifespan</code> function, paired with the <code>@asynccontextmanager</code> decorator defines a context manager that defines startup and shutdown behavior for your FastAPI app.
Next, it creates the FastAPI app, passing in the <code>lifespan</code> as a parameter.
Finally, you load in the environment variables and specify the <code>AGENT_GOAL</code> to <code>goal_event_flight_invoice</code>.</p>
<p>Next, add the appropriate middleware for handling CORS and define the root handler for your app:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-171-1"><a id="__codelineno-171-1" name="__codelineno-171-1" href="#__codelineno-171-1"></a><span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
</span><span id="__span-171-2"><a id="__codelineno-171-2" name="__codelineno-171-2" href="#__codelineno-171-2"></a>    <span class="n">CORSMiddleware</span><span class="p">,</span>
</span><span id="__span-171-3"><a id="__codelineno-171-3" name="__codelineno-171-3" href="#__codelineno-171-3"></a>    <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;http://localhost:5173&quot;</span><span class="p">],</span>
</span><span id="__span-171-4"><a id="__codelineno-171-4" name="__codelineno-171-4" href="#__codelineno-171-4"></a>    <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-171-5"><a id="__codelineno-171-5" name="__codelineno-171-5" href="#__codelineno-171-5"></a>    <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
</span><span id="__span-171-6"><a id="__codelineno-171-6" name="__codelineno-171-6" href="#__codelineno-171-6"></a>    <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
</span><span id="__span-171-7"><a id="__codelineno-171-7" name="__codelineno-171-7" href="#__codelineno-171-7"></a><span class="p">)</span>
</span><span id="__span-171-8"><a id="__codelineno-171-8" name="__codelineno-171-8" href="#__codelineno-171-8"></a>
</span><span id="__span-171-9"><a id="__codelineno-171-9" name="__codelineno-171-9" href="#__codelineno-171-9"></a>
</span><span id="__span-171-10"><a id="__codelineno-171-10" name="__codelineno-171-10" href="#__codelineno-171-10"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
</span><span id="__span-171-11"><a id="__codelineno-171-11" name="__codelineno-171-11" href="#__codelineno-171-11"></a><span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-171-12"><a id="__codelineno-171-12" name="__codelineno-171-12" href="#__codelineno-171-12"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Temporal AI Agent!&quot;</span><span class="p">}</span>
</span></code></pre></div>
<p>The CORS settings are set up to allow for access from an origin 
Any request to the root of your application will return JSON with a single key and a message.</p>
<p>Before moving on, test your FastAPI app by running the following commands:</p>
<p>In one terminal, start your Temporal development server:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-172-1"><a id="__codelineno-172-1" name="__codelineno-172-1" href="#__codelineno-172-1"></a>temporal server start-dev
</span></code></pre></div>
<p>This starts a local Temporal service running on port 7233 with the web UI running on port 8233.
The output of this command should resemble (The exact version numbers may not match):</p>
<div class="language-output highlight"><pre><span></span><code><span id="__span-173-1"><a id="__codelineno-173-1" name="__codelineno-173-1" href="#__codelineno-173-1"></a><span class="go">CLI 1.1.1 (Server 1.25.1, UI 2.31.2)</span>
</span><span id="__span-173-2"><a id="__codelineno-173-2" name="__codelineno-173-2" href="#__codelineno-173-2"></a>
</span><span id="__span-173-3"><a id="__codelineno-173-3" name="__codelineno-173-3" href="#__codelineno-173-3"></a><span class="go">Server:  localhost:7233</span>
</span><span id="__span-173-4"><a id="__codelineno-173-4" name="__codelineno-173-4" href="#__codelineno-173-4"></a><span class="go">UI:      http://localhost:8233</span>
</span><span id="__span-173-5"><a id="__codelineno-173-5" name="__codelineno-173-5" href="#__codelineno-173-5"></a><span class="go">Metrics: http://localhost:53697/metrics</span>
</span></code></pre></div>
<p>In another terminal, start the API using <code>uv</code> from the root of your project:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-174-1"><a id="__codelineno-174-1" name="__codelineno-174-1" href="#__codelineno-174-1"></a>uv run uvicorn api.main:app --reload
</span></code></pre></div>
<p>This uses <code>uvicorn</code>, an ASGI server to run the FastAPI app and auto reload the app if any changes are detected.</p>
<p>The output of this command should resemble:</p>
<div class="language-output highlight"><pre><span></span><code><span id="__span-175-1"><a id="__codelineno-175-1" name="__codelineno-175-1" href="#__codelineno-175-1"></a><span class="go">INFO:     Will watch for changes in these directories: [&#39;/Users/ziggy/temporal-ai-agent&#39;]</span>
</span><span id="__span-175-2"><a id="__codelineno-175-2" name="__codelineno-175-2" href="#__codelineno-175-2"></a><span class="go">INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)</span>
</span><span id="__span-175-3"><a id="__codelineno-175-3" name="__codelineno-175-3" href="#__codelineno-175-3"></a><span class="go">INFO:     Started reloader process [31826] using StatReload</span>
</span><span id="__span-175-4"><a id="__codelineno-175-4" name="__codelineno-175-4" href="#__codelineno-175-4"></a><span class="go">INFO:     Started server process [31828]</span>
</span><span id="__span-175-5"><a id="__codelineno-175-5" name="__codelineno-175-5" href="#__codelineno-175-5"></a><span class="go">INFO:     Waiting for application startup.</span>
</span><span id="__span-175-6"><a id="__codelineno-175-6" name="__codelineno-175-6" href="#__codelineno-175-6"></a><span class="go">Address: localhost:7233, Namespace default</span>
</span><span id="__span-175-7"><a id="__codelineno-175-7" name="__codelineno-175-7" href="#__codelineno-175-7"></a><span class="go">(If unset, then will try to connect to local server)</span>
</span><span id="__span-175-8"><a id="__codelineno-175-8" name="__codelineno-175-8" href="#__codelineno-175-8"></a><span class="go">INFO:     Application startup complete.</span>
</span></code></pre></div>
<p>Next, test your application is working by sending a request to it:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-176-1"><a id="__codelineno-176-1" name="__codelineno-176-1" href="#__codelineno-176-1"></a>curl localhost:8000
</span></code></pre></div>
<p>Your response should be:</p>
<div class="language-output highlight"><pre><span></span><code><span id="__span-177-1"><a id="__codelineno-177-1" name="__codelineno-177-1" href="#__codelineno-177-1"></a><span class="go">{&quot;message&quot;:&quot;Temporal AI Agent!&quot;}</span>
</span></code></pre></div>
<p>Now that you have the base FastAPI application configured with a Temporal client, you will implement the functions to interact with your agent Workflow.</p>
<h3 id="implementing-agent-workflow-endpoints">Implementing agent Workflow endpoints<a class="headerlink" href="#implementing-agent-workflow-endpoints" title="Permanent link">&para;</a></h3>
<p>Your API only needs a few endpoints to communicate with the agent.
You will implement the functionality to send Signals, get the conversation history, and start the Workflow.</p>
<h4 id="validating-the-temporal-client">Validating the Temporal client<a class="headerlink" href="#validating-the-temporal-client" title="Permanent link">&para;</a></h4>
<p>Every function will use the same Temporal client. First, you will implement a helper function to verify the client is set up correctly.</p>
<p>Add the following function to your <code>main.py</code> file:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-178-1"><a id="__codelineno-178-1" name="__codelineno-178-1" href="#__codelineno-178-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_ensure_temporal_client</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Client</span><span class="p">:</span>
</span><span id="__span-178-2"><a id="__codelineno-178-2" name="__codelineno-178-2" href="#__codelineno-178-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure temporal client is initialized and return it.</span>
</span><span id="__span-178-3"><a id="__codelineno-178-3" name="__codelineno-178-3" href="#__codelineno-178-3"></a>
</span><span id="__span-178-4"><a id="__codelineno-178-4" name="__codelineno-178-4" href="#__codelineno-178-4"></a><span class="sd">    Returns:</span>
</span><span id="__span-178-5"><a id="__codelineno-178-5" name="__codelineno-178-5" href="#__codelineno-178-5"></a><span class="sd">        TemporalClient: The initialized temporal client.</span>
</span><span id="__span-178-6"><a id="__codelineno-178-6" name="__codelineno-178-6" href="#__codelineno-178-6"></a>
</span><span id="__span-178-7"><a id="__codelineno-178-7" name="__codelineno-178-7" href="#__codelineno-178-7"></a><span class="sd">    Raises:</span>
</span><span id="__span-178-8"><a id="__codelineno-178-8" name="__codelineno-178-8" href="#__codelineno-178-8"></a><span class="sd">        HTTPException: If client is not initialized.</span>
</span><span id="__span-178-9"><a id="__codelineno-178-9" name="__codelineno-178-9" href="#__codelineno-178-9"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-178-10"><a id="__codelineno-178-10" name="__codelineno-178-10" href="#__codelineno-178-10"></a>    <span class="k">if</span> <span class="n">temporal_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-178-11"><a id="__codelineno-178-11" name="__codelineno-178-11" href="#__codelineno-178-11"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Temporal client not initialized&quot;</span><span class="p">)</span>
</span><span id="__span-178-12"><a id="__codelineno-178-12" name="__codelineno-178-12" href="#__codelineno-178-12"></a>    <span class="k">return</span> <span class="n">temporal_client</span>
</span></code></pre></div>
<p>This function ensures the global Temporal client is not <code>None</code>.
If it isn't, the function returns the client.
If it is <code>None</code>, it will raise an exception.
This is a type-safe way of validating the client before every function call.</p>
<h4 id="starting-the-agent-workflow">Starting the agent Workflow<a class="headerlink" href="#starting-the-agent-workflow" title="Permanent link">&para;</a></h4>
<p>Next, you'll define an endpoint that a client will use to start the agent Workflow.
This endpoint is a POST endpoint, and doesn't take any parameters.</p>
<p>Add the endpoint to your <code>api.py</code> file:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-179-1"><a id="__codelineno-179-1" name="__codelineno-179-1" href="#__codelineno-179-1"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/start-workflow&quot;</span><span class="p">)</span>
</span><span id="__span-179-2"><a id="__codelineno-179-2" name="__codelineno-179-2" href="#__codelineno-179-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_workflow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-179-3"><a id="__codelineno-179-3" name="__codelineno-179-3" href="#__codelineno-179-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Start the AgentGoalWorkflow&quot;&quot;&quot;</span>
</span><span id="__span-179-4"><a id="__codelineno-179-4" name="__codelineno-179-4" href="#__codelineno-179-4"></a>    <span class="n">temporal_client</span> <span class="o">=</span> <span class="n">_ensure_temporal_client</span><span class="p">()</span>
</span><span id="__span-179-5"><a id="__codelineno-179-5" name="__codelineno-179-5" href="#__codelineno-179-5"></a>
</span><span id="__span-179-6"><a id="__codelineno-179-6" name="__codelineno-179-6" href="#__codelineno-179-6"></a>    <span class="c1"># Create combined input</span>
</span><span id="__span-179-7"><a id="__codelineno-179-7" name="__codelineno-179-7" href="#__codelineno-179-7"></a>    <span class="n">combined_input</span> <span class="o">=</span> <span class="n">CombinedInput</span><span class="p">(</span>
</span><span id="__span-179-8"><a id="__codelineno-179-8" name="__codelineno-179-8" href="#__codelineno-179-8"></a>        <span class="n">tool_params</span><span class="o">=</span><span class="n">AgentGoalWorkflowParams</span><span class="p">(</span>
</span><span id="__span-179-9"><a id="__codelineno-179-9" name="__codelineno-179-9" href="#__codelineno-179-9"></a>            <span class="kc">None</span><span class="p">,</span> <span class="n">deque</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;### </span><span class="si">{</span><span class="n">AGENT_GOAL</span><span class="o">.</span><span class="n">starter_prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
</span><span id="__span-179-10"><a id="__codelineno-179-10" name="__codelineno-179-10" href="#__codelineno-179-10"></a>        <span class="p">),</span>
</span><span id="__span-179-11"><a id="__codelineno-179-11" name="__codelineno-179-11" href="#__codelineno-179-11"></a>        <span class="n">agent_goal</span><span class="o">=</span><span class="n">AGENT_GOAL</span><span class="p">,</span>
</span><span id="__span-179-12"><a id="__codelineno-179-12" name="__codelineno-179-12" href="#__codelineno-179-12"></a>    <span class="p">)</span>
</span><span id="__span-179-13"><a id="__codelineno-179-13" name="__codelineno-179-13" href="#__codelineno-179-13"></a>
</span><span id="__span-179-14"><a id="__codelineno-179-14" name="__codelineno-179-14" href="#__codelineno-179-14"></a>    <span class="n">workflow_id</span> <span class="o">=</span> <span class="s2">&quot;agent-workflow&quot;</span>
</span><span id="__span-179-15"><a id="__codelineno-179-15" name="__codelineno-179-15" href="#__codelineno-179-15"></a>
</span><span id="__span-179-16"><a id="__codelineno-179-16" name="__codelineno-179-16" href="#__codelineno-179-16"></a>    <span class="c1"># Start the workflow with the starter prompt from the goal</span>
</span><span id="__span-179-17"><a id="__codelineno-179-17" name="__codelineno-179-17" href="#__codelineno-179-17"></a>    <span class="k">await</span> <span class="n">temporal_client</span><span class="o">.</span><span class="n">start_workflow</span><span class="p">(</span>
</span><span id="__span-179-18"><a id="__codelineno-179-18" name="__codelineno-179-18" href="#__codelineno-179-18"></a>        <span class="n">AgentGoalWorkflow</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
</span><span id="__span-179-19"><a id="__codelineno-179-19" name="__codelineno-179-19" href="#__codelineno-179-19"></a>        <span class="n">combined_input</span><span class="p">,</span>
</span><span id="__span-179-20"><a id="__codelineno-179-20" name="__codelineno-179-20" href="#__codelineno-179-20"></a>        <span class="nb">id</span><span class="o">=</span><span class="n">workflow_id</span><span class="p">,</span>
</span><span id="__span-179-21"><a id="__codelineno-179-21" name="__codelineno-179-21" href="#__codelineno-179-21"></a>        <span class="n">task_queue</span><span class="o">=</span><span class="n">TEMPORAL_TASK_QUEUE</span><span class="p">,</span>
</span><span id="__span-179-22"><a id="__codelineno-179-22" name="__codelineno-179-22" href="#__codelineno-179-22"></a>    <span class="p">)</span>
</span><span id="__span-179-23"><a id="__codelineno-179-23" name="__codelineno-179-23" href="#__codelineno-179-23"></a>
</span><span id="__span-179-24"><a id="__codelineno-179-24" name="__codelineno-179-24" href="#__codelineno-179-24"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-179-25"><a id="__codelineno-179-25" name="__codelineno-179-25" href="#__codelineno-179-25"></a>        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Workflow started with goal&#39;s starter prompt: </span><span class="si">{</span><span class="n">AGENT_GOAL</span><span class="o">.</span><span class="n">starter_prompt</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="__span-179-26"><a id="__codelineno-179-26" name="__codelineno-179-26" href="#__codelineno-179-26"></a>    <span class="p">}</span>
</span></code></pre></div>
<p>The code verifies the Temporal client, then creates a <code>CombinedInput</code> type containing an <code>AgentGoalWorkflowParams</code> object and the <code>AGENT_GOAL</code>.
The <code>AgentGoalWorkflowParams</code> object assigns <code>None</code> to its first attribute, which represents the conversation history.
This is fine, as there is currently no conversation history.
The second attribute is the first prompt the agent will execute.
You then specify the <code>workflow_id</code> that will identify the execution, in this case it is hard coded to <code>agent-workflow</code>.
Finally, you start the Workflow asynchronously using <code>temporal.client.start_workflow</code>, specifying the Workflow method <code>AgentGoalWorkflow.run</code>, the parameter <code>combined_input</code>, <code>workflow_id</code>, and <code>task_queue</code>.</p>
<p>The function then returns with a message stating that the Workflow has started.</p>
<h4 id="sending-a-user-prompt-to-the-workflow">Sending a user prompt to the Workflow<a class="headerlink" href="#sending-a-user-prompt-to-the-workflow" title="Permanent link">&para;</a></h4>
<p>Now you'll implement sending the user's prompt to the Workflow.
The user will interact with the chatbot interface, sending messages to the agent.
The chatbot sends these as Signals to the <code>user_prompt</code> Signal handler you defined in your Workflow.</p>
<p>Add the following code to send the user's prompt to the Workflow:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-180-1"><a id="__codelineno-180-1" name="__codelineno-180-1" href="#__codelineno-180-1"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/send-prompt&quot;</span><span class="p">)</span>
</span><span id="__span-180-2"><a id="__codelineno-180-2" name="__codelineno-180-2" href="#__codelineno-180-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_prompt</span><span class="p">(</span><span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-180-3"><a id="__codelineno-180-3" name="__codelineno-180-3" href="#__codelineno-180-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Sends the user prompt to the Workflow&quot;&quot;&quot;</span>
</span><span id="__span-180-4"><a id="__codelineno-180-4" name="__codelineno-180-4" href="#__codelineno-180-4"></a>    <span class="n">temporal_client</span> <span class="o">=</span> <span class="n">_ensure_temporal_client</span><span class="p">()</span>
</span><span id="__span-180-5"><a id="__codelineno-180-5" name="__codelineno-180-5" href="#__codelineno-180-5"></a>
</span><span id="__span-180-6"><a id="__codelineno-180-6" name="__codelineno-180-6" href="#__codelineno-180-6"></a>    <span class="n">workflow_id</span> <span class="o">=</span> <span class="s2">&quot;agent-workflow&quot;</span>
</span><span id="__span-180-7"><a id="__codelineno-180-7" name="__codelineno-180-7" href="#__codelineno-180-7"></a>    <span class="n">handle</span> <span class="o">=</span> <span class="n">temporal_client</span><span class="o">.</span><span class="n">get_workflow_handle</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">)</span>
</span><span id="__span-180-8"><a id="__codelineno-180-8" name="__codelineno-180-8" href="#__codelineno-180-8"></a>    <span class="k">await</span> <span class="n">handle</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="s2">&quot;user_prompt&quot;</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
</span><span id="__span-180-9"><a id="__codelineno-180-9" name="__codelineno-180-9" href="#__codelineno-180-9"></a>
</span><span id="__span-180-10"><a id="__codelineno-180-10" name="__codelineno-180-10" href="#__codelineno-180-10"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Prompt &#39;</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&#39; sent to workflow </span><span class="si">{</span><span class="n">workflow_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">}</span>
</span></code></pre></div>
<p>This code identifies the Workflow Execution by its <code>workflow_id</code>, and sends the user's prompts sent to the API as Signals to that Workflow Execution.</p>
<h4 id="sending-a-confirmation-to-the-workflow">Sending a confirmation to the Workflow<a class="headerlink" href="#sending-a-confirmation-to-the-workflow" title="Permanent link">&para;</a></h4>
<p>If you have the <code>SHOW_CONFIRM</code> option set in your <code>.env</code> file, then the user must confirm the tool before it is executed.
This choice is sent to the workflow via a Signal.
You already implemented the Signal handler in the Workflow, now you will implement sending the Signal.</p>
<p>Add the following code to send the <code>confirm</code> Signal:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-181-1"><a id="__codelineno-181-1" name="__codelineno-181-1" href="#__codelineno-181-1"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/confirm&quot;</span><span class="p">)</span>
</span><span id="__span-181-2"><a id="__codelineno-181-2" name="__codelineno-181-2" href="#__codelineno-181-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_confirm</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-181-3"><a id="__codelineno-181-3" name="__codelineno-181-3" href="#__codelineno-181-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Sends a &#39;confirm&#39; signal to the workflow.&quot;&quot;&quot;</span>
</span><span id="__span-181-4"><a id="__codelineno-181-4" name="__codelineno-181-4" href="#__codelineno-181-4"></a>    <span class="n">temporal_client</span> <span class="o">=</span> <span class="n">_ensure_temporal_client</span><span class="p">()</span>
</span><span id="__span-181-5"><a id="__codelineno-181-5" name="__codelineno-181-5" href="#__codelineno-181-5"></a>
</span><span id="__span-181-6"><a id="__codelineno-181-6" name="__codelineno-181-6" href="#__codelineno-181-6"></a>    <span class="n">workflow_id</span> <span class="o">=</span> <span class="s2">&quot;agent-workflow&quot;</span>
</span><span id="__span-181-7"><a id="__codelineno-181-7" name="__codelineno-181-7" href="#__codelineno-181-7"></a>    <span class="n">handle</span> <span class="o">=</span> <span class="n">temporal_client</span><span class="o">.</span><span class="n">get_workflow_handle</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">)</span>
</span><span id="__span-181-8"><a id="__codelineno-181-8" name="__codelineno-181-8" href="#__codelineno-181-8"></a>    <span class="k">await</span> <span class="n">handle</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="s2">&quot;confirm&quot;</span><span class="p">)</span>
</span><span id="__span-181-9"><a id="__codelineno-181-9" name="__codelineno-181-9" href="#__codelineno-181-9"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Confirm signal sent.&quot;</span><span class="p">}</span>
</span></code></pre></div>
<p>This code identifies the Workflow Execution by its <code>workflow_id</code>, and sends the Signals sent to the API to that Workflow Execution.</p>
<h4 id="ending-the-chat_1">Ending the chat<a class="headerlink" href="#ending-the-chat_1" title="Permanent link">&para;</a></h4>
<p>Finally, the user can choose to end the chat at any time by saying something along the lines of "end conversation."
You also implemented this Signal handler in your Workflow, so now you'll implement the sending of the Signal.</p>
<p>Add the following code:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-182-1"><a id="__codelineno-182-1" name="__codelineno-182-1" href="#__codelineno-182-1"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/end-chat&quot;</span><span class="p">)</span>
</span><span id="__span-182-2"><a id="__codelineno-182-2" name="__codelineno-182-2" href="#__codelineno-182-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">end_chat</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-182-3"><a id="__codelineno-182-3" name="__codelineno-182-3" href="#__codelineno-182-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Sends a &#39;end_chat&#39; signal to the workflow.&quot;&quot;&quot;</span>
</span><span id="__span-182-4"><a id="__codelineno-182-4" name="__codelineno-182-4" href="#__codelineno-182-4"></a>    <span class="n">temporal_client</span> <span class="o">=</span> <span class="n">_ensure_temporal_client</span><span class="p">()</span>
</span><span id="__span-182-5"><a id="__codelineno-182-5" name="__codelineno-182-5" href="#__codelineno-182-5"></a>
</span><span id="__span-182-6"><a id="__codelineno-182-6" name="__codelineno-182-6" href="#__codelineno-182-6"></a>    <span class="n">workflow_id</span> <span class="o">=</span> <span class="s2">&quot;agent-workflow&quot;</span>
</span><span id="__span-182-7"><a id="__codelineno-182-7" name="__codelineno-182-7" href="#__codelineno-182-7"></a>    <span class="n">handle</span> <span class="o">=</span> <span class="n">temporal_client</span><span class="o">.</span><span class="n">get_workflow_handle</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">)</span>
</span><span id="__span-182-8"><a id="__codelineno-182-8" name="__codelineno-182-8" href="#__codelineno-182-8"></a>    <span class="k">await</span> <span class="n">handle</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="s2">&quot;end_chat&quot;</span><span class="p">)</span>
</span><span id="__span-182-9"><a id="__codelineno-182-9" name="__codelineno-182-9" href="#__codelineno-182-9"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;End chat signal sent.&quot;</span><span class="p">}</span>
</span></code></pre></div>
<p>This code identifies the Workflow Execution by its <code>workflow_id</code>, and sends the Signals sent to the API to that Workflow Execution.</p>
<h4 id="retrieving-the-conversation-history">Retrieving the conversation history<a class="headerlink" href="#retrieving-the-conversation-history" title="Permanent link">&para;</a></h4>
<p>The last API endpoint you must implement retrieves the conversation history.
The UI uses this to populate the interface for the user to read.
This API will perform a Query and retrieve the information from the running Workflow Execution.</p>
<p>Add the following code to implement the endpoint:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-183-1"><a id="__codelineno-183-1" name="__codelineno-183-1" href="#__codelineno-183-1"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/get-conversation-history&quot;</span><span class="p">)</span>
</span><span id="__span-183-2"><a id="__codelineno-183-2" name="__codelineno-183-2" href="#__codelineno-183-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_conversation_history</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ConversationHistory</span><span class="p">:</span>
</span><span id="__span-183-3"><a id="__codelineno-183-3" name="__codelineno-183-3" href="#__codelineno-183-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Calls the workflow&#39;s &#39;get_conversation_history&#39; query.&quot;&quot;&quot;</span>
</span><span id="__span-183-4"><a id="__codelineno-183-4" name="__codelineno-183-4" href="#__codelineno-183-4"></a>
</span><span id="__span-183-5"><a id="__codelineno-183-5" name="__codelineno-183-5" href="#__codelineno-183-5"></a>    <span class="n">temporal_client</span> <span class="o">=</span> <span class="n">_ensure_temporal_client</span><span class="p">()</span>
</span><span id="__span-183-6"><a id="__codelineno-183-6" name="__codelineno-183-6" href="#__codelineno-183-6"></a>
</span><span id="__span-183-7"><a id="__codelineno-183-7" name="__codelineno-183-7" href="#__codelineno-183-7"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-183-8"><a id="__codelineno-183-8" name="__codelineno-183-8" href="#__codelineno-183-8"></a>        <span class="n">handle</span> <span class="o">=</span> <span class="n">temporal_client</span><span class="o">.</span><span class="n">get_workflow_handle</span><span class="p">(</span><span class="s2">&quot;agent-workflow&quot;</span><span class="p">)</span>
</span><span id="__span-183-9"><a id="__codelineno-183-9" name="__codelineno-183-9" href="#__codelineno-183-9"></a>
</span><span id="__span-183-10"><a id="__codelineno-183-10" name="__codelineno-183-10" href="#__codelineno-183-10"></a>        <span class="n">failed_states</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-183-11"><a id="__codelineno-183-11" name="__codelineno-183-11" href="#__codelineno-183-11"></a>            <span class="n">WorkflowExecutionStatus</span><span class="o">.</span><span class="n">WORKFLOW_EXECUTION_STATUS_TERMINATED</span><span class="p">,</span>
</span><span id="__span-183-12"><a id="__codelineno-183-12" name="__codelineno-183-12" href="#__codelineno-183-12"></a>            <span class="n">WorkflowExecutionStatus</span><span class="o">.</span><span class="n">WORKFLOW_EXECUTION_STATUS_CANCELED</span><span class="p">,</span>
</span><span id="__span-183-13"><a id="__codelineno-183-13" name="__codelineno-183-13" href="#__codelineno-183-13"></a>            <span class="n">WorkflowExecutionStatus</span><span class="o">.</span><span class="n">WORKFLOW_EXECUTION_STATUS_FAILED</span><span class="p">,</span>
</span><span id="__span-183-14"><a id="__codelineno-183-14" name="__codelineno-183-14" href="#__codelineno-183-14"></a>        <span class="p">]</span>
</span><span id="__span-183-15"><a id="__codelineno-183-15" name="__codelineno-183-15" href="#__codelineno-183-15"></a>
</span><span id="__span-183-16"><a id="__codelineno-183-16" name="__codelineno-183-16" href="#__codelineno-183-16"></a>        <span class="n">description</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</span><span id="__span-183-17"><a id="__codelineno-183-17" name="__codelineno-183-17" href="#__codelineno-183-17"></a>        <span class="k">if</span> <span class="n">description</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="n">failed_states</span><span class="p">:</span>
</span><span id="__span-183-18"><a id="__codelineno-183-18" name="__codelineno-183-18" href="#__codelineno-183-18"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Workflow is in a failed state. Returning empty history.&quot;</span><span class="p">)</span>
</span><span id="__span-183-19"><a id="__codelineno-183-19" name="__codelineno-183-19" href="#__codelineno-183-19"></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="__span-183-20"><a id="__codelineno-183-20" name="__codelineno-183-20" href="#__codelineno-183-20"></a>
</span><span id="__span-183-21"><a id="__codelineno-183-21" name="__codelineno-183-21" href="#__codelineno-183-21"></a>        <span class="c1"># Set a timeout for the query</span>
</span><span id="__span-183-22"><a id="__codelineno-183-22" name="__codelineno-183-22" href="#__codelineno-183-22"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-183-23"><a id="__codelineno-183-23" name="__codelineno-183-23" href="#__codelineno-183-23"></a>            <span class="n">conversation_history</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
</span><span id="__span-183-24"><a id="__codelineno-183-24" name="__codelineno-183-24" href="#__codelineno-183-24"></a>                <span class="n">handle</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;get_conversation_history&quot;</span><span class="p">),</span>
</span><span id="__span-183-25"><a id="__codelineno-183-25" name="__codelineno-183-25" href="#__codelineno-183-25"></a>                <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># Timeout after 5 seconds</span>
</span><span id="__span-183-26"><a id="__codelineno-183-26" name="__codelineno-183-26" href="#__codelineno-183-26"></a>            <span class="p">)</span>
</span><span id="__span-183-27"><a id="__codelineno-183-27" name="__codelineno-183-27" href="#__codelineno-183-27"></a>            <span class="k">return</span> <span class="n">conversation_history</span>
</span><span id="__span-183-28"><a id="__codelineno-183-28" name="__codelineno-183-28" href="#__codelineno-183-28"></a>        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
</span><span id="__span-183-29"><a id="__codelineno-183-29" name="__codelineno-183-29" href="#__codelineno-183-29"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-183-30"><a id="__codelineno-183-30" name="__codelineno-183-30" href="#__codelineno-183-30"></a>                <span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span>
</span><span id="__span-183-31"><a id="__codelineno-183-31" name="__codelineno-183-31" href="#__codelineno-183-31"></a>                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Temporal query timed out (worker may be unavailable).&quot;</span><span class="p">,</span>
</span><span id="__span-183-32"><a id="__codelineno-183-32" name="__codelineno-183-32" href="#__codelineno-183-32"></a>            <span class="p">)</span>
</span><span id="__span-183-33"><a id="__codelineno-183-33" name="__codelineno-183-33" href="#__codelineno-183-33"></a>
</span><span id="__span-183-34"><a id="__codelineno-183-34" name="__codelineno-183-34" href="#__codelineno-183-34"></a>    <span class="k">except</span> <span class="n">TemporalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-183-35"><a id="__codelineno-183-35" name="__codelineno-183-35" href="#__codelineno-183-35"></a>        <span class="n">error_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="__span-183-36"><a id="__codelineno-183-36" name="__codelineno-183-36" href="#__codelineno-183-36"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temporal error: </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-183-37"><a id="__codelineno-183-37" name="__codelineno-183-37" href="#__codelineno-183-37"></a>
</span><span id="__span-183-38"><a id="__codelineno-183-38" name="__codelineno-183-38" href="#__codelineno-183-38"></a>        <span class="c1"># If worker is down or no poller is available, return a 404</span>
</span><span id="__span-183-39"><a id="__codelineno-183-39" name="__codelineno-183-39" href="#__codelineno-183-39"></a>        <span class="k">if</span> <span class="s2">&quot;no poller seen for task queue recently&quot;</span> <span class="ow">in</span> <span class="n">error_message</span><span class="p">:</span>
</span><span id="__span-183-40"><a id="__codelineno-183-40" name="__codelineno-183-40" href="#__codelineno-183-40"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-183-41"><a id="__codelineno-183-41" name="__codelineno-183-41" href="#__codelineno-183-41"></a>                <span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Workflow worker unavailable or not found.&quot;</span>
</span><span id="__span-183-42"><a id="__codelineno-183-42" name="__codelineno-183-42" href="#__codelineno-183-42"></a>            <span class="p">)</span>
</span><span id="__span-183-43"><a id="__codelineno-183-43" name="__codelineno-183-43" href="#__codelineno-183-43"></a>
</span><span id="__span-183-44"><a id="__codelineno-183-44" name="__codelineno-183-44" href="#__codelineno-183-44"></a>        <span class="k">if</span> <span class="s2">&quot;workflow not found&quot;</span> <span class="ow">in</span> <span class="n">error_message</span><span class="p">:</span>
</span><span id="__span-183-45"><a id="__codelineno-183-45" name="__codelineno-183-45" href="#__codelineno-183-45"></a>            <span class="k">await</span> <span class="n">start_workflow</span><span class="p">()</span>
</span><span id="__span-183-46"><a id="__codelineno-183-46" name="__codelineno-183-46" href="#__codelineno-183-46"></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="__span-183-47"><a id="__codelineno-183-47" name="__codelineno-183-47" href="#__codelineno-183-47"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-183-48"><a id="__codelineno-183-48" name="__codelineno-183-48" href="#__codelineno-183-48"></a>            <span class="c1"># For other Temporal errors, return a 500</span>
</span><span id="__span-183-49"><a id="__codelineno-183-49" name="__codelineno-183-49" href="#__codelineno-183-49"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-183-50"><a id="__codelineno-183-50" name="__codelineno-183-50" href="#__codelineno-183-50"></a>                <span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Internal server error while querying workflow.&quot;</span>
</span><span id="__span-183-51"><a id="__codelineno-183-51" name="__codelineno-183-51" href="#__codelineno-183-51"></a>            <span class="p">)</span>
</span></code></pre></div>
<p>This function identifies the Workflow by its Workflow ID, then checks the Workflow Execution's status, making sure it isn't in a failed state.
It then performs the Query, setting a timeout of five seconds, handling various errors as they may occur.
If the Workflow Execution isn't found however, the endpoint will actually kick it off.</p>
<details>

<summary>
The <code>api/main.py</code> is complete and will need no more revisions. You can review the complete file and copy the code here
</summary>

[api/main.py](https://github.com/temporal-community/tutorial-temporal-ai-agent/blob/main/api/main.py)

<div class="language-python highlight"><pre><span></span><code><span id="__span-184-1"><a id="__codelineno-184-1" name="__codelineno-184-1" href="#__codelineno-184-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-184-2"><a id="__codelineno-184-2" name="__codelineno-184-2" href="#__codelineno-184-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
</span><span id="__span-184-3"><a id="__codelineno-184-3" name="__codelineno-184-3" href="#__codelineno-184-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span>
</span><span id="__span-184-4"><a id="__codelineno-184-4" name="__codelineno-184-4" href="#__codelineno-184-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
</span><span id="__span-184-5"><a id="__codelineno-184-5" name="__codelineno-184-5" href="#__codelineno-184-5"></a>
</span><span id="__span-184-6"><a id="__codelineno-184-6" name="__codelineno-184-6" href="#__codelineno-184-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>
</span><span id="__span-184-7"><a id="__codelineno-184-7" name="__codelineno-184-7" href="#__codelineno-184-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
</span><span id="__span-184-8"><a id="__codelineno-184-8" name="__codelineno-184-8" href="#__codelineno-184-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.middleware.cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORSMiddleware</span>
</span><span id="__span-184-9"><a id="__codelineno-184-9" name="__codelineno-184-9" href="#__codelineno-184-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.api.enums.v1</span><span class="w"> </span><span class="kn">import</span> <span class="n">WorkflowExecutionStatus</span>
</span><span id="__span-184-10"><a id="__codelineno-184-10" name="__codelineno-184-10" href="#__codelineno-184-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.client</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>
</span><span id="__span-184-11"><a id="__codelineno-184-11" name="__codelineno-184-11" href="#__codelineno-184-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">temporalio.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TemporalError</span>
</span><span id="__span-184-12"><a id="__codelineno-184-12" name="__codelineno-184-12" href="#__codelineno-184-12"></a>
</span><span id="__span-184-13"><a id="__codelineno-184-13" name="__codelineno-184-13" href="#__codelineno-184-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">models.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentGoalWorkflowParams</span><span class="p">,</span> <span class="n">CombinedInput</span><span class="p">,</span> <span class="n">ConversationHistory</span>
</span><span id="__span-184-14"><a id="__codelineno-184-14" name="__codelineno-184-14" href="#__codelineno-184-14"></a><span class="kn">from</span><span class="w"> </span><span class="nn">shared.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">TEMPORAL_TASK_QUEUE</span><span class="p">,</span> <span class="n">get_temporal_client</span>
</span><span id="__span-184-15"><a id="__codelineno-184-15" name="__codelineno-184-15" href="#__codelineno-184-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tools.goal_registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">goal_event_flight_invoice</span>
</span><span id="__span-184-16"><a id="__codelineno-184-16" name="__codelineno-184-16" href="#__codelineno-184-16"></a><span class="kn">from</span><span class="w"> </span><span class="nn">workflows.agent_goal_workflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentGoalWorkflow</span>
</span><span id="__span-184-17"><a id="__codelineno-184-17" name="__codelineno-184-17" href="#__codelineno-184-17"></a>
</span><span id="__span-184-18"><a id="__codelineno-184-18" name="__codelineno-184-18" href="#__codelineno-184-18"></a><span class="n">temporal_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Client</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-184-19"><a id="__codelineno-184-19" name="__codelineno-184-19" href="#__codelineno-184-19"></a>
</span><span id="__span-184-20"><a id="__codelineno-184-20" name="__codelineno-184-20" href="#__codelineno-184-20"></a>
</span><span id="__span-184-21"><a id="__codelineno-184-21" name="__codelineno-184-21" href="#__codelineno-184-21"></a><span class="nd">@asynccontextmanager</span>
</span><span id="__span-184-22"><a id="__codelineno-184-22" name="__codelineno-184-22" href="#__codelineno-184-22"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
</span><span id="__span-184-23"><a id="__codelineno-184-23" name="__codelineno-184-23" href="#__codelineno-184-23"></a>    <span class="k">global</span> <span class="n">temporal_client</span>
</span><span id="__span-184-24"><a id="__codelineno-184-24" name="__codelineno-184-24" href="#__codelineno-184-24"></a>    <span class="c1"># Create the Temporal client</span>
</span><span id="__span-184-25"><a id="__codelineno-184-25" name="__codelineno-184-25" href="#__codelineno-184-25"></a>    <span class="n">temporal_client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_temporal_client</span><span class="p">()</span>
</span><span id="__span-184-26"><a id="__codelineno-184-26" name="__codelineno-184-26" href="#__codelineno-184-26"></a>    <span class="k">yield</span>
</span><span id="__span-184-27"><a id="__codelineno-184-27" name="__codelineno-184-27" href="#__codelineno-184-27"></a>
</span><span id="__span-184-28"><a id="__codelineno-184-28" name="__codelineno-184-28" href="#__codelineno-184-28"></a>
</span><span id="__span-184-29"><a id="__codelineno-184-29" name="__codelineno-184-29" href="#__codelineno-184-29"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">lifespan</span><span class="o">=</span><span class="n">lifespan</span><span class="p">)</span>
</span><span id="__span-184-30"><a id="__codelineno-184-30" name="__codelineno-184-30" href="#__codelineno-184-30"></a>
</span><span id="__span-184-31"><a id="__codelineno-184-31" name="__codelineno-184-31" href="#__codelineno-184-31"></a><span class="c1"># Load environment variables</span>
</span><span id="__span-184-32"><a id="__codelineno-184-32" name="__codelineno-184-32" href="#__codelineno-184-32"></a><span class="n">load_dotenv</span><span class="p">()</span>
</span><span id="__span-184-33"><a id="__codelineno-184-33" name="__codelineno-184-33" href="#__codelineno-184-33"></a>
</span><span id="__span-184-34"><a id="__codelineno-184-34" name="__codelineno-184-34" href="#__codelineno-184-34"></a><span class="n">AGENT_GOAL</span> <span class="o">=</span> <span class="n">goal_event_flight_invoice</span>
</span><span id="__span-184-35"><a id="__codelineno-184-35" name="__codelineno-184-35" href="#__codelineno-184-35"></a>
</span><span id="__span-184-36"><a id="__codelineno-184-36" name="__codelineno-184-36" href="#__codelineno-184-36"></a>
</span><span id="__span-184-37"><a id="__codelineno-184-37" name="__codelineno-184-37" href="#__codelineno-184-37"></a><span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span>
</span><span id="__span-184-38"><a id="__codelineno-184-38" name="__codelineno-184-38" href="#__codelineno-184-38"></a>    <span class="n">CORSMiddleware</span><span class="p">,</span>
</span><span id="__span-184-39"><a id="__codelineno-184-39" name="__codelineno-184-39" href="#__codelineno-184-39"></a>    <span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;http://localhost:5173&quot;</span><span class="p">],</span>
</span><span id="__span-184-40"><a id="__codelineno-184-40" name="__codelineno-184-40" href="#__codelineno-184-40"></a>    <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-184-41"><a id="__codelineno-184-41" name="__codelineno-184-41" href="#__codelineno-184-41"></a>    <span class="n">allow_methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
</span><span id="__span-184-42"><a id="__codelineno-184-42" name="__codelineno-184-42" href="#__codelineno-184-42"></a>    <span class="n">allow_headers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">],</span>
</span><span id="__span-184-43"><a id="__codelineno-184-43" name="__codelineno-184-43" href="#__codelineno-184-43"></a><span class="p">)</span>
</span><span id="__span-184-44"><a id="__codelineno-184-44" name="__codelineno-184-44" href="#__codelineno-184-44"></a>
</span><span id="__span-184-45"><a id="__codelineno-184-45" name="__codelineno-184-45" href="#__codelineno-184-45"></a>
</span><span id="__span-184-46"><a id="__codelineno-184-46" name="__codelineno-184-46" href="#__codelineno-184-46"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
</span><span id="__span-184-47"><a id="__codelineno-184-47" name="__codelineno-184-47" href="#__codelineno-184-47"></a><span class="k">def</span><span class="w"> </span><span class="nf">root</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-184-48"><a id="__codelineno-184-48" name="__codelineno-184-48" href="#__codelineno-184-48"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Temporal AI Agent!&quot;</span><span class="p">}</span>
</span><span id="__span-184-49"><a id="__codelineno-184-49" name="__codelineno-184-49" href="#__codelineno-184-49"></a>
</span><span id="__span-184-50"><a id="__codelineno-184-50" name="__codelineno-184-50" href="#__codelineno-184-50"></a>
</span><span id="__span-184-51"><a id="__codelineno-184-51" name="__codelineno-184-51" href="#__codelineno-184-51"></a><span class="k">def</span><span class="w"> </span><span class="nf">_ensure_temporal_client</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Client</span><span class="p">:</span>
</span><span id="__span-184-52"><a id="__codelineno-184-52" name="__codelineno-184-52" href="#__codelineno-184-52"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure temporal client is initialized and return it.</span>
</span><span id="__span-184-53"><a id="__codelineno-184-53" name="__codelineno-184-53" href="#__codelineno-184-53"></a>
</span><span id="__span-184-54"><a id="__codelineno-184-54" name="__codelineno-184-54" href="#__codelineno-184-54"></a><span class="sd">    Returns:</span>
</span><span id="__span-184-55"><a id="__codelineno-184-55" name="__codelineno-184-55" href="#__codelineno-184-55"></a><span class="sd">        TemporalClient: The initialized temporal client.</span>
</span><span id="__span-184-56"><a id="__codelineno-184-56" name="__codelineno-184-56" href="#__codelineno-184-56"></a>
</span><span id="__span-184-57"><a id="__codelineno-184-57" name="__codelineno-184-57" href="#__codelineno-184-57"></a><span class="sd">    Raises:</span>
</span><span id="__span-184-58"><a id="__codelineno-184-58" name="__codelineno-184-58" href="#__codelineno-184-58"></a><span class="sd">        HTTPException: If client is not initialized.</span>
</span><span id="__span-184-59"><a id="__codelineno-184-59" name="__codelineno-184-59" href="#__codelineno-184-59"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-184-60"><a id="__codelineno-184-60" name="__codelineno-184-60" href="#__codelineno-184-60"></a>    <span class="k">if</span> <span class="n">temporal_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-184-61"><a id="__codelineno-184-61" name="__codelineno-184-61" href="#__codelineno-184-61"></a>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Temporal client not initialized&quot;</span><span class="p">)</span>
</span><span id="__span-184-62"><a id="__codelineno-184-62" name="__codelineno-184-62" href="#__codelineno-184-62"></a>    <span class="k">return</span> <span class="n">temporal_client</span>
</span><span id="__span-184-63"><a id="__codelineno-184-63" name="__codelineno-184-63" href="#__codelineno-184-63"></a>
</span><span id="__span-184-64"><a id="__codelineno-184-64" name="__codelineno-184-64" href="#__codelineno-184-64"></a>
</span><span id="__span-184-65"><a id="__codelineno-184-65" name="__codelineno-184-65" href="#__codelineno-184-65"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/start-workflow&quot;</span><span class="p">)</span>
</span><span id="__span-184-66"><a id="__codelineno-184-66" name="__codelineno-184-66" href="#__codelineno-184-66"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_workflow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-184-67"><a id="__codelineno-184-67" name="__codelineno-184-67" href="#__codelineno-184-67"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Start the AgentGoalWorkflow&quot;&quot;&quot;</span>
</span><span id="__span-184-68"><a id="__codelineno-184-68" name="__codelineno-184-68" href="#__codelineno-184-68"></a>    <span class="n">temporal_client</span> <span class="o">=</span> <span class="n">_ensure_temporal_client</span><span class="p">()</span>
</span><span id="__span-184-69"><a id="__codelineno-184-69" name="__codelineno-184-69" href="#__codelineno-184-69"></a>
</span><span id="__span-184-70"><a id="__codelineno-184-70" name="__codelineno-184-70" href="#__codelineno-184-70"></a>    <span class="c1"># Create combined input</span>
</span><span id="__span-184-71"><a id="__codelineno-184-71" name="__codelineno-184-71" href="#__codelineno-184-71"></a>    <span class="n">combined_input</span> <span class="o">=</span> <span class="n">CombinedInput</span><span class="p">(</span>
</span><span id="__span-184-72"><a id="__codelineno-184-72" name="__codelineno-184-72" href="#__codelineno-184-72"></a>        <span class="n">tool_params</span><span class="o">=</span><span class="n">AgentGoalWorkflowParams</span><span class="p">(</span>
</span><span id="__span-184-73"><a id="__codelineno-184-73" name="__codelineno-184-73" href="#__codelineno-184-73"></a>            <span class="kc">None</span><span class="p">,</span> <span class="n">deque</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;### </span><span class="si">{</span><span class="n">AGENT_GOAL</span><span class="o">.</span><span class="n">starter_prompt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
</span><span id="__span-184-74"><a id="__codelineno-184-74" name="__codelineno-184-74" href="#__codelineno-184-74"></a>        <span class="p">),</span>
</span><span id="__span-184-75"><a id="__codelineno-184-75" name="__codelineno-184-75" href="#__codelineno-184-75"></a>        <span class="n">agent_goal</span><span class="o">=</span><span class="n">AGENT_GOAL</span><span class="p">,</span>
</span><span id="__span-184-76"><a id="__codelineno-184-76" name="__codelineno-184-76" href="#__codelineno-184-76"></a>    <span class="p">)</span>
</span><span id="__span-184-77"><a id="__codelineno-184-77" name="__codelineno-184-77" href="#__codelineno-184-77"></a>
</span><span id="__span-184-78"><a id="__codelineno-184-78" name="__codelineno-184-78" href="#__codelineno-184-78"></a>    <span class="n">workflow_id</span> <span class="o">=</span> <span class="s2">&quot;agent-workflow&quot;</span>
</span><span id="__span-184-79"><a id="__codelineno-184-79" name="__codelineno-184-79" href="#__codelineno-184-79"></a>
</span><span id="__span-184-80"><a id="__codelineno-184-80" name="__codelineno-184-80" href="#__codelineno-184-80"></a>    <span class="c1"># Start the workflow with the starter prompt from the goal</span>
</span><span id="__span-184-81"><a id="__codelineno-184-81" name="__codelineno-184-81" href="#__codelineno-184-81"></a>    <span class="k">await</span> <span class="n">temporal_client</span><span class="o">.</span><span class="n">start_workflow</span><span class="p">(</span>
</span><span id="__span-184-82"><a id="__codelineno-184-82" name="__codelineno-184-82" href="#__codelineno-184-82"></a>        <span class="n">AgentGoalWorkflow</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
</span><span id="__span-184-83"><a id="__codelineno-184-83" name="__codelineno-184-83" href="#__codelineno-184-83"></a>        <span class="n">combined_input</span><span class="p">,</span>
</span><span id="__span-184-84"><a id="__codelineno-184-84" name="__codelineno-184-84" href="#__codelineno-184-84"></a>        <span class="nb">id</span><span class="o">=</span><span class="n">workflow_id</span><span class="p">,</span>
</span><span id="__span-184-85"><a id="__codelineno-184-85" name="__codelineno-184-85" href="#__codelineno-184-85"></a>        <span class="n">task_queue</span><span class="o">=</span><span class="n">TEMPORAL_TASK_QUEUE</span><span class="p">,</span>
</span><span id="__span-184-86"><a id="__codelineno-184-86" name="__codelineno-184-86" href="#__codelineno-184-86"></a>    <span class="p">)</span>
</span><span id="__span-184-87"><a id="__codelineno-184-87" name="__codelineno-184-87" href="#__codelineno-184-87"></a>
</span><span id="__span-184-88"><a id="__codelineno-184-88" name="__codelineno-184-88" href="#__codelineno-184-88"></a>    <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-184-89"><a id="__codelineno-184-89" name="__codelineno-184-89" href="#__codelineno-184-89"></a>        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Workflow started with goal&#39;s starter prompt: </span><span class="si">{</span><span class="n">AGENT_GOAL</span><span class="o">.</span><span class="n">starter_prompt</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="__span-184-90"><a id="__codelineno-184-90" name="__codelineno-184-90" href="#__codelineno-184-90"></a>    <span class="p">}</span>
</span><span id="__span-184-91"><a id="__codelineno-184-91" name="__codelineno-184-91" href="#__codelineno-184-91"></a>
</span><span id="__span-184-92"><a id="__codelineno-184-92" name="__codelineno-184-92" href="#__codelineno-184-92"></a>
</span><span id="__span-184-93"><a id="__codelineno-184-93" name="__codelineno-184-93" href="#__codelineno-184-93"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/send-prompt&quot;</span><span class="p">)</span>
</span><span id="__span-184-94"><a id="__codelineno-184-94" name="__codelineno-184-94" href="#__codelineno-184-94"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_prompt</span><span class="p">(</span><span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-184-95"><a id="__codelineno-184-95" name="__codelineno-184-95" href="#__codelineno-184-95"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Sends the user prompt to the Workflow&quot;&quot;&quot;</span>
</span><span id="__span-184-96"><a id="__codelineno-184-96" name="__codelineno-184-96" href="#__codelineno-184-96"></a>    <span class="n">temporal_client</span> <span class="o">=</span> <span class="n">_ensure_temporal_client</span><span class="p">()</span>
</span><span id="__span-184-97"><a id="__codelineno-184-97" name="__codelineno-184-97" href="#__codelineno-184-97"></a>
</span><span id="__span-184-98"><a id="__codelineno-184-98" name="__codelineno-184-98" href="#__codelineno-184-98"></a>    <span class="n">workflow_id</span> <span class="o">=</span> <span class="s2">&quot;agent-workflow&quot;</span>
</span><span id="__span-184-99"><a id="__codelineno-184-99" name="__codelineno-184-99" href="#__codelineno-184-99"></a>    <span class="n">handle</span> <span class="o">=</span> <span class="n">temporal_client</span><span class="o">.</span><span class="n">get_workflow_handle</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">)</span>
</span><span id="__span-184-100"><a id="__codelineno-184-100" name="__codelineno-184-100" href="#__codelineno-184-100"></a>    <span class="k">await</span> <span class="n">handle</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="s2">&quot;user_prompt&quot;</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
</span><span id="__span-184-101"><a id="__codelineno-184-101" name="__codelineno-184-101" href="#__codelineno-184-101"></a>
</span><span id="__span-184-102"><a id="__codelineno-184-102" name="__codelineno-184-102" href="#__codelineno-184-102"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Prompt &#39;</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&#39; sent to workflow </span><span class="si">{</span><span class="n">workflow_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">}</span>
</span><span id="__span-184-103"><a id="__codelineno-184-103" name="__codelineno-184-103" href="#__codelineno-184-103"></a>
</span><span id="__span-184-104"><a id="__codelineno-184-104" name="__codelineno-184-104" href="#__codelineno-184-104"></a>
</span><span id="__span-184-105"><a id="__codelineno-184-105" name="__codelineno-184-105" href="#__codelineno-184-105"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/confirm&quot;</span><span class="p">)</span>
</span><span id="__span-184-106"><a id="__codelineno-184-106" name="__codelineno-184-106" href="#__codelineno-184-106"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_confirm</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-184-107"><a id="__codelineno-184-107" name="__codelineno-184-107" href="#__codelineno-184-107"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Sends a &#39;confirm&#39; signal to the workflow.&quot;&quot;&quot;</span>
</span><span id="__span-184-108"><a id="__codelineno-184-108" name="__codelineno-184-108" href="#__codelineno-184-108"></a>    <span class="n">temporal_client</span> <span class="o">=</span> <span class="n">_ensure_temporal_client</span><span class="p">()</span>
</span><span id="__span-184-109"><a id="__codelineno-184-109" name="__codelineno-184-109" href="#__codelineno-184-109"></a>
</span><span id="__span-184-110"><a id="__codelineno-184-110" name="__codelineno-184-110" href="#__codelineno-184-110"></a>    <span class="n">workflow_id</span> <span class="o">=</span> <span class="s2">&quot;agent-workflow&quot;</span>
</span><span id="__span-184-111"><a id="__codelineno-184-111" name="__codelineno-184-111" href="#__codelineno-184-111"></a>    <span class="n">handle</span> <span class="o">=</span> <span class="n">temporal_client</span><span class="o">.</span><span class="n">get_workflow_handle</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">)</span>
</span><span id="__span-184-112"><a id="__codelineno-184-112" name="__codelineno-184-112" href="#__codelineno-184-112"></a>    <span class="k">await</span> <span class="n">handle</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="s2">&quot;confirm&quot;</span><span class="p">)</span>
</span><span id="__span-184-113"><a id="__codelineno-184-113" name="__codelineno-184-113" href="#__codelineno-184-113"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Confirm signal sent.&quot;</span><span class="p">}</span>
</span><span id="__span-184-114"><a id="__codelineno-184-114" name="__codelineno-184-114" href="#__codelineno-184-114"></a>
</span><span id="__span-184-115"><a id="__codelineno-184-115" name="__codelineno-184-115" href="#__codelineno-184-115"></a>
</span><span id="__span-184-116"><a id="__codelineno-184-116" name="__codelineno-184-116" href="#__codelineno-184-116"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/end-chat&quot;</span><span class="p">)</span>
</span><span id="__span-184-117"><a id="__codelineno-184-117" name="__codelineno-184-117" href="#__codelineno-184-117"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">end_chat</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="__span-184-118"><a id="__codelineno-184-118" name="__codelineno-184-118" href="#__codelineno-184-118"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Sends a &#39;end_chat&#39; signal to the workflow.&quot;&quot;&quot;</span>
</span><span id="__span-184-119"><a id="__codelineno-184-119" name="__codelineno-184-119" href="#__codelineno-184-119"></a>    <span class="n">temporal_client</span> <span class="o">=</span> <span class="n">_ensure_temporal_client</span><span class="p">()</span>
</span><span id="__span-184-120"><a id="__codelineno-184-120" name="__codelineno-184-120" href="#__codelineno-184-120"></a>
</span><span id="__span-184-121"><a id="__codelineno-184-121" name="__codelineno-184-121" href="#__codelineno-184-121"></a>    <span class="n">workflow_id</span> <span class="o">=</span> <span class="s2">&quot;agent-workflow&quot;</span>
</span><span id="__span-184-122"><a id="__codelineno-184-122" name="__codelineno-184-122" href="#__codelineno-184-122"></a>    <span class="n">handle</span> <span class="o">=</span> <span class="n">temporal_client</span><span class="o">.</span><span class="n">get_workflow_handle</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">)</span>
</span><span id="__span-184-123"><a id="__codelineno-184-123" name="__codelineno-184-123" href="#__codelineno-184-123"></a>    <span class="k">await</span> <span class="n">handle</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="s2">&quot;end_chat&quot;</span><span class="p">)</span>
</span><span id="__span-184-124"><a id="__codelineno-184-124" name="__codelineno-184-124" href="#__codelineno-184-124"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;End chat signal sent.&quot;</span><span class="p">}</span>
</span><span id="__span-184-125"><a id="__codelineno-184-125" name="__codelineno-184-125" href="#__codelineno-184-125"></a>
</span><span id="__span-184-126"><a id="__codelineno-184-126" name="__codelineno-184-126" href="#__codelineno-184-126"></a>
</span><span id="__span-184-127"><a id="__codelineno-184-127" name="__codelineno-184-127" href="#__codelineno-184-127"></a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/get-conversation-history&quot;</span><span class="p">)</span>
</span><span id="__span-184-128"><a id="__codelineno-184-128" name="__codelineno-184-128" href="#__codelineno-184-128"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_conversation_history</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ConversationHistory</span><span class="p">:</span>
</span><span id="__span-184-129"><a id="__codelineno-184-129" name="__codelineno-184-129" href="#__codelineno-184-129"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Calls the workflow&#39;s &#39;get_conversation_history&#39; query.&quot;&quot;&quot;</span>
</span><span id="__span-184-130"><a id="__codelineno-184-130" name="__codelineno-184-130" href="#__codelineno-184-130"></a>
</span><span id="__span-184-131"><a id="__codelineno-184-131" name="__codelineno-184-131" href="#__codelineno-184-131"></a>    <span class="n">temporal_client</span> <span class="o">=</span> <span class="n">_ensure_temporal_client</span><span class="p">()</span>
</span><span id="__span-184-132"><a id="__codelineno-184-132" name="__codelineno-184-132" href="#__codelineno-184-132"></a>
</span><span id="__span-184-133"><a id="__codelineno-184-133" name="__codelineno-184-133" href="#__codelineno-184-133"></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="__span-184-134"><a id="__codelineno-184-134" name="__codelineno-184-134" href="#__codelineno-184-134"></a>        <span class="n">handle</span> <span class="o">=</span> <span class="n">temporal_client</span><span class="o">.</span><span class="n">get_workflow_handle</span><span class="p">(</span><span class="s2">&quot;agent-workflow&quot;</span><span class="p">)</span>
</span><span id="__span-184-135"><a id="__codelineno-184-135" name="__codelineno-184-135" href="#__codelineno-184-135"></a>
</span><span id="__span-184-136"><a id="__codelineno-184-136" name="__codelineno-184-136" href="#__codelineno-184-136"></a>        <span class="n">failed_states</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-184-137"><a id="__codelineno-184-137" name="__codelineno-184-137" href="#__codelineno-184-137"></a>            <span class="n">WorkflowExecutionStatus</span><span class="o">.</span><span class="n">WORKFLOW_EXECUTION_STATUS_TERMINATED</span><span class="p">,</span>
</span><span id="__span-184-138"><a id="__codelineno-184-138" name="__codelineno-184-138" href="#__codelineno-184-138"></a>            <span class="n">WorkflowExecutionStatus</span><span class="o">.</span><span class="n">WORKFLOW_EXECUTION_STATUS_CANCELED</span><span class="p">,</span>
</span><span id="__span-184-139"><a id="__codelineno-184-139" name="__codelineno-184-139" href="#__codelineno-184-139"></a>            <span class="n">WorkflowExecutionStatus</span><span class="o">.</span><span class="n">WORKFLOW_EXECUTION_STATUS_FAILED</span><span class="p">,</span>
</span><span id="__span-184-140"><a id="__codelineno-184-140" name="__codelineno-184-140" href="#__codelineno-184-140"></a>        <span class="p">]</span>
</span><span id="__span-184-141"><a id="__codelineno-184-141" name="__codelineno-184-141" href="#__codelineno-184-141"></a>
</span><span id="__span-184-142"><a id="__codelineno-184-142" name="__codelineno-184-142" href="#__codelineno-184-142"></a>        <span class="n">description</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</span><span id="__span-184-143"><a id="__codelineno-184-143" name="__codelineno-184-143" href="#__codelineno-184-143"></a>        <span class="k">if</span> <span class="n">description</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="n">failed_states</span><span class="p">:</span>
</span><span id="__span-184-144"><a id="__codelineno-184-144" name="__codelineno-184-144" href="#__codelineno-184-144"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Workflow is in a failed state. Returning empty history.&quot;</span><span class="p">)</span>
</span><span id="__span-184-145"><a id="__codelineno-184-145" name="__codelineno-184-145" href="#__codelineno-184-145"></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="__span-184-146"><a id="__codelineno-184-146" name="__codelineno-184-146" href="#__codelineno-184-146"></a>
</span><span id="__span-184-147"><a id="__codelineno-184-147" name="__codelineno-184-147" href="#__codelineno-184-147"></a>        <span class="c1"># Set a timeout for the query</span>
</span><span id="__span-184-148"><a id="__codelineno-184-148" name="__codelineno-184-148" href="#__codelineno-184-148"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-184-149"><a id="__codelineno-184-149" name="__codelineno-184-149" href="#__codelineno-184-149"></a>            <span class="n">conversation_history</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span>
</span><span id="__span-184-150"><a id="__codelineno-184-150" name="__codelineno-184-150" href="#__codelineno-184-150"></a>                <span class="n">handle</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;get_conversation_history&quot;</span><span class="p">),</span>
</span><span id="__span-184-151"><a id="__codelineno-184-151" name="__codelineno-184-151" href="#__codelineno-184-151"></a>                <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># Timeout after 5 seconds</span>
</span><span id="__span-184-152"><a id="__codelineno-184-152" name="__codelineno-184-152" href="#__codelineno-184-152"></a>            <span class="p">)</span>
</span><span id="__span-184-153"><a id="__codelineno-184-153" name="__codelineno-184-153" href="#__codelineno-184-153"></a>            <span class="k">return</span> <span class="n">conversation_history</span>
</span><span id="__span-184-154"><a id="__codelineno-184-154" name="__codelineno-184-154" href="#__codelineno-184-154"></a>        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
</span><span id="__span-184-155"><a id="__codelineno-184-155" name="__codelineno-184-155" href="#__codelineno-184-155"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-184-156"><a id="__codelineno-184-156" name="__codelineno-184-156" href="#__codelineno-184-156"></a>                <span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span>
</span><span id="__span-184-157"><a id="__codelineno-184-157" name="__codelineno-184-157" href="#__codelineno-184-157"></a>                <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Temporal query timed out (worker may be unavailable).&quot;</span><span class="p">,</span>
</span><span id="__span-184-158"><a id="__codelineno-184-158" name="__codelineno-184-158" href="#__codelineno-184-158"></a>            <span class="p">)</span>
</span><span id="__span-184-159"><a id="__codelineno-184-159" name="__codelineno-184-159" href="#__codelineno-184-159"></a>
</span><span id="__span-184-160"><a id="__codelineno-184-160" name="__codelineno-184-160" href="#__codelineno-184-160"></a>    <span class="k">except</span> <span class="n">TemporalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-184-161"><a id="__codelineno-184-161" name="__codelineno-184-161" href="#__codelineno-184-161"></a>        <span class="n">error_message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="__span-184-162"><a id="__codelineno-184-162" name="__codelineno-184-162" href="#__codelineno-184-162"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temporal error: </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-184-163"><a id="__codelineno-184-163" name="__codelineno-184-163" href="#__codelineno-184-163"></a>
</span><span id="__span-184-164"><a id="__codelineno-184-164" name="__codelineno-184-164" href="#__codelineno-184-164"></a>        <span class="c1"># If worker is down or no poller is available, return a 404</span>
</span><span id="__span-184-165"><a id="__codelineno-184-165" name="__codelineno-184-165" href="#__codelineno-184-165"></a>        <span class="k">if</span> <span class="s2">&quot;no poller seen for task queue recently&quot;</span> <span class="ow">in</span> <span class="n">error_message</span><span class="p">:</span>
</span><span id="__span-184-166"><a id="__codelineno-184-166" name="__codelineno-184-166" href="#__codelineno-184-166"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-184-167"><a id="__codelineno-184-167" name="__codelineno-184-167" href="#__codelineno-184-167"></a>                <span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Workflow worker unavailable or not found.&quot;</span>
</span><span id="__span-184-168"><a id="__codelineno-184-168" name="__codelineno-184-168" href="#__codelineno-184-168"></a>            <span class="p">)</span>
</span><span id="__span-184-169"><a id="__codelineno-184-169" name="__codelineno-184-169" href="#__codelineno-184-169"></a>
</span><span id="__span-184-170"><a id="__codelineno-184-170" name="__codelineno-184-170" href="#__codelineno-184-170"></a>        <span class="k">if</span> <span class="s2">&quot;workflow not found&quot;</span> <span class="ow">in</span> <span class="n">error_message</span><span class="p">:</span>
</span><span id="__span-184-171"><a id="__codelineno-184-171" name="__codelineno-184-171" href="#__codelineno-184-171"></a>            <span class="k">await</span> <span class="n">start_workflow</span><span class="p">()</span>
</span><span id="__span-184-172"><a id="__codelineno-184-172" name="__codelineno-184-172" href="#__codelineno-184-172"></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="__span-184-173"><a id="__codelineno-184-173" name="__codelineno-184-173" href="#__codelineno-184-173"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-184-174"><a id="__codelineno-184-174" name="__codelineno-184-174" href="#__codelineno-184-174"></a>            <span class="c1"># For other Temporal errors, return a 500</span>
</span><span id="__span-184-175"><a id="__codelineno-184-175" name="__codelineno-184-175" href="#__codelineno-184-175"></a>            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
</span><span id="__span-184-176"><a id="__codelineno-184-176" name="__codelineno-184-176" href="#__codelineno-184-176"></a>                <span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Internal server error while querying workflow.&quot;</span>
</span><span id="__span-184-177"><a id="__codelineno-184-177" name="__codelineno-184-177" href="#__codelineno-184-177"></a>            <span class="p">)</span>
</span></code></pre></div>
</details>

<p>You just implemented an API allowing client programs to interact with your agent.</p>
<details>

<summary>
Before moving on to the next section, verify your files and directory structure is correct.
</summary>

<div class="language-text highlight"><pre><span></span><code><span id="__span-185-1"><a id="__codelineno-185-1" name="__codelineno-185-1" href="#__codelineno-185-1"></a>temporal-ai-agent/
</span><span id="__span-185-2"><a id="__codelineno-185-2" name="__codelineno-185-2" href="#__codelineno-185-2"></a>├── .env
</span><span id="__span-185-3"><a id="__codelineno-185-3" name="__codelineno-185-3" href="#__codelineno-185-3"></a>├── .gitignore
</span><span id="__span-185-4"><a id="__codelineno-185-4" name="__codelineno-185-4" href="#__codelineno-185-4"></a>├── .python-version
</span><span id="__span-185-5"><a id="__codelineno-185-5" name="__codelineno-185-5" href="#__codelineno-185-5"></a>├── README.md
</span><span id="__span-185-6"><a id="__codelineno-185-6" name="__codelineno-185-6" href="#__codelineno-185-6"></a>├── pyproject.toml
</span><span id="__span-185-7"><a id="__codelineno-185-7" name="__codelineno-185-7" href="#__codelineno-185-7"></a>├── uv.lock
</span><span id="__span-185-8"><a id="__codelineno-185-8" name="__codelineno-185-8" href="#__codelineno-185-8"></a>├── activities/
</span><span id="__span-185-9"><a id="__codelineno-185-9" name="__codelineno-185-9" href="#__codelineno-185-9"></a>|   ├── __init__.py
</span><span id="__span-185-10"><a id="__codelineno-185-10" name="__codelineno-185-10" href="#__codelineno-185-10"></a>|   └── activities.py
</span><span id="__span-185-11"><a id="__codelineno-185-11" name="__codelineno-185-11" href="#__codelineno-185-11"></a>├── api/
</span><span id="__span-185-12"><a id="__codelineno-185-12" name="__codelineno-185-12" href="#__codelineno-185-12"></a>│   └── main.py
</span><span id="__span-185-13"><a id="__codelineno-185-13" name="__codelineno-185-13" href="#__codelineno-185-13"></a>├── models/
</span><span id="__span-185-14"><a id="__codelineno-185-14" name="__codelineno-185-14" href="#__codelineno-185-14"></a>│   ├── __init__.py
</span><span id="__span-185-15"><a id="__codelineno-185-15" name="__codelineno-185-15" href="#__codelineno-185-15"></a>│   ├── core.py
</span><span id="__span-185-16"><a id="__codelineno-185-16" name="__codelineno-185-16" href="#__codelineno-185-16"></a>│   └── requests.py
</span><span id="__span-185-17"><a id="__codelineno-185-17" name="__codelineno-185-17" href="#__codelineno-185-17"></a>├── prompts/
</span><span id="__span-185-18"><a id="__codelineno-185-18" name="__codelineno-185-18" href="#__codelineno-185-18"></a>│   ├── __init__.py
</span><span id="__span-185-19"><a id="__codelineno-185-19" name="__codelineno-185-19" href="#__codelineno-185-19"></a>│   ├── agent_prompt_generators.py
</span><span id="__span-185-20"><a id="__codelineno-185-20" name="__codelineno-185-20" href="#__codelineno-185-20"></a>│   └── prompts.py
</span><span id="__span-185-21"><a id="__codelineno-185-21" name="__codelineno-185-21" href="#__codelineno-185-21"></a>├── scripts/
</span><span id="__span-185-22"><a id="__codelineno-185-22" name="__codelineno-185-22" href="#__codelineno-185-22"></a>│   ├── create_invoice_test.py
</span><span id="__span-185-23"><a id="__codelineno-185-23" name="__codelineno-185-23" href="#__codelineno-185-23"></a>│   ├── find_events_test.py
</span><span id="__span-185-24"><a id="__codelineno-185-24" name="__codelineno-185-24" href="#__codelineno-185-24"></a>│   └── search_flights_test.py
</span><span id="__span-185-25"><a id="__codelineno-185-25" name="__codelineno-185-25" href="#__codelineno-185-25"></a>├── tools/
</span><span id="__span-185-26"><a id="__codelineno-185-26" name="__codelineno-185-26" href="#__codelineno-185-26"></a>│   ├── __init__.py
</span><span id="__span-185-27"><a id="__codelineno-185-27" name="__codelineno-185-27" href="#__codelineno-185-27"></a>│   ├── create_invoice.py
</span><span id="__span-185-28"><a id="__codelineno-185-28" name="__codelineno-185-28" href="#__codelineno-185-28"></a>│   ├── find_events.py
</span><span id="__span-185-29"><a id="__codelineno-185-29" name="__codelineno-185-29" href="#__codelineno-185-29"></a>│   ├── goal_registry.py
</span><span id="__span-185-30"><a id="__codelineno-185-30" name="__codelineno-185-30" href="#__codelineno-185-30"></a>│   ├── search_flights.py
</span><span id="__span-185-31"><a id="__codelineno-185-31" name="__codelineno-185-31" href="#__codelineno-185-31"></a>│   ├── tool_registry.py
</span><span id="__span-185-32"><a id="__codelineno-185-32" name="__codelineno-185-32" href="#__codelineno-185-32"></a>│   └── data/
</span><span id="__span-185-33"><a id="__codelineno-185-33" name="__codelineno-185-33" href="#__codelineno-185-33"></a>|       └── find_events_data.json
</span><span id="__span-185-34"><a id="__codelineno-185-34" name="__codelineno-185-34" href="#__codelineno-185-34"></a>├── worker/
</span><span id="__span-185-35"><a id="__codelineno-185-35" name="__codelineno-185-35" href="#__codelineno-185-35"></a>│   └── worker.py
</span><span id="__span-185-36"><a id="__codelineno-185-36" name="__codelineno-185-36" href="#__codelineno-185-36"></a>└── workflows/
</span><span id="__span-185-37"><a id="__codelineno-185-37" name="__codelineno-185-37" href="#__codelineno-185-37"></a>    ├── __init__.py
</span><span id="__span-185-38"><a id="__codelineno-185-38" name="__codelineno-185-38" href="#__codelineno-185-38"></a>    ├── agent_goal_workflow.py
</span><span id="__span-185-39"><a id="__codelineno-185-39" name="__codelineno-185-39" href="#__codelineno-185-39"></a>    └── workflow_helpers.py
</span></code></pre></div>

</details>

<p>In the next step, you will test your agent using a chatbot web interface.</p>
<h2 id="running-your-agent">Running your agent<a class="headerlink" href="#running-your-agent" title="Permanent link">&para;</a></h2>
<p>Now that you have implemented a mechanism of communication for your agent, it's time to test it.
You will now download a React frontend that implements a chatbot UI to interact with your agent.
The UI will open in a terminal window and prompt the user with a message stating their purpose and instructing the user what to do next.
Throughout the conversation, the user will interact with the agent, responding to questions from the agent as the agent tries to accomplish its goal.</p>
<h3 id="adding-a-chatbot-web-ui">Adding a Chatbot Web UI<a class="headerlink" href="#adding-a-chatbot-web-ui" title="Permanent link">&para;</a></h3>
<p>To get started, download the pre-built React based web UI:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-186-1"><a id="__codelineno-186-1" name="__codelineno-186-1" href="#__codelineno-186-1"></a>curl -o frontend.zip https://raw.githubusercontent.com/temporal-community/tutorial-temporal-ai-agent/main/frontend.zip
</span></code></pre></div>
<p>Once downloaded, extract the files from the zip to your root directory.
You can do this with your OS's tool, or with a command line tool like <code>unzip</code>:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-187-1"><a id="__codelineno-187-1" name="__codelineno-187-1" href="#__codelineno-187-1"></a>unzip frontend.zip
</span></code></pre></div>
<p>Next, change directories into the <code>frontend</code> directory that was just extracted and install the packages to run the UI:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-188-1"><a id="__codelineno-188-1" name="__codelineno-188-1" href="#__codelineno-188-1"></a>cd frontend
</span><span id="__span-188-2"><a id="__codelineno-188-2" name="__codelineno-188-2" href="#__codelineno-188-2"></a>npm install
</span></code></pre></div>
<p>Once the packages are finished installing, the web UI is ready to interact with your API.</p>
<h3 id="starting-your-agent">Starting Your Agent<a class="headerlink" href="#starting-your-agent" title="Permanent link">&para;</a></h3>
<p>You now have assembled all the pieces to run the agent to completion.
Running the agent requires a minimum of <strong>four</strong> different terminals, however there will only be one Worker process running.
You can either open multiple terminals, or use a terminal multiplexer like <code>screen</code> or <code>tmux</code>.
This tutorial can function with a single Worker. However, as with all real-world Temporal deployments, it is always better to run multiple Workers for scaling and redundancy."</p>
<p>The first requirement is running a local Temporal server that coordinates workflow execution and provides durability guarantees.</p>
<p>In the first terminal, start the development server:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-189-1"><a id="__codelineno-189-1" name="__codelineno-189-1" href="#__codelineno-189-1"></a>temporal server start-dev
</span></code></pre></div>
<p>This starts a local Temporal service running on port 7233 with the web UI running on port 8233.
The output of this command should resemble (The exact version numbers may not match):</p>
<div class="language-output highlight"><pre><span></span><code><span id="__span-190-1"><a id="__codelineno-190-1" name="__codelineno-190-1" href="#__codelineno-190-1"></a><span class="go">CLI 1.1.1 (Server 1.25.1, UI 2.31.2)</span>
</span><span id="__span-190-2"><a id="__codelineno-190-2" name="__codelineno-190-2" href="#__codelineno-190-2"></a>
</span><span id="__span-190-3"><a id="__codelineno-190-3" name="__codelineno-190-3" href="#__codelineno-190-3"></a><span class="go">Server:  localhost:7233</span>
</span><span id="__span-190-4"><a id="__codelineno-190-4" name="__codelineno-190-4" href="#__codelineno-190-4"></a><span class="go">UI:      http://localhost:8233</span>
</span><span id="__span-190-5"><a id="__codelineno-190-5" name="__codelineno-190-5" href="#__codelineno-190-5"></a><span class="go">Metrics: http://localhost:53697/metrics</span>
</span></code></pre></div>
<p>In the second terminal, start your Worker:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-191-1"><a id="__codelineno-191-1" name="__codelineno-191-1" href="#__codelineno-191-1"></a>uv<span class="w"> </span>run<span class="w"> </span>worker/worker.py
</span></code></pre></div>
<p>You should see the following output output:</p>
<div class="language-output highlight"><pre><span></span><code><span id="__span-192-1"><a id="__codelineno-192-1" name="__codelineno-192-1" href="#__codelineno-192-1"></a><span class="go">Worker will use LLM model: openai/gpt-4o</span>
</span><span id="__span-192-2"><a id="__codelineno-192-2" name="__codelineno-192-2" href="#__codelineno-192-2"></a><span class="go">Address: localhost:7233, Namespace default</span>
</span><span id="__span-192-3"><a id="__codelineno-192-3" name="__codelineno-192-3" href="#__codelineno-192-3"></a><span class="go">(If unset, then will try to connect to local server)</span>
</span><span id="__span-192-4"><a id="__codelineno-192-4" name="__codelineno-192-4" href="#__codelineno-192-4"></a><span class="go">AgentActivities initialized with LLM model: openai/gpt-4o</span>
</span><span id="__span-192-5"><a id="__codelineno-192-5" name="__codelineno-192-5" href="#__codelineno-192-5"></a><span class="go">Worker ready to process tasks!</span>
</span><span id="__span-192-6"><a id="__codelineno-192-6" name="__codelineno-192-6" href="#__codelineno-192-6"></a><span class="go">Starting worker, connecting to task queue: agent-task-queue</span>
</span><span id="__span-192-7"><a id="__codelineno-192-7" name="__codelineno-192-7" href="#__codelineno-192-7"></a><span class="go">Ready to begin processing...</span>
</span></code></pre></div>
<p>If you are able, running a second Worker in another terminal is recommended using the steps above.</p>
<p>Next, open another terminal and run the FastAPI application:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-193-1"><a id="__codelineno-193-1" name="__codelineno-193-1" href="#__codelineno-193-1"></a>uv run uvicorn api.main:app --reload
</span></code></pre></div>
<p>This uses <code>uvicorn</code>, an ASGI server to run the FastAPI app and auto-reload the app if any changes are detected.</p>
<p>The output of this command should resemble:</p>
<div class="language-output highlight"><pre><span></span><code><span id="__span-194-1"><a id="__codelineno-194-1" name="__codelineno-194-1" href="#__codelineno-194-1"></a><span class="go">INFO:     Will watch for changes in these directories: [&#39;/Users/ziggy/temporal-ai-agent&#39;]</span>
</span><span id="__span-194-2"><a id="__codelineno-194-2" name="__codelineno-194-2" href="#__codelineno-194-2"></a><span class="go">INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)</span>
</span><span id="__span-194-3"><a id="__codelineno-194-3" name="__codelineno-194-3" href="#__codelineno-194-3"></a><span class="go">INFO:     Started reloader process [31826] using StatReload</span>
</span><span id="__span-194-4"><a id="__codelineno-194-4" name="__codelineno-194-4" href="#__codelineno-194-4"></a><span class="go">INFO:     Started server process [31828]</span>
</span><span id="__span-194-5"><a id="__codelineno-194-5" name="__codelineno-194-5" href="#__codelineno-194-5"></a><span class="go">INFO:     Waiting for application startup.</span>
</span><span id="__span-194-6"><a id="__codelineno-194-6" name="__codelineno-194-6" href="#__codelineno-194-6"></a><span class="go">Address: localhost:7233, Namespace default</span>
</span><span id="__span-194-7"><a id="__codelineno-194-7" name="__codelineno-194-7" href="#__codelineno-194-7"></a><span class="go">(If unset, then will try to connect to local server)</span>
</span><span id="__span-194-8"><a id="__codelineno-194-8" name="__codelineno-194-8" href="#__codelineno-194-8"></a><span class="go">INFO:     Application startup complete.</span>
</span></code></pre></div>
<p>Finally, open the last new terminal, change directories into the <code>frontend</code> directory and start the web UI:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-195-1"><a id="__codelineno-195-1" name="__codelineno-195-1" href="#__codelineno-195-1"></a>cd frontend
</span><span id="__span-195-2"><a id="__codelineno-195-2" name="__codelineno-195-2" href="#__codelineno-195-2"></a>npx vite
</span></code></pre></div>
<p>You will see output to your terminal, and then your web browser will open to <code>localhost:5173</code> with your agent running.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When first starting the web UI, you may see a red error banner appear upon startup with a message about timeouts.
This is expected, as the UI begins polling immediately before the Workflow may begin.
This will go away within a few seconds once the Workflow Execution has started and the first message from the agent appears.</p>
</div>
<p>Finally, open a new browser tab and navigate to <code>localhost:8233</code>.
This will display the Temporal Web UI.
You should see a running Workflow Execution there with the Workflow ID <strong>agent-workflow</strong>.
Click on the link to open it so you can watch the Workflow progress as you run test your agent.</p>
<h3 id="testing-the-complete-system">Testing the complete system<a class="headerlink" href="#testing-the-complete-system" title="Permanent link">&para;</a></h3>
<p>With all components running, you can now test the agent Workflow.</p>
<p>Navigate back to <code>localhost:5173</code>.
You should see a message <em>similar</em> to the following.
Remember, the agent's responses are powered by an LLM, so the responses are non-deterministic, meaning they are likely to be slightly different every time.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-196-1"><a id="__codelineno-196-1" name="__codelineno-196-1" href="#__codelineno-196-1"></a>Agent: Welcome! I&#39;m here to help you plan your travel to events in North America. 
</span><span id="__span-196-2"><a id="__codelineno-196-2" name="__codelineno-196-2" href="#__codelineno-196-2"></a>I can assist you in finding events, booking flights, and generating invoices for your trip. 
</span><span id="__span-196-3"><a id="__codelineno-196-3" name="__codelineno-196-3" href="#__codelineno-196-3"></a>To get started, please tell me which city and month you&#39;re interested in traveling to?
</span></code></pre></div>
<p>Test the conversation by responding with a city you'd like to travel to and the month you want to travel:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-197-1"><a id="__codelineno-197-1" name="__codelineno-197-1" href="#__codelineno-197-1"></a>You: I&#39;d like to see events in San Francisco in March
</span></code></pre></div>
<p>The agent will process receive your prompt and use the LLM to determine the next step:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-198-1"><a id="__codelineno-198-1" name="__codelineno-198-1" href="#__codelineno-198-1"></a>Agent: Let&#39;s proceed with finding events in San Francisco in March.
</span></code></pre></div>
<p>It will determine that it should use the <code>FindEvents</code> tool and search for events.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you have the <code>SHOW_CONFIRM</code> environment variable set to <code>True</code>, the UI will prompt you to confirm execution of this tool and all future tool executions.
By default this is enabled, so you will need to confirm the execution.</p>
</div>
<p>Once you have confirmed the tool execution, the agent executes the tool and provides events for you to choose from:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-199-1"><a id="__codelineno-199-1" name="__codelineno-199-1" href="#__codelineno-199-1"></a>Agent: I found a couple of events in San Francisco:
</span><span id="__span-199-2"><a id="__codelineno-199-2" name="__codelineno-199-2" href="#__codelineno-199-2"></a>1. Lunar New Year Festival &amp; Parade from February 8 to February 22, 2026
</span><span id="__span-199-3"><a id="__codelineno-199-3" name="__codelineno-199-3" href="#__codelineno-199-3"></a>2. San Francisco International Film Festival from April 17 to May 1, 2026
</span><span id="__span-199-4"><a id="__codelineno-199-4" name="__codelineno-199-4" href="#__codelineno-199-4"></a>Would you like to search for flights to attend any of these events? If so, please provide your departure city.
</span></code></pre></div>
<p>You can then respond with which event you'd like to attend:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-200-1"><a id="__codelineno-200-1" name="__codelineno-200-1" href="#__codelineno-200-1"></a>You: I would like to attend the San Francisco International Film Festival
</span></code></pre></div>
<p>However, you forgot to provide the departure city here, which the agent recognized and then prompted you for again.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-201-1"><a id="__codelineno-201-1" name="__codelineno-201-1" href="#__codelineno-201-1"></a>Agent: Great choice! The San Francisco International Film Festival is from April 17 to May 1, 2026. 
</span><span id="__span-201-2"><a id="__codelineno-201-2" name="__codelineno-201-2" href="#__codelineno-201-2"></a>Please provide your departure city so I can search for flights.
</span></code></pre></div>
<p>Thinking about lunch, you accidentally input your lunch order into the chatbot:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-202-1"><a id="__codelineno-202-1" name="__codelineno-202-1" href="#__codelineno-202-1"></a>I would like to order two double cheeseburgers.
</span></code></pre></div>
<p>The agent's guardrails recognize this isn't valid for its goal, so it informs you and prompts you to enter your departure city.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-203-1"><a id="__codelineno-203-1" name="__codelineno-203-1" href="#__codelineno-203-1"></a>Agent: Your request to order two double cheeseburgers doesn&#39;t align with our current goal. 
</span><span id="__span-203-2"><a id="__codelineno-203-2" name="__codelineno-203-2" href="#__codelineno-203-2"></a>We&#39;re working on organizing a trip for you to attend the San Francisco International Film Festival. 
</span><span id="__span-203-3"><a id="__codelineno-203-3" name="__codelineno-203-3" href="#__codelineno-203-3"></a>To proceed, please let me know your departure city so I can search for flights for your trip.
</span></code></pre></div>
<p>You then provide it with your departure city:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-204-1"><a id="__codelineno-204-1" name="__codelineno-204-1" href="#__codelineno-204-1"></a>You: I&#39;m sorry. I&#39;d like to depart from Austin, TX
</span></code></pre></div>
<p>The agent now has the information it needs, and can move on to the next step.
However, it may decide to confirm with you again to ensure that's what you meant.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-205-1"><a id="__codelineno-205-1" name="__codelineno-205-1" href="#__codelineno-205-1"></a>Agent: Thanks! You&#39;re departing from Austin, TX. 
</span><span id="__span-205-2"><a id="__codelineno-205-2" name="__codelineno-205-2" href="#__codelineno-205-2"></a>Would you like to proceed with searching for flights from Austin to San Francisco for the San Francisco International Film Festival?
</span></code></pre></div>
<p>To which you should either confirm or deny. In this instance, confirm:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-206-1"><a id="__codelineno-206-1" name="__codelineno-206-1" href="#__codelineno-206-1"></a>You: Yes
</span></code></pre></div>
<p>This extra confirmation step may not always happen.
It depends if the LLM decides to verify.</p>
<p>However, it is now satisfied and is ready to execute the next tool. This is evident because after this response, you are asked to confirm execution for the <code>SearchFlights</code> tool:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-207-1"><a id="__codelineno-207-1" name="__codelineno-207-1" href="#__codelineno-207-1"></a>Agent: Let&#39;s proceed with searching for flights from Austin, TX (AUS) to San Francisco (SFO) around the dates of April 17 to May 1, 2026.
</span></code></pre></div>
<p>After you confirm the tool usage, the agent then executes the tool, searching for flights to your destination. </p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you have supplied a RAPIDAPI key, this will make a call to a microservice to check for real flight data.
If the API returns multiple times with an error or no flights, this is the external API being unreliable and returning sporadic error messages.
To alleviate this, use the mocked function instead.</p>
</div>
<p>Once the agent finds flight options, it will present them to you, allowing you to select a flight if there are multiple.
It will prompt you if you would like to create an invoice for the flight:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-208-1"><a id="__codelineno-208-1" name="__codelineno-208-1" href="#__codelineno-208-1"></a>Agent: 
</span><span id="__span-208-2"><a id="__codelineno-208-2" name="__codelineno-208-2" href="#__codelineno-208-2"></a>I found the cheapest flight with Southwest Airlines for $149.75. 
</span><span id="__span-208-3"><a id="__codelineno-208-3" name="__codelineno-208-3" href="#__codelineno-208-3"></a>Would you like to create an invoice for this flight?
</span></code></pre></div>
<p>To which you confirm:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-209-1"><a id="__codelineno-209-1" name="__codelineno-209-1" href="#__codelineno-209-1"></a>You: Yes
</span></code></pre></div>
<p>And the agent will proceed with creating an invoice, prompting the user to allow the execution of the <code>CreateInvoice</code> tool:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-210-1"><a id="__codelineno-210-1" name="__codelineno-210-1" href="#__codelineno-210-1"></a>Agent: Let&#39;s proceed with creating an invoice for the Southwest Airlines flight.
</span></code></pre></div>
<p>The agent then creates the invoice, the goal is complete, and the chat is over.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-211-1"><a id="__codelineno-211-1" name="__codelineno-211-1" href="#__codelineno-211-1"></a>Agent: Invoice generated successfully! 
</span><span id="__span-211-2"><a id="__codelineno-211-2" name="__codelineno-211-2" href="#__codelineno-211-2"></a>You can view and pay your invoice at: https://pay.example.com/invoice/12345. 
</span><span id="__span-211-3"><a id="__codelineno-211-3" name="__codelineno-211-3" href="#__codelineno-211-3"></a>Your reference number is INV-12345. If you need further assistance, feel free to ask.
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you set a <code>STRIPE_API_KEY</code> environment variable in your <code>.env</code> file, the tool will use the Stripe API to create an invoice in your Stripe environment.
Otherwise, it will create a pseudo link.</p>
</div>
<p>Now that the chat is over, the Workflow Execution is over.
You can start another chat session by clicking the <strong>Start New Chat</strong> button in the web UI, which will start a new Workflow Execution.</p>
<p>Next, you'll examine the Event History of your most recent chat session.</p>
<h2 id="tracing-the-workflow-execution-in-the-web-ui">Tracing the Workflow Execution in the Web UI<a class="headerlink" href="#tracing-the-workflow-execution-in-the-web-ui" title="Permanent link">&para;</a></h2>
<p>One of the features of Temporal is the observability that you gain via the Temporal Web UI.
This is made possible since every event is stored, along with the inputs and output of Workflows, Activities, and other Temporal operations. </p>
<p>Open the Temporal Web UI at <code>http://localhost:8233</code> and navigate to your most recent run.</p>
<p><em>Your UI may not look exactly like the screenshots below due to differing UI versions, varying output from LLMs, and different user inputs.
This is fine; the core concepts are still applicable.</em></p>
<p>Navigate to the Workflows page to see your past agent Workflow Executions. 
This is also the default landing page.</p>
<p><img alt="Screenshot of the Temporal Web UI Workflow Executions list page with your current Workflow Executions" src="../img/003-durable-ai-agent/workflow-executions.png" /></p>
<p>You will see all of your completed and currently running chat sessions here. 
Click on the <strong>Workflow ID</strong> link <strong>agent-workflow</strong> of the most recently completed execution to see the details about that specific execution.</p>
<p>At the top, you'll see the summary for the Workflow Execution.
This contains information such as the duration of the execution, when it started, when it ended, what Task Queue it used, the size of the history, and the Workflow Type.
All of this information an also be pieced together throughout the <strong>Event History</strong>, the <strong>Summary</strong> section provides an easier way to find it.</p>
<p><img alt="Screenshot of the summary section of the Temporal Web UI for the most recent Workflow Execution" src="../img/003-durable-ai-agent/summary.png" /></p>
<p>Next is the <strong>Input</strong> and <strong>Result</strong> section.
Here you can see the initial input to the Workflow, and the final result that the agent returned in JSON format.</p>
<p><img alt="Screenshot of the input and output section of the Temporal Web UI for the most recent Workflow Execution's input and outputs" src="../img/003-durable-ai-agent/workflow-input-results.png" /></p>
<p>Below that is the <strong>Event History</strong> timeline.
This is a time-based representation of every event that occurred during the execution of the Workflow.</p>
<p><img alt="Screenshot of the timeline section of the Temporal Web UI for the most recent Workflow Execution" src="../img/003-durable-ai-agent/timeline.png" /></p>
<p>Each individual event in this timeline is expandable.
You can click on it and view the details for the event.
For example, if you click on a purple <strong>Signal</strong> icon, you can see the Signal name, the identity of the Worker that processed it, and the input. </p>
<p><img alt="Screenshot of the timeline section of the Temporal Web UI, with a signal portion expanded so the data can be viewed" src="../img/003-durable-ai-agent/timeline-signal-expanded.png" /></p>
<p>Other events will contain other information.
Activities will contain information regarding the timeouts, retry policies, and input and results.</p>
<p>Finally, you have the list version of the <strong>Event History</strong>.
Everything that is recorded above is derived from this history. 
You can click into each individual event and see all the information about a single event.
Certain events, such as Activities, that typically come in a group, will be automatically paired for concise viewing as shown below.</p>
<p><img alt="Screenshot of the the Event History list section in the Temporal Web UI with an Activity expanded so the results can be seen" src="../img/003-durable-ai-agent/expanded-activity.png" /></p>
<p>You can also use this UI live.
During a running Workflow Execution, you can watch live updates as you interact with your chatbot, and see the events come in to the timeline and list views.
If you'd like, run another session of your chatbot and have the web UI open in a separate browser tab on another window so you can witness this.</p>
<p>Next, you'll explore a few testing scenarios for demonstrating how Temporal adds durability to your agent.</p>
<h2 id="optional-witnessing-the-durability-of-the-agent">(Optional) Witnessing the Durability of the Agent<a class="headerlink" href="#optional-witnessing-the-durability-of-the-agent" title="Permanent link">&para;</a></h2>
<p>Building your agent with Temporal adds durability to your agent.
This means that your agent can withstand failures that traditional applications wouldn't be able to, such as internet outages or process crashes.
Perform the following scenarios to witness the durability Temporal provides.</p>
<p>The following scenario is a simulation of one engineer's <em>very</em> bad day at work.
Follow along and see how Temporal mitigated potentially outage level issues.</p>
<h3 id="part-1-terminating-the-worker">Part 1: Terminating the Worker<a class="headerlink" href="#part-1-terminating-the-worker" title="Permanent link">&para;</a></h3>
<p><em>Scenario</em>: Your agent is deployed to production.
You have a chat session running, and a Worker is processing your Workflow.
Suddenly, the virtual machine hosting your Worker is rebooted for updates.
The Worker is forcefully terminated and progress appears lost.
What happens?</p>
<p><em>Simulating this scenario</em>:</p>
<ol>
<li>Ensure your Temporal development server, Worker (be sure you only have one running), API, and web UI are running.</li>
<li>Start a new chat session.</li>
<li>Before typing anything in the chat, kill the Worker using <code>CTRL-C</code>.</li>
<li>Type a city and month in the chat, and press <strong>Send</strong>.</li>
<li>You will see the UI stall, and not make progress. You may also see an error message appear at the top saying <strong>Error fetching history</strong>.</li>
<li>Return to the Worker terminal and restart the Worker.</li>
<li>Return to the web UI and watch for progress. Eventually the message should send and the agent Workflow progresses like nothing happened.</li>
<li>If you are prompted to confirm the tool execution, do so. Then leave the UI up for the next scenario.</li>
</ol>
<p><em>What happened?</em>: When the Worker came back online, it registered with the Task Queue and began listening for tasks it could execute.
When the original Worker timed out, not returning a response for the task it was supposed to execute, the new Worker accepted it.
The new Worker then rebuilt the state of the original Workflow Execution, up to the point of failure, and continued execution as if nothing happened.
This new Worker could have been on another virtual machine within the Worker fleet, or the original Worker when the virtual machine finished its upgrade.
This ensured that the state was not lost and the Workflow continued to progress.</p>
<h3 id="part-2-turning-off-the-internet">Part 2: Turning off the Internet<a class="headerlink" href="#part-2-turning-off-the-internet" title="Permanent link">&para;</a></h3>
<p><em>Scenario</em>: After the upgrade finished, somewhere, miles away, Danny the data center intern trips over a improperly managed power cable and the network switch to the rack where your Worker is hosted goes down.
While he scrambles to plug it back end, your Worker is intermittently without network access.
What happens?</p>
<p><em>Simulating this scenario</em>:</p>
<ol>
<li>Either continue from the previous session, or start with a new chat window and don't send a message yet.</li>
<li>Turn off your Wifi/Unplug your network adapter to simulate this failure.</li>
<li>Respond to the prompt the agent posed to you. The agent will validate this using the LLM, which it won't be able to access.</li>
<li>Go to your Temporal Web UI at <code>localhost:8233</code> and find the failing Activity. You will see it attempting to retry the call to the LLM. </li>
<li>Turn the internet back on.</li>
<li>Eventually, the LLM call will succeed, with no intervention from the developer.</li>
<li>If you are prompted to confirm the tool execution, do so. Then leave the UI up for the next scenario.</li>
</ol>
<p><em>What happened?</em>: Temporal Activities are retried automatically upon failure.
Intermittent failures such as network outages are often fixed via retries.
Each Activity has a default Retry Policy that retries, then backs off increasingly to a maximum duration.
Once the network comes back online, at the next retry interval the LLM call will execute and succeed.</p>
<h3 id="part-3-swapping-out-llms">Part 3: Swapping out LLMs<a class="headerlink" href="#part-3-swapping-out-llms" title="Permanent link">&para;</a></h3>
<p><em>Scenario</em>: Now that the switch is back online, the developer can breath a sigh of relief.
Unfortunately they get paged that their OpenAI credits are depleted, there are angry customers trying to use the chatbot, and the only person with a corporate card to replenish the credits is on PTO.
You have an Anthropic account with some Claude credits you can swap in quickly.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This scenario requires an Anthropic account with a Claude API token.</p>
</div>
<p><em>Simulating this scenario</em>:</p>
<ol>
<li>Either continue from the previous session, or start with a new chat window. Send a few chats to make progress in the Workflow, but do not complete it.</li>
<li>Open the <code>.env</code> file and modify the following variables:<ul>
<li><code>LLM_MODEL</code>: <code>anthropic/claude-sonnet-4-20250514</code></li>
<li><code>LLM_KEY</code>: Your LLM Key</li>
</ul>
</li>
<li>Restart the Worker.</li>
<li>Respond to the next prompt in the chat.</li>
<li>The agent will respond as if nothing happened, continuing the conversation.</li>
</ol>
<p><em>What happened?</em>: Since the agent is durable and preserves state, the conversation history was preserved when the Worker was terminated.
The state of the Workflow was reconstructed to the point where the Worker was terminated, and the conversation history was sent to Claude as context when executing the next prompt.
The agent continues executing as if nothing happened.</p>
<p>These are just some of the failure scenarios the agent can survive.</p>
<h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">&para;</a></h2>
<p>In this tutorial, you built a durable AI agent that handles multi-turn conversations, executes tools to achieve a goal, and recovers from failures.
You implemented the agent using Temporal primitives, including Workflows, Activities, Signals, Queries, Workers, and Task Queues.
You created a REST API to enable client integration with your agent.
You tested your agent with a chatbot interface, and witnessed the agent survive various failure scenarios.</p>
<h3 id="key-architectural-patterns">Key architectural patterns<a class="headerlink" href="#key-architectural-patterns" title="Permanent link">&para;</a></h3>
<p>Your implementation demonstrates several important patterns for building AI agent systems:</p>
<p><strong>Durability through orchestration</strong>: Temporal Workflows provide automatic state persistence, ensuring conversations survive process crashes, network failures, and infrastructure issues. This durability is essential for AI agents that manage long-running, stateful interactions.</p>
<p><strong>Separation of concerns</strong>: The architecture cleanly separates orchestration logic (Workflows), external interactions (Activities), tool implementations (Python functions), and user interface (API), making the system maintainable and extensible.</p>
<p><strong>Observability by design</strong>: Every execution step is recorded in the Event History, providing visibility into the agent's execution without the need for extra tools.</p>
<p><strong>Extensibility</strong>: The tool and goal registry pattern enables adding defining new tools and goals without modifying the core Workflow logic.</p>
<h3 id="resources-for-continued-learning">Resources for continued learning<a class="headerlink" href="#resources-for-continued-learning" title="Permanent link">&para;</a></h3>
<p>To continue your learning on Temporal and its use for AI, check out the following resources</p>
<ul>
<li>Download and run a more feature-rich <a href="https://github.com/temporal-community/temporal-ai-agent/">version of this agent</a>, which is what inspired this tutorial.</li>
<li>Learn more about <a href="https://temporal.io/solutions/ai">Temporal AI Use Cases</a></li>
<li>Explore the <a href="https://docs.temporal.io">Temporal documentation</a> for more Temporal features and best practices.</li>
<li>Take a <a href="https://learn.temporal.io/courses/">Temporal Course</a> and dive deeper into Temporal topics.</li>
<li>Ask a question in the <a href="https://temporal.io/slack">Temporal community</a> in the #topic-ai channel.</li>
</ul>
<h3 id="final-thoughts">Final thoughts<a class="headerlink" href="#final-thoughts" title="Permanent link">&para;</a></h3>
<p>The foundation you built in this tutorial enables you to build agents to solve nearly any goal.
If you're up to it, try writing your own goal and tools and have the agent execute them.
Temporal's Durable Execution brings reliability and observability to long-running, distributed systems, which is exactly what AI agents are.</p>
<p>Check back later for the next installment in this tutorial series, where you will continue to add functionality to your agent.</p>
<h2 id="license-acknowledgements">License Acknowledgements<a class="headerlink" href="#license-acknowledgements" title="Permanent link">&para;</a></h2>
<p>I wrote this piece while employed at Temporal.
In order to preserve it in my portfolio, I am cross posting it here.
You can find the MIT License for the <a href="https://learn.temporal.io">Temporal Learning site</a> for the content below, in accordance with the licensing terms.</p>
<p><a href="https://github.com/temporalio/temporal-learning/blob/main/LICENSE.md">Link to original license</a></p>
<div class="admonition inclusion of license">
<p class="admonition-title">Inclusion</p>
<p>Temporal documentation</p>
<p>MIT License</p>
<p>Copyright &copy; 2022 Temporal Technologies Inc. All rights reserved.</p>
<p>Copyright &copy; 2017 Uber Technologies, Inc.</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>
</div>







  
  



  


  



      
    </article>
  </div>

          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2018-2025 - Mason Egger
    </div>
  
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://twitter.com/masonegger" target="_blank" rel="noopener" title="Twitter" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg>
    </a>
  
    
    
      
    
    
    
    <a href="https://fosstodon.org/@masonegger" target="_blank" rel="noopener me" title="Mastodon" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M433 179.1c0-97.2-63.7-125.7-63.7-125.7-62.5-28.7-228.6-28.4-290.5 0 0 0-63.7 28.5-63.7 125.7 0 115.7-6.6 259.4 105.6 289.1 40.5 10.7 75.3 13 103.3 11.4 50.8-2.8 79.3-18.1 79.3-18.1l-1.7-36.9s-36.3 11.4-77.1 10.1c-40.4-1.4-83-4.4-89.6-54-.6-4.6-.9-9.3-.9-13.9 85.6 20.9 158.7 9.1 178.7 6.7 56.1-6.7 105-41.3 111.2-72.9 9.8-49.8 9-121.5 9-121.5zm-75.1 125.2h-46.6V190.1c0-49.7-64-51.6-64 6.9v62.5H201V197c0-58.5-64-56.6-64-6.9v114.2H90.3c0-122.1-5.2-147.9 18.4-175 25.9-28.9 79.8-30.8 103.8 6.1l11.6 19.5 11.6-19.5c24.1-37.1 78.1-34.8 103.8-6.1 23.7 27.3 18.4 53 18.4 175"/></svg>
    </a>
  
    
    
    
    
    <a href="https://bsky.app/profile/mason.dev" target="_blank" rel="noopener" title="Bluesky" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M407.8 294.7c-3.3-.4-6.7-.8-10-1.3 3.4.4 6.7.9 10 1.3M288 227.1c-26.1-50.7-97.1-145.2-163.1-191.8C61.6-9.4 37.5-1.7 21.6 5.5 3.3 13.8 0 41.9 0 58.4S9.1 194 15 213.9c19.5 65.7 89.1 87.9 153.2 80.7 3.3-.5 6.6-.9 10-1.4-3.3.5-6.6 1-10 1.4-93.9 14-177.3 48.2-67.9 169.9C220.6 589.1 265.1 437.8 288 361.1c22.9 76.7 49.2 222.5 185.6 103.4 102.4-103.4 28.1-156-65.8-169.9-3.3-.4-6.7-.8-10-1.3 3.4.4 6.7.9 10 1.3 64.1 7.1 133.6-15.1 153.2-80.7C566.9 194 576 75 576 58.4s-3.3-44.7-21.6-52.9c-15.8-7.1-40-14.9-103.2 29.8C385.1 81.9 314.1 176.4 288 227.1"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/mason-egger" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.youtube.com/c/MasonEgger" target="_blank" rel="noopener" title="www.youtube.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M549.7 124.1c-6.2-23.7-24.8-42.3-48.3-48.6C458.9 64 288.1 64 288.1 64S117.3 64 74.7 75.5c-23.5 6.3-42 24.9-48.3 48.6C15 167 15 256.4 15 256.4s0 89.4 11.4 132.3c6.3 23.6 24.8 41.5 48.3 47.8C117.3 448 288.1 448 288.1 448s170.8 0 213.4-11.5c23.5-6.3 42-24.2 48.3-47.8 11.4-42.9 11.4-132.3 11.4-132.3s0-89.4-11.4-132.3zM232.2 337.6V175.2l142.7 81.2z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/MasonEgger" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="static/docs/MasonEgger-resume.pdf" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M176 48H64c-8.8 0-16 7.2-16 16v384c0 8.8 7.2 16 16 16h256c8.8 0 16-7.2 16-16V208h-88c-39.8 0-72-32.2-72-72zm140.1 112L224 67.9V136c0 13.3 10.7 24 24 24zM0 64C0 28.7 28.7 0 64 0h133.5c17 0 33.3 6.7 45.3 18.7l122.5 122.6c12 12 18.7 28.3 18.7 45.3V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64z"/></svg>
    </a>
  
    
    
    
    
    <a href="./feed_rss_created.xml" target="_blank" rel="noopener" title="RSS" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M64 32C28.7 32 0 60.7 0 96v320c0 35.3 28.7 64 64 64h320c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64zm32 104c0-13.3 10.7-24 24-24 137 0 248 111 248 248 0 13.3-10.7 24-24 24s-24-10.7-24-24c0-110.5-89.5-200-200-200-13.3 0-24-10.7-24-24m0 96c0-13.3 10.7-24 24-24 83.9 0 152 68.1 152 152 0 13.3-10.7 24-24 24s-24-10.7-24-24c0-57.4-46.6-104-104-104-13.3 0-24-10.7-24-24m0 120a32 32 0 1 1 64 0 32 32 0 1 1-64 0"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>